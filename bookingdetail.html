<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html lang="en-US" class="js flexbox flexboxlegacy canvas canvastext webgl no-touch geolocation postmessage websqldatabase indexeddb hashchange history draganddrop websockets rgba hsla multiplebgs backgroundsize borderimage borderradius boxshadow textshadow opacity cssanimations csscolumns cssgradients cssreflections csstransforms csstransforms3d csstransitions fontface generatedcontent video audio localstorage sessionstorage webworkers no-applicationcache svg inlinesvg smil svgclippaths win win-10_0 webkit chrome chrome-92 chrome-92_0_4515_131 k-webkit k-webkit92 general logged"><head id="Head"><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><style type="text/css">svg:not(:root).svg-inline--fa {
  overflow: visible;
}

.svg-inline--fa {
  display: inline-block;
  font-size: inherit;
  height: 1em;
  overflow: visible;
  vertical-align: -0.125em;
}
.svg-inline--fa.fa-lg {
  vertical-align: -0.225em;
}
.svg-inline--fa.fa-w-1 {
  width: 0.0625em;
}
.svg-inline--fa.fa-w-2 {
  width: 0.125em;
}
.svg-inline--fa.fa-w-3 {
  width: 0.1875em;
}
.svg-inline--fa.fa-w-4 {
  width: 0.25em;
}
.svg-inline--fa.fa-w-5 {
  width: 0.3125em;
}
.svg-inline--fa.fa-w-6 {
  width: 0.375em;
}
.svg-inline--fa.fa-w-7 {
  width: 0.4375em;
}
.svg-inline--fa.fa-w-8 {
  width: 0.5em;
}
.svg-inline--fa.fa-w-9 {
  width: 0.5625em;
}
.svg-inline--fa.fa-w-10 {
  width: 0.625em;
}
.svg-inline--fa.fa-w-11 {
  width: 0.6875em;
}
.svg-inline--fa.fa-w-12 {
  width: 0.75em;
}
.svg-inline--fa.fa-w-13 {
  width: 0.8125em;
}
.svg-inline--fa.fa-w-14 {
  width: 0.875em;
}
.svg-inline--fa.fa-w-15 {
  width: 0.9375em;
}
.svg-inline--fa.fa-w-16 {
  width: 1em;
}
.svg-inline--fa.fa-w-17 {
  width: 1.0625em;
}
.svg-inline--fa.fa-w-18 {
  width: 1.125em;
}
.svg-inline--fa.fa-w-19 {
  width: 1.1875em;
}
.svg-inline--fa.fa-w-20 {
  width: 1.25em;
}
.svg-inline--fa.fa-pull-left {
  margin-right: 0.3em;
  width: auto;
}
.svg-inline--fa.fa-pull-right {
  margin-left: 0.3em;
  width: auto;
}
.svg-inline--fa.fa-border {
  height: 1.5em;
}
.svg-inline--fa.fa-li {
  width: 2em;
}
.svg-inline--fa.fa-fw {
  width: 1.25em;
}

.fa-layers svg.svg-inline--fa {
  bottom: 0;
  left: 0;
  margin: auto;
  position: absolute;
  right: 0;
  top: 0;
}

.fa-layers {
  display: inline-block;
  height: 1em;
  position: relative;
  text-align: center;
  vertical-align: -0.125em;
  width: 1em;
}
.fa-layers svg.svg-inline--fa {
  -webkit-transform-origin: center center;
          transform-origin: center center;
}

.fa-layers-counter, .fa-layers-text {
  display: inline-block;
  position: absolute;
  text-align: center;
}

.fa-layers-text {
  left: 50%;
  top: 50%;
  -webkit-transform: translate(-50%, -50%);
          transform: translate(-50%, -50%);
  -webkit-transform-origin: center center;
          transform-origin: center center;
}

.fa-layers-counter {
  background-color: #ff253a;
  border-radius: 1em;
  -webkit-box-sizing: border-box;
          box-sizing: border-box;
  color: #fff;
  height: 1.5em;
  line-height: 1;
  max-width: 5em;
  min-width: 1.5em;
  overflow: hidden;
  padding: 0.25em;
  right: 0;
  text-overflow: ellipsis;
  top: 0;
  -webkit-transform: scale(0.25);
          transform: scale(0.25);
  -webkit-transform-origin: top right;
          transform-origin: top right;
}

.fa-layers-bottom-right {
  bottom: 0;
  right: 0;
  top: auto;
  -webkit-transform: scale(0.25);
          transform: scale(0.25);
  -webkit-transform-origin: bottom right;
          transform-origin: bottom right;
}

.fa-layers-bottom-left {
  bottom: 0;
  left: 0;
  right: auto;
  top: auto;
  -webkit-transform: scale(0.25);
          transform: scale(0.25);
  -webkit-transform-origin: bottom left;
          transform-origin: bottom left;
}

.fa-layers-top-right {
  right: 0;
  top: 0;
  -webkit-transform: scale(0.25);
          transform: scale(0.25);
  -webkit-transform-origin: top right;
          transform-origin: top right;
}

.fa-layers-top-left {
  left: 0;
  right: auto;
  top: 0;
  -webkit-transform: scale(0.25);
          transform: scale(0.25);
  -webkit-transform-origin: top left;
          transform-origin: top left;
}

.fa-lg {
  font-size: 1.3333333333em;
  line-height: 0.75em;
  vertical-align: -0.0667em;
}

.fa-xs {
  font-size: 0.75em;
}

.fa-sm {
  font-size: 0.875em;
}

.fa-1x {
  font-size: 1em;
}

.fa-2x {
  font-size: 2em;
}

.fa-3x {
  font-size: 3em;
}

.fa-4x {
  font-size: 4em;
}

.fa-5x {
  font-size: 5em;
}

.fa-6x {
  font-size: 6em;
}

.fa-7x {
  font-size: 7em;
}

.fa-8x {
  font-size: 8em;
}

.fa-9x {
  font-size: 9em;
}

.fa-10x {
  font-size: 10em;
}

.fa-fw {
  text-align: center;
  width: 1.25em;
}

.fa-ul {
  list-style-type: none;
  margin-left: 2.5em;
  padding-left: 0;
}
.fa-ul > li {
  position: relative;
}

.fa-li {
  left: -2em;
  position: absolute;
  text-align: center;
  width: 2em;
  line-height: inherit;
}

.fa-border {
  border: solid 0.08em #eee;
  border-radius: 0.1em;
  padding: 0.2em 0.25em 0.15em;
}

.fa-pull-left {
  float: left;
}

.fa-pull-right {
  float: right;
}

.fa.fa-pull-left,
.fas.fa-pull-left,
.far.fa-pull-left,
.fal.fa-pull-left,
.fab.fa-pull-left {
  margin-right: 0.3em;
}
.fa.fa-pull-right,
.fas.fa-pull-right,
.far.fa-pull-right,
.fal.fa-pull-right,
.fab.fa-pull-right {
  margin-left: 0.3em;
}

.fa-spin {
  -webkit-animation: fa-spin 2s infinite linear;
          animation: fa-spin 2s infinite linear;
}

.fa-pulse {
  -webkit-animation: fa-spin 1s infinite steps(8);
          animation: fa-spin 1s infinite steps(8);
}

@-webkit-keyframes fa-spin {
  0% {
    -webkit-transform: rotate(0deg);
            transform: rotate(0deg);
  }
  100% {
    -webkit-transform: rotate(360deg);
            transform: rotate(360deg);
  }
}

@keyframes fa-spin {
  0% {
    -webkit-transform: rotate(0deg);
            transform: rotate(0deg);
  }
  100% {
    -webkit-transform: rotate(360deg);
            transform: rotate(360deg);
  }
}
.fa-rotate-90 {
  -ms-filter: "progid:DXImageTransform.Microsoft.BasicImage(rotation=1)";
  -webkit-transform: rotate(90deg);
          transform: rotate(90deg);
}

.fa-rotate-180 {
  -ms-filter: "progid:DXImageTransform.Microsoft.BasicImage(rotation=2)";
  -webkit-transform: rotate(180deg);
          transform: rotate(180deg);
}

.fa-rotate-270 {
  -ms-filter: "progid:DXImageTransform.Microsoft.BasicImage(rotation=3)";
  -webkit-transform: rotate(270deg);
          transform: rotate(270deg);
}

.fa-flip-horizontal {
  -ms-filter: "progid:DXImageTransform.Microsoft.BasicImage(rotation=0, mirror=1)";
  -webkit-transform: scale(-1, 1);
          transform: scale(-1, 1);
}

.fa-flip-vertical {
  -ms-filter: "progid:DXImageTransform.Microsoft.BasicImage(rotation=2, mirror=1)";
  -webkit-transform: scale(1, -1);
          transform: scale(1, -1);
}

.fa-flip-both, .fa-flip-horizontal.fa-flip-vertical {
  -ms-filter: "progid:DXImageTransform.Microsoft.BasicImage(rotation=2, mirror=1)";
  -webkit-transform: scale(-1, -1);
          transform: scale(-1, -1);
}

:root .fa-rotate-90,
:root .fa-rotate-180,
:root .fa-rotate-270,
:root .fa-flip-horizontal,
:root .fa-flip-vertical,
:root .fa-flip-both {
  -webkit-filter: none;
          filter: none;
}

.fa-stack {
  display: inline-block;
  height: 2em;
  position: relative;
  width: 2.5em;
}

.fa-stack-1x,
.fa-stack-2x {
  bottom: 0;
  left: 0;
  margin: auto;
  position: absolute;
  right: 0;
  top: 0;
}

.svg-inline--fa.fa-stack-1x {
  height: 1em;
  width: 1.25em;
}
.svg-inline--fa.fa-stack-2x {
  height: 2em;
  width: 2.5em;
}

.fa-inverse {
  color: #fff;
}

.sr-only {
  border: 0;
  clip: rect(0, 0, 0, 0);
  height: 1px;
  margin: -1px;
  overflow: hidden;
  padding: 0;
  position: absolute;
  width: 1px;
}

.sr-only-focusable:active, .sr-only-focusable:focus {
  clip: auto;
  height: auto;
  margin: 0;
  overflow: visible;
  position: static;
  width: auto;
}

.svg-inline--fa .fa-primary {
  fill: var(--fa-primary-color, currentColor);
  opacity: 1;
  opacity: var(--fa-primary-opacity, 1);
}

.svg-inline--fa .fa-secondary {
  fill: var(--fa-secondary-color, currentColor);
  opacity: 0.4;
  opacity: var(--fa-secondary-opacity, 0.4);
}

.svg-inline--fa.fa-swap-opacity .fa-primary {
  opacity: 0.4;
  opacity: var(--fa-secondary-opacity, 0.4);
}

.svg-inline--fa.fa-swap-opacity .fa-secondary {
  opacity: 1;
  opacity: var(--fa-primary-opacity, 1);
}

.svg-inline--fa mask .fa-primary,
.svg-inline--fa mask .fa-secondary {
  fill: black;
}

.fad.fa-inverse {
  color: #fff;
}</style><style type="text/css">@charset "UTF-8";[ng\:cloak],[ng-cloak],[data-ng-cloak],[x-ng-cloak],.ng-cloak,.x-ng-cloak,.ng-hide{display:none !important;}ng\:form{display:block;}.ng-animate-block-transitions{transition:0s all!important;-webkit-transition:0s all!important;}.ng-hide-add-active,.ng-hide-remove{display:block!important;}</style>


<title>
	Track Shipment
</title><meta id="MetaKeywords" name="KEYWORDS" content=",DotNetNuke,DNN"><meta id="MetaGenerator" name="GENERATOR" content="DotNetNuke "><meta id="MetaRobots" name="ROBOTS" content="INDEX, FOLLOW"><link href="./css/default.css" type="text/css" rel="stylesheet"><link href="./css/module.css" type="text/css" rel="stylesheet"><link href="./css/skin.css" type="text/css" rel="stylesheet"><script async="" src="./js/analytics.js"></script><script src="./js/jquery.js" type="text/javascript"></script><script src="./js/jquery-ui.js" type="text/javascript"></script><meta name="viewport" content="width=device-width,initial-scale=1"><link href="./css/enUS.css" type="text/css" rel="stylesheet"></head>
<body id="Body">
    
<form method="post" action="#" id="Form" enctype="multipart/form-data">
<div class="aspNetHidden">
<input type="hidden" name="__EVENTTARGET" id="__EVENTTARGET" value="">
<input type="hidden" name="__EVENTARGUMENT" id="__EVENTARGUMENT" value="">
<input type="hidden" name="__VIEWSTATE" id="__VIEWSTATE" value="jMC8ux023nuhFgnNppIZhkdPhxfEi9/MhjULCPSUnnrpS2gm71pQuD5/Nl4MIyMlCsIBK0hCw5pqv9I0ai8DLIm/6HVkP3wsfhzP3FDxXUZdwNoju+PHuO1iJfAgKnWdYQPJDxTaiEBY1hf65gU70feVcxDFs4n0Ses+Xb+l9sIUlQSWCP2PU8BB1iA=">
</div>

<script type="text/javascript">
//<![CDATA[
var theForm = document.forms['Form'];
if (!theForm) {
    theForm = document.Form;
}
function __doPostBack(eventTarget, eventArgument) {
    if (!theForm.onsubmit || (theForm.onsubmit() != false)) {
        theForm.__EVENTTARGET.value = eventTarget;
        theForm.__EVENTARGUMENT.value = eventArgument;
        theForm.submit();
    }
}
//]]>
</script>

<div class="aspNetHidden">

	<input type="hidden" name="__VIEWSTATEGENERATOR" id="__VIEWSTATEGENERATOR" value="CA0B0334">
	<input type="hidden" name="__VIEWSTATEENCRYPTED" id="__VIEWSTATEENCRYPTED" value="">
	<input type="hidden" name="__PREVIOUSPAGE" id="__PREVIOUSPAGE" value="KNiZiHexPoVKOx2L-TZK6V1x7ZVDguk0-5FDsXrGBw3h5VgFljksJKLVrGo1">
	<input type="hidden" name="__EVENTVALIDATION" id="__EVENTVALIDATION" value="LJWSAruka68AjsB9WIPa6ylTrFEN9VyVFMgAnSPKo6znrlLMCEeX1yHE7LHrFe+dVmqkU7kMfeAOM5NOkCX+xXQtMK3PaLe9kst/B27Mzx18XUJEKBQg9zvQ/qSMAC/XmnBIoeZ9A7/ujpiXn4iijJM9oxLAoO7vm07+cN2UxUqfvOJeb6MLBvrDsjwYf+uxyOFz9W+7eRxl3h6mdzxl6Zw4z/RmQ1C3J0qu2zgSFZRbAr7WNlfdqkpbcWOMx8nQ3WNDEahNJWTO4IeDRgzeFV6Swoo=">
</div><script src="./js/dnn.modalpopup.js" type="text/javascript"></script><script src="./js/dnncore.js" type="text/javascript"></script>

<!--
<script src="./Track_Shipment_files/WebResource.axd" type="text/javascript"></script>
<script src="./Track_Shipment_files/ScriptResource.axd" type="text/javascript"></script>
<script src="./Track_Shipment_files/ScriptResource(1).axd" type="text/javascript"></script>
<script type="text/javascript">
//<![CDATA[
Sys.WebForms.PageRequestManager._initialize('ScriptManager', 'Form', [], [], [], 90, '');
//]]>
</script>-->

        
        
        

<link href="./css/app.menu.css" rel="stylesheet">
<!-- Google Analytics -->
<script src="./js/ga.js"></script>

<!-- JavaScript -->
<script src="./js/skin.js"></script>
<script src="./js/bootstrap.min.js"></script>
<script src="./js/bootstrap-toggle.min.js"></script>
<script src="./js/modernizr.js"></script>
<script src="./js/main.js"></script>
<script src="./js/angular_1.2.20_angular.min.js"></script>
<script src="./js/bootstrap-tagsinput.min.js"></script>
<script src="./js/bootstrap-tagsinput-angular.min.js"></script>
<script src="./js/bootstrap-select.min.js"></script>
<script src="./js/typeahead.bundle.js"></script>
<script src="./js/bootstrap-datepicker_1.9.0.js"></script>
<script src="./js/lodash.min_4.17.15.js"></script>
<script src="./js/i18next.min.js"></script>
<script src="./js/i18nextXHRBackend.min.js"></script>
<script src="./js/old_version_browser.js"></script>
<script src="./js/jquery-i18next.min.js"></script>
<script src="./js/jquery.bind-first-0.2.3.min.js"></script>
<script src="./js/jquery.signalR-2.2.1.min.js"></script>
<script src="./js/hubs.js"></script>

<!-- Styles -->
<link href="./css/bootstrap.min.css" rel="stylesheet">
<link href="./css/bootstrap-toggle.min.css" rel="stylesheet">
<link href="./css/jquery-ui.css" rel="stylesheet">
<link href="./css/toggle-switch.css" rel="stylesheet">
<link href="./css/bootstrap-select.min_1.12.4.css" rel="stylesheet">
<link href="./css/bootstrap-datepicker_1.9.0.css" rel="stylesheet">
<link href="./css/bootstrap-tagsinput.css" rel="stylesheet">
<link href="./css/typeaheadjs.css" rel="stylesheet">
<link href="./css/style.css" rel="stylesheet">
<link href="./css/skin.css" rel="stylesheet">
	
<!-- IE8 -->
<!--[if lt IE 9]>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->

<script>
var _currentCulture = 'en-US';

if (document.location.href.indexOf("/0/OldBrowser") == -1) {
var browser = BrowserDetect.browser ? BrowserDetect.browser.name : undefined;
var version = BrowserDetect.browser ? BrowserDetect.browser.value : undefined;

	if (browser && browser.toUpperCase() == "MSIE" && parseInt(version.substring(0,version.indexOf("."))) <= 10) {
		document.location.href = "/0/OldBrowser";
	}

	
}

<!-- i18n -->
jqueryI18next.init(i18next, $, {
	tName: 't',
	i18nName: 'i18n',
	handleName: 'localize',
	selectorAttr: 'data-i18n',
	targetAttr: 'i18n-target',
	optionsAttr: 'i18n-options',
	useOptionsAttr: false,
	parseDefaultValueFromContent: true
});

i18next.use(window.i18nextXHRBackend).init({
	fallbackLng: 'en-US',
	lng: _currentCulture,
	backend: {
	  loadPath: './locales/{{ns}}_{{lng}}.json',
	  addPath: './locales/add/{{ns}}_{{lng}}.json', // unused
	  allowMultiLoading: false
    }
}, function(err, t) {
	$("html").localize();
});

$(function() {
	i18nInitCore("20191219");
});

</script>

<!-- Error Message Template -->
<script id="error_main_template" type="text/x-template">
    <div class="error-box">
        <p class="error-message">$ERR_MESSAGE$</p>
        <div class="errorTable">
            <div class="errorTableBody">
                $ERR_ITEMS$
            </div>
        </div>
    </div>
</script>
<script id="error_item_template" type="text/x-template">
    <div class="errorTableRow">
        <div class="errorTableCell">$ERR_TITLE$</div>
        <div class="errorTableCell"><span class="awb">$ERR_DESCRIPTION$</span></div>
    </div>
</script>

<div class="d-off-canvas-wrapper d-example general_nav">
	<div class="general_nav_inner" style="overflow: hidden;">	
			<div class="flex-box-container">
				<!-- Menu -->
				<div id="app" class="wrap"><div data-v-6b6bd2ad="" class="wrap" style=""><div data-v-6b6bd2ad="" id="mobile_logo" title="EzyCargo" class="header-wrapper__logo logo"></div><div data-v-6b6bd2ad="" id="logo" class="logo-container"><a data-v-6b6bd2ad="" class="closebtn" style="display: none;"><svg data-v-6b6bd2ad="" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="times" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 352 512" class="svg-inline--fa fa-times fa-w-11 fa-1x"><path data-v-6b6bd2ad="" fill="currentColor" d="M242.72 256l100.07-100.07c12.28-12.28 12.28-32.19 0-44.48l-22.24-22.24c-12.28-12.28-32.19-12.28-44.48 0L176 189.28 75.93 89.21c-12.28-12.28-32.19-12.28-44.48 0L9.21 111.45c-12.28 12.28-12.28 32.19 0 44.48L109.28 256 9.21 356.07c-12.28 12.28-12.28 32.19 0 44.48l22.24 22.24c12.28 12.28 32.2 12.28 44.48 0L176 322.72l100.07 100.07c12.28 12.28 32.2 12.28 44.48 0l22.24-22.24c12.28-12.28 12.28-32.19 0-44.48L242.72 256z" class=""></path></svg></a></div><div data-v-6b6bd2ad="" id="hamburger"><span data-v-6b6bd2ad=""></span><span data-v-6b6bd2ad=""></span><span data-v-6b6bd2ad=""></span></div><div data-v-6b6bd2ad="" id="myNav"><nav data-v-496691e8="" data-v-6b6bd2ad="" id="menu" class="overlay-content" style="height: 10px;"><div data-v-496691e8="" id="nav_menu"><div data-v-496691e8="" class="menu-header-container"><a data-v-496691e8="" href="#" title="Ezycargo_UAT" oncontextmenu="return false;" class="header-wrapper__logo logo" style="width: 100px; height: 40px;"></a>
				
				<a data-v-496691e8="" href="./index.html" id="menudashboardlink" title="Dash board" oncontextmenu="return false;" class="menudashboardlink"><div data-v-496691e8="" class="menudashboard"> Dashboard </div></a>
				
				<a data-v-496691e8="" href="./booking.html" style="text-decoration: none" id="menulink" oncontextmenu="return false;" class="menulink"><p data-v-496691e8="" id="dropdownHeader_0" class="mainMenu"> Booking </p></a>
				
				<a data-v-496691e8="" href="./trackshipment.html" style="text-decoration: none" id="menulink" oncontextmenu="return false;" class="menulink"><p data-v-496691e8="" id="dropdownHeader_1" class="mainMenu"> Track Shipment </p></a>
				
				<!----></div></div><form data-v-496691e8="" id="form1" method="post" action="#"><input data-v-496691e8="" type="hidden" id="CompanyID" name="CompanyID" value=""><br data-v-496691e8=""><input data-v-496691e8="" type="hidden" id="UserID" name="UserID" value=""><br data-v-496691e8=""><br data-v-496691e8=""><input data-v-496691e8="" type="hidden" id="SessionID" name="SessionID" value=""><br data-v-496691e8=""><input data-v-496691e8="" type="hidden" id="CompanyPIMA" name="CompanyPIMA" value=""><br data-v-496691e8=""><br data-v-496691e8=""><input data-v-496691e8="" type="hidden" id="COSACID" name="COSACID" value=""><br data-v-496691e8=""><input data-v-496691e8="" type="hidden" id="CompanyName" name="CompanyName" value=""><br data-v-496691e8=""><br data-v-496691e8=""><input data-v-496691e8="" type="hidden" id="TargetURL" name="TargetURL" value=""><br data-v-496691e8=""><br data-v-496691e8=""><input data-v-496691e8="" type="hidden" id="Lang" name="Lang" value=""><br data-v-496691e8=""><br data-v-496691e8=""><input data-v-496691e8="" type="hidden" id="ApiToken" name="ApiToken" value=""><br data-v-496691e8=""><br data-v-496691e8=""><input data-v-496691e8="" type="hidden" id="RefreshToken" name="RefreshToken" value=""><br data-v-496691e8=""><br data-v-496691e8=""><input data-v-496691e8="" type="hidden" id="ApiTokenExpiryTime" name="ApiTokenExpiryTime" value=""><br data-v-496691e8=""><br data-v-496691e8=""></form></nav></div></div></div>
				

<div class="navbar-form navbar-right">
    <div id="profile_blk" class="profile_blk">
	    <div class="notify">
		    <div class="notify_switch disabled" data-toggle="dropdown" id="dropdownMenu1"></div>
            <div id="profile_alert_cnt" class="disabled"><span>0</span></div>
		    <div aria-labelledby="dropdownMenu1" class="panel_news">			
		    </div>
	    </div>
        <span class="divider_v disabled"></span>
	    <div class="profile_txtblk">
		    <div aria-expanded="false" class="profile_switch" data-toggle="dropdown" id="dropdownMenu9">
			    <div class="profile_co">
				    <span id="profile_companyid">Test Account</span>
			    </div>
			    <div class="profile_user">
				    <span id="profile_username">Test User</span>
			    </div>
		    </div>
		    <div aria-labelledby="dropdownMenu9" class="profile_panel">
				<a id="dnn_GLS_PROFILE_lnkLogout" data-i18n="common.Logout" href="#">Logout</a>
				
				
		    </div>
		    <div class="profile_close"></div>
	    </div>
    </div>
</div>
<script>
    setTimeout(function () {
	    $("html").addClass("logged");
    }, 1000);
</script>			
			</div>
	</div>
</div>


<!-- Page Content -->
<div class="pageContent">
<main role="main">
<div id="dnn_ContentPane" class="contentPane">
<div class="DnnModule DnnModule-TrackAndTrace DnnModule-385"><a name="385"></a>
<div class="DNNContainer_noTitle logged js flexbox flexboxlegacy canvas canvastext webgl no-touch geolocation postmessage websqldatabase indexeddb hashchange history draganddrop websockets rgba hsla multiplebgs backgroundsize borderimage borderradius boxshadow textshadow opacity cssanimations csscolumns cssgradients cssreflections csstransforms csstransforms3d csstransitions fontface generatedcontent video audio localstorage sessionstorage webworkers applicationcache svg inlinesvg smil svgclippaths">
<div id="dnn_ctr385_ContentPane"><!-- Start_Module_385 -->
<div id="dnn_ctr385_ModuleContent" class="DNNModuleContent ModTrackAndTraceC">
<script src="./js/bookingdetail/bluebird-3.3.5.min.js"></script>

<script src="./js/bookingdetail/ConfigManager.js"></script>
<script src="./js/bookingdetail/InjectionManager.js"></script>
<link rel="stylesheet" href="./css/bookingdetail/all.css">

<script>
    function loadMainScript() {
        return Promise.all([
            InjectionManager.injectScripts(['formatCheck.js', 'format.js', 'constant.js', 'template_record.js']),
            InjectionManager.injectService(['AjaxRequest.js']),
            InjectionManager.injectService(['APIHandler.js'])
        ]);
    }
</script>

<script>
    var bookingHub = $.connection.bookingHub;
    var timeoutValue = 10000; //30000;
    var timeoutHandle = -1;
    var callback = null;

    var multiBookingSubmitCnt = 0;
    var multiBookingReceiveCnt = 0;
    var multiBookingAWBWaitingReply = [];

    var currentTabID = "49";
    var decimalRoundTo = 2;
    var decimalWeightRoundTo = 1;
	var decimalTemperatureRoundTo = 1;
    var decimalVolumeRoundToCX = 3;
    var defaultAddressBookCount = 50;
    var defaultChooseTemplateCount = 20;
    var defaultToolsBoxChooseTemplateCount = 30;
    var maxMultiAWB = 12;
    var intVad = /^\+?(0|[1-9]\d*)$/;
    var decVad = /^([1-9]\d*|0\.\d*[0-9]|[0-9]\d*\.\d*[0-9]|0)$/;
    var decVadWithNeg = /^-?([1-9]\d*|0\.\d*[1-9]|[1-9]\d*\.\d*[0-9]|0)$/;
    var lbToKgConstant = 0.453592;
	
	//20210730 For retrieving booking log data
	var wayToRetrieveBookingLog = 1;
	var RetrieveBookingHistoryAPIURL = "";

    //20201207 For switch the way of retrieveing booking data
    var wayToRetrieve = 1; // 0 = bookinghub , 1 = booking API
    var RetrieveAPIURL = "";

    //20210208 For switch the way of submit booking data
    var wayToSubmit = 1; // 0 = bookinghub , 1 = booking API
    var SubmitAPIURL = "";

    var BookingAPIURL = "";

    String.prototype.replaceAll = function (search, replacement) {
        var target = this;
        return target.replace(new RegExp(search, 'g'), replacement);
    };

    Date.prototype.addDays = function (days) {
        var date = new Date(this.valueOf());
        date.setDate(date.getDate() + days);
        return date;
    }

    Date.prototype.dateDiff = function (interval, objDate) {
        var dtEnd = new Date(objDate);
        if (isNaN(dtEnd))
            return undefined;
        switch (interval) {
            case "s": return parseInt(Math.ceil((dtEnd - this) / 1000));
            case "n": return parseInt(Math.ceil((dtEnd - this) / 60000));
            case "h": return parseInt(Math.ceil((dtEnd - this) / 3600000));
            case "d": return parseInt(Math.ceil((dtEnd - this) / 86400000));
            case "w": return parseInt(Math.ceil((dtEnd - this) / (86400000 * 7)));
            case "m": return (dtEnd.getMonth() + 1) + ((dtEnd.getFullYear() - this.getFullYear()) * 12) - (this.getMonth() + 1);
            case "y": return dtEnd.getFullYear() - this.getFullYear();
        }
    }

    const AfterTemplateChange = {
        NoAction: 0,
        QuickAWBSearch: 1,
        FillTemplateData: 2,
        SetBookingData: 3,
        PasteFlightDetailData: 4
    };

    function isInt(value) {
        return !isNaN(value) && (function (x) { return (x | 0) === x; })(parseFloat(value))
    }

    function isJsonParsable(str) {
        try {
            JSON.parse(str);
        } catch (e) {
            return false;
        }
        return true;
    }

    //Airline setting
    //var airlineList = ["CX", "JL", "KA", "AA", "AF", "EY", "KE", "KK", "KL", "LD", "LH" ,"LX", "NH", "SA", "SK", "SQ", "SV", "UA"];
    var airlineList = [];
    var multiAirlineIgnoreList = ["SQ", "LH"];

    //CX Warehouse code
    var warehouseCX = ["", "BF", "CA", "CE", "CG", "CH", "CR", "CV", "CW", "CX", "DF"];
    var warehouseCXDesc = ["",
        "BF - Kaohsiung Air Cargo Terminal",
        "CA - Taiwan Air Cargo Terminal Ltd. - Export",
        "CE - Taiwan Air Cargo Terminal Ltd. - Express",
        "CG - Evergreen Air Cargo Services. Corp. - Export",
        "CH - Ever Terminal Co., Ltd. - Export",
        "CR - Evergreen Air Cargo Sevrices. Corp. - Express",
        "CV - Ever Terminal Co., Ltd. - Express",
        "CW - Far Glory Air Cargo Terminal Co., Ltd. - Export",
        "CX - Far Glory Air Cargo Terminal Co., Ltd. - Express",
        "DF - DF"
    ];

    //CX priority
    var cxPriority = [];
    var priObj = new Object();
    priObj.Value = "PR3";
    priObj.Text = "General LIFT";
    cxPriority.push(priObj);
    priObj = new Object();
    priObj.Value = "PR2";
    priObj.Text = "General LIFT Plus";
    cxPriority.push(priObj);
    priObj = new Object();
    priObj.Value = "PR1";
    priObj.Text = "Priority LIFT";
    cxPriority.push(priObj);
    priObj = new Object();
    priObj.Value = "PR4";
    priObj.Text = "Flexi LIFT";
    cxPriority.push(priObj);
    localStorage.setItem("CXPriorityType", JSON.stringify(cxPriority));

    //SQ
    const sqProductValue = {
        Empty: 0,
        SwiftRider: 1,
        ValueAddCool: 2,
    };
    var uldListSQ = ["", "AAF", "AAP", "AAU", "AKE", "AMA", "AMD", "AVE", "BUK", "CTR", "HMA", "KMA", "LDP", "MA1", "MA2", "MDB", "MDT", "MQ6", "MQ7", "PGA", "PLB", "PZA", "RAP", "RKN"];

    //BA
    /*
    var uldUnitListBA = ["", "AAF", "AAP", "AAU", "AKE", "ALF", "ALP", "ALU", "PAG", "PGA", "PLA", "PMC", "PMP", "PZA"];
    var uldContourListBA = ["", "A2", "H2", "H3", "W2", "Q6", "Q7", "ZA"];
    var arrBAULDUnit1 = ["PAG", "PMP", "PLA"];
    var arrBAULDUnit2 = ["PGA", "PZA"];
    var arrBAULDUnit3 = ["PMC"];
    var arrBAULDContour1 = ["", "A2", "H2", "H3", "W2"];	        //PAG, PMP, PLA
    var arrBAULDContour2 = ["", "Q6", "Q7"];						//PGA, PZA
    var arrBAULDContour3 = ["", "Q6", "Q7", "ZA"];				//PMC

    function getBAULDVol(str) {
        var tmpVol;
        if (str == 'PAG' || str == 'PMP' || str == 'AAP' || str == 'AAF' || str == 'AAU')
            tmpVol = 11.0;
        else if (str == 'PLA' || str == 'ALP' || str == 'ALF' || str == 'ALU')
            tmpVol = 7.0;
        else if (str == 'PGA' || str == 'PZA')
            tmpVol = 34.0;
        else if (str == 'PMC')
            tmpVol = 17.0;
        else if (str == 'AKE')
            tmpVol = 4.0;
        else
            tmpVol = 0.0;
        return tmpVol;
    }
    */

    //JL
    var uldListJL = ["", "M", "L", "C"];
    var uldListJLDesc = ["", "Main", "Lower", "LD3"];
    var prdListJL = ["", "JCA", "JCL", "JPR", "JSP", "JWH"];
    var prdListJLDesc = ["", "J-Care", "J-Cool", "J-Priority", "J-Speed", "J-Wheel"];

    function connectHub(doneFunction) {
        /*
        if ($.connection.hub.state != 4) {
            console.log("SignalR - Cancel Previous Action");
            $.connection.hub.stop();
        }


        if (timeoutHandle != -1) {
            clearInterval(timeoutHandle);
            timeoutHandle = -1;
        }
        */
        clearInterval(timeoutHandle);

        if ($.connection.hub.state != $.signalR.connectionState.connected) {
            $.connection.hub.start().done(doneFunction);
        } else {
            doneFunction();
        }

        return true;
    }

    function disconnectHub() {
        $.connection.hub.stop();
        return true;
    }

    function startAction(fullLoading, message, disableInput) {
        if (fullLoading) {
            ToggleLoading(true);
        }
        else {
            TogglePartialLoading(true, message, disableInput);
        }

        if (typeof disableCargoInfoAWBInput === 'function') {
            disableCargoInfoAWBInput();
        }

        startTimeout();
    }

    function stopAction() {
        if (timeoutHandle != -1) {
            clearTimeout(timeoutHandle);
            timeoutHandle = -1;
        }

        //disconnectHub();

        if (callback) {
            callback();
            callback = null;
        }

        if (typeof enableCargoInfoAWBInput === 'function') {
            enableCargoInfoAWBInput();
        }
        console.timeEnd("submitForm");
        ToggleLoading(false);
    }

    function startTimeout() {
        timeoutHandle = setTimeout(function () {
            bkdTimeout();
        }, timeoutValue);
    }

    function getData(moduleID, dataID) {
        var o = $("#" + moduleID)[0];
        if (o && $(o, 'events') && $._data(o, 'events').getData != null)
            return $(o).triggerHandler("getData", dataID);
        else
            return null;
    }

    function setData(moduleID, dataID, value) {
        var o = $("#" + moduleID)[0];
        if (o && $(o, 'events') && $._data(o, 'events').setData != null) {
            var extraPara = [];
            extraPara.push(dataID);
            extraPara.push(value);
            $(o).triggerHandler("setData", extraPara);
        }
    }

    bookingHub.client.ack = function (functionID) {
        console.log("Ack: " + functionID);
    }

    bookingHub.client.completed = function (functionID) {
        console.log("Completed: " + functionID);
        stopAction();
    }

    bookingHub.client.error = function (msg) {
        console.log("Error Message - " + msg);
        alert(msg);
        stopAction();
    }

    bookingHub.client.sessionTimeout = function (redirectTo) {
        console.log("Session Timeout");
        var redirect = function () {
            window.location.replace(redirectTo);
        }
        stopAction();
        DialogManager.alert(i18next.t('common.System'), i18next.t('common.SessionTimeout'), redirect, { backdrop: false });
    }

    function bkdTimeout() {
        debugger;
        bookingHub.client.error("Timeout");
        timeoutHandle = -1;
    }

    var linkBkdLanding = "";
    var linkBkdSingleAwb = "";
    var linkBkdMultiAwb = "";
    var linkBkdMultiAirline = "";
    var linkBkdBookingLog = "";
    var linkBkdDetail = "";
    var linkBkdSpreadsheet = "";

    var bkdQSSingle = "?Airline=$AIRLINE$&AWBPrefix=$AWBPREFIX$&AWBSuffix=$AWBSUFFIX$";
    var bkdQSBookingLogSearch = "?Orig=$ORIG$&Dest=$DEST$&DateRange=$DATERANGE$&DateType=$DATETYPE$&UserID=$USERID$";

    $(document).ready(function () {
        $(".btn-select").each(function (e) {
            var value = $(this).find("ul li.selected").html();
            if (value != undefined) {
                $(this).find(".btn-select-input").val(value);
                $(this).find(".btn-select-value").html(value);
            }
        });
    });

    $(document).on('click', '.btn-select', function (e) {
        e.preventDefault();
        var ul = $(this).find("ul");
        if ($(this).hasClass("active")) {
            if (ul.find("li").is(e.target)) {
                var target = $(e.target);
                target.addClass("selected").siblings().removeClass("selected");
                var value = target.data("val");
                var text = target.html();
                $(this).find(".btn-select-input").val(value).trigger('change');
                $(this).find(".btn-select-value").html(text);
            }
            ul.hide();
            $(this).removeClass("active");
        }
        else {
            $('.btn-select').not(this).each(function () {
                $(this).removeClass("active").find("ul").hide();
            });
            ul.slideDown(300);
            $(this).addClass("active");
        }
    });

    $(document).on('click', function (e) {
        var target = $(e.target).closest(".btn-select");
        if (!target.length) {
            $(".btn-select").removeClass("active").find("ul").hide();
        }
    });

    function bkdAWBPrefixToAirline(awbPrefix) {
        switch (awbPrefix) {
            case "001":
                return "AA";
            case "016":
                return "UA";
            case "020":
                return "LH";
            case "043":
                return "KA";
            case "057":
                return "AF";
            case "065":
                return "SV";
            case "074":
                return "KL";			
            case "083":
                return "SA";
            case "117":
                return "SK";
            case "125":
                return "BA";
            case "128":
                return "UO";
            case "131":
                return "JL";
            case "144":
                return "7T";
            case "155":
                return "ES";
            case "160":
                return "CX";
            case "180":
                return "KE";
            case "189":
                return "JX";
            case "205":
                return "NH";
            case "278":
                return "3S";
            case "288":
                return "LD";
            case "607":
                return "EY";
            case "610":
                return "KK";
            case "615":
                return "QY";
            case "618":
                return "SQ";
            case "724":
                return "LX"
            case "810":
                return "M6";
            case "936":
                return "D0";
            case "946":
                return "V4";
            case "947":
                return "L3";
            case "992":
                return "D5";
            case "580":
                return "RU";
			// ad-hoc on JL, 16082021
			case "047":
				return "TP";
			case "064":
				return "OK";
			case "183":
				return "LC";
			case "230":
				return "CM";
			case "289":
				return "OM";
			case "355":
				return "E7";
			case "577":
				return "AD";
			case "657":
				return "BT";
			case "873":
				return "6R";
			case "996":
				return "UX";
			case "077":
				return "MS";
			case "805":
				return "4X";
			case "643":
				return "KM";
			case "244":
				return "TN";
			// ad-hoc on JL end
			// ad-hoc on JL, 18082021
			case "656":
				return "PX";
			case "575":
				return "7C";
			case "114":
				return "LY";
			case "202":
				return "TA";
			case "319":
				return "8D";
			// ad-hoc on JL end
            default:
                if (sessionStorage.getItem("OtherBookingPrefixPflList")) {
                    var otherBookingPrefixPflList = JSON.parse(sessionStorage.getItem("OtherBookingPrefixPflList"));
                    var convertPrefix = _.find(otherBookingPrefixPflList, function (o) { return o.AllowedPrefix == awbPrefix; })

                    if (convertPrefix) {
                        return bkdAWBPrefixToAirline(convertPrefix.AirlinePrefix)
                    }
                }
                return "";
        }
    }

    function bkdAirlineDefaultAWBPrefix(airline) {
        switch (airline) {
            case "AA":
                return "001";
            case "UA":
                return "016";
            case "LH":
                return "020";
            case "KA":
                return "043";
            case "AF":
                return "057";
            case "SV":
                return "065";
            case "KL":
                return "074";
            case "SA":
                return "083";
            case "SK":
                return "117";
            case "BA":
                return "125";
            case "UO":
                return "128";
            case "JL":
                return "131"
            case "7T":
                return "144"
            case "ES":
                return "155"
            case "CX":
                return "160";
            case "KE":
                return "180";
            case "JX":
                return "189";
            case "NH":
                return "205";
            case "3S":
                return "278"
            case "LD":
                return "288";
            case "EY":
                return "607";
            case "KK":
                return "610";
            case "QY":
                return "615"
            case "SQ":
                return "618";
            case "LX":
                return "724";
            //case "M6":
            //    return "810";
            case "D0":
                return "936"
            case "V4":
                return "946"
            case "L3":
                return "947"
            case "D5":
                return "992"
            default:
                return "";
        }
    }

    function bkdCheckAirlineCodeAndPrefix(code, prefix) {
        if (!code || !code.trim())
            return true;

        if (sessionStorage.getItem("OtherBookingPrefixPflList")) {
            if (code.toUpperCase() == bkdAWBPrefixToAirline(prefix)) {
                return true;
            }
            else {
                var otherBookingPrefixPflList = JSON.parse(sessionStorage.getItem("OtherBookingPrefixPflList"));
                var inputAirlinePrefix = bkdAirlineDefaultAWBPrefix(code.toUpperCase());

                if (_.find(otherBookingPrefixPflList, function (o) {
                    return o.AirlinePrefix == inputAirlinePrefix && o.AllowedPrefix == prefix;
                }))
                    return true
                else
                    return false;
            }
        }
        else {
            return true;
        }
    }

    function bkdConvertAirlineToMaster(airline) {
        airline = airline.toUpperCase();
        switch (airline) {
            case "AA":
            case "AF":
            case "EY":
            case "KE":
            case "KK":
            case "NH":
            case "SA":
            case "SK":
            case "SV":
            case "UA":
            case "JX":
            case "7T":
            case "ES":
            case "3S":
            case "QY":
            case "D0":
            case "V4":
            case "L3":
            case "D5":
            case "M6":
                return "AA";
            case "CX":
            case "KA":
            case "LD":
            case "UO":
                return "CX";
            case "JL":
                return "JL";
            case "KL":
                return "KL";
            case "LH":
                return "LH";
            case "LX":
                return "LX";
            case "SQ":
                return "SQ";
        }
    }

    function bkdStatusToGeneralType(status) {
        switch (status) {
            case 0:
            case 1:
                return "Draft";
            case 2:
            case 15:
                return "Pending";
            case 3:
            case 5:
            case 6:
            case 7:
            case 8:
            case 9:
            case 13:
                return "Replied";
            case 4:
            case 11:
            case 13:
            case 10:
            case 12:
            case 14:
            case 99:
            default:
                return "Error";
        }
    }

    function bkdStatusToText(status) {
        statusText = "";
        isError = false;

        switch (status) {
            case 0:
                statusText = "New";
                break;
            case 1:
                statusText = "Saved";
                break;
            case 2:
                statusText = "Submitted";
                break;
            case 3:
                statusText = "Acknowledged";
                break;
            case 4:
            case 11:
                statusText = "Flight Not Exists";
                isError = true;
                break;
            case 5:
                statusText = "Confirmed";
                break;
            case 6:
                statusText = "Partially Confirmed";
                break;
            case 7:
                statusText = "Partially Confirmed";
                break;
            case 8:
                statusText = "Partially Confirmed Split";
                break;
            case 9:
            case 13:
                statusText = "Cancelled";
                break;
            case 10:
                statusText = "Rejected";
                isError = true;
                break;
            case 12:
                statusText = "Waiting List";
                isError = true;
                break;
            case 14:
                statusText = "Holding";
                isError = true;
                break;
            case 15:
                statusText = "Awaiting Reply";
                break;
            case 16:
                statusText = "Saved";
                break;
            case 99:
            default:
                statusText = "Error";
                isError = true;
        }

        return {
            StatusText: statusText,
            Error: isError
        };
    }

    function selectSHCFromAutoComplete(event, ui) {
        console.log(ui.item.label);

        setTimeout(function () {
            $("#sc_special_code_focus").focus();
        }, 200);

        setTimeout(function () {
            $(".SHCodeAC input.form-control.autocomplete.ui-autocomplete-input").focus();
        }, 300);

    }

    function selectSHCFromAutoCompleteDG(event, ui) {
        console.log(ui.item.label);

        setTimeout(function () {
            $("#sc_special_code_dg_focus").focus();
        }, 200);

        setTimeout(function () {
            $(".SHCodeDG input.form-control.autocomplete.ui-autocomplete-input").focus();
        }, 300);

    }

    function checkSHCShowTemperatureInput(shc) {
        var shcList = [];
        var rtn = false;

        if (shc != "") {
            shcList = shc.split(",");
        }

        if (shcList.length > 0) {
            if (shcList.indexOf("ACT") > -1) {
                rtn = true;
            } else if (shcList.indexOf("PIL") > -1 && shcList.indexOf("COL") > -1) {
                rtn = true;
            } else if (shcList.indexOf("PIL") > -1 && shcList.indexOf("FRO") > -1) {
                rtn = true;
            } else if (shcList.indexOf("PIL") > -1 && shcList.indexOf("ICE") > -1) {
                rtn = true;
            }
        }

        return rtn;
    }

    function checkSHCPromptShipperConsigneeInput(shc) {
        var shcList = [];
        var rtn = false;

        if (shc != "") {
            shcList = shc.split(",");
        }

        if (shcList.length > 0) {
            if (shcList.indexOf("AVI") > -1 || shcList.indexOf("HUM") > -1 || shcList.indexOf("AVC") > -1 || shcList.indexOf("AVP") > -1 || shcList.indexOf("RRY") > -1) {
                rtn = true;
            }
        }

        return rtn;
    }

	function checkSHCPromptNGTTInput(shc)
    {
        var shcList = [];
        var rtn = false;

        if (shc != "") {
            shcList = shc.split(",");
        }

        if (shcList.length > 0) {
            if (shcList.indexOf(ngtt_shc) > -1) {
                rtn = true;

                var isexist = false;

                for (var i = 0; i < shcList.length; i++) {

                    $('#ngtt_product option').each(function () {

                        if (this.value == shcList[i])
                        {
                            $('#ngtt_product').val(this.value).change();
                            isexist = true;
                            return false;
                        }
                    });

                    if (isexist) {
                        break;
                    }

                }

            }
        }

        return rtn;
    }

    function bkdPortQueryLimitToChar() {
        $(".port_query").unbind("keypress").keypress(function (e) {
            console.log(e.which);
            if ((e.which >= 65 && e.which <= 90) || (e.which >= 97 && e.which <= 122)) {
            } else {
                return false;
            }
        });
    }

    // Key shipper
    function getAirlineKeyShipper(airline) {
        connectHub(function () {
            localStorage.removeItem("AirlineKeyShipper");
            bookingHub.server.getAirlineKeyShipper(airline);
        });
    }

    bookingHub.client.setAirlineKeyShipper = function (ksd) {
        console.log("setAirlineKeyShipper: " + ksd);
        localStorage.setItem("AirlineKeyShipper", ksd);
        if (typeof SetVirtualFlightKeyShipper == "function") {
            SetVirtualFlightKeyShipper();
        }
    }

    function getAirlineAdvBookDay(airline) {
        if (sessionStorage.getItem("AirlineAdvBookDay") != null) {
            var advDay = JSON.parse(sessionStorage.getItem("AirlineAdvBookDay"));
            var obj = advDay.filter(function (x) {
                return x.Airline == airline;
            });
            console.log(obj);

            if (typeof obj !== 'undefined' && obj != null) {
                if (obj.length > 0) {
                    return obj[0].AdvBookDay;
                }
            }
        }

        return 0;
    }

    function validateJPCity(strCity) {
        var strCityList = ["FUK", "NGO", "OKA", "OSA", "SPK", "TYO", "YOK"];
        if (strCity != "") {
            if (strCityList.indexOf(strCity) > -1) {
                return true;
            } else {
                return false;
            }
        }
        return false;
    }

    /*
    function CHF_String_IsFormat(strInputData, strDataType, strSyntax) {
        var isFormat = false;
        var strFormat, strFormatChar;
        var strChar;
        var strRepeat;
        var strMandatory;

        switch (strDataType) {
            case "C":
                //convert strSyntax statement to strFormat statement
                strFormat = ""
                for (var i = 1; i <= strSyntax.length; i++) {
                    if (strSyntax.substr(i, 1)) {
                        strChar = strSyntax.substr(i - 1, 1);
                        i = i + 1;
                        strRepeat = "";
                        while (isNumeric(strSyntax.substr(i, 1))) {
                            strRepeat = strRepeat + strSyntax.substr(i, 1);
                            i = i + 1;
                        }
                        i = i - 1;
                        strFormat = strFormat + String(parseInt(strRepeat) - 1, strChar)
                    } else {
                        strFormat = strFormat + strSyntax.substr(i, 1);
                    }
                }

                //check strInputData & strFormat length
                if (strInputData.length > strFormat.length) {
                    return false;
                }

                if (typeof strInputData !== 'undefined' && strInputData != null) {
                    if (strInputData.length == 0) {
                        //check if mandatory or not
                        if (strFormat != strFormat.toLowerCase()) {
                            return false;
                        }
                    }
                } else {
                    //check if mandatory or not
                    if (strFormat != strFormat.toLowerCase()) {
                        return false;
                    }
                }

                //check strInputData format
                for (var i = 1; i <= strFormat.length; i++) {
                    strChar = strInputData.substr(i, 1);
                    strFormatChar = strFormat.substr(i, 1);
                    if (strChar == "" && strFormatChar >= "A" && strFormatChar <= "Z") {
                        console.log("mandatory char not present, exit with error");
                        return false; //mandatory char not present, exit with error
                    } else if (strChar == "" && strFormatChar >= "a" && strFormatChar <= "z") {
                        //optional char not present, continue with next
                        console.log("optional char not present, continue with next");
                    } else {
                        switch (strFormatChar) {
                            case "A", "a":
                                if ((strChar < "A" || strChar > "Z") && (strChar < "a" || strChar > "z")) {
                                    return false;
                                }
                                break;
                            case "N", "n":
                                if (!isNumeric(strChar)) {
                                    return false;
                                }
                                break;
                            case "M", "m":
                                if ((strChar < "A" || strChar > "Z") && (strChar < "a" || strChar > "z")) {
                                    if (!isNumeric(strChar)) {
                                        return false;
                                    }
                                }
                                break;
                            case "T", "t":
                                if ((strChar < "A" || strChar > "Z") && (strChar < "a" || strChar > "z")) {
                                    if (!isNumeric(strChar)) {
                                        var srcStr = "-. ";
                                        if (srcStr.indexOf(strChar) < -1) {
                                            return false;
                                        }
                                    }
                                }
                                break;
                            case "U", "u":
                                //#21440
                                if ((strChar < "A" || strChar > "Z") && (strChar < "a" || strChar > "z")) {
                                    if (!isNumeric(strChar)) {
                                        var srcStr = "-./ ";
                                        if (srcStr.indexOf(strChar) < -1) {
                                            return false;
                                        }
                                    }
                                }
                                break;
                            case "F", "f":
                                if ((strChar < "A" || strChar > "Z") && (strChar < "a" || strChar > "z")) {
                                    if (!isNumeric(strChar)) {
                                        var srcStr = "-. ,/():;&'";
                                        if (srcStr.indexOf(strChar) < -1) {
                                            return false;
                                        }
                                    }
                                }
                                break;
                            case "X", "x": //all printable characters
                                if ((strChar.charCodeAt(0) < 32 || strChar.charCodeAt(0) > 126) && strChar !== "\r" && strChar !== "\n") {
                                    return false;
                                }
                                break;
                            default:
                                return false;
                        }
                    }
                }

                isFormat = true;
                break;

            case "I", "F":

                break;
        }

        return isFormat;
    }
    */

    function isNumeric(n) {
        return !isNaN(parseFloat(n)) && isFinite(n);
    }

    function checkPort(text) {
        var portList = JSON.parse(sessionStorage.getItem("PortList"));
        return portList.filter(function (el) { return el.data == text.toUpperCase() }).length > 0;
    }

    function getWeightUnitTextByCode(code) {

        switch (parseInt(code)) {
            case 1:
                return i18next.t("cargoInfo.LB");
                break;
            default:
                return i18next.t("cargoInfo.KG");
        }
    }

    function getVolUnitTextByCode(code) {

        switch (parseInt(code)) {
            case 1:
                return i18next.t("cargoInfo.CF");
                break;
            case 2:
                return i18next.t("cargoInfo.CC");
                break;
            case 3:
                return i18next.t("cargoInfo.CI");
                break;
            default:
                return i18next.t("cargoInfo.MC");
        }
    }

    function getDimUnitTextBoCode(code) {

        switch (parseInt(code)) {
            case 3:
                return i18next.t("dimension.IN");
                break;
            default:
                return i18next.t("dimension.CM");
        }
    }

    function autoScroll() {
        var errEl = $('.error_or, .error_tag, .invalid_input_field, .cx_awb_validate_invalid').toArray();

        if (errEl.length > 0) {
            $('html, body').animate({
                scrollTop: $(errEl).offset().top - 100
            }, 400);
        }
        else {
            $('html, body').animate({ scrollTop: 0 }, 400);
        }
    }

    function assignElsOnEnterFunc(els, func) {
        if (els.length > 0 && typeof func === "function") {

            for (var i = 0; i < els.length; i++) {
                $(els[i]).keypress(function (e) {
                    if (e.keyCode == 13)
                        func();
                });
            }
        }
    }

    //Issue #27684, Temp fix for csp reply - consignee and shipper addr "null" value
    function HandleContactAddrNullVal(streetAddrs) {
        var addrs = [];

        _.forEach(streetAddrs, function (sa) {
            if (sa.toUpperCase() == "NULL")
                addrs.push('');
            else
                addrs.push(sa);
        });

        return addrs;
    }

    function getDatePickerOpt(opt) {
        var def = {
            format: DateTimeFormat.YearMonthDate2,
            updateViewDate: false,
            todayHighlight: true,
            autoclose: true,
            //startDate: new Date(), hide this row to allow user select any date
            clearBtn: true
        };

        return _.merge(def, opt);
    }

    function refreshModuleTranslation() {
        i18nInit("MVC/Booking", "20210715");
        for (var i = 1; i <= 3; i++) {

            $("#tab" + i + " > .bkd_block").each(function (i, o) {
                if ($._data(o, 'events') && $._data(o, 'events').refreshPlaceHolder != null)
                    $(o).triggerHandler("refreshPlaceHolder");
            });
        };
        stopAction();
    }

    $(function () {
        enableClassicLink("/");
    });

</script>

<div id="mvcContainer-403">
    


<script src="./js/bookingdetail/defiant.min.js"></script>
<script src="./js/bookingdetail/jquery.autocomplete.min.js"></script>
<script src="./js/bookingdetail/lity.min.js"></script>

<link rel="stylesheet" href="./css/bookingdetail/lity.min.css">

<style>
	.flex-container {
	  display: flex;
	  justify-content: center;
	}
	.margin-right {
	  margin-right: 10px;
	}
    .bootstrap-tagsinput .tag {
        line-height: 18px;
        float: left;
    }

    .error_or label {
        color: #FF8715 !important;
    }

    .error_or input {
        background-color: #ffffcc !important;
    }

    .SHCodeAC input.form-control.autocomplete.ui-autocomplete-input {
        text-transform: uppercase !important;
    }

    #bkd_def_cargoinfo .m_table .cnt_inline {
        vertical-align: top;
    }

    #split_book_error_wrapper {
        margin-top: 25px;
    }

    #split_book_error_wrapper ul li {
        display: block;
        list-style-type: none;
        margin-bottom: 10px;
        padding-left: 20px;
    }
</style>
<script id="bkd_error_template" type="text/x-template">
    <li>$ERRORMESSAGE$</li>
</script>
<div id="main_loading" class="container wbg disabled" style="display: block; width: 100%; position: absolute; top: 20%;">
    <div class="loading-main">
        <span id="loading_message" data-i18n="common.Loading">Loading</span>
    </div>
</div>
<div id="bkd_detail_error" class="jumbotron disabled" style="padding-top: 12px !important;">
    <div class="container wbg" style="min-height: 80%;">
        <div id="errorWrapper">
            <div class="error-box">
                <p class="error-message" style="text-align: left; font-size: 13px;">We have encountered the following error:-</p>
                <ul id="blk_detail_errorLt" class="blk_list"></ul>
            </div>
            <a href="javascript: void(0)" onclick="javascript: window.location.href = linkBkdBookingLog;" data-i18n="cargoInfo.ReturnToBookingLog">Return to Booking Log</a>
        </div>
    </div>
</div>
<div id="bkd_detail" class="jumbotron">
    <div class="container">
        <h1 class="col-xs-12" data-i18n="cargoInfo.BookingDetails">Booking Details</h1>
        <div class="blkc"></div>
        <div class="blk_sty02">
            <div id="bd_awbno" class="b_flight_num">160-10039651</div><div class="cnt">
                <div class="b_flight_location"><span id="bd_origin">HKG</span><img src="./img/icon_gy_flight.png"><span id="bd_dest">TPE</span></div><div class="b_flight_piece">
                    <span id="bd_pcs">50</span>
                    <span id="cargoInfo_disp_pcs_unit" data-i18n="cargoInfo.pcs">pcs</span>
                </div><div class="b_flight_weight"><span id="bd_weight">10.3</span><span id="bd_weight_code">KG</span></div>
				<div class="blkr">
                    <img class="get_awb_1r" src="./img/icon_oneRecord.jpg" style="cursor : pointer;width: 32px; height: 32px; margin-left: 10px;" onclick="showOneRecordJson('awb_1r');">
                </div>
            <div class="blkc"></div>

            <div class="blk_tb">
                <div class="blk_error"><div id="booking_detail_summary_icon" class="icon_success"></div><h2 id="bd_header_status">SPACE REQUEST RECEIVED</h2><div class="lbl_remarks"></div></div>
                <div class="blkr">
                    <a href="javascript: void(0)" class="bu_link" onclick="goToSingleBooking(&#39;CX&#39;, &#39;160&#39;, &#39;10099364&#39;);"><span class="icon_edit"></span><span data-i18n="common.Edit">Edit</span></a>
                    <a id="cancel_booking_btn" href="javascript: void(0)" class="bu_link" onclick="javascript: wayToSubmitCancel(event);"><span class="icon_cross"></span><span data-i18n="BookingDetails.CancelBooking">Cancel Booking</span></a>
                </div>
                <div class="blkc"></div>
            </div>
            <div class="blkc"></div>
            <div class="b_action_tool for_flight disabled">
                <div class="divider_gy"></div>
                <a href="javascript: void(0)" class="btn_img_share"></a>
                <a href="javascript: void(0)" class="btn_img_email"></a>
                <a href="javascript: void(0)" class="btn_img_saved"></a>
            </div>
        </div>
    </div>
    <div class="blkc"></div>
    <div id="bkd_booking_detail">
        <div class="tab_top">
            <div class="cd-tabs">
                <nav>
                    <ul class="cd-tabs-navigation">
                        <li class="dash_1"><a id="tab1btn" data-content="tab1" class="selected" href="#"><span class="flat_label" data-i18n="cargoInfo.BookingInfo">Booking Information</span></a></li>
                        <li class="dash_2"><a id="tab2btn" data-content="tab2" class="" href="#"><span class="flat_label" data-i18n="cargoInfo.BookingRecord">Booking Record</span></a></li>
                    </ul>
                </nav>

                <ul class="cd-tabs-content" style="height: auto;">
                    <li id="tab1" data-content="tab1" class="bkdtabs selected" style="padding-bottom: 0px;">
                        <div class="wbg">
                            <div class="container wbg">
                                <!-- Tab1 -->
<div id="bkd_def_cargoinfo" class="bkd_block">
	<h3 class="col-xs-7" data-i18n="cargoInfo.CargoInfo">Cargo Information</h3>
	<div class="col-xs-5 header_inline_right">
		<a href="javascript:void(0)" class="date_refresh" onclick="reloadBookingDetail()" data-i18n="cargoInfo.BKCreated">Booking Created: </a>
	</div>
	<div class="head_hr"></div>
	<div class="consign_info m_table">
		<a href="#" class="btn_gy_edit" onclick="openCargoInfoEdit(event)"></a>
		<div class="cnt_inline bu_txt w48 mr55"><label data-i18n="cargoInfo.Airline">Airline</label><div class="lbl_value"><span id="cargoInfo_disp_airline">CX</span></div></div>
		<div class="cnt_inline bu_txt mr55"><label data-i18n="cargoInfo.Pieces">Pieces</label><div class="lbl_value"><span id="cargoInfo_disp_pcs">50</span> <span id="cargoInfo_disp_pcs_unit" data-i18n="cargoInfo.pcs">pcs</span></div></div>
		<div class="cnt_inline bu_txt w175 mr55"><label data-i18n="cargoInfo.Weight">Weight</label><div class="lbl_value"><span id="cargoInfo_disp_weight">10.3</span> <span id="cargoInfo_disp_weightCode">KG</span></div></div>
		<div class="cnt_inline bu_txt w175 mr55"><label data-i18n="cargoInfo.Volume">Volume</label><div class="lbl_value"><span id="cargoInfo_disp_vol">0.022</span> <span id="cargoInfo_disp_volumeCode">MC</span></div></div>
		<div class="cnt_inline bu_txt w175 mr55"><label data-i18n="cargoInfo.Description">Description</label><div class="lbl_value"><span id="cargoInfo_disp_des">BOOKS</span></div></div>
		<div class="cnt_inline bu_txt w175 mr55"><label data-i18n="cargoInfo.PriorityType">Priority Type</label><div class="lbl_value"><span id="cargoInfo_disp_priority">General LIFT</span></div></div>
		<div class="cnt_inline bu_txt w175 mr55"><label data-i18n="cargoInfo.DealCode">Deal Code</label><div class="lbl_value"><span id="cargoInfo_disp_deal_code">&nbsp;</span></div></div>
		<!--<div id="cargoInfo_disp_dg_mask_ind" class="update_indicator" style="display: none;">*DG Mask info updated</div>-->
	</div>

	<input type="hidden" id="cargoInfo_revision" value="10">
	<input type="hidden" id="cargoInfo_hd_airline" value="CX">
	<input type="hidden" id="cargoInfo_hd_awbprefix" value="160">
	<input type="hidden" id="cargoInfo_hd_awbsuffix" value="10039654">


	<div class="booking_lb lity-hide" id="cargoInfo_edit" style="width: 1000px;">
		<div class="lightbox_ctr" style="width: 100%;">
			<div class="close_ctr"><a id="btn_cargoInfo_edit_close" href="javascript:void(0)" class="close_btn" onclick="closeCargoInfoEdit(event)"></a></div>
			<div class="lightbox_blk">
				<h3 data-i18n="cargoInfo.CargoInfo">Cargo Information</h3>
				<div class="blkc"></div>

				<div class="blk_filter">

					<div class="head_hr"></div>
					<div class="consign_info">
						<div class="blkr lbl_lgy">*<span data-i18n="cargoInfo.RequiredFields">Required fields</span></div>
						<div class="blkc"></div>
						<div class="cnt_inline bu_txt w48 mr35">
							<label for="cargoInfo_pcs"><span data-i18n="cargoInfo.Pieces">Pieces</span>*</label>
							<input type="text" value="" id="cargoInfo_pcs" class="cargoinfo_int_input bkd_num_input" maxlength="4">
							<div class="error_or_msg" style="display: none;" data-i18n="cargoInfo.InvalidPieces">Invalid Pieces</div>
						</div>
						<div class="cnt_inline bu_txt w48 mr35">
							<label for="cargoInfo_weight"><span data-i18n="cargoInfo.Weight">Weight</span>*</label>
							<input type="text" value="" id="cargoInfo_weight" class="cargoinfo_dec_input_weight bkd_num_input" maxlength="7">
							<fieldset class="switch-toggle-set">
								<div class="switch-toggle switch-candy">
									<input id="cargoInfo_kg" name="weight-unit" type="radio" value="0" checked="">
									<label for="cargoInfo_kg" onclick="" data-i18n="cargoInfo.KG">KG</label>
									<input id="cargoInfo_lb" name="weight-unit" type="radio" value="1">
									<label for="cargoInfo_lb" onclick="" data-i18n="cargoInfo.LB">LB</label>
									<a></a>
								</div>
							</fieldset>
							<div class="error_or_msg" style="display: none;" data-i18n="cargoInfo.InvalidWeight">Invalid Weight</div>
						</div>
						<div class="cnt_inline bu_txt w48 mr35">
							<label for="cargoInfo_vol"><span data-i18n="cargoInfo.Volume">Volume</span>*</label>
							<input type="text" value="" id="cargoInfo_vol" class="cargoinfo_dec_input bkd_num_input" maxlength="9">
							<fieldset class="switch-toggle-set">
								<div class="switch-toggle switch-candy">
									<input id="cargoInfo_mc" name="vol-unit" type="radio" value="0" checked="">
									<label for="cargoInfo_mc" onclick="" data-i18n="cargoInfo.MC">MC</label>
									<!--<input id="cargoInfo_cc" name="vol-unit" type="radio" value="2">
									<label for="cargoInfo_cc" onclick="" data-i18n="cargoInfo.CC">CC</label>-->
									<input id="cargoInfo_cf" name="vol-unit" type="radio" value="1">
									<label for="cargoInfo_cf" onclick="" data-i18n="cargoInfo.CF">CF</label>
									<!--<input id="cargoInfo_ci" name="vol-unit" type="radio" value="3">
									<label for="cargoInfo_ci" onclick="" data-i18n="cargoInfo.CI">CI</label>-->
									<a></a>
								</div>
							</fieldset>
							<div class="error_or_msg" style="display: none;" data-i18n="cargoInfo.InvalidVolume">Invalid Volume</div>
						</div>
						<div class="cnt_inline bu_txt w175 mr35 b878">
							<label for="cargoInfo_good_des"><span data-i18n="cargoInfo.GoodDesc">Goods Description</span>*</label>
							<select class="select_bu" id="cargoInfo_good_des">
								
							<option value="OTH">Others</option><option value="AC Sparepart">AC Sparepart</option><option value="Advertising Mat">Advertising Mat</option><option value="Aircraft Engine">Aircraft Engine</option><option value="Auto Parts">Auto Parts</option><option value="Bags">Bags</option><option value="Blades">Blades</option><option value="Blood">Blood</option><option value="Books">Books</option><option value="Calculators">Calculators</option><option value="Calendar">Calendar</option><option value="Camera">Camera</option><option value="Capsicum">Capsicum</option><option value="Car">Car</option><option value="Carpets">Carpets</option><option value="Cheese">Cheese</option><option value="Chemicals">Chemicals</option><option value="Cloths">Cloths</option><option value="Coffin">Coffin</option><option value="Comp Parts">Comp Parts</option><option value="Consolidated">Consolidated</option><option value="Cosmetic">Cosmetic</option><option value="Costumes">Costumes</option><option value="Cut Flower">Cut Flower</option><option value="Cut Foliage ">Cut Foliage </option><option value="Day Old Chicken">Day Old Chicken</option><option value="Diplomatic Mail">Diplomatic Mail</option><option value="Documents">Documents</option><option value="Edible Fish">Edible Fish</option><option value="Egg Plants">Egg Plants</option><option value="Elect Component">Elect Component</option><option value="Essential Oil">Essential Oil</option><option value="Exhibit Goods">Exhibit Goods</option><option value="Fabrics">Fabrics</option><option value="Films">Films</option><option value="Flowers">Flowers</option><option value="Foodstuffs">Foodstuffs</option><option value="Foot Ball">Foot Ball</option><option value="Foot Wear">Foot Wear</option><option value="Fresh Fruits">Fresh Fruits</option><option value="Frozen Fish">Frozen Fish</option><option value="Garment">Garment</option><option value="Glassware">Glassware</option><option value="Gold">Gold</option><option value="Hair">Hair</option><option value="Handicrafts">Handicrafts</option><option value="Hanging Garmt">Hanging Garmt</option><option value="Hard Disk">Hard Disk</option><option value="Hatching Eggs">Hatching Eggs</option><option value="Imitated Jewel">Imitated Jewel</option><option value="Jewelry">Jewelry</option><option value="Knitted Goods">Knitted Goods</option><option value="Leather">Leather</option><option value="Live Animals">Live Animals</option><option value="Live Bird">Live Bird</option><option value="Live Fish">Live Fish</option><option value="Live Plants">Live Plants</option><option value="LV Trop Fish">LV Trop Fish</option><option value="Machinery Part">Machinery Part</option><option value="Magazines">Magazines</option><option value="Meat">Meat</option><option value="Medical Equip">Medical Equip</option><option value="Medicines">Medicines</option><option value="Metal Goods">Metal Goods</option><option value="Microchip">Microchip</option><option value="Motor Cycles">Motor Cycles</option><option value="MP3">MP3</option><option value="Mushroom">Mushroom</option><option value="Musical Instru">Musical Instru</option><option value="Newspaper">Newspaper</option><option value="Opital Material">Opital Material</option><option value="Orchids">Orchids</option><option value="Paper Bags">Paper Bags</option><option value="Perfumery Prod">Perfumery Prod</option><option value="Personal Eff">Personal Eff</option><option value="Pharmaceutical">Pharmaceutical</option><option value="Pin &amp; Bolt">Pin &amp; Bolt</option><option value="Plastic Mat">Plastic Mat</option><option value="Printed Mat">Printed Mat</option><option value="Radio">Radio</option><option value="Samples">Samples</option><option value="screw">screw</option><option value="Serum">Serum</option><option value="Ship parts">Ship parts</option><option value="Shoes">Shoes</option><option value="Silk">Silk</option><option value="Skins">Skins</option><option value="Solar Panels">Solar Panels</option><option value="Spare Parts">Spare Parts</option><option value="Speaker">Speaker</option><option value="Sporting Goods">Sporting Goods</option><option value="Stainless Prod">Stainless Prod</option><option value="Tape Recorder">Tape Recorder</option><option value="Telecom Equip">Telecom Equip</option><option value="Textiles">Textiles</option><option value="Tools">Tools</option><option value="Toys">Toys</option><option value="Transformer">Transformer</option><option value="Trinkets">Trinkets</option><option value="Tuna Fish">Tuna Fish</option><option value="Tyres">Tyres</option><option value="Vegetables">Vegetables</option><option value="Watches">Watches</option><option value="Wearing Appea">Wearing Appea</option></select>
							<input type="text" value="" placeholder="Details" id="cargoInfo_good_detail" style="" maxlength="15">
							<div class="error_or_msg" style="display: none;" data-i18n="cargoInfo.InvalidGoodDesc">Invalid Goods Description</div>
						</div>
						<div class="cnt_inline bu_txt w175 mr35 b977">
							<label for="cargoInfo_priority" data-i18n="cargoInfo.PriorityType">Priority Type</label>
							<select class="select_bu" id="cargoInfo_priority">
								<option value="PR3">General LIFT</option>
								
								<option value="PR1">Priority LIFT</option>
								
							</select>
							<div class="error_or_msg" style="display: none;" data-i18n="cargoInfo.InvalidPriority">Invalid Priority</div>
						</div>
						<div id="deal_code_wrapper" class="cnt_inline bu_txt mr35">
							<label for="cargoInfo_deal_code"><span data-i18n="cargoInfo.DealCode">Deal Code</span></label>
							<input type="text" id="cargoInfo_deal_code" maxlength="12">
							<div class="error_or_msg" style="display: none;" data-i18n="cargoInfo.InvalidDealCode">Invalid Deal Code</div>
						</div>
						<div class="blkc"></div>

						<!--div id ="cargoInfo_dgmask_wrapper" class="mb25" style="">
							<div><span class="filterPanelBtn" data-i18n="cargoInfo.DGMask">DG Mask</span><span id="dgmask_filter_arrow" class="filter_arrow_close"></span></div>
							<div id="dgMaskPanel" class="" style="margin-top: 0px; padding: 10px;">
								<div id="sc_special_code_dg_focus" tabindex="-1"></div>
								<div class="w175 mr35">
									<label for="cargoInfo_dg_cargo_aircraft" data-i18n="cargoInfo.CargoAircraftOnly">Cargo Aircraft only</label>
									<input type="checkbox" data-toggle="toggle" data-on="Yes" data-off="No" data-style="bu_toggle" id="cargoInfo_dg_cargo_aircraft">
									<div class="error_or_msg" style="display: none;" data-i18n="cargoInfo.Invalid">Invalid </div>
								</div>
								<div class="blkc"></div>
								<div class="" style="margin-top: 10px;">
									<label for="cargoInfo_dg_special_code" data-i18n="cargoInfo.SHC">Special Handling Code</label>
									<div class="category-container SHCodeDG">
										<input type="text" id="cargoInfo_dg_special_code" placeholder="" class = "autocomplete" data-role = "tagsinput" />
										<div class="error_or_msg" style="display: none;" data-i18n="cargoInfo.Invalid">Invalid</div>
									</div>
								</div>
								<div class="blkc"></div>
								<div class="cnt_inline bu_txt mr35">
									<label for="cargoInfo_un_no" ><span data-i18n="cargoInfo.UNNo">UN number</span>*</label>
									<input type="text" value="" id="cargoInfo_un_no" class="" maxlength="6">
									<div class="error_or_msg" style="display: none;" data-i18n="cargoInfo.Invalid">Invalid</div>
								</div>
								<div class="cnt_inline bu_txt mr35">
									<label for="cargoInfo_class_division" ><span data-i18n="cargoInfo.ClassDivision">Class or Division</span>*</label>
									<input type="text" value="" id="cargoInfo_class_division" class="" maxlength="4">
									<div class="error_or_msg" style="display: none;" data-i18n="cargoInfo.Invalid">Invalid</div>
								</div>
								<div class="cnt_inline bu_txt mr35">
									<label for="cargoInfo_sub_risk" data-i18n="cargoInfo.SubRisk">Subsidiary Risk</label>
									<input type="text" value="" id="cargoInfo_sub_risk" class="" maxlength="3">
									<div class="error_or_msg" style="display: none;" data-i18n="cargoInfo.Invalid">Invalid</div>
								</div>
								<div class="cnt_inline bu_txt w175 mr35 b878">
									<label for="cargoInfo_packing_grp" data-i18n="cargoInfo.PackGrp">Packing Group</label>
									<select class="select_bu" id="cargoInfo_packing_grp">
										<option value="">&nbsp;</option>
										<option value="I">I</option>
										<option value="II">II</option>
										<option value="III">III</option>
									</select>
									<div class="error_or_msg" style="display: none;" data-i18n="cargoInfo.Invalid">Invalid</div>
								</div>
								<div class="blkc"></div>
								<div class="cnt_inline bu_txt mr35">
									<label for="cargoInfo_packing_instr" ><span data-i18n="cargoInfo.PackingInstruction">Packing Instruction</span>*</label>
									<input type="text" value="" id="cargoInfo_packing_instr" class="" maxlength="4">
									<div class="error_or_msg" style="display: none;" data-i18n="cargoInfo.Invalid">Invalid</div>
								</div>
								<div class="cnt_inline bu_txt mr35">
									<label for="cargoInfo_quantity" ><span data-i18n="cargoInfo.Quantity">Quantity</span>*</label>
									<input type="text" value="" id="cargoInfo_quantity" class="cargoinfo_int_input bkd_num_input" maxlength="10">
									<div class="error_or_msg" style="display: none;" data-i18n="cargoInfo.Invalid">Invalid</div>
								</div>
								<div class="blkc"></div>
								<h3 data-i18n="cargoInfo.ShipperInfo">Shipper Info.</h3>
								<div class="blkc"></div>
								<div class="cnt_inline bu_txt mr35">
									<label for="cargoInfo_dg_shipper_contact_name" data-i18n="cargoInfo.PackingInstruction">Shipper contact name</label>
									<input type="text" value="" id="cargoInfo_dg_shipper_contact_name" class="" maxlength="20">
									<div class="error_or_msg" style="display: none;" data-i18n="cargoInfo.Invalid">Invalid</div>
								</div>
								<div class="cnt_inline bu_txt mr35">
									<label for="cargoInfo_dg_shipper_contact_no" data-i18n="cargoInfo.ShipperContactNo">Shipper contact no.</label>
									<input type="text" value="" id="cargoInfo_dg_shipper_contact_no" class="" maxlength="11">
									<div class="error_or_msg" style="display: none;" data-i18n="cargoInfo.Invalid">Invalid</div>
								</div>
								<div class="blkc"></div>
							</div>
						</div>-->
					</div>


				</div>
				<div>
					<a href="javascript:void(0)" class="link_bu_l2" style="float: left;" onclick="closeCargoInfoEdit(event)" data-i18n="common.Cancel">Cancel</a>
					<span href="javascript:void(0)" class="btn_or_l" onclick="onSaveCargoInfoEdit()" data-i18n="common.Save">Save</span>
					<div class="blkc"></div>
				</div>



			</div>
		</div>
	</div>

	<script>
		//for demo init data
		$("#bd_awbno").text("160-10039654");
		$("#bd_origin").text("HKG");
		$("#bd_dest").text("AMS");
		$("#bd_pcs").text("1");
		$("#bd_weight").text("1");
		$("#cargoInfo_disp_airline").text("CX");
		$("#cargoInfo_disp_pcs").text("1");
		$("#cargoInfo_disp_weight").text("1");
		$("#cargoInfo_disp_vol").text("1");
		$("#cargoInfo_disp_des").text("BLADES");
		$("#bu_ptr_s").text("-2.0");
		$("#bu_ptr_e").text("10.0");
		$("#bu_str_s").text("10.0");
		$("#bu_str_e").text("20.0");
		$("#bd_remark_ssi").html("TEMPERATURE -2C10C  ");
		$("#bd_remark_ssi2").html("STORAGE 10C20CCTC 789332 TEMPERATURE -2C10C   STORAGE 10C20CCTC 789332 TEMP");
		$("#routing_origin").text("HKG");
		$("#routing_dest").text("AMS/CX");
		$("#flight_detail_temp_origin").text("HKG");
		$("#flight_detail_temp_dest").text("AMS");
		// $("#").text("");
		// $("#").val("");
		//end
		$(function() {
			var id = "#bkd_def_cargoinfo";
			var cargoLity;
			cargoInfoCheckUserCity();
			var shcLengthLimitDG = 4;

			$(id).on("clear", function(event) {
				//console.log(data);
				//debugger;
				localStorage.removeItem("bd_cargo_info_edit");
				$("#cargoInfo_revision").val("");
				$("#cargoInfo_hd_airline").val("");
				$("#cargoInfo_hd_awbprefix").val("");
				$("#cargoInfo_hd_awbsuffix").val("");

				$("#cargoInfo_disp_airline").text("");
				$("#cargoInfo_disp_pcs").text("");
				$("#cargoInfo_disp_weight").text("");
				$("#cargoInfo_disp_weightCode").text("");
				$("#cargoInfo_disp_vol").text("");
				$("#cargoInfo_disp_volumeCode").text("");
				$("#cargoInfo_disp_des").text("");
				$("#cargoInfo_disp_priority").text("");
				$("#cargoInfo_disp_deal_code").text("");
				clearEditErrorMsgCargoInfo();

			});

			$(id).on("init", function(event, data) {
				console.log(data);
				//debugger;

			});

			$(id).on("validate", function() {
				console.log("OK");

				var isValid = true;

				console.log("CargoInfo isValid:" + isValid);
				return isValid
				//return true;
			});

			$(id).on("submit", function() {

				var airline = $("#cargoInfo_hd_airline").val();
				var awbPrefix = $("#cargoInfo_hd_awbprefix").val();
				var awbSuffix = $("#cargoInfo_hd_awbsuffix").val();

				var bkdData = "";
				if (typeof localStorage.getItem("bd_cargo_info_edit") !== 'undefined' && localStorage.getItem("bd_cargo_info_edit") != null) {
					bkdData = JSON.parse(localStorage.getItem("bd_cargo_info_edit"));
				} else if (typeof localStorage.getItem("bd_cargo_info") !== 'undefined' && localStorage.getItem("bd_cargo_info") != null) {
					bkdData = JSON.parse(localStorage.getItem("bd_cargo_info"));
				}

				var cargoPcs = bkdData.Pieces.toString();
				var cargoWeight = bkdData.Weight.toString();
				var cargoWeightUnit = bkdData.WeightCode;
				var cargoVolume = bkdData.Volume.toString();
				var cargoVolumeIsSpecified = false;
				if (cargoVolume != "") {
					cargoVolumeIsSpecified = true;
				}
				var cargoVolumeUnit = bkdData.VolumeCode;
				var cargoDesc = bkdData.Description;
				var cargoPT = bkdData.PriorityType;

				var cargoDealCode = "";
				if(bkdData.Cx)
					cargoDealCode = bkdData.Cx.DealCode;

				var revision = $("#cargoInfo_revision").val();

				//dg mask
				/*
				var dgAircraftOnly = bkdData.DGAircraftOnly;
				var dgShcList = [];
				if (typeof bkdData.DGSHCList !== 'undefined' && bkdData.DGSHCList != null) {
					//console.log("bkdData.SHCList: " + bkdData.SHCList);
					dgShcList = bkdData.DGSHCList;
				}
				var dgUNNo = bkdData.DGUNNo;
				var dgClassDivision = bkdData.DGClassDivision;
				var dgSubRisk = bkdData.DGSubRisk;
				var dgPackGroup = bkdData.DGPackGroup;
				var dgPackInstr = bkdData.DGInstr;
				var dgQuantity = bkdData.DGQuantity;
				var dgShipperName = bkdData.DGShipperName;
				var dgShipperContactNo = bkdData.DGShipperContactNo;
				*/

				getAWBAPI(airline, awbPrefix, awbSuffix,
					function(succResult){
						//Get AWB info, override revision number for booking update
						revision = succResult.bookings.Cx.Revision;
					},
					function(failResult)
					{
						//Error on calling api, use original result set
						//It will trigger revision needed error
						console.log("Retrieve Booking Error via API");
					}
				)

				return {
					"CargoInfo" : {
						"Airline" : airline,
						"AWBPrefix" : awbPrefix,
						"AWBSuffix": awbSuffix,
						"Pieces": cargoPcs,
						"PiecesIsSpecified": isInt(cargoPcs),
						"Weight": cargoWeight,
						"WeightIsSpecified": isInt(cargoWeight),
						"WeightUnit": cargoWeightUnit.toString(),
						"Volume": cargoVolume,
						"VolumeIsSpecified": cargoVolumeIsSpecified,
						"VolumeUnit": cargoVolumeUnit.toString(),
						"CargoDesc": cargoDesc,
						"PriorityType": cargoPT,
						"DealCode": cargoDealCode,
						"Revision": revision.toString(),
						/*
						"DGAircraftOnly": dgAircraftOnly,
						"DGSHC": dgShcList,
						"DGUNNo": dgUNNo,
						"DGClassDivision": dgClassDivision,
						"DGSubRisk": dgSubRisk,
						"DGPackGroup": dgPackGroup,
						"DGPackInstrction": dgPackInstr,
						"DGQuantity": dgQuantity,
						"DGShipperName": dgShipperName,
						"DGShipperContactNo": dgShipperContactNo
						*/
					}
				}
			});

            $(id).on("loadBookingData", function(event, bkdData, bkdStatus) {
				console.log(bkdData);

				var obj = new Object();
				obj.Airline = bkdData.Airline.toUpperCase();
				if (bkdData.PiecesIsSpecified) {
                    obj.Pieces = bkdData.Pieces;
                } else {
					obj.Pieces = "";
				}
				if (bkdData.WeightIsSpecified) {
                   if (!isNaN(parseFloat(bkdData.Weight).toFixed(decimalWeightRoundTo))) {
						obj.Weight = parseFloat(bkdData.Weight).toFixed(decimalWeightRoundTo);
					} else {
						obj.Weight = bkdData.Weight;
					}
                } else {
					obj.Weight = "";
				}
				obj.WeightCode = bkdData.WeightCode;
				if (bkdData.VolumeAmountIsSpecified != true) {
					obj.Volume = "";
				} else if (!isNaN(parseFloat(bkdData.VolumeAmount).toFixed(decimalVolumeRoundToCX))) {
					obj.Volume = parseFloat(bkdData.VolumeAmount).toFixed(decimalVolumeRoundToCX);
				} else {
					obj.Volume = bkdData.VolumeAmount;
				}
				obj.VolumeCode = bkdData.VolumeCode;
				obj.Description = bkdData.ManifestDesc;

				if(bkdData.Cx){
					obj.PriorityType = bkdData.Cx.ProductCode;
					obj.Cx = {
						DealCode: bkdData.Cx.DealCode
					}
				}

				localStorage.setItem("bd_cargo_info", JSON.stringify(obj));
				localStorage.removeItem("bd_cargo_info_edit");

				cargoInfoRefreshDisplay();

				if (typeof bkdData.Cx !== 'undefined' && bkdData.Cx != null) {
					$("#cargoInfo_revision").val(bkdData.Cx.Revision);
				}

				//dg mask
				/*
				obj.DGAircraftOnly = false;
				obj.DGSHCList = [];
				obj.DGUNNo = "";
				obj.DGClassDivision = "";
				obj.DGSubRisk = "";
				obj.DGPackGroup = "";
				obj.DGInstr = "";
				obj.DGQuantity = "";
				obj.DGShipperName = "";
				obj.DGShipperContactNo = "";
				*/

				$("#cargoInfo_hd_airline").val(bkdData.Airline.toUpperCase());
				$("#cargoInfo_hd_awbprefix").val(bkdData.AwbPrefix);
				$("#cargoInfo_hd_awbsuffix").val(bkdData.AwbSuffix);

				if(_.find([5, 6, 7, 8], function(s) { return s == bkdStatus })){
					$("#cargoInfo_deal_code").prop("disabled", true).addClass("no_border");
				}
			});

			$(id).on("getData", function(event, dataID) {
				console.log(dataID);

				var rtn = "";

				switch(dataID) {
					case "Airline":
						rtn = $("#cargoInfo_disp_airline").text();
						break;
					case "AWBPrefix":
						rtn = $("#cargoInfo_awb_prefix").val();
						break;
					case "AWBSuffix":
						rtn = $("#cargoInfo_awb_suffix").val();
						break;
					case "Contact":
						rtn = $("#cargoInfo_contact").val();
						break;
					case "Pieces":
						rtn = $("#cargoInfo_pcs").val();
						break;
					case "Weight":
						rtn = $("#cargoInfo_weight").val();
						break;
					case "WeightUnit":
						rtn = $('input[name=weight-unit]:checked').val();
						break;
					case "Volume":
						rtn = $("#cargoInfo_vol").val();
						break;
					case "VolumeUnit":
						rtn = $('input[name=vol-unit]:checked').val();
						break;
					case "CargoDesc":
						var cargoDescType = $("#cargoInfo_good_des").val();
						var cargoDescDetail = $("#cargoInfo_good_detail").val();
						if (cargoDescType == "OTH") {
							rtn = cargoDescDetail;
						} else {
							rtn = cargoDescType;
						}
						break;
					case "PriorityType":
						rtn = $("#cargoInfo_priority").val();
						break;
					case "IsSpecialCargo":
						rtn = $("#cargoInfo_special_cargo").val();
						break;
					case "DealCode":
						rtn = $("#cargoInfo_deal_code").val();
						break;
				}

				return rtn;

			});

			$(id).on("setData", function(event, dataID, value) {
				console.log(dataID);
				console.log(value);
				/*
				switch(dataID) {
					case "Airline":
						$("#cargoInfo_airline").val(value);
						break;
					case "AWBPrefix":
						$("#cargoInfo_awb_prefix").val(value);
						break;
					case "AWBSuffix":
						$("#cargoInfo_awb_suffix").val(value);
						break;
					case "Contact":
						$("#cargoInfo_contact").val(value);
						break;
					case "Pieces":
						$("#cargoInfo_pcs").val(value);
						break;
					case "Weight":
						$("#cargoInfo_weight").val(value);
						break;
					case "WeightUnit":
						if (bkdData.WeightCode == 0) {
							$("#cargoInfo_kg").prop("checked", true);
						} else {
							$("#cargoInfo_lb").prop("checked", true);
						}
						break;
					case "Volume":
						$("#cargoInfo_vol").val(value);
						break;
					case "VolumeUnit":
						if (bkdData.VolumeCode == 0) {
							$("#cargoInfo_mc").prop("checked", true);
						} else {
							$("#cargoInfo_ck").prop("checked", true);
						}
						break;
					case "CargoDesc":
						if ($("#cargoInfo_good_des option[value='"+value+"']").length > 0) {
							console.log(true);
							$("#cargoInfo_good_des").val(value);
							$("#cargoInfo_good_detail").hide();
						} else {
							console.log(true);
							$("#cargoInfo_good_des").val("OTH");
							$("#cargoInfo_good_detail").val(value);
							$("#cargoInfo_good_detail").show();
						}
						break;
					case "PriorityType":
						$("#cargoInfo_priority").val();
						break;
					case "IsSpecialCargo":
						$("#cargoInfo_special_cargo").val();
						break;
					case "DealCode":
						$("#cargoInfo_deal_code").val(value);
				}
				*/

			});

		});

		$('#cargoInfo_deal_code').keypress(function(e) {
			console.log(e.which);
			if ((e.which >= 65 && e.which <= 90) || (e.which >= 97 && e.which <= 122) || (e.which >= 48 && e.which <= 57)) {

			} else {
				return false;
			}
		});

		$('#cargoInfo_deal_code').blur(function(e) {
			$(this).val($(this).val().toUpperCase());
		});

		function cargoInfoRefreshDisplay() {

			var bkdData = "";

			if (typeof localStorage.getItem("bd_cargo_info_edit") !== 'undefined' && localStorage.getItem("bd_cargo_info_edit") != null) {
				bkdData = JSON.parse(localStorage.getItem("bd_cargo_info_edit"));
			} else if (typeof localStorage.getItem("bd_cargo_info") !== 'undefined' && localStorage.getItem("bd_cargo_info") != null) {
				bkdData = JSON.parse(localStorage.getItem("bd_cargo_info"));
			}

			if (bkdData != "") {

				if (bkdData.Airline != "") {
					$('#cargoInfo_disp_airline').text(bkdData.Airline);
				} else {
					$('#cargoInfo_disp_airline').html("&nbsp;");
				}

				if (bkdData.Pieces != "") {
					$("#cargoInfo_disp_pcs").text(bkdData.Pieces);
				} else {
					$('#cargoInfo_disp_pcs').html("&nbsp;");
				}

				if (bkdData.Weight != "") {
					$("#cargoInfo_disp_weight").text(bkdData.Weight);
				} else {
					$('#cargoInfo_disp_weight').html("&nbsp;");
				}

				$("#cargoInfo_disp_weightCode").text(getWeightUnitTextByCode(bkdData.WeightCode));

				if (bkdData.Volume != "") {
					$("#cargoInfo_disp_vol").text(bkdData.Volume);
				} else {
					$('#cargoInfo_disp_vol').html("&nbsp;");
				}

				$("#cargoInfo_disp_volumeCode").text(getVolUnitTextByCode(bkdData.VolumeCode));

				if (bkdData.Description != "") {
					$("#cargoInfo_disp_des").text(bkdData.Description);
				} else {
					$('#cargoInfo_disp_des').html("&nbsp;");
				}

				if (bkdData.PriorityType == "PR1") {
					//$("#cargoInfo_disp_priority").text(i18n.t("cargoInfo_pt_pr1"));
					$("#cargoInfo_disp_priority").text("Priority LIFT");
				} else if (bkdData.PriorityType == "PR2") {
					//$("#cargoInfo_disp_priority").text(i18n.t("cargoInfo_pt_pr2"));
					$("#cargoInfo_disp_priority").text("General LIFT Plus");
				} else if (bkdData.PriorityType == "PR3") {
					//$("#cargoInfo_disp_priority").text(i18n.t("cargoInfo_pt_pr3"));
					$("#cargoInfo_disp_priority").text("General LIFT");
				} else if (bkdData.PriorityType == "PR4") {
					//$("#cargoInfo_disp_priority").text(i18n.t("cargoInfo_pt_pr4"));
					$("#cargoInfo_disp_priority").text("Flexi LIFT");
				} else if (bkdData.PriorityType == "") {
					$("#cargoInfo_disp_priority").html("&nbsp;");
				} else {
					$("#cargoInfo_disp_priority").text(bkdData.PriorityType);
				}

				if(bkdData.Cx && bkdData.Cx.DealCode != ""){
					$("#cargoInfo_disp_deal_code").text(bkdData.Cx.DealCode);
				}
				else{
					$('#cargoInfo_disp_deal_code').html("&nbsp;");
				}

				updateIndicatorCargoInfo();
			}
		}

		function openCargoInfoEdit(e) {
			e.preventDefault();
			regCargoInfoInit();
			loadEditDataCargoInfo();
			clearEditErrorMsgCargoInfo();
			cargoLity = lity('#cargoInfo_edit');
		}

		function closeCargoInfoEdit(e) {
			if (typeof e !== 'undefined' && e != null) {
				e.preventDefault();
			}
			cargoLity.close();
		}

		function regCargoInfoInit() {
			$('#cargoInfo_good_des').on('change', function() {
				console.log( this.value );
				if ($(this).val() == "OTH") {
					$("#cargoInfo_good_detail").show();
				} else {
					$("#cargoInfo_good_detail").hide();
				}
			})

			$(".cargoinfo_int_input").keypress(function(e) {
				console.log(e.which);
				if(e.which >= 48 && e.which <= 57 ){
				} else {
					return false;
				}
			});

            $(".cargoinfo_dec_input, .cargoinfo_dec_input_weight, .cargoinfo_dec_input_volume").keypress(function (e) {
                console.log(e.which);
                if ((e.which >= 48 && e.which <= 57) || e.which == 46) {
                } else {
                    return false;
                }
            });

            $(".cargoinfo_dec_input").blur(function (e) {
                if ($(this).val() != "") {
                    $(this).val(FormatDecInput($(this).val(), decimalRoundTo));
                }
            });

            $(".cargoinfo_dec_input_volume").blur(function (e) {
                if ($(this).val() != "") {
                    $(this).val(FormatDecInput($(this).val(), decimalVolumeRoundToCX));
                }
            });

			$(".cargoinfo_dec_input_weight").blur(function(e) {
				if ($(this).val() != "") {
					$(this).val(FormatDecInput($(this).val(), decimalWeightRoundTo));
				}
			});

			var bkdData = "";

			if (typeof localStorage.getItem("bd_cargo_info_edit") !== 'undefined' && localStorage.getItem("bd_cargo_info_edit") != null) {
				bkdData = JSON.parse(localStorage.getItem("bd_cargo_info_edit"));
			} else if (typeof localStorage.getItem("bd_cargo_info") !== 'undefined' && localStorage.getItem("bd_cargo_info") != null) {
				bkdData = JSON.parse(localStorage.getItem("bd_cargo_info"));
			}

			if (bkdData.Airline == "CX" && bkdData.AwbPrefix == "171") {
				$("#cargoInfo_priority option[value='PR2']").remove();
				$("#cargoInfo_priority option[value='PR4']").remove();
				$("#cargoInfo_priority option[value='PRS']").remove();
				$("#cargoInfo_priority option[value='PR1']").remove();
			} else {
				$('#cargoInfo_priority option').remove();
				if (localStorage.getItem("CXPriorityType") != null) {
					var ptList = JSON.parse(localStorage.getItem("CXPriorityType"));
					if (typeof ptList !== 'undefined' && ptList != null) {
						for(var i = 0; i < ptList.length; i++) {
							$('#cargoInfo_priority').append('<option value="'+ptList[i].Value+'">'+ptList[i].Text+'</option>');
						}
					}
				}
			}

			cargoInfoCheckUserCity();

			//dg mask
			/*
			resetDGMaskFilterPanel();
			$(".filterPanelBtn").click(function (e) {
				e.preventDefault();
				if ($("#dgmask_filter_arrow").attr('class') == "filter_arrow_open") {
					closeDGMaskFilterPanel();
				} else {
					openDGMaskFilterPanel();
				}

			});

			function openDGMaskFilterPanel() {
				$("#dgmask_filter_arrow").removeClass("filter_arrow_close").addClass("filter_arrow_open");
				$("#dgMaskPanel").slideDown();
			}

			function closeDGMaskFilterPanel() {
				$("#dgmask_filter_arrow").removeClass("filter_arrow_open").addClass("filter_arrow_close");
				$("#dgMaskPanel").slideUp();
			}

			function resetDGMaskFilterPanel() {
				$("#dgmask_filter_arrow").removeClass("filter_arrow_open").addClass("filter_arrow_close");
				$("#dgMaskPanel").hide();
			}

			$('#cargoInfo_dg_special_code').on('beforeItemAdd', function(event) {
				// event.item: contains the item
				// event.cancel: set to true to prevent the item getting added
				var currentValue = $("#cargoInfo_dg_special_code").val();
				var arr = currentValue.split(",");
				var shcInput = event.item.substring(0, 3).toUpperCase();
				if (currentValue.trim() != "" && arr.length >= shcLengthLimitDG) {
					event.cancel = true;
				//} else if (availableSHCTags.indexOf(event.item.toUpperCase()) > -1) {
				} else if (availableSHCTags.indexOf(shcInput) > -1) {
					if (event.item != event.item.toUpperCase() || event.item != shcInput) {
						event.cancel = true;
						$(this).tagsinput('add', shcInput);
						//$(this).tagsinput('add', event.item.substring(0, 3).toUpperCase());
					}
				} else if (availableSHCTags.indexOf(event.item.toUpperCase()) == -1) {
					event.cancel = true;
				} else {
					//event.cancel = true;
					//$(this).tagsinput('add', event.item.toUpperCase());
				}
			});

			setTimeout(function () {
				$(".SHCodeDG input.form-control.autocomplete.ui-autocomplete-input").keypress(function(e) {
					// event.item: contains the item
					// event.cancel: set to true to prevent the item getting added
					console.log(e.which);

					var currentValue = $("#cargoInfo_dg_special_code").val();
					var arr = currentValue.split(",");
					if (currentValue.trim() != "" && arr.length >= shcLengthLimitDG) {
						return false;
					}

				});
			}, 2000);
			*/
		}

		function loadEditDataCargoInfo() {

			cargoInfoResetEdit();

			var bkdData = "";

			if (typeof localStorage.getItem("bd_cargo_info_edit") !== 'undefined' && localStorage.getItem("bd_cargo_info_edit") != null) {
				bkdData = JSON.parse(localStorage.getItem("bd_cargo_info_edit"));
			} else if (typeof localStorage.getItem("bd_cargo_info") !== 'undefined' && localStorage.getItem("bd_cargo_info") != null) {
				bkdData = JSON.parse(localStorage.getItem("bd_cargo_info"));
			}

			if (bkdData != "") {
				$("#cargoInfo_pcs").val(bkdData.Pieces);
				$("#cargoInfo_weight").val(bkdData.Weight);
				if (bkdData.WeightCode == 0) {
					$("#cargoInfo_kg").prop("checked", true);
				} else {
					$("#cargoInfo_lb").prop("checked", true);
				}
				$("#cargoInfo_vol").val(bkdData.Volume);

				switch (bkdData.VolumeCode) {
				  case 1:
				    $("#cargoInfo_cf").prop("checked", true);
				    break;
				  case 2:
				    $("#cargoInfo_cc").prop("checked", true);
				    break;
				  case 3:
				    $("#cargoInfo_ci").prop("checked", true);
				    break;
				  default:
				  	$("#cargoInfo_mc").prop("checked", true);
				}

				if (bkdData.Description != "") {
					var optionList = [];
					var foundInx = 1;
					$("#cargoInfo_good_des option").each(function() {
					   optionList.push($(this).val());
					});

					for (var i = 0; i < optionList.length; i++) {
						if (optionList[i].toLowerCase() == bkdData.Description.toLowerCase()) {
							foundInx = i + 1;
						}
					}

					if (foundInx > 1) {
						$("#cargoInfo_good_des :nth-child("+foundInx+")").prop('selected', true);
						$("#cargoInfo_good_detail").hide();
					} else {
						$("#cargoInfo_good_des").val("OTH");
						$("#cargoInfo_good_detail").val(bkdData.Description);
						$("#cargoInfo_good_detail").show();
					}
				} else {
					$("#cargoInfo_good_des").val("OTH");
					$("#cargoInfo_good_detail").val(bkdData.Description);
					$("#cargoInfo_good_detail").show();
				}

				$("#cargoInfo_priority").val(bkdData.PriorityType);

				if(bkdData.Cx)
					$("#cargoInfo_deal_code").val(bkdData.Cx.DealCode);
			}


		}

		function validateCargoInfo() {
			//var intVad = /^\+?(0|[1-9]\d*)$/;
			//var decVad = /^([1-9]\d*|0\.\d*[1-9]|[1-9]\d*\.\d*[0-9]|0)$/;

			var cargoPcs = $("#cargoInfo_pcs").val();
			var cargoWeight = $("#cargoInfo_weight").val();
			var cargoWeightUnit = $('input[name=weight-unit]:checked').val();
			var cargoVolume = $("#cargoInfo_vol").val();
			var cargoVolumeUnit = $('input[name=vol-unit]:checked').val();
			var cargoDescType = $("#cargoInfo_good_des").val();
			var cargoDescDetail = $("#cargoInfo_good_detail").val();
			var cargoPT = $("#cargoInfo_priority").val();
			var cargoDealCode = $("#cargoInfo_deal_code").val();

			//dg mask
			/*
			var dgAircraftOnly = $("#cargoInfo_dg_cargo_aircraft").is(':checked');
			var dgShc = $("#cargoInfo_dg_special_code").val().toUpperCase();
			var dgShcList = [];
			if (dgShc != "") {
				dgShcList = dgShc.split(",");
			}
			var dgUNNo = $("#cargoInfo_un_no").val();
			var dgClassDivision = $("#cargoInfo_class_division").val();
			var dgSubRisk = $("#cargoInfo_sub_risk").val();
			var dgPackGroup = $("#cargoInfo_packing_grp").val();
			var dgPackInstr = $("#cargoInfo_packing_instr").val();
			var dgQuantity = $("#cargoInfo_quantity").val();
			var dgShipperName = $("#cargoInfo_dg_shipper_contact_name").val();
			var dgShipperContactNo = $("#cargoInfo_dg_shipper_contact_no").val();
			*/
			var isValid = true;

			//pieces
			if (cargoPcs == "") {
				$("#cargoInfo_pcs ~ .error_or_msg").show();
				$("#cargoInfo_pcs").parent().addClass("error_or");
				isValid = false;
			} else if (!intVad.test(cargoPcs) && cargoPcs != "") {
				$("#cargoInfo_pcs ~ .error_or_msg").show();
				$("#cargoInfo_pcs").parent().addClass("error_or");
				isValid = false;
			} else {
				$("#cargoInfo_pcs ~ .error_or_msg").hide();
				$("#cargoInfo_pcs").parent().removeClass("error_or");

			}

			//weight
			if (cargoWeight == "") {
				$("#cargoInfo_weight ~ .error_or_msg").show();
				$("#cargoInfo_weight").parent().addClass("error_or");
				isValid = false;
			} else if (!decVad.test(cargoWeight) && cargoWeight != "") {
				$("#cargoInfo_weight ~ .error_or_msg").show();
				$("#cargoInfo_weight").parent().addClass("error_or");
				isValid = false;
			} else {
				$("#cargoInfo_weight ~ .error_or_msg").hide();
				$("#cargoInfo_weight").parent().removeClass("error_or");
			}

			//volume
			if (cargoVolume == "") {
				$("#cargoInfo_vol ~ .error_or_msg").show();
				$("#cargoInfo_vol").parent().addClass("error_or");
				isValid = false;
			} else if (!decVad.test(cargoVolume) && cargoVolume != "") {
				$("#cargoInfo_vol ~ .error_or_msg").show();
				$("#cargoInfo_vol").parent().addClass("error_or");
				isValid = false;
			} else {
				$("#cargoInfo_vol ~ .error_or_msg").hide();
				$("#cargoInfo_vol").parent().removeClass("error_or");
			}

			//good desc
			if (cargoDescType == "OTH" && !StringFormatChecker.checkFormatX2(cargoDescDetail, 1, 15)) {
				$("#cargoInfo_good_detail ~ .error_or_msg").show();
				$("#cargoInfo_good_detail").parent().addClass("error_or");
				isValid = false;
			} else {
				$("#cargoInfo_good_detail ~ .error_or_msg").hide();
				$("#cargoInfo_good_detail").parent().removeClass("error_or");
			}

			//Deal Code
			if(!StringFormatChecker.checkDealCodeFormat(cargoDealCode)){
				isValid = false;
				$("#cargoInfo_deal_code ~ .error_or_msg").show();
				$("#cargoInfo_deal_code").parent().addClass("error_or");
			}
			else{
				$("#cargoInfo_deal_code ~ .error_or_msg").hide();
				$("#cargoInfo_deal_code").parent().removeClass("error_or");
			}

			//check dg mask
			/*
			if (dgAircraftOnly == true || dgShc != "" || dgUNNo != "" || dgClassDivision != "" || dgSubRisk != ""
			|| dgPackGroup != "" || dgPackInstr != "" || dgQuantity != "" || dgShipperName != "" || dgShipperContactNo != "") {

				if (dgShcList.length == 0) {
					$("#cargoInfo_dg_special_code ~ .error_or_msg").show();
					isValid = false;
				} else {
					$("#cargoInfo_dg_special_code ~ .error_or_msg").hide();
				}

				if (dgUNNo == "") {
					$("#cargoInfo_un_no ~ .error_or_msg").show();
					$("#cargoInfo_un_no").parent().addClass("error_or");
					isValid = false;
				} else if (dgUNNo.length != 6) {
					$("#cargoInfo_un_no ~ .error_or_msg").show();
					$("#cargoInfo_un_no").parent().addClass("error_or");
					isValid = false;
				} else {
					var airline = dgUNNo.substr(0,2);
					var flightNum = dgUNNo.substr(2);
					var reg = new RegExp(/^\d{4}$/);

					if (!isNaN(airline) || !reg.test(flightNum)) {
						$("#cargoInfo_un_no ~ .error_or_msg").show();
						$("#cargoInfo_un_no").parent().addClass("error_or");
						isValid = false;
					} else {
						$("#cargoInfo_un_no ~ .error_or_msg").hide();
						$("#cargoInfo_un_no").parent().removeClass("error_or");
					}
				}

				if (dgClassDivision == "") {
					$("#cargoInfo_class_division ~ .error_or_msg").show();
					$("#cargoInfo_class_division").parent().addClass("error_or");
					isValid = false;
				} else {
					$("#cargoInfo_class_division ~ .error_or_msg").hide();
					$("#cargoInfo_class_division").parent().removeClass("error_or");
				}

				if (dgSubRisk != "") {
					if (!decVad.test(dgSubRisk)) {
						$("#cargoInfo_sub_risk ~ .error_or_msg").show();
						$("#cargoInfo_sub_risk").parent().addClass("error_or");
						isValid = false;
					}
				} else {
					$("#cargoInfo_sub_risk ~ .error_or_msg").hide();
					$("#cargoInfo_sub_risk").parent().removeClass("error_or");
				}

				if (dgPackGroup == "") {
					$("#cargoInfo_packing_grp ~ .error_or_msg").show();
					$("#cargoInfo_packing_grp").parent().addClass("error_or");
					isValid = false;
				} else {
					$("#cargoInfo_packing_grp ~ .error_or_msg").hide();
					$("#cargoInfo_packing_grp").parent().removeClass("error_or");
				}

				if (dgPackInstr == "" || dgPackInstr.length < 3 || dgPackInstr.length > 4) {
					$("#cargoInfo_packing_instr ~ .error_or_msg").show();
					$("#cargoInfo_packing_instr").parent().addClass("error_or");
					isValid = false;
				} else {

					$("#cargoInfo_packing_instr ~ .error_or_msg").hide();
					$("#cargoInfo_packing_instr").parent().removeClass("error_or");

					if (dgPackInstr.length == 3) {
						var reg = new RegExp(/^\d{3}$/);
						if (!reg.test(dgPackInstr)) {
							$("#cargoInfo_packing_instr ~ .error_or_msg").show();
							$("#cargoInfo_packing_instr").parent().addClass("error_or");
							isValid = false;
						}
					} else if (dgPackInstr.length == 4) {
						var reg = new RegExp(/^[a-zA-Z]{1}\d{3}$/);
						if (!reg.test(dgPackInstr)) {
							$("#cargoInfo_packing_instr ~ .error_or_msg").show();
							$("#cargoInfo_packing_instr").parent().addClass("error_or");
							isValid = false;
						}
					}
				}

				if (dgShipperName == "") {
					$("#cargoInfo_dg_shipper_contact_name ~ .error_or_msg").show();
					$("#cargoInfo_dg_shipper_contact_name").parent().addClass("error_or");
					isValid = false;
				} else {
					$("#cargoInfo_dg_shipper_contact_name ~ .error_or_msg").hide();
					$("#cargoInfo_dg_shipper_contact_name").parent().removeClass("error_or");
				}

				if (dgShipperContactNo == "") {
					$("#cargoInfo_dg_shipper_contact_no ~ .error_or_msg").show();
					$("#cargoInfo_dg_shipper_contact_no").parent().addClass("error_or");
					isValid = false;
				} else {
					$("#cargoInfo_dg_shipper_contact_no ~ .error_or_msg").hide();
					$("#cargoInfo_dg_shipper_contact_no").parent().removeClass("error_or");
				}

			}
			*/

			console.log("cargoinfo isValid:" + isValid);
			return isValid;
		}

		function onSaveCargoInfoEdit(){
			if (!validateCargoInfo()) {
				return false;
			}

			//changing deal code warning
			var dealCode = $("#cargoInfo_deal_code").val();
			var bkdData = "";
			if (typeof localStorage.getItem("bd_cargo_info_edit") !== 'undefined' && localStorage.getItem("bd_cargo_info_edit") != null) {
				bkdData = JSON.parse(localStorage.getItem("bd_cargo_info_edit"));
			} else if (typeof localStorage.getItem("bd_cargo_info") !== 'undefined' && localStorage.getItem("bd_cargo_info") != null) {
				bkdData = JSON.parse(localStorage.getItem("bd_cargo_info"));
			}

			if((!bkdData.Cx && dealCode) || (bkdData.Cx && bkdData.Cx.DealCode != dealCode)){
				DialogManager.confirm(undefined, i18next.t("cargoInfo.ConfirmToChangeDealCodeMsg"), saveCargoInfoEdit);
			}
			else {
				saveCargoInfoEdit();
			}
		}

		function saveCargoInfoEdit() {
			var obj = new Object();
			obj.Pieces = $("#cargoInfo_pcs").val();
			obj.Weight = $("#cargoInfo_weight").val();
			obj.WeightCode = $('input[name=weight-unit]:checked').val();
			obj.Volume = $("#cargoInfo_vol").val();
			obj.VolumeCode = $('input[name=vol-unit]:checked').val();
			var cargoDescType = $("#cargoInfo_good_des").val();
			var cargoDescDetail = $("#cargoInfo_good_detail").val();
			var cargoDesc;
			if (cargoDescType == "OTH") {
				cargoDesc = cargoDescDetail;
			} else {
				cargoDesc = cargoDescType;
			}
			obj.Description = cargoDesc;
			obj.PriorityType = $("#cargoInfo_priority").val();
			obj.Cx = {
				DealCode: $("#cargoInfo_deal_code").val()
			}

			//dg mask
			/*
			obj.DGAircraftOnly = $("#cargoInfo_dg_cargo_aircraft").is(':checked');
			var dgShc = $("#cargoInfo_dg_special_code").val().toUpperCase();
			if (dgShc != "") {
				obj.DGSHCList = dgShc.split(",");
			}
			obj.DGUNNo = $("#cargoInfo_un_no").val();
			obj.DGClassDivision = $("#cargoInfo_class_division").val();
			obj.DGSubRisk = $("#cargoInfo_sub_risk").val();
			obj.DGPackGroup = $("#cargoInfo_packing_grp").val();
			obj.DGInstr = $("#cargoInfo_packing_instr").val();
			obj.DGQuantity = $("#cargoInfo_quantity").val();
			obj.DGShipperName = $("#cargoInfo_dg_shipper_contact_name").val();
			obj.DGShipperContactNo = $("#cargoInfo_dg_shipper_contact_no").val();
			*/

			localStorage.setItem("bd_cargo_info_edit", JSON.stringify(obj));

			cargoInfoRefreshDisplay();
			closeCargoInfoEdit();
		}

		function updateIndicatorCargoInfo() {
			var original;
			var updated;
			var hasUpdate = false;

			if (typeof localStorage.getItem("bd_cargo_info_edit") !== 'undefined' && localStorage.getItem("bd_cargo_info_edit") != null) {
				original = JSON.parse(localStorage.getItem("bd_cargo_info"));
				updated = JSON.parse(localStorage.getItem("bd_cargo_info_edit"));

				if (original.Pieces != updated.Pieces) {
					$("#cargoInfo_disp_pcs").addClass("update_indicator");
					hasUpdate = true;
				} else {
					$("#cargoInfo_disp_pcs").removeClass("update_indicator");
				}

				if (original.Weight != updated.Weight) {
					$("#cargoInfo_disp_weight").addClass("update_indicator");
					hasUpdate = true;
				} else {
					$("#cargoInfo_disp_weight").removeClass("update_indicator");
				}

				if (original.WeightCode != updated.WeightCode) {
					$("#cargoInfo_disp_weightCode").addClass("update_indicator");
					hasUpdate = true;
				} else {
					$("#cargoInfo_disp_weightCode").removeClass("update_indicator");
				}

				if (original.Volume != updated.Volume) {
					$("#cargoInfo_disp_vol").addClass("update_indicator");
					hasUpdate = true;
				} else {
					$("#cargoInfo_disp_vol").removeClass("update_indicator");
				}

				if (original.VolumeCode != updated.VolumeCode) {
					$("#cargoInfo_disp_volumeCode").addClass("update_indicator");
					hasUpdate = true;
				} else {
					$("#cargoInfo_disp_volumeCode").removeClass("update_indicator");
				}

				if (original.Description != updated.Description) {
					$("#cargoInfo_disp_des").addClass("update_indicator");
					hasUpdate = true;
				} else {
					$("#cargoInfo_disp_des").removeClass("update_indicator");
				}

				if (original.PriorityType != updated.PriorityType) {
					$("#cargoInfo_disp_priority").addClass("update_indicator");
					hasUpdate = true;
				} else {
					$("#cargoInfo_disp_priority").removeClass("update_indicator");
				}

				if (original.Cx.DealCode != updated.Cx.DealCode) {
					$("#cargoInfo_disp_deal_code").addClass("update_indicator");
					hasUpdate = true;
				} else {
					$("#cargoInfo_disp_deal_code").removeClass("update_indicator");
				}

				/*
				if (updated.DGUNNo != "") {
					$("#cargoInfo_disp_dg_mask_ind").show();
				} else {
					$("#cargoInfo_disp_dg_mask_ind").hide();
				}
				*/

				if (hasUpdate) {
					localStorage.setItem("bd_cargo_info_has_update", 1);
				}

			}
		}

		function clearEditErrorMsgCargoInfo() {
			$("#cargoInfo_edit .error_or").removeClass("error_or");
			$("#cargoInfo_edit .error_or_msg").hide();
		}

		function cargoInfoResetEdit() {
			$("#cargoInfo_pcs").val("");
			$("#cargoInfo_weight").val("");
			$("#cargoInfo_kg").prop("checked", true);
			$("#cargoInfo_vol").val("");
			$("#cargoInfo_mc").prop("checked", true);
			$("#cargoInfo_good_detail").show();
			$("#cargoInfo_good_des").val("OTH");
			$("#cargoInfo_good_detail").val("");
			$("#cargoInfo_priority").val($("#cargoInfo_priority option:first").val());
			$("cargoInfo_deal_code").val();

			// dg mask info
			/*
			$('#cargoInfo_dg_cargo_aircraft').bootstrapToggle();
			$('#cargoInfo_dg_cargo_aircraft').bootstrapToggle('off');
			$('#cargoInfo_dg_special_code').tagsinput('removeAll');
			$("#cargoInfo_un_no").val("");
			$("#cargoInfo_class_division").val("");
			$("#cargoInfo_sub_risk").val("");
			$("#cargoInfo_packing_grp").val("");
			$("#cargoInfo_packing_instr").val("");
			$("#cargoInfo_quantity").val("");
			$("#cargoInfo_dg_shipper_contact_name").val("");
			$("#cargoInfo_dg_shipper_contact_no").val("");
			//$("#cargoInfo_dg_shipper_remark").val("");
			*/
			clearEditErrorMsgCargoInfo();
		}

		function cargoInfoCheckUserCity() {
			//alter priority type option if user city is hk
			if (localStorage.getItem("userCity") != null) {

				var vipPTList = "";
				var isVipPT = false;
				if (localStorage.getItem("hasEzyCargoVipPT") != null) {
					isVipPT = localStorage.getItem("hasEzyCargoVipPT") == "true" ? true : false;
				}

				if (localStorage.getItem("userCity") == "HKG" && !isVipPT) {
					$("#cargoInfo_priority option[value='PR2']").remove();
				}

				if (localStorage.getItem("userCity") == "HKG" ) {
					$("#cargoInfo_priority option[value='PR4']").remove();
					$("#cargoInfo_priority option[value='PRS']").remove();
				}

				/*
				if (validateJPCity(localStorage.getItem("userCity"))) {
					$("#cargoInfo_dgmask_wrapper").show();
				} else {
					$("#cargoInfo_dgmask_wrapper").hide();
					$("#cargoInfo_disp_dg_mask_ind").hide();
				}
				*/
			}
		}

		function getAWBAPI(airline, awbPrefix, awbSuffix, succCallback, failCallback) {
			var requestData = {
				"request": {
					"airline": airline,
					"awbPrefix": awbPrefix,
					"awbSuffix": awbSuffix
				}
			}; //create array of objects
			var options = {};
            options.url = RetrieveAPIURL;
			options.type = "POST";
			options.contentType = "application/json; charset=utf-8";
			options.dataType = "json";
			options.async = false;
			options.timeout = 10000;
			options.data = JSON.stringify(requestData)
			options.beforeSend = function (xhr, settings) {
				xhr.setRequestHeader('Authorization', 'Bearer ' + getCookie('ApiToken'));
			};
			options.success = function (bkd) {
				succCallback(bkd);
			};
			options.error = function () {
				failCallback();
			};
			$.ajax(options);
    	}

	</script>
</div><div id="bkd_def_routing" class="bkd_block">
    <h3 class="col-xs-12" data-i18n="flight.RoutingFlights">Routing &amp; Flights</h3>
    <div class="head_hr"></div>
    <div id="route_table" class="consign_info m_table">
        <a href="javascript:void(0)" class="btn_gy_edit" onclick="openRoutingEdit(event)"></a>
        <div class="cnt_inline bu_txt mr5"><div id="routing_origin" class="lbl_value">HKG</div></div>
    
    
    

    <div class="cnt_inline chk_to bd_route_tp"></div>
    <div class="cnt_inline bu_txt mr5 bd_route_tp"><div id="routing_dest" class="lbl_value">AMS/CX</div></div>
</div>

    <div class="booking_lb lity-hide" id="routing_edit" style="width: 100%; min-width: 900px; max-width: 900px;">
        <div class="lightbox_ctr" style="width: 100%;">
            <div class="close_ctr"><a id="btn_routing_edit_close" href="javascript:void(0)" class="close_btn" onclick="closeRoutingEdit(event)"></a></div>
            <div class="lightbox_blk">
                <h3 data-i18n="routing.Routing">Routing</h3>
                <div class="blkc"></div>

                <div class="blk_filter">

                    <div class="head_hr"></div>
                    <div class="consign_info">
                        <div class="route_input_wrapper">
                            <div class="route_input_row cnt_inline" data-rowid="1" style="height: 80px;">
                                <div class="cnt_inline bu_txt chk_location">
                                    <label for="routing_route_from_1" data-i18n="routing.From">From</label>
                                    <input type="text" value="" placeholder="Port Code" id="routing_route_from_1" class="port_query flight_flt" autocomplete="off">
                                    <div class="error_or_msg" style="display: none;" data-i18n="routing.InvalidOrigin">Invalid Origin</div>
                                </div>
                                <div class="cnt_inline chk_to"></div>
                                <div class="cnt_inline bu_txt chk_location">
                                    <label for="routing_route_to_1" data-i18n="routing.To">To</label>
                                    <input type="text" value="" placeholder="Port Code" id="routing_route_to_1" class="port_query flight_flt" autocomplete="off">
                                    <div class="error_or_msg" style="display: none;" data-i18n="routing.InvalidPort">Invalid Port</div>
                                </div>
                                <div class="cnt_inline bu_txt w48">
                                    <label for="routing_route_airline_1" data-i18n="routing.Airline">Airline</label>
                                    <input type="text" value="" id="routing_route_airline_1" class="flight_num_input">
                                    <div class="error_or_msg" style="display: none;" data-i18n="routing.InvalidAirline">Invalid Airline</div>
                                </div>
                            </div>
                        
    <div class="route_input_row cnt_inline extra_row" data-rowid="2" style="height: 80px;">
        <div class="cnt_inline chk_to"></div>
        <div class="cnt_inline bu_txt chk_location">
            <label for="routing_route_to_2" data-i18n="routing.To">To</label>
            <input type="text" value="" placeholder="Port Code" id="routing_route_to_2" class="port_query flight_flt" autocomplete="off">
            <div class="error_or_msg" style="display: none;" data-i18n="routing.InvalidPort">Invalid Port</div>
        </div>
        <div class="cnt_inline bu_txt w48">
            <label for="routing_route_airline_2" data-i18n="routing.Airline">Airline</label>
            <input type="text" value="" id="routing_route_airline_2" class="flight_num_input">
            <div class="error_or_msg" style="display: none;" data-i18n="routing.InvalidAirline">Invalid Airline</div>
        </div>
    </div>

    <div class="route_input_row cnt_inline extra_row" data-rowid="3" style="height: 80px;">
        <div class="cnt_inline chk_to"></div>
        <div class="cnt_inline bu_txt chk_location">
            <label for="routing_route_to_3" data-i18n="routing.To">To</label>
            <input type="text" value="" placeholder="Port Code" id="routing_route_to_3" class="port_query flight_flt" autocomplete="off">
            <div class="error_or_msg" style="display: none;" data-i18n="routing.InvalidPort">Invalid Port</div>
        </div>
        <div class="cnt_inline bu_txt w48">
            <label for="routing_route_airline_3" data-i18n="routing.Airline">Airline</label>
            <input type="text" value="" id="routing_route_airline_3" class="flight_num_input">
            <div class="error_or_msg" style="display: none;" data-i18n="routing.InvalidAirline">Invalid Airline</div>
        </div>
    </div>

    <div class="route_input_row cnt_inline extra_row" data-rowid="4" style="height: 80px;">
        <div class="cnt_inline chk_to"></div>
        <div class="cnt_inline bu_txt chk_location">
            <label for="routing_route_to_4" data-i18n="routing.To">To</label>
            <input type="text" value="" placeholder="Port Code" id="routing_route_to_4" class="port_query flight_flt" autocomplete="off">
            <div class="error_or_msg" style="display: none;" data-i18n="routing.InvalidPort">Invalid Port</div>
        </div>
        <div class="cnt_inline bu_txt w48">
            <label for="routing_route_airline_4" data-i18n="routing.Airline">Airline</label>
            <input type="text" value="" id="routing_route_airline_4" class="flight_num_input">
            <div class="error_or_msg" style="display: none;" data-i18n="routing.InvalidAirline">Invalid Airline</div>
        </div>
    </div>
</div>
                        <div class="act_bu act_add_col add_dest disabled" id="btnAddDest" onclick="addDestinationEdit(event)">
                            <span data-i18n="routing.AddDest">Add destination</span>
                        </div>
                    </div>


                </div>
                <div>
                    <a href="javascript:void(0)" class="link_bu_l2" style="float: left;" onclick="closeRoutingEdit(event)" data-i18n="common.Cancel">Cancel</a>
                    <span href="javascript:void(0)" class="btn_or_l" onclick="saveRoutingEdit()" data-i18n="common.Save">Save</span>
                    <div class="blkc"></div>
                </div>



            </div>
        </div>
    </div>

</div>

<script id="routing_input_row_temp" type="text/x-template">
    <div class="route_input_row cnt_inline extra_row" data-rowid="%ID%" style="height: 80px;">
        <div class="cnt_inline chk_to"></div>
        <div class="cnt_inline bu_txt chk_location">
            <label for="routing_route_to_%ID%" data-i18n="routing.To">To</label>
            <input type="text" value="" placeholder="Port Code" id="routing_route_to_%ID%" class="port_query flight_flt">
            <div class="error_or_msg" style="display: none;" data-i18n="routing.InvalidPort">Invalid Port</div>
        </div>
        <div class="cnt_inline bu_txt w48">
            <label for="routing_route_airline_%ID%" data-i18n="routing.Airline">Airline</label>
            <input type="text" value="" id="routing_route_airline_%ID%" class="flight_num_input">
            <div class="error_or_msg" style="display: none;" data-i18n="routing.InvalidAirline">Invalid Airline</div>
        </div>
    </div>
</script>

<script id="bd_route_temp" type="text/x-template">
    <div class="cnt_inline chk_to bd_route_tp"></div>
    <div class="cnt_inline bu_txt mr5 bd_route_tp"><div class="lbl_value">%DEST%/%AIRLINE%</div></div>
</script>

<script id="bd_route_temp_edit" type="text/x-template">
    <div class="route_input_row cnt_inline extra_row" data-rowid="%ID%" style="height: 80px;">
        <div class="cnt_inline chk_to"></div>
        <div class="cnt_inline bu_txt chk_location">
            <label for="routing_route_to_%ID%" data-i18n="routing.To">To</label>
            <input type="text" value="" placeholder="Port Code" id="routing_route_to_%ID%" class="port_query flight_flt">
            <div class="error_or_msg" style="display: none;" data-i18n="routing.InvalidPort">Invalid Port</div>
        </div>
        <div class="cnt_inline bu_txt w48">
            <label for="routing_route_airline_%ID%" data-i18n="routing.Airline">Airline</label>
            <input type="text" value="" id="routing_route_airline_%ID%" class="flight_num_input">
            <div class="error_or_msg" style="display: none;" data-i18n="routing.InvalidAirline">Invalid Airline</div>
        </div>
    </div>
</script>

<script>
	$(function() {
		var id = "#bkd_def_routing";
		var routeLity;
		
		var numberOfExtraRows = $(".route_input_row.cnt_inline extra_row").length;
		var numberOfRowsTotal = numberOfExtraRows + 1;
		console.log("number of rows: " + numberOfRowsTotal);
		for(i=numberOfRowsTotal; i<4; i++){
			AddDestinationEditInput();
		}
		
		$(id).on("clear", function(event) {
			//console.log(data);
			
			//debugger;
			$("#routing_route_from_1").val("");
			$("#routing_route_to_1").val("");
			$("#routing_route_airline_1").val("");
			$("#routing_route_from_1 ~ .error_or_msg").hide();
			$("#routing_route_to_1 ~ .error_or_msg").hide();
			$("#routing_route_airline_1 ~ .error_or_msg").hide();
			//$(".route_input_row.extra_row").remove();
			clearEditErrorMsgRouting();
			
			$("#routing_origin").text("");
			$(".route_table.bd_route_tp").remove();
			
		});
		
		$(id).on("init", function(event, data) {
			console.log(data);
			var currentRowID;
			regPortQueryV2();
			//debugger;
			
			$("#routing_route_from_1").val(data.RouteInfo.RouteFrom);
			
			for (var i = 0; i < data.RouteInfo.RouteTo.length; i++) {
				currentRowID = i + 1;
				
				if (i > 0) {
					AddDestinationInput(currentRowID, i, function(cID, dataRow){
						$("#routing_route_to_" + cID).val(data.RouteInfo.RouteTo[dataRow].RouteTo);
						$("#routing_route_airline_" + cID).val(data.RouteInfo.RouteTo[dataRow].Airline);
					});
				} else {
					$("#routing_route_to_" + currentRowID).val(data.RouteInfo.RouteTo[i].RouteTo);
					$("#routing_route_airline_" + currentRowID).val(data.RouteInfo.RouteTo[i].Airline);
				}
			}
			
		});
		
		$(id).on("validate", function() {
			console.log("OK");
			
			var isValid = true;
			
			console.log("routing isValid:" + isValid);
			return isValid;
			//return true;
		});
		
		$(id).on("submit", function() {
		
			var bkdData = "";
			if (typeof localStorage.getItem("bd_routing_edit") !== 'undefined' && localStorage.getItem("bd_routing_edit") != null) {
				bkdData = JSON.parse(localStorage.getItem("bd_routing_edit"));
			} else if (typeof localStorage.getItem("bd_routing") !== 'undefined' && localStorage.getItem("bd_routing") != null) {
				bkdData = JSON.parse(localStorage.getItem("bd_routing"));
			}

			var routeFrom = bkdData.RouteFrom;
			var routeTo = [];
			var routeSegments = [];
			
			for (var i = 0; i < bkdData.FlightDetail.length; i++) {
				var fd = new Object();
				fd.Airline = bkdData.FlightDetail[i].CarrierCode;
				fd.RouteTo = bkdData.FlightDetail[i].ArrivalPort;
				//objRoute.FlightDetail.push(fd);
				routeTo.push(fd);

				//construct route segment
				if(i > 0){
					routeSegments.push({
						Seq: i + 1,
						Origin: bkdData.FlightDetail[i - 1].ArrivalPort,
						Destination: bkdData.FlightDetail[i].ArrivalPort,
						Airline: bkdData.FlightDetail[i].CarrierCode
					});
				}
				else{
					routeSegments.push({
						Seq: 1,
						Origin: routeFrom,
						Destination: bkdData.FlightDetail[i].ArrivalPort,
						Airline: bkdData.FlightDetail[i].CarrierCode
					});
				}
			}

			return { 
				"RouteInfo" : {
					"RouteFrom" : routeFrom,
					"RouteTo" : routeTo,
					"RouteSegment" : routeSegments
				}
			};
		});
		
		
		$(id).on("loadBookingData", function(event, bkdData) {
			console.log(bkdData);
			
			var obj = new Object();
			obj.RouteFrom = bkdData.Origin;
			obj.FlightDetail = [];

			if(bkdData.BkdRouteSegment.length > 0){
				var routeSegment = bkdData.BkdRouteSegment;

				_.forEach(bkdData.BkdRouteSegment, function(route, index) {
					var fd = new Object();
					fd.CarrierCode = route.Airline.toUpperCase();
					fd.DeparturePort = route.Origin.toUpperCase();
					fd.ArrivalPort = route.Destination.toUpperCase();
					obj.FlightDetail.push(fd);
				});
			}
			// this is for old records without information of BkdRouteSegment, this should remove after all records contain information of route segment
			else{
				for (var i = 0; i < bkdData.FlightDetail.length; i++) {
					var fd = new Object();
					fd.CarrierCode = bkdData.FlightDetail[i].CarrierCode.toUpperCase();
					fd.DeparturePort = bkdData.FlightDetail[i].DeparturePort.toUpperCase();
					fd.ArrivalPort = bkdData.FlightDetail[i].ArrivalPort.toUpperCase();
					//fd.FlightNum = bkdData.FlightDetail[i].FlightNum;
					//fd.DeptFlightDate = new Date(getAPIDate(bkdData.FlightDetail[i].DepartureDate));
					//fd.ArrivalFlightDate = new Date(getAPIDate(bkdData.FlightDetail[i].ArrivalDate));
					//fd.AllotmentId = bkdData.FlightDetail[i].AllotmentId;
					//fd.AllotmentCode = bkdData.FlightDetail[i].SpaceAllocationCode;
					//objRoute.FlightDetail.push(fd);
					obj.FlightDetail.push(fd);
				}
			}

			localStorage.setItem("bd_routing", JSON.stringify(obj));
			localStorage.removeItem("bd_routing_edit");
			
			routingRefreshDisplay();	
		});
		
		function AddDestinationInput(cID, dID, callback) {

			var row = $("#routing_input_row_temp").html();
		
            var currentRowID = getComponentRowID("route_input_row");
			row = row.replaceAll("%ID%", currentRowID + 1);
			
			if(currentRowID < 4){
				$(".route_input_wrapper").append(row);
			}
			if (typeof callback === "function" && typeof cID !== 'undefined' && typeof dID !== 'undefined') {
				callback(cID, dID);
			}
			regPortQueryV2();
        }
		
	});	
	
	function routingRefreshDisplay() {
	
		$("#route_table .bd_route_tp").remove();
	
		var bkdData = "";
		if (typeof localStorage.getItem("bd_routing_edit") !== 'undefined' && localStorage.getItem("bd_routing_edit") != null) {
			bkdData = JSON.parse(localStorage.getItem("bd_routing_edit"));
		} else if (typeof localStorage.getItem("bd_routing") !== 'undefined' && localStorage.getItem("bd_routing") != null) {
			bkdData = JSON.parse(localStorage.getItem("bd_routing"));
		}
	
		if (bkdData != "") {
			//console.log("fltRefreshDisplay: " + JSON.stringify(bkdData));
			
			$("#routing_origin").text(bkdData.RouteFrom);
			var routeTemp = $("#bd_route_temp").html();
			var routeContent;
			for (var i = 0; i < bkdData.FlightDetail.length; i++) {
			
				var carrierCode = bkdData.FlightDetail[i].CarrierCode;
				var departurePort = bkdData.FlightDetail[i].DeparturePort;
				var arrivalPort = bkdData.FlightDetail[i].ArrivalPort;
				//var flightNum = bkdData.FlightDetail[i].FlightNum;
				//var deptFlightDate = new Date(bkdData.FlightDetail[i].DeptFlightDate);
				//var arrivalFlightDate = new Date(bkdData.FlightDetail[i].ArrivalFlightDate);
				//var allotmentId = bkdData.FlightDetail[i].AllotmentId || "-";
				//var allotmentCode = bkdData.FlightDetail[i].AllotmentCode;
				// var remarkType = "N";
				// var remarkClass = "blk_error";
				// var remark = "Flight not available for booking";
				// if (remarkType != "N") {
				// 	remarkClass = "ball_bu";
				// 	remark = "Book not accept alternative";
				// }
				
				routeContent = routeTemp.replace("%DEST%", arrivalPort).replace("%AIRLINE%", carrierCode);
				$("#route_table").append(routeContent);
				
			}

			updateIndicatorRouting();		
		}
		
	}
	
	// Route edit
	
	function openRoutingEdit(e) {
		e.preventDefault();
		//$(".route_input_row.extra_row").remove();
		clearEditErrorMsgRouting();	
		regRoutingInit();
		loadEditDataRouting();
		routeLity = lity('#routing_edit');

		//$('.flight_flt').attr("placeholder", i18next.t("BookingLandingPage.PortCode"));
	}
	
	function closeRoutingEdit(e) {
		if (typeof e !== 'undefined' && e != null) {
			e.preventDefault();
		}
		routeLity.close();
	}
	
	function regRoutingInit() {
		regPortQueryV2();
	}
	
	function loadEditDataRouting() {
		
		routingResetEdit();
		
		var bkdData = "";
		
		if (typeof localStorage.getItem("bd_routing_edit") !== 'undefined' && localStorage.getItem("bd_routing_edit") != null) {
			bkdData = JSON.parse(localStorage.getItem("bd_routing_edit"));
		} else if (typeof localStorage.getItem("bd_routing") !== 'undefined' && localStorage.getItem("bd_routing") != null) {
			bkdData = JSON.parse(localStorage.getItem("bd_routing"));
		}
		
		if (bkdData != "") {
			var currentRowID;
            if (bkdData.FlightDetail.length > 0) {
                $("#routing_route_from_1").val(bkdData.RouteFrom);
            }
			
			for (var i = 0; i < bkdData.FlightDetail.length; i++) {
				currentRowID = i + 1;
				
				if (i > 0) {
					AddDestinationEditInput(currentRowID, i, function(cID, dataRow){
						$("#routing_route_to_" + cID).val(bkdData.FlightDetail[dataRow].ArrivalPort);
						$("#routing_route_airline_" + cID).val(bkdData.FlightDetail[dataRow].CarrierCode);
					});
				} else {
					$("#routing_route_to_" + currentRowID).val(bkdData.FlightDetail[i].ArrivalPort);
					$("#routing_route_airline_" + currentRowID).val(bkdData.FlightDetail[i].CarrierCode);
				}
			}
		}
	}
	
	function validateRoutingInfo() {
		var routeFrom = $("#routing_route_from_1").val();
		var isValid = true;
		if (routeFrom == "" || (routeFrom != "" && !checkPort(routeFrom))) {
			$("#routing_route_from_1 ~ .error_or_msg").show();
			$("#routing_route_from_1").parent().addClass("error_or");
			isValid = false;
		} else {
			$("#routing_route_from_1 ~ .error_or_msg").hide();
			$("#routing_route_from_1").parent().removeClass("error_or");
		}

		$("div[class^='route_input_row']").each(function (i, el) {
			var rowid = $(this).attr("data-rowid");
			var routeTo = $("#routing_route_to_"+rowid).val();
			var airline = $("#routing_route_airline_"+rowid).val();

			if ((rowid == "1" && routeTo == "") || (routeTo != "" && !checkPort(routeTo))) {
				$("#routing_route_to_"+rowid+" ~ .error_or_msg").show();
				$("#routing_route_to_"+rowid).parent().addClass("error_or");
				isValid = false;
			} else {
				$("#routing_route_to_"+rowid+" ~ .error_or_msg").hide();
				$("#routing_route_to_"+rowid).parent().removeClass("error_or");
			}
			
			if ((rowid == "1" && airline == "") || (airline != "" && airline.length != 2)) {
				$("#routing_route_airline_"+rowid+" ~ .error_or_msg").show();
				$("#routing_route_airline_"+rowid).parent().addClass("error_or");
				isValid = false;
			} else {
				$("#routing_route_airline_"+rowid+" ~ .error_or_msg").hide();
				$("#routing_route_airline_"+rowid).parent().removeClass("error_or");
			}
			
			if (isValid) {
				if (routeTo != "" && airline == "") {
					$("#routing_route_airline_"+rowid+" ~ .error_or_msg").show();
					$("#routing_route_airline_"+rowid).parent().addClass("error_or");
					isValid = false;
				} else {
					$("#routing_route_to_"+rowid+" ~ .error_or_msg").hide();
					$("#routing_route_to_"+rowid).parent().removeClass("error_or");
				}
			}
			
			if (isValid) {
				if (routeTo == "" && airline != "") {
					$("#routing_route_to_"+rowid+" ~ .error_or_msg").show();
					$("#routing_route_to_"+rowid).parent().addClass("error_or");
					isValid = false;
				} else {
					$("#routing_route_airline_"+rowid+" ~ .error_or_msg").hide();
					$("#routing_route_airline_"+rowid).parent().removeClass("error_or");
				}
			}
				
		});

		return isValid;
	}
	
	function saveRoutingEdit() {
		
		if (!validateRoutingInfo()) {
			return false;
		}
		
		var obj = new Object();
		obj.RouteFrom = $("#routing_route_from_1").val() || "";
		obj.RouteFrom = obj.RouteFrom.toUpperCase();
		obj.FlightDetail = [];
		
		$("div[class^='route_input_row']").each(function (i, el) {
			//var id = el.id.substring(el.id.indexOf("_")+1);
			var rowid = $(this).attr("data-rowid");
			//console.log("routeValue");
			//console.log("id: " +id);
			//console.log("i: " +i);
			 
			if ($("#routing_route_to_"+rowid).val() != "" && $("#routing_route_airline_"+rowid).val() != "") {
				var fd = new Object();
				fd.CarrierCode = $("#routing_route_airline_"+rowid).val() || "";
				fd.CarrierCode = fd.CarrierCode.toUpperCase();
				fd.ArrivalPort = $("#routing_route_to_"+rowid).val() || "";
				fd.ArrivalPort = fd.ArrivalPort.toUpperCase();
				obj.FlightDetail.push(fd);
			} 
			
		});
					
		localStorage.setItem("bd_routing_edit", JSON.stringify(obj));

		routingRefreshDisplay();
		closeRoutingEdit();
		
	}
	
	function updateIndicatorRouting() {
		
		$("#route_table .lbl_value").removeClass("update_indicator");
		
		var original;
		var updated;
		var hasUpdate = false;
		
		if (typeof localStorage.getItem("bd_routing_edit") !== 'undefined' && localStorage.getItem("bd_routing_edit") != null) {
			original = JSON.parse(localStorage.getItem("bd_routing"));
			updated = JSON.parse(localStorage.getItem("bd_routing_edit"));
		
			if (typeof original.FlightDetail !== 'undefined' && original.FlightDetail != null && typeof updated.FlightDetail !== 'undefined' && updated.FlightDetail != null) {
				
				if (original.FlightDetail.length != updated.FlightDetail.length) {
					$("#route_table .lbl_value").addClass("update_indicator");
				} else {
					for (var i = 0; i < updated.FlightDetail.length; i++) {
						if (original.FlightDetail[i].CarrierCode != updated.FlightDetail[i].CarrierCode || original.FlightDetail[i].ArrivalPort != updated.FlightDetail[i].ArrivalPort) {
							$("#route_table .lbl_value").addClass("update_indicator");
						}
					}
				}
			}
			
		}
		
		if (hasUpdate) {
			localStorage.setItem("bd_routing_has_update", 1);
		}
		
	}
	
	function addDestinationEdit(e) {
		e.preventDefault();
		AddDestinationEditInput();
	}
	
	function AddDestinationEditInput(cID, dID, callback) {
		
		var row = $("#bd_route_temp_edit").html();
		
		var currentRowID = getComponentRowID("route_input_row");
		row = row.replaceAll("%ID%", currentRowID + 1);
		$(".route_input_wrapper").append(row);
		var newRowID = currentRowID + 1;

		if (typeof callback === "function" && typeof cID !== 'undefined' && typeof dID !== 'undefined') {
			callback(cID, dID);
		}

        regPortQueryV2();
		if (currentRowID >= 3) {
			$("#btnAddDest").addClass("disabled");
		}
        refreshModuleTranslation();
        
		$('.flight_flt').attr("placeholder", i18next.t("BookingLandingPage.PortCode"));
	}
	
	function clearEditErrorMsgRouting() {
		$("#routing_edit .error_or").removeClass("error_or");
		$("#routing_edit .error_or_msg").hide();
	}
	
	function routingResetEdit() {
		$("#routing_route_from_1").val("");
		$("#routing_route_to_1").val("");
		$("#routing_route_airline_1").val("");
		$("#routing_route_from_1 ~ .error_or_msg").hide();
		$("#routing_route_to_1 ~ .error_or_msg").hide();
		$("#routing_route_airline_1 ~ .error_or_msg").hide();
		//$(".route_input_row.extra_row").remove();
		clearEditErrorMsgRouting();
		
	}
	// end Route edit
	
</script><div id="bkd_def_flight" class="bkd_block">
	<!--<h3 data-i18n="flight.RoutingFlights">Routing & Flights</h3>
	<div class="head_hr"></div>
	<div id="fld_route_table" class="consign_info m_table">
        <a href="javascript:void(0)" class="btn_gy_edit" onclick="openRoutingEdit(event)"></a>
        <div class="cnt_inline bu_txt mr5"><div id="flt_origin" class="lbl_value"></div></div>
    </div>-->
	
	<ol id="fld_flight_table" class="routing_flights">
	<li data-rowid="0">
		<div class="cola" style="width: 110px;"><span id="flight_detail_temp_origin" class="flight_detail_temp">HKG</span><div class="cnt_inline chk_to"></div><span id="flight_detail_temp_dest" class="flight_detail_temp">AMS</span></div>
		<div class="cola" style="width: 70px;"><span class="flight_detail_temp flight_num_display">CX271</span></div>
		<div class="blklc w991"></div>
		<div class="colb" style="width: 130px;"><label data-i18n="flight.Departure">Departure</label><span class="flight_detail_temp">24 Sep</span></div>
		<div class="colb" style="width: 130px;"><label data-i18n="flight.Arrival">Arrival</label><span class="flight_detail_temp">25 Sep 12:00</span></div>
		<div class="colb" style="width: 130px;"><label data-i18n="flight.AllotmentID">Allotment ID</label><span class="flight_detail_temp">-</span></div>
		<div class="colb" style="width: 130px;"><label data-i18n="cargoInfo.Pieces">Pieces</label><span class="flight_detail_temp">1</span></div>
		<div class="colb" style="width: 130px;"><label data-i18n="cargoInfo.Weight">Weight</label><span class="flight_detail_temp">1.0</span></div>
		<div class="colb" style="width: 130px;"><label data-i18n="cargoInfo.Volume">Volume</label><span class="flight_detail_temp">1.000</span></div>
		<div class="blklc w630"></div>
		<div class="colb"><div class="blk_error"><span class="flight_detail_remark_mark"></span>SPACE REQUEST RECEIVED</div></div>
		<a href="#" class="btn_gy_edit" onclick="openFlightEdit(event, 0)"></a>
	</li>
</ol>
	<div class="act_bu act_add_flights" style="display: inline-block;"><span onclick="openFlightEdit(event)" data-i18n="flight.AddFlight">Add flight</span></div>
	
	<div id="split_book_error_wrapper">
		<ul>
		</ul>
	</div>
	
	<div id="fld_disp_TW_WarehouseCode_wrapper" style="padding-top: 12px; display: none;">
		<div class="consign_info m_table">
			<a href="#" class="btn_gy_edit" onclick="openFlightWarehouseEdit(event)"></a>
			<div class="cnt_inline bu_txt w48 mr55">
				<label data-i18n="flight.WarehouseCode">Warehouse Code</label>
				<div class="lbl_value">
					<span id="fld_disp_warehouse_code"></span>
				</div>
			</div>
		</div>
	</div>
	

	<div class="lightbox" id="all_code">
		<div class="lightbox_ctr">
			<div class="close_ctr"><a href="javascript:void(0)" class="close_btn"></a></div>
			<div class="lightbox_blk">
				<h3 data-i18n="flight.AllocationCode">Allocation Code</h3>
				<div class="blkc"></div>
				<div class="ts_table">
					<div class="trow theader">
						<div class="tcell col1" data-i18n="flight.AllocCode">Alloc</div>
						<div class="tcell colh" data-i18n="flight.Description">Description</div>

					</div> 
			
					<div class="rowwrapper">
						<div class="trow">
							<div class="tcell col1">
								<div class="flight_pieces">NN</div>
							</div>
							<div class="tcell cols">
								<div class="flight_pieces">Book not accept alternative</div>
							</div>
						</div>
					</div>
					<div class="rowwrapper">
						<div class="trow">
							<div class="tcell col1">
								<div class="flight_pieces">NA</div>
							</div>
							<div class="tcell cols">
								<div class="flight_pieces">Book accept alternative</div>
							</div>
						</div>
					</div> 
			
					<div class="rowwrapper">
						<div class="trow">
							<div class="tcell col1">
								<div class="flight_pieces">CA</div>
							</div>
							<div class="tcell cols">
								<div class="flight_pieces">Booking against allotment</div>
							</div>
						</div>
					</div> 
				
					<div class="rowwrapper">
						<div class="trow">
							<div class="tcell col1"><div class="flight_pieces">XX</div></div>
							<div class="tcell cols"><div class="flight_pieces">Cancel booking</div></div>
						</div>
					</div>   
				 
					<div class="rowwrapper">
						<div class="trow">
							<div class="tcell col1"><div class="flight_pieces">NL</div></div>
							<div class="tcell cols"><div class="flight_pieces">Booking for wait list</div></div>
						</div>
					</div>   
				 
					<div class="rowwrapper">
						<div class="trow">
							<div class="tcell col1"><div class="flight_pieces">SS</div></div>
							<div class="tcell cols"><div class="flight_pieces">Reporting Sale</div></div>
						</div>
					</div>   
				</div>
			</div>
		</div>
	</div>
	

	<div class="booking_lb lity-hide" id="search_flight">
		<div class="lightbox_ctr">
			<div class="close_ctr"><a id="btn_flt_src_close" href="javascript:void(0)" class="close_btn"></a></div>
			<div class="lightbox_blk">
				<h3 data-i18n="flight.SearchFlights">Search Flights</h3>
				<div class="blkc"></div>
			
				<div class="blk_filter">
					<div class="cnt_inline bu_txt">
						<label for="flt_airline_src" data-i18n="flight.Airline" style="color: #000000;">Airline</label>
						<input type="text" value="" id="flt_airline_src" style="width: 50px; height: 32px; text-transform: uppercase;">
					</div>
					<div class="cnt_inline bu_txt chk_dept">
						<label for="flt_date_src"><span data-i18n="flight.Date" style="color: #000000;">Date</span>*</label>
						<div id="datepicker_src" class="input-group date" data-date-format="yyyy-mm-dd">
							<input class="form-control" type="text" id="flt_date_src">
							<span class="input-group-addon" style=""><i class="glyphicon glyphicon-calendar"></i></span>
						</div>
					</div>
					<div class="cnt_inline bu_txt chk_location">
						<label for="flt_from_src" data-i18n="flight.From" style="color: #000000;">From</label>
						<input type="text" value="" placeholder="Port Code" id="flt_from_src" class="port_query flight_flt" style="width: 180px; height: 32px;" autocomplete="off">
					</div>
					<div class="cnt_inline bu_txt chk_to lb_chk_to"></div>
					<div class="cnt_inline bu_txt chk_location mr5 code_02_ctr">
						<label for="flt_to_src" data-i18n="flight.To" style="color: #000000;">To</label>
						<input type="text" value="" placeholder="Port Code" id="flt_to_src" class="port_query flight_flt" style="width: 180px; height: 32px;" autocomplete="off">
						<div id="btn_fa_src" class="btn_search" style="top:23px"></div>
					</div>
					<div class="blkc"></div>
				</div>     
			
				<div id="fa_result_wrapper" class="ts_table w_flight">
					<div class="trow theader" style="display: table-row;">
						<div class="tcell col1 colm">
							<img src="./img/icon_wt_pointer.png"> HKG - BOS
						</div>
						<div class="tcell col1 colm date_select">
							<a href="#" class="sort_left"> </a>17 Nov 2016 (Thu) <a href="#" class="sort_right"> </a>
						</div>
						<div class="tcell colh">
					
						</div>
						<div class="tcell colh" data-i18n="cargoInfo.FlightNo">Flight No.</div>
						<div class="tcell colh" data-i18n="flight.From">From</div>
						<div class="tcell colh" data-i18n="flight.To">To</div>
						<div class="tcell colh colc">
				   
						</div>

						<div class="trow action_bar_wt" style="display: table-row;">
							<select class="switch_dn">
								<option>All airlines&nbsp;(34)</option>
								<option>CX</option>
								<option>JL</option>
							</select> |
							<select class="switch_dn">
								<option>All flights&nbsp;(34)</option>
								<option>Direct flights</option>
							</select> | 
							<select class="switch_dn">
								<option>By flight time</option>
								<option>By flight no.</option>
							</select> 
						</div>
					</div>
					<!--<div id="fa_result_wrapper">-->
						<div class="trow fa_result_row" style="display: table-row;">
							<div class="tcell col1 colh">
								<b>1.</b>
							</div>
							<div class="tcell cols">
								<div class="flight_num_l"><span>CX101</span></div>
							</div>
							<div class="tcell cols">
								<div class="flight_general">
									<span class="time">01:30</span>
									<span>HKG</span>
								</div>
								<div class="flight_general">
									<div class="flight_to">
									</div>
								</div>
							</div>
							<div class="tcell cols">
								<div class="flight_general"><span class="time">01:30</span><span>HKG</span></div>
							</div>
							<div class="tcell colh ccol">
								<div class="flight_general"><span class="mark_booked">
									<a href="javascript:void(0)" onclick="loadFSResultToRow(event, 0)">
									<span class="tick"></span><span data-i18n="flight.Select">Select</span></a></span>
								</div>
							</div>
						</div>
				
						<div class="merged trow fa_result_row" style="display: table-row;">
							<div class="ecell col1 colh">
					
							</div>
							<div class="tcell cols">
								<div class="flight_num_l"><span>CX102</span></div>
							</div>
							<div class="tcell cols">
								<div class="flight_general"><span class="time">02:30</span><span>HKG</span></div>
								<div class="flight_general"><div class="flight_to"></div></div>
							</div>
							<div class="tcell cols">
								<div class="flight_general"><span class="time">02:30</span><span>HKG</span></div>
							</div>
							<div class="ecell colh ccol">
								<div class="flight_general"><span class="mark_booked">
									<a href="javascript:void(0)" onclick="loadFSResultToRow(event, 0)">
									<span class="tick"></span><span data-i18n="flight.Select">Select</span></a></span>
								</div>
							</div>
						</div>
				
			  
						<div class="trow fa_result_row">
							<div class="tcell col1 colh">
								<b>2.</b>
							</div>
							<div class="tcell cols">
								<div class="flight_num_l"><span>CX501</span></div>
							</div>
							<div class="tcell cols">
								<div class="flight_general">
									<span class="time">10:30</span>
									<span>HKG</span>
								</div>
								<div class="flight_general">
									<div class="flight_to"></div>
								</div>
							</div>
							<div class="tcell cols">
								<div class="flight_general">
									<span class="time">10:30</span>
									<span>HKG</span>
								</div>
							</div>
							<div class="tcell colh ccol">
								<div class="flight_general">
									<div class="flight_general"><span class="mark_booked">
										<a href="javascript:void(0)" onclick="loadFSResultToRow(event, 1)">
									<span class="tick"></span><span data-i18n="flight.Select">Select</span></a></span>
								</div>
								</div>
							</div>
						</div>
						
					<!--</div>-->
						
				</div>
				<div id="faResultStatusWrapper" class="">
					<div class="error-box disabled">
						<p class="error-message" style="text-align: left;">Flight not found</p>
						<div class="errorTable">
							<div class="errorTableBody">
								
							</div>
						</div>
					</div>
					<div class="loading-main disabled">
						<span id="loading_message" data-i18n="common.Loading">Loading</span>
					</div>
				</div>
			</div>
		</div>
	</div>
	
	<div class="booking_lb lity-hide cx" id="flight_edit" style="width: 100%; min-width: 900px; max-width: 900px;">
		<div class="lightbox_ctr" style="width: 100%;">
			<div class="close_ctr"><a id="btn_flight_edit_close" href="javascript:void(0)" class="close_btn" onclick="closeFlightEdit(event)"></a></div>
			<div class="lightbox_blk">
				<h3 data-i18n="flight.Flights">Flights</h3>
				<div class="blkc"></div>
			
				<div class="blk_filter">
					<div class="head_hr"></div>
					<div class="consign_info">
						<div class="cnt_inline bu_txt w64 mr5">
							<label for="flight_flt_no"><span data-i18n="cargoInfo.FlightNo">Flight No.</span>*</label>
							<input type="text" value="" id="flight_flt_no" class="flight_num_input">
							<div class="error_or_msg" style="display: none;" data-i18n="flight.Invalid">Invalid</div>
						</div>
						<div class="cnt_inline bu_txt chk_dept">
							<label for="flt_date"><span data-i18n="flight.Date">Date</span>*</label>
							<div id="datepicker_edit" class="input-group date" data-date-format="yyyy-MM-dd" style="margin-bottom: 0px;">
								<input class="form-control" type="text" readonly="" id="flight_flt_date">
								<span class="input-group-addon" style=""><i class="glyphicon glyphicon-calendar"></i></span>
							</div>
							<div class="error_or_msg" style="display: none;" data-i18n="flight.Invalid">Invalid</div>
						</div>
						<div class="cnt_inline bu_txt chk_location top">
							<label for="flight_flt_from" data-i18n="flight.From">From</label>
							<input type="text" value="" placeholder="Port Code" id="flight_flt_from" class="port_query flight_flt" autocomplete="off">
							<div class="error_or_msg" style="display: none;" data-i18n="flight.Invalid">Invalid</div>
						</div>
						<div class="cnt_inline chk_to"></div>
						<div class="cnt_inline bu_txt chk_location mr5 top">
							<label for="flight_flt_to" data-i18n="flight.To">To</label>
							<input type="text" value="" placeholder="Port Code" id="flight_flt_to" class="port_query flight_flt" autocomplete="off">
							<div class="error_or_msg" style="display: none;" data-i18n="flight.Invalid">Invalid</div>
						</div>
						<div class="cnt_inline bu_txt w145 mr4 b878 disabled">
							<label for="flight_flt_allt" data-i18n="flight.AllotmentID">Allotment ID</label>
							<input type="text" value="" id="flight_flt_allt">
							<div class="error_or_msg" style="display: none;" data-i18n="flight.Invalid">Invalid</div>
						</div>
						<div class="cnt_inline bu_txt w48 b878 mr5">
							<label for="flight_flt_alloc"><span data-i18n="flight.AllocCode">Alloc</span>*</label>
							<select class="select_bu" id="flight_flt_alloc">
								<option>NN</option>
								<option>CA</option>
								<option disabled="">NA</option>
								<option disabled="">SS</option>
								<option>XX</option>
							</select>
							<input type="hidden" value="" id="flight_flt_alloc_hd">
						</div>
						<div class="cnt_inline bu_txt w84 mr5">
							<label for="flight_pcs"><span data-i18n="cargoInfo.Pieces">Pieces</span></label>
							<input type="text" value="" id="flight_pcs" class="flight_int_input" maxlength="4">
							<div class="error_or_msg" style="display: none;" data-i18n="cargoInfo.InvalidPieces">Invalid Pieces</div>
						</div>
						<div class="cnt_inline bu_txt w84 mr5">
							<label for="flight_weight"><span data-i18n="cargoInfo.Weight">Weight</span></label>
							<input type="text" value="" id="flight_weight" class="flight_dec_input flight_dec_input_weight" maxlength="7">
							<div class="error_or_msg" style="display: none;" data-i18n="cargoInfo.InvalidWeight">Invalid Weight</div>
						</div>
						<div class="cnt_inline bu_txt w84 mr5">
							<label for="flight_vol"><span data-i18n="cargoInfo.Volume">Volume</span></label>
							<input type="text" value="" id="flight_vol" class="flight_dec_input flight_dec_input_volume" maxlength="9">
							<div class="error_or_msg" style="display: none;" data-i18n="cargoInfo.InvalidVolume">Invalid Volume</div>
						</div>
						<a id="bd_flight_edit_del_btn" href="javascript:void(0)" class="btn_bu_delete mr10" onclick="delFlightEditRow(event)"></a>
					
						<div class="blkc"></div>
					
						<!--<div id="bkd_TW_WarehouseCode" style="padding-top: 12px">
							<div class="cnt_inline mr5">
								<label for="bkdTWWhsCode" style="padding-right: 12px" data-i18n="flight.WarehouseCode">Warehouse Code</label>
								<select class="select_bu" id="bkdTWWhsCode">
									<option value="" data-i18n="cargoInfo.PleaseSelect">Please select</option>
								</select>
							</div>
						</div>-->
					
					</div>
					
				</div>
				<div>
					<a href="javascript:void(0)" class="link_bu_l2" style="float: left;" onclick="closeFlightEdit(event)" data-i18n="common.Cancel">Cancel</a>
					<span href="javascript:void(0)" class="btn_or_l" onclick="saveFlightEdit()" data-i18n="common.Save">Save</span>
					<div class="blkc"></div>
				</div>
				
				
				
			</div>
		</div>
	</div>
	
	<div class="booking_lb lity-hide" id="flight_warehouse_edit" style="width: 100%; min-width: 900px; max-width: 900px;">
		<div class="lightbox_ctr" style="width: 100%;">
			<div class="close_ctr"><a id="btn_flight_edit_close" href="javascript:void(0)" class="close_btn" onclick="closeFlightEdit(event)"></a></div>
			<div class="lightbox_blk">
				<h3 data-i18n="flight.Flights">Flights</h3>
				<div class="blkc"></div>
			
				<div class="blk_filter">
					<div class="head_hr"></div>
					<div class="consign_info">
					
						<div id="bkd_TW_WarehouseCode" style="padding-top: 12px">
							<div class="cnt_inline mr5">
								<label for="bkdTWWhsCode" style="padding-right: 12px" data-i18n="flight.WarehouseCode">Warehouse Code</label>
								<select class="select_bu" id="bkdTWWhsCode">
									<option value="" data-i18n="cargoInfo.PleaseSelect">Please select</option>
								</select>
								<div class="error_or_msg" style="display: none;" data-i18n="common.Required">Required</div>
							</div>
						</div>
					
					</div>
					
				</div>
				<div>
					<a href="javascript:void(0)" class="link_bu_l2" style="float: left;" onclick="closeFlightEdit(event)" data-i18n="common.Cancel">Cancel</a>
					<span href="javascript:void(0)" class="btn_or_l" onclick="saveFlightWarehouseEdit()" data-i18n="common.Save">Save</span>
					<div class="blkc"></div>
				</div>
				
			</div>
		</div>
	</div>
	<input type="hidden" id="flight_hd_edit_rowid" value="">

</div>

<script id="flt_row_temp" type="text/x-template">
	<div class="trow fa_result_row" style="display: table-row;">
		<div class="tcell col1 colh">
			<b>%ROW_INX%.</b>
		</div>
		<div class="tcell cols">
			<div class="flight_num_l"><span>%FLIGT_NUM%</span></div>
		</div>
		<div class="tcell cols">
			<div class="flight_general">
				<span class="time">%ORIG_T%</span>
				<span>%ORIG%</span>
			</div>
			<div class="flight_general">
				<div class="flight_to">
				</div>
			</div>
		</div>
		<div class="tcell cols">
			<div class="flight_general"><span class="time">%DEST_T%</span><span>%DEST%</span></div>
		</div>
		<div class="tcell colh ccol">
			<div class="flight_general"><span class="mark_booked">
				<a href="javascript:void(0)" onclick="loadFSResultToRow(event, %ROW_INX_RS%)">
				<span class="tick"></span><span data-i18n="flight.Select">Select</span></a></span>
			</div>
		</div>
	</div>
</script>

<script id="flt_row_temp_merged" type="text/x-template">
	<div class="merged trow fa_result_row" style="display: table-row;">
		<div class="ecell col1 colh">

		</div>
		<div class="tcell cols">
			<div class="flight_num_l"><span>%FLIGT_NUM%</span></div>
		</div>
		<div class="tcell cols">
			<div class="flight_general"><span class="time">%ORIG_T%</span><span>%ORIG%</span></div>
			<div class="flight_general"><div class="flight_to"></div></div>
		</div>
		<div class="tcell cols">
			<div class="flight_general"><span class="time">%DEST_T%</span><span>%DEST%</span></div>
		</div>
		<div class="ecell colh ccol">
			<div class="flight_general"><span class="mark_booked">
				<a href="javascript:void(0)" onclick="loadFSResultToRow(event, %ROW_INX_RS%)">
				<span class="tick"></span><span data-i18n="flight.Select">Select</span></a></span>
			</div>
		</div>
	</div>
</script>


<script id="fld_flight_detail_temp" type="text/x-template">
	<li data-rowid="%rowid%">
		<div class="cola" style="width: 110px;"><span class="flight_detail_temp">%DEPT%</span><div class="cnt_inline chk_to"></div><span class="flight_detail_temp">%ARRIVAL%</span></div>
		<div class="cola" style="width: 70px;"><span class="flight_detail_temp flight_num_display">%FLT_NUM%</span></div>
		<div class="blklc w991"></div>
		<div class="colb" style="width: 130px;"><label data-i18n="flight.Departure">Departure</label><span class="flight_detail_temp">%DEPT_DT%</span></div>
		<div class="colb" style="width: 130px;"><label data-i18n="flight.Arrival">Arrival</label><span class="flight_detail_temp">%ARRIVAL_DT%</span></div>
		<div class="colb" style="width: 130px;"><label data-i18n="flight.AllotmentID">Allotment ID</label><span class="flight_detail_temp">%ALLOT_ID%</span></div>
		<div class="colb" style="width: 130px;"><label data-i18n="cargoInfo.Pieces">Pieces</label><span class="flight_detail_temp">%PIECES%</span></div>
		<div class="colb" style="width: 130px;"><label data-i18n="cargoInfo.Weight">Weight</label><span class="flight_detail_temp">%WEIGHT%</span></div>
		<div class="colb" style="width: 130px;"><label data-i18n="cargoInfo.Volume">Volume</label><span class="flight_detail_temp">%VOLUME%</span></div>
		<div class="blklc w630"></div>
		<div class="colb"><div class="%REMARK_TYPE%"><span class="flight_detail_remark_mark"></span>%REMARK%</div></div>
		<a href="#edit_flight" class="btn_gy_edit" onclick="openFlightEdit(event, %rowid%)"></a>
	</li>
</script>

<script id="fld_flight_detail_temp_del" type="text/x-template">
	<li data-rowid="%rowid%">
		<div class="cola" style="width: 110px;"><span class="bd_flight_del_txt">%DEPT%</span><div class="cnt_inline chk_to"></div><span class="bd_flight_del_txt">%ARRIVAL%</span></div>
		<div class="cola" style="width: 70px;"><span class="bd_flight_del_txt flight_num_display">%FLT_NUM%</span></div>
		<div class="blklc w991"></div>
		<div class="colb" style="width: 130px;"><label data-i18n="flight.Departure">Departure</label><span class="bd_flight_del_txt">%DEPT_DT%</span></div>
		<div class="colb" style="width: 130px;"><label data-i18n="flight.Arrival">Arrival</label><span class="bd_flight_del_txt">%ARRIVAL_DT%</span></div>
		<div class="colb" style="width: 130px;"><label data-i18n="flight.AllotmentID">Allotment ID</label><span class="bd_flight_del_txt">%ALLOT_ID%</span></div>
		<div class="colb" style="width: 130px;"><label data-i18n="cargoInfo.Pieces">Pieces</label><span class="bd_flight_del_txt">%PIECES%</span></div>
		<div class="colb" style="width: 130px;"><label data-i18n="cargoInfo.Weight">Weight</label><span class="bd_flight_del_txt">%WEIGHT%</span></div>
		<div class="colb" style="width: 130px;"><label data-i18n="cargoInfo.Volume">Volume</label><span class="bd_flight_del_txt">%VOLUME%</span></div>
		<div class="blklc w630"></div>
		<div class="colb"><div class="%REMARK_TYPE%"><span></span>%REMARK%</div></div>
	</li>
</script>

<script id="flt_input_row_temp" type="text/x-template">
	<li class="flight_segment_input_row extra_row" data-rowid="%ID%" style="margin-right: 50px;">
		<div class="cnt_inline bu_txt w64 mr5">
			<input type="text" value="" id="flight_flt_no_%ID%" class="flight_num_input">
			<div class="error_or_msg" style="display: none;" data-i18n="flight.Invalid">Invalid</div>
		</div>
		<div class="cnt_inline bu_txt chk_dept">
            <div id="datepicker_%ID%" class="input-group date" data-date-format="yyyy-mm-dd" style="margin-bottom: 0px;">
                <!--<input class="form-control" type="text" readonly id="flight_flt_date_%ID%">-->
                <input class="form-control" type="text" placeholder="YYYY-MM-DD" id="flight_flt_date_%ID%">
                <span class="input-group-addon" style=""><i class="glyphicon glyphicon-calendar"></i></span>
            </div>
			<div class="error_or_msg" style="display: none;" data-i18n="flight.Invalid">Invalid</div>
		</div>
		<div class="cnt_inline bu_txt chk_location">
			<input type="text" value="" placeholder="City name or code" id="flight_flt_from_%ID%" class="port_query flight_flt">
			<div class="error_or_msg" style="display: none;" data-i18n="flight.Invalid">Invalid</div>
		</div>
		<div class="cnt_inline chk_to"></div>
		<div class="cnt_inline bu_txt chk_location mr5">
			<input type="text" value="" placeholder="City name or code" id="flight_flt_to_%ID%" class="port_query flight_flt">
			<div class="error_or_msg" style="display: none;" data-i18n="flight.Invalid">Invalid</div>
		</div>
		<div class="cnt_inline bu_txt w145 mr4 b878">
			<input type="text" value="" id="flight_flt_allt_%ID%">
			<div class="error_or_msg" style="display: none;" data-i18n="flight.Invalid">Invalid</div>
		</div>
		<div class="cnt_inline bu_txt w48 b878 mr5">
			<select class="select_bu" id="flight_flt_alloc_%ID%">
				<option>NN</option>
				<option>CA</option>
				<option disabled>NA</option>
				<option disabled>SS</option>
				<option>XX</option>
			</select>
			<input type="hidden" value="" id="flight_flt_alloc_hd_%ID%">
		</div>
		<div class="act_bu act_add_col btnCheckAvail">
			<span>
				<a onclick="openFSLb(event)" href="javascript:void(0)" data-i18n="flight.CheckAvail">Check availability</a>
			</span>
		</div>
	</li>
</script>

<script>
	$(function() {
		var id = "#bkd_def_flight";
		var flightLity;

		var splitBookingErrCtrl = new msgCtrl(
			function(){
				_.forEach(splitBookingErrCtrl.get(), function(err) {
					$("#split_book_error_wrapper ul").append('<li class="error_or_msg">'+err+'</li>');
				});
			},
			function(){
				$("#split_book_error_wrapper li").remove();
			}
		);
		
		$(id).on("clear", function(event) {
			//console.log(data);
			//debugger;
			clearEditErrorMsgFlight();
			flightResetEdit();
			$("#fld_flight_table").empty();
			
		});
		
		$(id).on("init", function(event, data) {
			console.log(data);
			
		});
		
		$(id).on("validate", function() {
			var isValid = true;

			var bkdCargoinfoData = "";
			if (typeof localStorage.getItem("bd_cargo_info_edit") !== 'undefined' && localStorage.getItem("bd_cargo_info_edit") != null) {
				bkdCargoinfoData = JSON.parse(localStorage.getItem("bd_cargo_info_edit"));
			} else if (typeof localStorage.getItem("bd_cargo_info") !== 'undefined' && localStorage.getItem("bd_cargo_info") != null) {
			 	bkdCargoinfoData = JSON.parse(localStorage.getItem("bd_cargo_info"));
			}

			var masterPieces = bkdCargoinfoData.Pieces;
			var masterWeight = bkdCargoinfoData.Weight;
			var masterVolume = bkdCargoinfoData.Volume;
			var weightUnit = bkdCargoinfoData.WeightCode == 0 ? i18next.t("cargoInfo.KG") : i18next.t("cargoInfo.LB");
			var volUnit = bkdCargoinfoData.VolumeCode == 0 ? i18next.t("cargoInfo.MC") : i18next.t("cargoInfo.CF");

			var bkdFlightData = "";
			var bkdFlightSegments = [];
			if (typeof localStorage.getItem("bd_flight_edit") !== 'undefined' && localStorage.getItem("bd_flight_edit") != null) {
				bkdFlightData = JSON.parse(localStorage.getItem("bd_flight_edit"));
			 	bkdFlightSegments = _.filter(bkdFlightData.FlightDetail, function(o) { return o.IsDelete == 0; });
			}

			var origs = [];
			var dests = [];

			var fromHkgObj = {
			 	pieces: 0,
			 	weight: 0,
			 	volume: 0
			};

			var toHkgObj = {
				pieces: 0,
			 	weight: 0,
			 	volume: 0
			};

			if (typeof bkdFlightSegments !== 'undefined' && bkdFlightSegments != null) {
			 	for (var i = 0; i < bkdFlightSegments.length; i++) {
			 		var pieces;
			 		var weight;
			 		var volume;

			 		if(bkdFlightSegments[i].FlightDetailCx){
			 			pieces = bkdFlightSegments[i].FlightDetailCx.Pieces;
			 			weight = bkdFlightSegments[i].FlightDetailCx.Weight;
			 			volume = bkdFlightSegments[i].FlightDetailCx.Volume;
			 		}

			 		var from = bkdFlightSegments[i].DeparturePort;
			 		var to = bkdFlightSegments[i].ArrivalPort;

			 		if(from && from.toUpperCase() == "HKG"){
			 			if(StringFormatChecker.checkInteger(true, pieces)) fromHkgObj.pieces += parseInt(pieces);
                            if (StringFormatChecker.checkFloat(true, weight)) fromHkgObj.weight += parseFloat(weight);
                            if (StringFormatChecker.checkFloat(true, volume)) fromHkgObj.volume += parseFloat(volume);
			 		}
			 		else if(to && to.toUpperCase() == "HKG"){
			 			if(StringFormatChecker.checkInteger(true, pieces)) toHkgObj.pieces += parseInt(pieces);
                            if (StringFormatChecker.checkFloat(true, weight)) toHkgObj.weight += parseFloat(weight);
                            if (StringFormatChecker.checkFloat(true, volume)) toHkgObj.volume += parseFloat(volume);
			 		}

			 		if(from)
			 			origs.push(from);

			 		if(to)
			 			dests.push(to);		
			 	}
			}

            fromHkgObj.weight =fromHkgObj.weight.toFixed(1);
            fromHkgObj.volume=fromHkgObj.volume.toFixed(3);
            toHkgObj.weight=toHkgObj.weight.toFixed(1);
            toHkgObj.volume=toHkgObj.volume.toFixed(3);

			//remove all split booking errs
			 splitBookingErrCtrl.dropAll();

			if (typeof bkdFlightSegments !== 'undefined' && bkdFlightSegments != null) {
			 	for (var i = 0; i < bkdFlightSegments.length; i++) {
			 		var isSplitBooking = false;
			 		var pieces;
			 		var weight;
			 		var volume;

			 		if(bkdFlightSegments[i].FlightDetailCx){
			 			pieces = bkdFlightSegments[i].FlightDetailCx.Pieces;
			 			weight = bkdFlightSegments[i].FlightDetailCx.Weight;
			 			volume = bkdFlightSegments[i].FlightDetailCx.Volume;
			 		}

			 		var from = bkdFlightSegments[i].DeparturePort;
			 		var to = bkdFlightSegments[i].ArrivalPort;

			 		if(_.filter(origs, function(o) { return o == from; }).length > 1 || _.filter(dests, function(d) { return d == to; }).length > 1){
			 			isSplitBooking = true;
			 		}
					
			 		if(isSplitBooking) {
			 			//pieces
			 			if(!StringFormatChecker.checkInteger(true, pieces, 1, 9999)){
			 				splitBookingErrCtrl.add(i18next.t('flight.SplitBookingInfoRequired').replace("$row$", i + 1));
			 				isValid = false;
			 			}
			 			else if(pieces && (from && masterPieces && from.toUpperCase() == "HKG" && fromHkgObj.pieces > masterPieces) ||
			 					(to && masterPieces && to.toUpperCase() == "HKG" && toHkgObj.pieces > masterPieces)){
			 				splitBookingErrCtrl.add(i18next.t('flight.SegmentPieceExceed').replace("$piece$", masterPieces));
			 				isValid = false;
			 			}

			 			//weight
                            var FloatmasterWeight = parseFloat(masterWeight).toFixed(1);
			 			if(!StringFormatChecker.checkFloat(true, weight, 0.1, 9999999, 1)){
			 				splitBookingErrCtrl.add(i18next.t('flight.SplitBookingInfoRequired').replace("$row$", i + 1));
			 				isValid = false;
			 			}
                            else if (weight && (from && FloatmasterWeight && from.toUpperCase() == "HKG" && fromHkgObj.weight > FloatmasterWeight) ||
                                (to && FloatmasterWeight && to.toUpperCase() == "HKG" && toHkgObj.weight > FloatmasterWeight)){
                                splitBookingErrCtrl.add(i18next.t('flight.SegmentWeightExceed').replace("$weight$", FloatmasterWeight).replace("$weightUnit$", weightUnit));
			 				isValid = false;
			 			}

			 			//volume
                            var FloatMasterVolume = parseFloat(masterVolume).toFixed(3);
			 			if(!StringFormatChecker.checkFloat(true, volume, 0.001, 999999999, 3)){
			 				splitBookingErrCtrl.add(i18next.t('flight.SplitBookingInfoRequired').replace("$row$", i + 1));
			 				isValid = false;
			 			}
                            else if (volume && (from && FloatMasterVolume && from.toUpperCase() == "HKG" && fromHkgObj.volume > FloatMasterVolume) ||
                                (to && FloatMasterVolume && to.toUpperCase() == "HKG" && toHkgObj.volume > FloatMasterVolume)){
                                splitBookingErrCtrl.add(i18next.t('flight.SegmentVolExceed').replace("$vol$", FloatMasterVolume).replace("$volUnit$", volUnit));
			 				isValid = false;
			 			}
			 		}
			 	}
			}

			//for auto scroll
			if(!isValid){
			 	$("#fld_flight_table").addClass("error_tag");
			}
			else{
			 	$("#fld_flight_table").removeClass("error_tag");
			}

			return isValid;
		});

		$(id).on("getData", function(event, dataID) {
			var rtn;
			var seq;
			var dataType = dataID.substring(0, dataID.lastIndexOf("_"));
			if (dataType == "") {
				dataType = dataID;
			} else {
				seq = dataID.substring(dataID.lastIndexOf("_")+1);
			}
			
			switch(dataType) {
				case "AllFlightNo":
					var flightNoList = [];
					$('#fld_flight_table .flight_num_display').each(function(index, el){
						if(el.textContent)
							flightNoList.push(el.textContent.toUpperCase());
					})
					rtn = flightNoList;
					break;
			}
			
			return rtn;
		});
		
		$(id).on("submit", function() {
			
			var flightSegment = [];

			var bkdCargoinfoData = "";
			if (typeof localStorage.getItem("bd_cargo_info_edit") !== 'undefined' && localStorage.getItem("bd_cargo_info_edit") != null) {
				bkdCargoinfoData = JSON.parse(localStorage.getItem("bd_cargo_info_edit"));
			} else if (typeof localStorage.getItem("bd_cargo_info") !== 'undefined' && localStorage.getItem("bd_cargo_info") != null) {
			 	bkdCargoinfoData = JSON.parse(localStorage.getItem("bd_cargo_info"));
			}

			var masterPieces = bkdCargoinfoData.Pieces;
			var masterWeight = bkdCargoinfoData.Weight;
			var masterVolume = bkdCargoinfoData.Volume;

			var bkdData = "";
			if (typeof localStorage.getItem("bd_flight_edit") !== 'undefined' && localStorage.getItem("bd_flight_edit") != null) {
				bkdData = JSON.parse(localStorage.getItem("bd_flight_edit"));
			}
			
			if (typeof bkdData.FlightDetail !== 'undefined' && bkdData.FlightDetail != null) {
				for (var i = 0; i < bkdData.FlightDetail.length; i++) {
					
					if (bkdData.FlightDetail[i].IsDelete == 0) {
						var obj = new Object();
						obj.FlightNo = bkdData.FlightDetail[i].FlightNum;
						//Remarks, Remove time on purpose, to avoid time issue
						obj.FlightDate = new Date(bkdData.FlightDetail[i].DeptFlightDate).ToString(DateTimeFormat.YearMonthDate);
						obj.From = bkdData.FlightDetail[i].DeparturePort;
						obj.To = bkdData.FlightDetail[i].ArrivalPort;
						obj.AllotmentID = bkdData.FlightDetail[i].AllotmentId;
						obj.AllocationCode = bkdData.FlightDetail[i].AllocationCode;
						if(bkdData.FlightDetail[i].FlightDetailCx){
						 	obj.FlightDetailCx ={
						 		Pieces: bkdData.FlightDetail[i].FlightDetailCx.Pieces.toString() || masterPieces.toString(),
						 		Weight: bkdData.FlightDetail[i].FlightDetailCx.Weight.toString() || masterWeight.toString(),
						 		Volume: bkdData.FlightDetail[i].FlightDetailCx.Volume.toString() || masterVolume.toString()
						 	};
						}

						if (obj.FlightNo == "" && obj.FlightDate == "" && obj.From == "" && obj.To == "" && obj.AllotmentID == "") {	
						} else {
							flightSegment.push(obj);
						}
					}
					
				}
			}
			
			var warehouseCode = "";
			if (typeof bkdData.WarehouseCode !== 'undefined' && bkdData.WarehouseCode != null) {
				warehouseCode = bkdData.WarehouseCode;
			}
			
			return { 
				"FlightSegmentInfo" : {
					"FlightSegment" : flightSegment,
					"CxUseAutoAllot": false,
					"CxWarehouseCode": warehouseCode
				}
			};
			
		});
		
		$(id).on("loadBookingData", function(event, bkdData) {

            if (localStorage.getItem("userCity") != null) {
                if (localStorage.getItem("userCity") == "TPE") {
                    //bkdCXRegTWWarehouseCode();
                    $("#fld_disp_TW_WarehouseCode_wrapper").css("display", "block");
                }
                else {
                    $("#fld_disp_TW_WarehouseCode_wrapper").css("display", "none");
                }
            }

			console.log(bkdData);
			
			var obj = new Object();
			obj.FlightDetail = [];
			obj.WarehouseCode = "";

			for (var i = 0; i < bkdData.FlightDetail.length; i++) {
				var fd = new Object();
				fd.CarrierCode = bkdData.FlightDetail[i].CarrierCode.toUpperCase();
				fd.DeparturePort = bkdData.FlightDetail[i].DeparturePort.toUpperCase();
				fd.ArrivalPort = bkdData.FlightDetail[i].ArrivalPort.toUpperCase();
				fd.FlightNum = bkdData.FlightDetail[i].CarrierCode.toUpperCase() + bkdData.FlightDetail[i].FlightNum;

				if(bkdData.FlightDetail[i].FlightDetailCx){
					fd.FlightDetailCx = {
						Pieces: bkdData.FlightDetail[i].FlightDetailCx.Pieces,
						Weight: bkdData.FlightDetail[i].FlightDetailCx.Weight,
						Volume: bkdData.FlightDetail[i].FlightDetailCx.Volume
					}
				}

				if (typeof bkdData.FlightDetail[i].DepartureDate !== 'undefined' && bkdData.FlightDetail[i].DepartureDate != null) {
					fd.DeptFlightDate = new Date(getAPIDate(bkdData.FlightDetail[i].DepartureDate));
				} else {
					fd.DeptFlightDate = "";
				}if (typeof bkdData.FlightDetail[i].ArrivalDate !== 'undefined' && bkdData.FlightDetail[i].ArrivalDate != null) {
					fd.ArrivalFlightDate = new Date(getAPIDate(bkdData.FlightDetail[i].ArrivalDate));
				} else {
					fd.ArrivalFlightDate = "";
				}
				fd.AllotmentId = bkdData.FlightDetail[i].AllotmentId;
				//fd.AllocationCode = bkdData.FlightDetail[i].SpaceAllocationCode;
				fd.IsDelete = 0;
				//objRoute.FlightDetail.push(fd);
				
				if (typeof bkdData.FlightDetail[i].FlightDetailCx !== 'undefined' && bkdData.FlightDetail[i].FlightDetailCx != null) {
					fd.FCTLStatusX = bkdData.FlightDetail[i].FlightDetailCx.FCTLStatusX;
					fd.AllocationCode = bkdData.FlightDetail[i].FlightDetailCx.FCTLStatus;					
				} else {
					fd.FCTLStatusX = "";
					fd.AllocationCode = "";
				}
				
				obj.FlightDetail.push(fd);
			}
			
			if (typeof bkdData.Cx !== 'undefined' && bkdData.Cx != null) {
				obj.WarehouseCode = bkdData.Cx.WarehouseCode;
			}
			
			//localStorage.setItem("bd_routing", JSON.stringify(objRoute));
			localStorage.setItem("bd_flight", JSON.stringify(obj));
			localStorage.setItem("bd_flight_edit", JSON.stringify(obj));
			
			fltRefreshDisplay();
			
		});
		
		$("#btnAddSegment").click(function (e) {
			e.preventDefault();
			AddFlightSegmentInput();
		});
		
		$("#btn_flt_src_close").click(function (e) {
			e.preventDefault();
			lityInstance.close();
		});
		
		function AddFlightSegmentInput(cID, dID, callback) {

			var row = $("#flt_input_row_temp").html();
			
			var currentRowID = getComponentRowID("flight_segment_input_row");
			row = row.replaceAll("%ID%", currentRowID + 1);
			$(".flight_segment_input_wrapper").append(row);
			var newRowID = currentRowID + 1;
			$("#flight_flt_date_" + newRowID).datepicker({
	            format: 'yyyy-mm-dd',
				autoclose: true,
	            startDate: new Date(),
	            clearBtn: true
			});

			$("#flight_flt_date_" + newRowID).blur(function () {
				val = $(this).val();
				val1 = Date.parse(val);
				if (isNaN(val1) == true && val !== '') {
					$(this).datepicker("setDate", new Date());
				}
			});

			if (typeof callback === "function" && typeof cID !== 'undefined' && typeof dID !== 'undefined') {
				callback(cID, dID);
			}

			regPortQueryV2();
		}
		
	});	
		
	function showOneRecordJson(type){
            let params = "scrollbars=yes,resizable=no,status=no,location=no,toolbar=no,menubar=no,width=1000,height=500";
            if(type == "awb_1r"){
			    var objOneRecord = {}
				$.getJSON("json/OneRecord_160-10039654.json", function(json) {
					objOneRecord = json;
				});
                var oneRecord_window = window.open("/1R_Display.html", "One Record", params);
                oneRecord_window.document.write("<head><title>One Record</title></head>");
                oneRecord_window.document.write("<pre>" + JSON.stringify(objOneRecord, null, 2) + "</pre>");
            }
            else if(type == "raw"){
                var rawData_window = window.open("/1R_Display.html", "One Record", params);
                rawData_window.document.write("<head><title>Raw Data</title></head>");
                rawData_window.document.write("<pre>" + JSON.stringify(objRawData, null, 2) + "</pre>");
            }
            
        }

	function fltRefreshDisplay() {
		
		$("#fld_flight_table").empty();
		
		var bkdData = "";
		var bkdDataOrigin = "";
		if (typeof localStorage.getItem("bd_flight_edit") !== 'undefined' && localStorage.getItem("bd_flight_edit") != null) {
			bkdData = JSON.parse(localStorage.getItem("bd_flight_edit"));
		} else if (typeof localStorage.getItem("bd_flight") !== 'undefined' && localStorage.getItem("bd_flight") != null) {
			bkdData = JSON.parse(localStorage.getItem("bd_flight"));
		}
		
		if (typeof localStorage.getItem("bd_flight") !== 'undefined' && localStorage.getItem("bd_flight") != null) {
			bkdDataOrigin = JSON.parse(localStorage.getItem("bd_flight"));
		}
	
		if (bkdData != "") {
			//console.log("fltRefreshDisplay: " + JSON.stringify(bkdData));
			
			var flightTemp = $("#fld_flight_detail_temp").html();
			var flightContent;
			for (var i = 0; i < bkdData.FlightDetail.length; i++) {
				
				var carrierCode = bkdData.FlightDetail[i].CarrierCode;
				var departurePort = bkdData.FlightDetail[i].DeparturePort;
				var arrivalPort = bkdData.FlightDetail[i].ArrivalPort;
				var flightNum = bkdData.FlightDetail[i].FlightNum;
				if (isNaN(Date.parse(bkdData.FlightDetail[i].DeptFlightDate))){
					var deptFlightDate = "";
				} else {
					var deptFlightDate = new Date(bkdData.FlightDetail[i].DeptFlightDate);
				}
				
				if (isNaN(Date.parse(bkdData.FlightDetail[i].ArrivalFlightDate))){
					var arrivalFlightDate = "";
				} else {
					var arrivalFlightDate = new Date(bkdData.FlightDetail[i].ArrivalFlightDate);
				}
				
				var allotmentId = bkdData.FlightDetail[i].AllotmentId.trim() || "-";
				
				if (allotmentId != "-") {
					allotmentId = "Allotted Booking";
				}				
				
				var allocationCode = bkdData.FlightDetail[i].AllocationCode;
				var remarkType = "N";
				var remarkClass = "blk_error";
                var remark = bkdData.FlightDetail[i].FCTLStatusX;

				var pieces;
				var weight;
				var volume;

				if(bkdData.FlightDetail[i].FlightDetailCx){
					pieces = bkdData.FlightDetail[i].FlightDetailCx.Pieces || '-';
					weight = bkdData.FlightDetail[i].FlightDetailCx.Weight || '-';
					volume = bkdData.FlightDetail[i].FlightDetailCx.Volume || '-';
				}
				else{
					pieces = '-';
					weight = '-';
					volume = '-';
				}

				if (typeof goodReplyMessage !== 'undefined' && goodReplyMessage != null) {
					if (goodReplyMessage.indexOf(remark) > -1) {
						remarkType = "Y";
					}
				}
				//var remark = "Flight not available for booking";
				if (remarkType != "N") {
					remarkClass = "ball_bu";
					//remark = "Book not accept alternative";
				}
				
				if (bkdData.FlightDetail[i].IsDelete == 1) {
					flightTemp = $("#fld_flight_detail_temp_del").html();
				} else {
					flightTemp = $("#fld_flight_detail_temp").html();
				}

				flightContent = flightTemp.replace("%DEPT%", departurePort).replace("%ARRIVAL%", arrivalPort)
				.replace("%FLT_NUM%", flightNum)
				.replace("%ALLOT_ID%", allotmentId)
				.replace("%REMARK_TYPE%", remarkClass)
				.replace("%REMARK%", remark)
				.replace("%PIECES%", pieces)
				.replace("%WEIGHT%", weight)
				.replace("%VOLUME%", volume)
				.replaceAll("%rowid%", i);
				
				if (arrivalFlightDate == "") {
					flightContent = flightContent.replace("%ARRIVAL_DT%", "-");
				} else {
					flightContent = flightContent.replace("%ARRIVAL_DT%", arrivalFlightDate.ToString(DateTimeFormat.DateMonthTime));
				}
				
				if (deptFlightDate == "") {
					flightContent = flightContent.replace("%DEPT_DT%", "-");
				} else {
					flightContent = flightContent.replace("%DEPT_DT%", deptFlightDate.ToString(DateTimeFormat.DateMonth));
				}
				
				if (bkdData.FlightDetail[i].IsDelete == 1 && (bkdDataOrigin.FlightDetail[i] === 'undefined' || bkdDataOrigin.FlightDetail[i] == null)) {
				} else {
					$("#fld_flight_table").append(flightContent);
				}
				
				if (remark == "") {
					$("li[data-rowid='"+i+"'] .flight_detail_remark_mark").hide();
				} else {
					$("li[data-rowid='"+i+"'] .flight_detail_remark_mark").show();
				}
				
			}
			
			$("#fld_disp_warehouse_code").text(getWarehouseFull(bkdData.WarehouseCode));
			
			updateIndicatorFlight();
			
			if (bkdData.FlightDetail.length >= 10) {
				$(".act_add_flights").css("display", "none");
			} else {
				$(".act_add_flights").css("display", "inline-block");
			}
		}
		
	}
	
	// flight edit
	
	function openFlightEdit(e, rowid) {
		e.preventDefault();
		clearEditErrorMsgFlight();
		flightResetEdit();
		regFlightInit();
		if (typeof rowid !== 'undefined' && rowid != null) {
			loadEditDataFlight(rowid);
			$("#bd_flight_edit_del_btn").show();
		} else {
			$("#flight_hd_edit_rowid").val("");
			$("#bd_flight_edit_del_btn").hide();
		}
		flightLity = lity('#flight_edit');

		//$('.flight_flt').attr("placeholder", i18next.t("BookingLandingPage.CityNameOrCode"));
	}
	
	function closeFlightEdit(e) {
		if (typeof e !== 'undefined' && e != null) {
			e.preventDefault();
		}
		flightLity.close();
	}
	
	function regFlightInit() {
		regPortQueryV2();
		
		$("#flight_flt_date").datepicker({
            format: 'yyyy-mm-dd',
			autoclose: true,
            startDate: new Date(),
            clearBtn: true
        });
		
		$("#flight_flt_date").blur(function () {
			val = $(this).val();
			val1 = Date.parse(val);
			if (isNaN(val1) == true && val !== '') {
				$(this).datepicker("setDate", new Date());
			}
		});
		
	}
	
	function loadEditDataFlight(rowid) {
		
		flightResetEdit();
		
		var flightDate;
		var flightDateTxt;
		var bkdData = "";
		if (typeof localStorage.getItem("bd_flight_edit") !== 'undefined' && localStorage.getItem("bd_flight_edit") != null) {
			bkdData = JSON.parse(localStorage.getItem("bd_flight_edit"));
		}
		
		if (bkdData != "") {
			$("#flight_hd_edit_rowid").val(rowid);
		
			$("#flight_flt_no").val(bkdData.FlightDetail[rowid].FlightNum);
			if (bkdData.FlightDetail[rowid].DeptFlightDate != "") {
				flightDate = new Date(bkdData.FlightDetail[rowid].DeptFlightDate);
				flightDateTxt = flightDate.ToString(DateTimeFormat.YearMonthDate);
			} else {
				flightDateTxt = "";
			}
			console.log("flightDate: " + flightDate);
			//$("#flight_flt_date").datepicker("setDate", new Date(flightDateTxt));
			$("#flight_flt_date").val(flightDateTxt);
			$("#flight_flt_from").val(bkdData.FlightDetail[rowid].DeparturePort);
			$("#flight_flt_to").val(bkdData.FlightDetail[rowid].ArrivalPort);
			$("#flight_flt_allt").val(bkdData.FlightDetail[rowid].AllotmentId);
			$("#flight_flt_alloc").val(bkdData.FlightDetail[rowid].AllocationCode);
			$("#flight_flt_alloc_hd").val(bkdData.FlightDetail[rowid].AllocationCode);
			
			if(bkdData.FlightDetail[rowid].FlightDetailCx){
				$("#flight_pcs").val(bkdData.FlightDetail[rowid].FlightDetailCx.Pieces);
				$("#flight_weight").val(bkdData.FlightDetail[rowid].FlightDetailCx.Weight);
				$("#flight_vol").val(bkdData.FlightDetail[rowid].FlightDetailCx.Volume);
			}
		}
	}
	
	function validateFlightInfo() {
		var isValid = true;
		
		var flightNo = $("#flight_flt_no").val();
		var flightDate = $("#flight_flt_date").val();
		var from = $("#flight_flt_from").val();
		var to = $("#flight_flt_to").val();
		var allotmentID = $("#flight_flt_allt").val();
		var allocationCode = $("#flight_flt_alloc").val() || $("#flight_flt_alloc_hd").val();
		var pieces = $("#flight_pcs").val();
		var weight = $("#flight_weight").val();
		var volume = $("#flight_vol").val();
		
		if (flightNo == "" || !checkFlightNoFormat(flightNo)) {
			$("#flight_flt_no ~ .error_or_msg").show();
			$("#flight_flt_no").parent().addClass("error_or");
			isValid = false;
		} else {
			$("#flight_flt_no ~ .error_or_msg").hide();
			$("#flight_flt_no").parent().removeClass("error_or");
		}
		
		var bkdData = "";
		if (typeof localStorage.getItem("bd_cargo_info_edit") !== 'undefined' && localStorage.getItem("bd_cargo_info_edit") != null) {
			bkdData = JSON.parse(localStorage.getItem("bd_cargo_info_edit"));
		} else if (typeof localStorage.getItem("bd_cargo_info") !== 'undefined' && localStorage.getItem("bd_cargo_info") != null) {
			bkdData = JSON.parse(localStorage.getItem("bd_cargo_info"));
		}
		
		if (typeof localStorage.getItem("bd_flight_edit") !== 'undefined' && localStorage.getItem("bd_flight_edit") != null) {
			bkdData = JSON.parse(localStorage.getItem("bd_flight_edit"));
		} else if (typeof localStorage.getItem("bd_flight") !== 'undefined' && localStorage.getItem("bd_flight") != null) {
			bkdData = JSON.parse(localStorage.getItem("bd_flight"));
		}
		
		var currentAirline = "";
		if (bkdData != "") {
			currentAirline = bkdData.Airline;
		}
		var advBookDay = getAirlineAdvBookDay(currentAirline);
		var currentDate = new Date();
		if (flightDate == "") {
			$("#datepicker_edit ~ .error_or_msg").show();
			$("#datepicker_edit ~ .error_or_msg").text("Invalid");
			$("#datepicker_edit").parent().addClass("error_or");
			isValid = false;
		} else if (advBookDay > 0 && currentDate.dateDiff("d", new Date(flightDate)) > advBookDay) {
			$("#datepicker_edit ~ .error_or_msg").show();
			$("#datepicker_edit ~ .error_or_msg").text(i18next.t("cargoInfo.AdvDateRangeErr").replace("$number$", advBookDay));
			$("#datepicker_edit").parent().addClass("error_or");
			//alert("Flight Date booking must be within" + advBookDay + "days");
			isValid = false;
		} else {
			$("#datepicker_edit ~ .error_or_msg").hide();
			$("#datepicker_edit").parent().removeClass("error_or");
		}
		
		//Origin
		if (!checkPort(from)) {
			$("#flight_flt_from ~ .error_or_msg").text(i18next.t("cargoInfo.Invalid"));
			$("#flight_flt_from ~ .error_or_msg").show();
			$("#flight_flt_from").parent().addClass("error_or");
			isValid = false;
		} else{
			$("#flight_flt_from ~ .error_or_msg").hide();
			$("#flight_flt_from").parent().removeClass("error_or");
		}

		//Destination
		if (!checkPort(to)) {
			$("#flight_flt_to ~ .error_or_msg").show();
			$("#flight_flt_to").parent().addClass("error_or");
			isValid = false;
		} else {
			$("#flight_flt_to ~ .error_or_msg").hide();
			$("#flight_flt_to").parent().removeClass("error_or");
		}

		//Origin and Destination duplicate check
		if(checkPort(from) && from.toUpperCase() == to.toUpperCase()){
			$("#flight_flt_from ~ .error_or_msg").text(i18next.t('flight.SameODMsg'));
			$("#flight_flt_from ~ .error_or_msg").show();

			$("#flight_flt_from").parent().addClass("error_or");
			$("#flight_flt_to").parent().addClass("error_or");
			isValid = false;
		}

		if(pieces || weight || volume) {
		 	//pieces
		 	if(!StringFormatChecker.checkInteger(true, pieces, 1, 9999)){
		 		$("#flight_pcs ~ .error_or_msg").show();
		 		$("#flight_pcs").parent().addClass("error_or");
		 		isValid = false;
		 	}
		 	else{
		 		$("#flight_pcs ~ .error_or_msg").hide();
		 		$("#flight_pcs").parent().removeClass("error_or");
		 	}

		 	//weight
		 	if(!StringFormatChecker.checkFloat(true, weight, 0.1, 9999999, 1)){
		 		$("#flight_weight ~ .error_or_msg").show();
		 		$("#flight_weight").parent().addClass("error_or");
		 		isValid = false;
		 	}
		 	else{
		 		$("#flight_weight ~ .error_or_msg").hide();
		 		$("#flight_weight").parent().removeClass("error_or");
		 	}

		 	//volume
		 	if(!StringFormatChecker.checkFloat(true, volume, 0.001, 999999999, 3)){
		 		$("#flight_vol ~ .error_or_msg").show();
		 		$("#flight_vol").parent().addClass("error_or");
		 		isValid = false;
		 	}
		 	else{
		 		$("#flight_vol ~ .error_or_msg").hide();
		 		$("#flight_vol").parent().removeClass("error_or");
		 	}
		}
		else{
		 	$("#flight_pcs ~ .error_or_msg").hide();
		 	$("#flight_pcs").parent().removeClass("error_or");

		 	$("#flight_weight ~ .error_or_msg").hide();
		 	$("#flight_weight").parent().removeClass("error_or");

		 	$("#flight_vol ~ .error_or_msg").hide();
		 	$("#flight_vol").parent().removeClass("error_or");
		}
				
		console.log("flight isValid:" + isValid);
		return isValid;
	}
	
	function saveFlightEdit() {
		console.log("saveFlightEdit start");
		if (!validateFlightInfo()) {
			return false;
		}

		var rowid = $("#flight_hd_edit_rowid").val();
		var flightNo = $("#flight_flt_no").val().toUpperCase() || "";
		var flightDate = $("#flight_flt_date").val().toUpperCase() || "";
		var from = $("#flight_flt_from").val().toUpperCase() || "";
		var to = $("#flight_flt_to").val().toUpperCase() || "";
		var allotmentID = $("#flight_flt_allt").val().toUpperCase() || "";
		var allocationCode = $("#flight_flt_alloc").val().toUpperCase() || $("#flight_flt_alloc_hd").val();
		var pieces = $("#flight_pcs").val();
		var weight = $("#flight_weight").val();
		var volume = $("#flight_vol").val();

		var bkdData = "";
		var bkdDataOrigin = "";
		if (typeof localStorage.getItem("bd_flight_edit") !== 'undefined' && localStorage.getItem("bd_flight_edit") != null) {
			bkdData = JSON.parse(localStorage.getItem("bd_flight_edit"));
		}
		
		if (typeof localStorage.getItem("bd_flight") !== 'undefined' && localStorage.getItem("bd_flight") != null) {
			bkdDataOrigin = JSON.parse(localStorage.getItem("bd_flight"));
		}
		
		if (rowid != "" && bkdData != "") {
			if (typeof bkdData.FlightDetail[rowid] !== 'undefined' && bkdData.FlightDetail[rowid] != null) {
				bkdData.FlightDetail[rowid].FlightNum = flightNo;
				bkdData.FlightDetail[rowid].DeptFlightDate = GetUTCDateByLocalDateObj(new Date(flightDate));
				bkdData.FlightDetail[rowid].DeparturePort = from;
				bkdData.FlightDetail[rowid].ArrivalPort = to;
				bkdData.FlightDetail[rowid].ArrivalFlightDate = "";
				bkdData.FlightDetail[rowid].AllotmentId = allotmentID;
				bkdData.FlightDetail[rowid].AllocationCode = allocationCode;

				if(bkdData.FlightDetail[rowid].FlightDetailCx){
				 	bkdData.FlightDetail[rowid].FlightDetailCx = {
				 		Pieces: pieces,
				 		Weight: weight,
				 		Volume: volume
				 	};
				}
			}
		} else if (rowid == "" && bkdData != "") {
			var fd = new Object();
			fd.FlightNum = flightNo;
			fd.DeptFlightDate = GetUTCDateByLocalDateObj(new Date(flightDate));
			fd.DeparturePort = from;
			fd.ArrivalPort = to;
			fd.ArrivalFlightDate = "";
			fd.AllotmentId = allotmentID;
			fd.AllocationCode = allocationCode;
			fd.FlightDetailCx = {
			 	Pieces: pieces,
			 	Weight: weight,
			 	Volume: volume
			};
			fd.IsDelete = 0;
			fd.FCTLStatusX = "";
			bkdData.FlightDetail.push(fd);
		}

		localStorage.setItem("bd_flight_edit", JSON.stringify(bkdData));

		fltRefreshDisplay();
		closeFlightEdit();
		refreshModuleTranslation();
	}
	
	function delFlightEditRow(e) {
		
		e.preventDefault();
		
		var r = confirm("Are you sure to delete the flight?");
		if (r == true) {
		} else {
			return;
		}
		
		var rowid = $("#flight_hd_edit_rowid").val();
		
		var bkdData = "";
		if (typeof localStorage.getItem("bd_flight_edit") !== 'undefined' && localStorage.getItem("bd_flight_edit") != null) {
			bkdData = JSON.parse(localStorage.getItem("bd_flight_edit"));
		}
		
		if (rowid != "" && bkdData != "") {
			if (typeof bkdData.FlightDetail[rowid] !== 'undefined' && bkdData.FlightDetail[rowid] != null) {
				bkdData.FlightDetail[rowid].IsDelete = 1;
			}
		}
		localStorage.setItem("bd_flight_edit", JSON.stringify(bkdData));

		fltRefreshDisplay();
		closeFlightEdit();
		
	}
	
	function updateIndicatorFlight() {
		//$(".routing_flights li .cola span").removeClass("update_indicator");
		//$(".routing_flights li .colb span").removeClass("update_indicator");
		$(".flight_detail_temp").removeClass("update_indicator");
		
		var original;
		var updated;
		var hasUpdate = false;
		
		if (typeof localStorage.getItem("bd_flight_edit") !== 'undefined' && localStorage.getItem("bd_flight_edit") != null) {
			original = JSON.parse(localStorage.getItem("bd_flight"));
			updated = JSON.parse(localStorage.getItem("bd_flight_edit"));

			if (typeof updated.FlightDetail !== 'undefined' && updated.FlightDetail != null) {
				
				if (typeof original.FlightDetail === 'undefined' || original.FlightDetail == null) {
					hasUpdate = true;
				} else {
					//if (original.FlightDetail.length != updated.FlightDetail.length) {
					//	hasUpdate = true;
					//} else {
						for (var i = 0; i < updated.FlightDetail.length; i++) {
							if (typeof original.FlightDetail[i] !== 'undefined' && original.FlightDetail[i] != null) {
								
								if (original.FlightDetail[i].FlightNum != updated.FlightDetail[i].FlightNum 
								|| original.FlightDetail[i].DeptFlightDate != updated.FlightDetail[i].DeptFlightDate
								|| original.FlightDetail[i].DeparturePort != updated.FlightDetail[i].DeparturePort
								|| original.FlightDetail[i].ArrivalPort != updated.FlightDetail[i].ArrivalPort
								|| original.FlightDetail[i].AllotmentId != updated.FlightDetail[i].AllotmentId
								|| original.FlightDetail[i].AllocationCode != updated.FlightDetail[i].AllocationCode) {
									//$(".routing_flights li[data-rowid='"+i+"'] .cola span").addClass("update_indicator");
									//$(".routing_flights li[data-rowid='"+i+"'] .colb span").addClass("update_indicator");
									$("li[data-rowid='"+i+"'] .flight_detail_temp").addClass("update_indicator");
									hasUpdate = true;
								}
							} else {
								$("li[data-rowid='"+i+"'] .flight_detail_temp").addClass("update_indicator");
								hasUpdate = true;
							}
						}
					//}
				}
				
			}
			
			if (updated.WarehouseCode != original.WarehouseCode) {
				$("#fld_disp_warehouse_code").addClass("update_indicator");
				hasUpdate = true;
			}
		}
		
		if (hasUpdate) {
			localStorage.setItem("bd_flight_has_update", 1);
		}
		
	}
	
	function clearEditErrorMsgFlight() {
		$("#flight_edit .error_or").removeClass("error_or");
		$("#flight_edit .error_or_msg").hide();
		
	}
	
	function flightResetEdit() {
		$("#flight_flt_no").val("");
		$("#flight_flt_date").val("");
		$("#flight_flt_from").val("");
		$("#flight_flt_to").val("");
		$("#flight_flt_allt").val("");
		$("#flight_pcs").val("");
		$("#flight_weight").val("");
		$("#flight_vol").val("");
		$("#flight_flt_alloc").val($("#flight_flt_alloc option:first").val());
		clearEditErrorMsgFlight();
	}
	
	// end flight edit
	
	// warehouse edit
	
	function openFlightWarehouseEdit(e, rowid) {
		e.preventDefault();
		clearEditErrorMsgFlightWarehouse();
		flightWarehouseResetEdit();
		regFlightWarehouseInit();
		loadFlightWarehouseInfo();
		flightLity = lity('#flight_warehouse_edit');
	}
	
	function closeFlightWarehouseEdit(e) {
		if (typeof e !== 'undefined' && e != null) {
			e.preventDefault();
		}
		flightLity.close();
	}
	
	function regFlightWarehouseInit() {
		setWarehouseOption();
		
	}
	
	function loadFlightWarehouseInfo() {
		var bkdData = "";
		if (typeof localStorage.getItem("bd_flight_edit") !== 'undefined' && localStorage.getItem("bd_flight_edit") != null) {
			bkdData = JSON.parse(localStorage.getItem("bd_flight_edit"));
		} else if (typeof localStorage.getItem("bd_flight") !== 'undefined' && localStorage.getItem("bd_flight") != null) {
			bkdData = JSON.parse(localStorage.getItem("bd_flight"));
		}
		
		$("#bkdTWWhsCode").val(bkdData.WarehouseCode);
	}
	
	function validateFlightWarehouseInfo() {
		var isValid = true;
		
		var bkdData = "";
		if (typeof localStorage.getItem("bd_flight_edit") !== 'undefined' && localStorage.getItem("bd_flight_edit") != null) {
			bkdData = JSON.parse(localStorage.getItem("bd_flight_edit"));
		} else if (typeof localStorage.getItem("bd_flight") !== 'undefined' && localStorage.getItem("bd_flight") != null) {
			bkdData = JSON.parse(localStorage.getItem("bd_flight"));
		}
		
		if (localStorage.getItem("userCity") == "TPE") {
			if (bkdData.WarehouseCode = "") {
				$("#bkdTWWhsCode ~ .error_or_msg").show();
				$("#bkdTWWhsCode").parent().addClass("error_or");
				isValid = false;
			} else {
				$("#bkdTWWhsCode ~ .error_or_msg").hide();
				$("#bkdTWWhsCode").parent().removeClass("error_or");
			}
		}
				
		console.log("validateFlightWarehouseInfo isValid:" + isValid);
		return isValid;
	}
	
	function saveFlightWarehouseEdit() {
		console.log("saveFlightWarehouseEdit start");
		if (!validateFlightWarehouseInfo()) {
			return false;
		}
		
		var bkdData = "";
		if (typeof localStorage.getItem("bd_flight_edit") !== 'undefined' && localStorage.getItem("bd_flight_edit") != null) {
			bkdData = JSON.parse(localStorage.getItem("bd_flight_edit"));
		} else if (typeof localStorage.getItem("bd_flight") !== 'undefined' && localStorage.getItem("bd_flight") != null) {
			bkdData = JSON.parse(localStorage.getItem("bd_flight"));
		}
		
		bkdData.WarehouseCode =  $("#bkdTWWhsCode").val();
					
		localStorage.setItem("bd_flight_edit", JSON.stringify(bkdData));

		fltRefreshDisplay();
		closeFlightEdit();
		
	}
	
	function clearEditErrorMsgFlightWarehouse() {
		$("#flight_warehouse_edit .error_or").removeClass("error_or");
		$("#flight_warehouse_edit .error_or_msg").hide();
		
	}
	
	function flightWarehouseResetEdit() {
		$("#bkdTWWhsCode").val("");
		clearEditErrorMsgFlightWarehouse();
	}
	
	function setWarehouseOption() {
		if (typeof warehouseCX !== 'undefined' && warehouseCX != null) {
			$('#bkdTWWhsCode option').remove();
			for (var i = 0; i < warehouseCX.length; i++) {
				if (warehouseCX[i] == "") {
					$('#bkdTWWhsCode').append('<option value="">&nbsp;</option>');
				} else {
					$('#bkdTWWhsCode').append('<option value="'+warehouseCX[i]+'">'+warehouseCXDesc[i]+'</option>');
				}
			}
		}	
	}
	
	function getWarehouseFull(warehouseCode) {
		if (typeof warehouseCXDesc[warehouseCX.indexOf(warehouseCode)] !== "undefined") {
			return warehouseCXDesc[warehouseCX.indexOf(warehouseCode)];
		} else {
			return warehouseCode;
		}
	}
    // end warehouse edit    
	
</script>                            </div>
                        </div> <!-- outer wbg -->
                        <div class="gbg">
                            <div class="container gbg" style="padding-left: 45px; padding-right: 45px;">
                                <!-- Tab1 -->
<div id="bkd_def_shc" class="bkd_block">

	<div class="col-xs-12">
		<h3 class="inline_block" data-i18n="specialCargo.SpecialCargo">Special Cargo</h3>
		<a onclick="openSpecialCargoEdit(event)" href="javascript:void(0)" class="btn_gy_edit"></a>
	</div>

	<div class="blkc"></div>
	<div class="col-xs-12">
		<div class="blk_gy_line blkl">
            <ul id="bu_shc" class="bu_list show_handling_code">
	<li>BLK - </li>

	<li>COL - </li>

	<li>PIL - </li>

	<li>TRK - </li>
</ul>
	        <div id="bu_temperature_list" class="blk_cnt" style="">
	        	<div class="blk_b">
		        </div>
	            <div class="blk_typea">
	                <label data-i18n="specialCargo.ProductTempRange">Product Temperature Range</label>
	                <div><span id="bu_ptr_s">-2.0</span> - <span id="bu_ptr_e">10.0</span> <span id="bu_ptr_u">°C</span></div>
	            </div>
	            <div class="blk_typea">
	                <label data-i18n="specialCargo.StorageTempRange">Storage Temperature Range</label>
	                <div><span id="bu_str_s">10.0</span> - <span id="bu_str_e">20.0</span> <span id="bu_str_u">°C</span></div>
	            </div>
	            <div class="blk_typea">
	                <label data-i18n="specialCargo.EmergencyTel">Emergency Tel</label>
	                <div><span id="bu_emer_tel">-</span></div>
	            </div>
	        </div>
	    </div>
	</div>

	<div class="booking_lb lity-hide" id="specialCargo_edit" style="width: 100%; min-width: 900px; max-width: 900px;">
		<div class="lightbox_ctr" style="width: 100%;">
			<div class="close_ctr"><a id="btn_special_cargo_edit_close" href="javascript:void(0)" class="close_btn" onclick="closeSpecialCargoEdit(event)"></a></div>
			<div class="lightbox_blk">
				<h3 data-i18n="specialCargo.SpecialCargo">Special Cargo</h3>
				<div class="blkc"></div>
			
				<div class="blk_filter">
					<div class="head_hr"></div>
					<div class="consign_info">
						<label for="sc_special_code">
			            	<span data-i18n="specialCargo.SHC">Special Handling Code</span>
			            	<span class="reminder">(<span data-i18n="SHC.EnterWordReminder">Enter keyword or code…</span>)</span>
			            </label>
						<div class="category-container SHCodeAC">
							<div class="bootstrap-tagsinput"><input type="text" class="form-control autocomplete ui-autocomplete-input" placeholder="" autocomplete="off"></div><input type="text" id="sc_special_code" placeholder="" class="autocomplete ui-autocomplete-input" data-role="tagsinput" autocomplete="off" style="display: none;">
						</div>
						<div id="sc_temp_range_wrapper" class="cnt_inline bu_txt w64 mr35" style="display: none;">
							<label for="sc_temp_range_start"><span data-i18n="specialCargo.ProductTempRange">Product Temperature Range</span>*</label>
							<input type="text" value="" id="sc_temp_range_start" class="sc_dec_input"> - <input type="text" value="" id="sc_temp_range_end" class="sc_dec_input">
							<fieldset class="switch-toggle-set">
								<div class="switch-toggle switch-candy">
									<input id="sc_temp_range_c" name="product-temp" type="radio" value="0" checked="">
									<label for="sc_temp_range_c" onclick="">°C</label>
									<input id="sc_temp_range_f" name="product-temp" type="radio" value="1">
									<label for="sc_temp_range_f" onclick="">°F</label>
									<a></a>
								</div>
							</fieldset>
							<div class="error_or_msg" style="display: none;" data-i18n="cargoInfo.InvalidTemp">Invalid temperature</div>
						</div>
						<div id="sc_storage_temp_range_wrapper" class="cnt_inline bu_txt w64 mr35" style="display: none;">
							<label for="sc_store_temp_start"><span data-i18n="specialCargo.StorageTempRange">Storage Temperature Range</span>*</label>
							<input type="text" value="" id="sc_store_temp_start" class="sc_dec_input"> - <input type="text" value="" id="sc_store_temp_end" class="sc_dec_input">
							<fieldset class="switch-toggle-set">
								<div class="switch-toggle switch-candy">
									<input id="sc_store_temp_c" name="store-temp" type="radio" value="0" checked="">
									<label for="sc_store_temp_c" onclick="">°C</label>
									<input id="sc_store_temp_f" name="store-temp" type="radio" value="1">
									<label for="sc_store_temp_f" onclick="">°F</label>
									<a></a>
								</div>
							</fieldset>
							<div class="error_or_msg" style="display: none;" data-i18n="cargoInfo.InvalidTemp">Invalid temperature</div>
						</div>

						<div id="sc_emergency_tel_wrapper" class="cnt_inline bu_txt w145" style="display: none;">
							<label for="sc_emergency_tel"><span data-i18n="specialCargo.EmergencyTel">Emergency Tel</span>*</label>
							<input type="text" value="" class="sc_int_input" id="sc_emergency_tel" maxlength="17">
							<div class="error_or_msg" style="display: none;" data-i18n="cargoInfo.InvalidTel">Invalid Tel No</div>
						</div>
						<div class="blkc"></div>
						<div id="sc_shipper_prompt" class="error_or_msg" style="display:none;" data-i18n="specialCargo.InputShipper">Please provide shipper and consignee information</div>
			
						<div id="sc_special_code_focus" tabindex="-1"></div>
						
					</div>
				</div>
				<div>
					<a href="javascript:void(0)" class="link_bu_l2" style="float: left;" onclick="closeSpecialCargoEdit(event)" data-i18n="common.Cancel">Cancel</a>
					<span href="javascript:void(0)" class="btn_or_l" onclick="saveSpecialCargoEdit()" data-i18n="common.Save">Save</span>
					<div class="blkc"></div>
				</div>
				
				
				
			</div>
		</div>
	</div>
	
</div>

<script id="bu_shc_list_temp" type="text/x-template">
	<li>%SHC% - %SHC_DESC%</li>
</script>

<script>

	$(window).load(function(){
	/*
	var handlingCode = new Bloodhound({
	  datumTokenizer: Bloodhound.tokenizers.obj.whitespace('text'),
	  queryTokenizer: Bloodhound.tokenizers.whitespace,
	  prefetch: '/DesktopModules/MVC/Booking/Views/Airline/Default/handlingCode.json'
	});
	handlingCode.initialize();

	var elt = $('.category-container input');
	elt.tagsinput({
	  itemValue: 'value',
	  itemText: 'Hcode',
	  typeaheadjs: [{
		minLength: 1,
		highlight: true,
		} , {
		name: 'handlingCode',
		displayKey: 'text',
		source: handlingCode.ttAdapter()
	  }]
	});

	handlingCode.initialize();

	$(".bootstrap-tagsinput input").focus(function(){jQuery(this).attr('placeholder', '')})
	$(".bootstrap-tagsinput input").blur(function(){ if ($(".category-container input").val() != "") { jQuery(this).attr('placeholder', '') } else { jQuery(this).attr('placeholder', 'Enter keyword or code...') }})
	*/
	
	

	});

	$(function() {
		var id = "#bkd_def_shc";
		var specialCargoLity;
		var shcLengthLimit = 5;
		
		$(id).on("clear", function(event) {
			//console.log(data);
			
			//debugger;
			$("#bu_shc").empty();
			clearEditErrorMsgSpecialCargo();
			
			$("#bu_ptr_s").text("");
			$("#bu_ptr_e").text("");
			$("#bu_ptr_u").text("");
			$("#bu_str_s").text("");
			$("#bu_str_e").text("");
			$("#bu_str_u").text("");
			$("#bu_emer_tel").text("");
			
		});
		
		$(id).on("init", function(event, data) {
			console.log(data);
			//debugger;
			/*
			//$("input[data-role=tagsinput]").tagsinput();
			$("#sc_special_code").tagsinput();
			if (typeof data.SpecialCargo.SHC !== 'undefined' && data.SpecialCargo.SHC != null) {
				for (var i = 0; i < data.SpecialCargo.SHC.length; i++) {
					$('#sc_special_code').tagsinput('add', data.SpecialCargo.SHC[i]);
				}	
			}
			
			//$('input[name=product-temp]').bootstrapSwitch();
			
			$("#sc_temp_range_start").val(data.SpecialCargo.PTempStart);
			$("#sc_temp_range_end").val(data.SpecialCargo.PTempEnd);
			if (data.SpecialCargo.PTempUnit == 0 || typeof data.SpecialCargo.PTempUnit === 'undefined') {
				$("#sc_temp_range_c").prop("checked", true);
			} else {
				$("#sc_temp_range_f").prop("checked", true);
			}
			$("#sc_store_temp_start").val(data.SpecialCargo.STempStart);
			$("#sc_store_temp_end").val(data.SpecialCargo.STempEnd);
			if (data.SpecialCargo.STempUnit == 0 || typeof data.SpecialCargo.STempUnit === 'undefined') {
				$("#sc_store_temp_c").prop("checked", true);
			} else {
				$("#sc_store_temp_f").prop("checked", true);
			}
			$('#sc_emergency_tel').val(data.SpecialCargo.EmergencyTel);
			
			setTimeout(function () { regSHCodeAutoComplete(); }, 300);
			*/
		});
		
		$(id).on("validate", function() {
			console.log("OK");
			var isValid = true;
			return isValid;
			//return true;
		});
		
		$(id).on("submit", function() {
			
			
			var bkdData = "";
			if (typeof localStorage.getItem("bd_special_cargo_edit") !== 'undefined' && localStorage.getItem("bd_special_cargo_edit") != null) {
				bkdData = JSON.parse(localStorage.getItem("bd_special_cargo_edit"));
			} else if (typeof localStorage.getItem("bd_special_cargo") !== 'undefined' && localStorage.getItem("bd_special_cargo") != null) {
				bkdData = JSON.parse(localStorage.getItem("bd_special_cargo"));
			}
			
				
			var shcList = [];
			var includeTemp = false;
			var shcStr = "";
			if (typeof bkdData.SHCList !== 'undefined' && bkdData.SHCList != null) {
				//console.log("bkdData.SHCList: " + bkdData.SHCList);
				shcList	= bkdData.SHCList;
				if (shcList.length > 0) {
					shcStr = shcList.join();
					includeTemp = checkSHCShowTemperatureInput(shcStr);
				}
			}
			
			var tempStart = bkdData.PTRs;
			var tempEnd = bkdData.PTRe;
			var tempUnit = bkdData.PTRu;
			var storeTempStart = bkdData.STRs;
			var storeTempEnd = bkdData.STRe;
			var storeTempUnit = bkdData.STRu;
			var emergencyTel = bkdData.EmergencyTel;
			
			if (includeTemp) {
				return { 
					"SpecialCargo" : {
						"SHC" : shcList,
						"PTempStart" : tempStart,
						"PTempEnd" : tempEnd,
						"PTempUnit" : tempUnit,
						"STempStart" : storeTempStart,
						"STempEnd" : storeTempEnd,
						"STempUnit" : storeTempUnit,
						"EmergencyTel" : emergencyTel
					}
				};
			} else {
				return { 
					"SpecialCargo" : {
						"SHC" : shcList
					}
				};
			}
			
		});
		
		$(id).on("loadBookingData", function(event, bkdData) {
			
			var obj = new Object();
			obj.SHCList = [];
			if (typeof bkdData.Cx.ProductTempUpper !== 'undefined' && bkdData.Cx.ProductTempUpper != null) {
				if (!isNaN(parseFloat(bkdData.Cx.ProductTempUpper).toFixed(decimalTemperatureRoundTo))) {
					obj.PTRe = parseFloat(bkdData.Cx.ProductTempUpper).toFixed(decimalTemperatureRoundTo);
				} else {
					obj.PTRe = bkdData.Cx.ProductTempUpper;
				}
			} else {
				obj.PTRe = "";
			}
			
			if (typeof bkdData.Cx.ProductTempLower !== 'undefined' && bkdData.Cx.ProductTempLower != null) {
				if (!isNaN(parseFloat(bkdData.Cx.ProductTempLower).toFixed(decimalTemperatureRoundTo))) {
					obj.PTRs = parseFloat(bkdData.Cx.ProductTempLower).toFixed(decimalTemperatureRoundTo);
				} else {
					obj.PTRs = bkdData.Cx.ProductTempLower;
				}		
			} else {
				obj.PTRs = "";
			}
			/*
			if (data.CargoInfo.VolumeUnit == 0) {
				$("#sc_temp_range_c").prop("checked", true);
			} else {
				$("#sc_temp_range_f").prop("checked", true);
			}
			*/
			if (typeof bkdData.Cx.StorageTempUpper !== 'undefined' && bkdData.Cx.StorageTempUpper != null) {
				if (!isNaN(parseFloat(bkdData.Cx.StorageTempUpper).toFixed(decimalTemperatureRoundTo))) {
					obj.STRe = parseFloat(bkdData.Cx.StorageTempUpper).toFixed(decimalTemperatureRoundTo);
				} else {
					obj.STRe = bkdData.Cx.StorageTempUpper;
				}
			} else {
				obj.STRe = "";
			}
			if (typeof bkdData.Cx.StorageTempLower !== 'undefined' && bkdData.Cx.StorageTempLower != null) {
				if (!isNaN(parseFloat(bkdData.Cx.StorageTempLower).toFixed(decimalTemperatureRoundTo))) {
					obj.STRs = parseFloat(bkdData.Cx.StorageTempLower).toFixed(decimalTemperatureRoundTo);
				} else {
					obj.STRs = bkdData.Cx.StorageTempLower;
				}
			} else {
				obj.STRs = "";
			}

			/*
			if (data.CargoInfo.VolumeUnit == 0) {
				$("#sc_store_temp_c").prop("checked", true);
			} else {
				$("#sc_store_temp_f").prop("checked", true);
			}
			*/
			if (typeof bkdData.Cx.EmergencyTele !== 'undefined' && bkdData.Cx.EmergencyTele != null) {
				obj.EmergencyTel = bkdData.Cx.EmergencyTele;
			} else {
				obj.EmergencyTel = "";
			}
			obj.PTRu = 0;
			obj.STRu = 0;
			
			if (typeof bkdData.ShrCode !== 'undefined' && bkdData.ShrCode != null) {
				for (var i = 0; i < bkdData.ShrCode.length; i++) {
					//console.log("bkdData.ShrCode: " + bkdData.ShrCode[i]);
					if (availableSHCTags.indexOf(bkdData.ShrCode[i]) > -1) {
						obj.SHCList.push(bkdData.ShrCode[i]);
					}
				}	
			}
			
			localStorage.setItem("bd_special_cargo", JSON.stringify(obj));
			localStorage.removeItem("bd_special_cargo_edit");
			
			specialCargoRefreshDisplay();
			
		});	

		
		$('#sc_special_code').on('beforeItemAdd', function(event) {
			// event.item: contains the item
			// event.cancel: set to true to prevent the item getting added
			var currentValue = $("#sc_special_code").val();
			var arr = currentValue.split(",");
			var shcInput = event.item.substring(0, 3).toUpperCase();
			if (currentValue.trim() != "" && arr.length >= shcLengthLimit) {
				event.cancel = true;
			//} else if (availableSHCTags.indexOf(event.item.toUpperCase()) > -1) {
			} else if (availableSHCTags.indexOf(shcInput) > -1) {
				if (event.item != event.item.toUpperCase() || event.item != shcInput) {
					event.cancel = true;
					$(this).tagsinput('add', shcInput);
					//$(this).tagsinput('add', event.item.substring(0, 3).toUpperCase());
				}
			} else if (availableSHCTags.indexOf(event.item.toUpperCase()) == -1) {
				event.cancel = true;
			} else {
				//event.cancel = true;
				//$(this).tagsinput('add', event.item.toUpperCase());
			}
		});
		
		
		$('#sc_special_code').on('itemAdded', function(event) {
            // event.item: contains the item
            console.log(event.item);
            var showTemp = false;
			var showShipperPrompt = false;
            var currentValue = $("#sc_special_code").val();
            var arr = currentValue.split(",");
			
			showTemp = checkSHCShowTemperatureInput(currentValue);
			showShipperPrompt = checkSHCPromptShipperConsigneeInput(currentValue);
			
            if (showTemp) {
                $("#sc_temp_range_wrapper").show();
                $("#sc_storage_temp_range_wrapper").show();
                $("#sc_emergency_tel_wrapper").show();
            }
			
			if (showShipperPrompt) {
				$("#sc_shipper_prompt").show();
			}
			
        });
		
        $('#sc_special_code').on('itemRemoved', function(event) {
            // event.item: contains the item
            console.log(event.item);
            var showTemp = false;
			var showShipperPrompt = false;
            var currentValue = $("#sc_special_code").val();
            var arr = currentValue.split(",");
			
			showTemp = checkSHCShowTemperatureInput(currentValue);
			showShipperPrompt = checkSHCPromptShipperConsigneeInput(currentValue);
			
            if (showTemp) {
                $("#sc_temp_range_wrapper").show();
                $("#sc_storage_temp_range_wrapper").show();
                $("#sc_emergency_tel_wrapper").show();
            } else {
                $("#sc_temp_range_wrapper").hide();
                $("#sc_storage_temp_range_wrapper").hide();
                $("#sc_emergency_tel_wrapper").hide();
            }
			
			if (showShipperPrompt) {
				$("#sc_shipper_prompt").show();
			} else {
				$("#sc_shipper_prompt").hide();
			}
			
        });
		
		setTimeout(function () {
			$(".SHCodeAC input.form-control.autocomplete.ui-autocomplete-input").keypress(function(e) {
				// event.item: contains the item
				// event.cancel: set to true to prevent the item getting added
				console.log(e.which);
				
				var currentValue = $("#sc_special_code").val();
				var arr = currentValue.split(",");
				if (currentValue.trim() != "" && arr.length >= shcLengthLimit) {
					return false;
				}
				
			});
		}, 2000);
		
		$(".sc_dec_input").keypress(function(e) {
			console.log(e.which);
			if((e.which >= 48 && e.which <= 57) || e.which == 46 || e.which == 45){
			} else {
				return false;
			}
		});
		
		$(".sc_dec_input").blur(function(e) {
			if ($(this).val() != "") {
				$(this).val(FormatDecInput($(this).val(), decimalTemperatureRoundTo));
			}
		});
		
		$(".sc_int_input").keypress(function(e) {
			console.log(e.which);
			if(e.which >= 48 && e.which <= 57 ){
			} else {
				return false;
			}
		});
		
	});
	
	function specialCargoRefreshDisplay() {
		
		$("#bu_shc").empty();
		
		var showTemperature = false;
		var bkdData = "";
		if (typeof localStorage.getItem("bd_special_cargo_edit") !== 'undefined' && localStorage.getItem("bd_special_cargo_edit") != null) {
			bkdData = JSON.parse(localStorage.getItem("bd_special_cargo_edit"));
		} else if (typeof localStorage.getItem("bd_special_cargo") !== 'undefined' && localStorage.getItem("bd_special_cargo") != null) {
			bkdData = JSON.parse(localStorage.getItem("bd_special_cargo"));
		}
		
		if (bkdData != "") {
			
			$("#bu_ptr_s").text(bkdData.PTRs);
			$("#bu_ptr_e").text(bkdData.PTRe);
			var pu;
			if (bkdData.PTRu == 0) {
				pu = "°C";
			} else {
				pu = "°F";
			}
			$("#bu_ptr_u").text(pu);
			$("#bu_str_s").text(bkdData.STRs);
			$("#bu_str_e").text(bkdData.STRe);
			if (bkdData.STRu == 0) {
				pu = "°C";
			} else {
				pu = "°F";
			}
			$("#bu_str_u").text(pu);
			if (bkdData.EmergencyTel != "") {
				$("#bu_emer_tel").text(bkdData.EmergencyTel);
			} else {
				$("#bu_emer_tel").text("-");
			}
			var shcTemp = $("#bu_shc_list_temp").html();
			var shcContent;
			
			var shcStr= "";
			if (bkdData.SHCList.length > 0) {
				shcStr = bkdData.SHCList.join();
				showTemperature = checkSHCShowTemperatureInput(shcStr);
			}
			
			for (var i = 0; i < bkdData.SHCList.length; i++) {
				shcContent = shcTemp.replace("%SHC%", bkdData.SHCList[i]).replace("%SHC_DESC%", "");
				$("#bu_shc").append(shcContent);
			}

			updateIndicatorSpecialCargo();
		}
		
		if (showTemperature) {
			$("#bu_temperature_list").show();
		} else {
			$("#bu_temperature_list").hide();
		}
	}
	
	// special edit
	
	function openSpecialCargoEdit(e) {
		e.preventDefault();
		clearEditErrorMsgSpecialCargo();
		regSpecialCargoInit();
		loadEditDataSpecialCargo();
		specialCargoLity = lity('#specialCargo_edit');
	}
	
	function closeSpecialCargoEdit(e) {
		if (typeof e !== 'undefined' && e != null) {
			e.preventDefault();
		}
		specialCargoLity.close();
	}
	
	function regSpecialCargoInit() {
		//setTimeout(function () { regSHCodeAutoComplete(); }, 300);
		
	}
	
	function loadEditDataSpecialCargo() {
	
		specialCargoResetEdit();
		
		var bkdData = "";
		if (typeof localStorage.getItem("bd_special_cargo_edit") !== 'undefined' && localStorage.getItem("bd_special_cargo_edit") != null) {
			bkdData = JSON.parse(localStorage.getItem("bd_special_cargo_edit"));
		} else if (typeof localStorage.getItem("bd_special_cargo") !== 'undefined' && localStorage.getItem("bd_special_cargo") != null) {
			bkdData = JSON.parse(localStorage.getItem("bd_special_cargo"));
		}
		
		var showTemp = false;
		var showShipperPrompt = false;
		var shcStr= "";
		if (bkdData != "") {
			if (typeof bkdData.SHCList !== 'undefined' && bkdData.SHCList != null) {
				//console.log("bkdData.SHCList: " + bkdData.SHCList);
				if (bkdData.SHCList.length > 0) {
					shcStr = bkdData.SHCList.join();
					showTemp = checkSHCShowTemperatureInput(shcStr);
					showShipperPrompt = checkSHCPromptShipperConsigneeInput(shcStr);
				}
				for (var i = 0; i < bkdData.SHCList.length; i++) {
					$('#sc_special_code').tagsinput('add', bkdData.SHCList[i]);
				}	
			}
			
			if (showTemp) {
                $("#sc_temp_range_wrapper").show();
                $("#sc_storage_temp_range_wrapper").show();
                $("#sc_emergency_tel_wrapper").show();
            } else {
                $("#sc_temp_range_wrapper").hide();
                $("#sc_storage_temp_range_wrapper").hide();
                $("#sc_emergency_tel_wrapper").hide();
            }
			
			if (showShipperPrompt) {
				$("#sc_shipper_prompt").show();
			} else {
				$("#sc_shipper_prompt").hide();
			}
			
			if (typeof bkdData.PTRe !== 'undefined' && bkdData.PTRe != null) {
				$("#sc_temp_range_end").val(bkdData.PTRe);
			} else {
				$("#sc_temp_range_end").val("");
			}
			
			if (typeof bkdData.PTRs !== 'undefined' && bkdData.PTRs != null) {
				$("#sc_temp_range_start").val(bkdData.PTRs);
			} else {
				$("#sc_temp_range_start").val("");
			}
			/*
			if (data.CargoInfo.VolumeUnit == 0) {
				$("#sc_temp_range_c").prop("checked", true);
			} else {
				$("#sc_temp_range_f").prop("checked", true);
			}
			*/
			if (typeof bkdData.STRe !== 'undefined' && bkdData.STRe != null) {
				$("#sc_store_temp_end").val(bkdData.STRe);
			} else {
				$("#sc_store_temp_end").val("");
			}
			if (typeof bkdData.STRs !== 'undefined' && bkdData.STRs != null) {
				$("#sc_store_temp_start").val(bkdData.STRs);
			} else {
				$("#sc_store_temp_start").val("");
			}

			/*
			if (data.CargoInfo.VolumeUnit == 0) {
				$("#sc_store_temp_c").prop("checked", true);
			} else {
				$("#sc_store_temp_f").prop("checked", true);
			}
			*/
			if (typeof bkdData.EmergencyTel !== 'undefined' && bkdData.EmergencyTel != null) {
				$("#sc_emergency_tel").val(bkdData.EmergencyTel);
			} else {
				$("#sc_emergency_tel").val("");
			}
			
		}
		
	}
	
	function validateSpecialCargoInfo() {
		//var intVad = /^\+?(0|[1-9]\d*)$/;
		//var decVad = /^-?([1-9]\d*|0\.\d*[1-9]|[1-9]\d*\.\d*[0-9]|0)$/;
		
		var shc = $("#sc_special_code").val() || "";
		var shcList = [];
		if (shc != "") {
			shcList = shc.split(",");
		}
		var tempStart = $("#sc_temp_range_start").val();
		var tempEnd = $("#sc_temp_range_end").val();
		var tempUnit = $('input[name=product-temp]:checked').val();
		var storeTempStart = $("#sc_store_temp_start").val();
		var storeTempEnd = $("#sc_store_temp_end").val();
		var storeTempUnit = $('input[name=store-temp]:checked').val();
		var emergencyTel = $('#sc_emergency_tel').val();
		var isValid = true;
		var checkTemperature = false;
		
		checkTemperature = checkSHCShowTemperatureInput(shc);
		
		if (checkTemperature) {
			if (tempStart == "" || tempEnd == "") {
				$("#sc_temp_range_start ~ .error_or_msg").show();
				$("#sc_temp_range_start").parent().addClass("error_or");
				isValid = false;
			} else if (!decVad.test(parseFloat(tempStart)) && tempStart != "") {
				$("#sc_temp_range_start ~ .error_or_msg").show();
				$("#sc_temp_range_start").parent().addClass("error_or");
				isValid = false;
			} else if (!decVad.test(parseFloat(tempEnd)) && tempEnd != "") {
				$("#sc_temp_range_start ~ .error_or_msg").show();
				$("#sc_temp_range_start").parent().addClass("error_or");
				isValid = false;
			} else if (parseFloat(tempStart) >= parseFloat(tempEnd)) {
				$("#sc_temp_range_start ~ .error_or_msg").show();
				$("#sc_temp_range_start").parent().addClass("error_or");
				isValid = false;
			} else {
				$("#sc_temp_range_start ~ .error_or_msg").hide();
				$("#sc_temp_range_start").parent().removeClass("error_or");
			}
			
			if (parseFloat(tempStart) > 99.9 || parseFloat(tempStart) < -99.9) {
				$("#sc_temp_range_start ~ .error_or_msg").show();
				$("#sc_temp_range_start").parent().addClass("error_or");
				isValid = false;
			}
			
			if (parseFloat(tempEnd) > 99.9 || parseFloat(tempEnd) < -99.9) {
				$("#sc_temp_range_end ~ .error_or_msg").show();
				$("#sc_temp_range_end").parent().addClass("error_or");
				isValid = false;
			}
			
			if (storeTempStart == "" || storeTempEnd == "") {
				$("#sc_store_temp_start ~ .error_or_msg").show();
				$("#sc_store_temp_start").parent().addClass("error_or");
				isValid = false;
			} else if (!decVad.test(parseFloat(storeTempStart)) && storeTempStart != "") {
				$("#sc_store_temp_start ~ .error_or_msg").show();
				$("#sc_store_temp_start").parent().addClass("error_or");
				isValid = false;
			} else if (!decVad.test(parseFloat(storeTempEnd)) && storeTempEnd != "") {
				$("#sc_store_temp_start ~ .error_or_msg").show();
				$("#sc_store_temp_start").parent().addClass("error_or");
				isValid = false;
			} else if (parseFloat(storeTempStart) >= parseFloat(storeTempEnd)) {
				$("#sc_store_temp_start ~ .error_or_msg").show();
				$("#sc_store_temp_start").parent().addClass("error_or");
				isValid = false;
			} else {
				$("#sc_store_temp_start ~ .error_or_msg").hide();
				$("#sc_store_temp_start").parent().removeClass("error_or");
			}
			
			if (parseFloat(storeTempStart) > 99.9 || parseFloat(storeTempStart) < -99.9) {
				$("#sc_store_temp_start ~ .error_or_msg").show();
				$("#sc_store_temp_start").parent().addClass("error_or");
				isValid = false;
			}
			
			if (parseFloat(storeTempEnd) > 99.9 || parseFloat(storeTempEnd) < -99.9) {
				$("#sc_store_temp_end ~ .error_or_msg").show();
				$("#sc_store_temp_end").parent().addClass("error_or");
				isValid = false;
			}
			
			if (emergencyTel == "") {
				$("#sc_emergency_tel ~ .error_or_msg").show();
				$("#sc_emergency_tel").parent().addClass("error_or");
				isValid = false;
			} else {
				$("#sc_emergency_tel ~ .error_or_msg").hide();
				$("#sc_emergency_tel").parent().removeClass("error_or");
			}
			
		} else {
			$("#sc_temp_range_start ~ .error_or_msg").hide();
			$("#sc_temp_range_start").parent().removeClass("error_or");
			$("#sc_store_temp_start ~ .error_or_msg").hide();
			$("#sc_store_temp_start").parent().removeClass("error_or");
			$("#sc_emergency_tel ~ .error_or_msg").hide();
			$("#sc_emergency_tel").parent().removeClass("error_or");
		}
		console.log("specialCargo isValid:" + isValid);
		return isValid;
	}
	
	function saveSpecialCargoEdit() {
		
		if (!validateSpecialCargoInfo()) {
			return false;
		}
		
		var shc = $("#sc_special_code").val().toUpperCase();
		var shcList = [];
		var showTemp = false;
		if (shc != "") {
			shcList = shc.split(",");
			showTemp = checkSHCShowTemperatureInput(shc);
		}
		var tempStart = $("#sc_temp_range_start").val();
		var tempEnd = $("#sc_temp_range_end").val();
		var tempUnit = $('input[name=product-temp]:checked').val();
		var storeTempStart = $("#sc_store_temp_start").val();
		var storeTempEnd = $("#sc_store_temp_end").val();
		var storeTempUnit = $('input[name=store-temp]:checked').val();
		var emergencyTel = $('#sc_emergency_tel').val();
		
		var obj = new Object();
		obj.SHCList = [];
		if (shc != "") {
			obj.SHCList = shc.split(",");
		}
		obj.PTRe = tempEnd;
		obj.PTRs = tempStart;
		obj.PTRu = tempUnit;
		obj.STRe = storeTempEnd;
		obj.STRs = storeTempStart;
		obj.STRu = storeTempUnit;
		obj.EmergencyTel = emergencyTel;
		
		localStorage.setItem("bd_special_cargo_edit", JSON.stringify(obj));
		
		//handle enable/disable OSI
		if (showTemp) {
			remarkDisableClearOSI();
		} else {
			remarkEnableOSI();
		}
		specialCargoRefreshDisplay();
		closeSpecialCargoEdit();
		
	}
	
	function updateIndicatorSpecialCargo() {
		var original;
		var updated;
		var hasUpdate = false;
		
		if (typeof localStorage.getItem("bd_special_cargo_edit") !== 'undefined' && localStorage.getItem("bd_special_cargo_edit") != null) {
			original = JSON.parse(localStorage.getItem("bd_special_cargo"));
			updated = JSON.parse(localStorage.getItem("bd_special_cargo_edit"));
		
			if (typeof updated.SHCList !== 'undefined' && updated.SHCList != null) {
				
				if (typeof original.SHCList === 'undefined' || original.SHCList == null) {
					hasUpdate = true;
				} else {
				
					if (original.SHCList.length != updated.SHCList.length) {
						hasUpdate = true;
					} else {
						for (var i = 0; i < updated.SHCList; i++) {
							if (original.SHCList.indexOf(updated.SHCList[i]) < 0) {
								hasUpdate = true;
							}
						}
					}
					
				}
				
			}
			
			if (hasUpdate) {
				$("#bu_shc").addClass("update_indicator");
			} else {
				$("#bu_shc").removeClass("update_indicator");
			}
			
			if (original.PTRs != updated.PTRs) {
				$("#bu_ptr_s").addClass("update_indicator");
				hasUpdate = true;
			} else {
				$("#bu_ptr_s").removeClass("update_indicator");
			}
			
			if (original.PTRe != updated.PTRe) {
				$("#bu_ptr_e").addClass("update_indicator");
				hasUpdate = true;
			} else {
				$("#bu_ptr_e").removeClass("update_indicator");
			}
			
			if (original.PTRu != updated.PTRu) {
				$("#bu_ptr_u").addClass("update_indicator");
				hasUpdate = true;
			} else {
				$("#bu_ptr_u").removeClass("update_indicator");
			}
			
			if (original.STRs != updated.STRs) {
				$("#bu_str_s").addClass("update_indicator");
				hasUpdate = true;
			} else {
				$("#bu_str_s").removeClass("update_indicator");
			}
			
			if (original.STRe != updated.STRe) {
				$("#bu_str_e").addClass("update_indicator");
				hasUpdate = true;
			} else {
				$("#bu_str_e").removeClass("update_indicator");
			}
			
			if (original.STRu != updated.STRu) {
				$("#bu_str_u").addClass("update_indicator");
				hasUpdate = true;
			} else {
				$("#bu_str_u").removeClass("update_indicator");
			}
			
			if (original.EmergencyTel != updated.EmergencyTel) {
				$("#bu_emer_tel").addClass("update_indicator");
				hasUpdate = true;
			} else {
				$("#bu_emer_tel").removeClass("update_indicator");
			}
			
			if (hasUpdate) {
				localStorage.setItem("bd_special_cargo_has_update", 1);
			}
		
		}
	}
	
	function clearEditErrorMsgSpecialCargo() {
		$("#specialCargo_edit .error_or").removeClass("error_or");
		$("#specialCargo_edit .error_or_msg").hide();
		
	}
	
	function specialCargoResetEdit() {
		$('#sc_special_code').tagsinput('removeAll');
		$("#sc_temp_range_wrapper").hide();
		$("#sc_storage_temp_range_wrapper").hide();
		$("#sc_emergency_tel_wrapper").hide();
		
		$("#sc_temp_range_end").val("");
		$("#sc_temp_range_start").val("");	
		$("#sc_temp_range_c").prop("checked", true);
		$("#sc_store_temp_end").val("");
		$("#sc_store_temp_start").val("");	
		$("#sc_store_temp_c").prop("checked", true);
		$("#sc_emergency_tel").val("");
		
		clearEditErrorMsgSpecialCargo();
	}
	
	// end special cargo edit

</script><div id="bkd_def_uld" class="bkd_block">
	<div class="col-xs-12">
		<h3 class="inline_block" data-i18n="uld.ULDInfo">ULD Information</h3>
		<a onclick="openULDEdit(event)" href="javascript:void(0)" class="btn_gy_edit"></a>
	</div>

	<div class="blkc"></div>

	<div class="col-xs-12 col-md-5">
		<div class="blk_gy_line blkl">
	        <h4 data-i18n="uld.PalletContainer">Pallet/ Container</h4>
	        <div class="blk_typeb">
	        	<div class="col-xs-12 no_side_padding">
		            <label data-i18n="uld.UpperDeckPallet">Upper Deck Pallet</label>
		            <div id="bd_uld_upper_deck_pallet">-</div>
		        </div>
		        <div class="col-xs-12 no_side_padding">
		            <label data-i18n="uld.LowerDeckPallet">Lower Deck Pallet</label>
		            <div id="bd_uld_lower_deck_pallet">-</div>
		        </div>
		        <div class="col-xs-12 no_side_padding">
		            <label data-i18n="uld.LowerDeckContainer">Lower Deck Container</label>
		            <div id="bd_uld_lower_deck_container">-</div>
		        </div>
	        </div>
	    </div>
    </div>

    <div class="col-xs-12 col-md-5">
	    <div class="blk_gy_line blkl">
	        <h4 data-i18n="uld.ULDContour">ULD Contour</h4>
	        <div class="blk_typeb">
				<ol id="uld_contour_table"></ol>
	        </div>
	    </div>
	</div>
	
    <div class="blkc"></div>

	<div class="clearfix"></div>
	
	<div class="booking_lb lity-hide" id="uld_edit" style="width: 100%; min-width: 900px; max-width: 900px;">
		<div class="lightbox_ctr" style="width: 100%;">
			<div class="close_ctr"><a id="btn_uld_edit_close" href="javascript:void(0)" class="close_btn" onclick="closeULDEdit(event)"></a></div>
			<div class="lightbox_blk">
				<h3 data-i18n="uld.ULDInfo">ULD Information</h3>
				<div class="blkc"></div>
			
				<div class="blk_filter">
					<div class="head_hr"></div>
					<div class="consign_info no_side_padding">
						<div class="col-xs-6">
							<div class="blk_gy_line blkl">
								<h4 data-i18n="uld.PalletContainer" style="margin-top:0px;">Pallet/ Container</h4>
								<div class="blk_pallet">
									<label for="uld_upper_deck_pallet" data-i18n="uld.UpperDeckPallet">Upper Deck Pallet</label>
									<input type="text" id="uld_upper_deck_pallet" class="uld_pallet_input" maxlength="2">
								</div>
								<div class="blk_pallet">
									<label for="uld_lower_deck_pallet" data-i18n="uld.LowerDeckPallet">Lower Deck Pallet</label>
									<input type="text" id="uld_lower_deck_pallet" class="uld_pallet_input" maxlength="2">
								</div>
								<div class="blk_pallet">
									<label for="uld_lower_deck_container" data-i18n="uld.LowerDeckContainer">Lower Deck Container</label>
									<input type="text" id="uld_lower_deck_container" class="uld_pallet_input" maxlength="2">
								</div>
							</div>
						</div>
						<div class="col-xs-6">
							<div class="blk_gy_line blkl">
								<h4 data-i18n="uld.ULDContour" style="margin-top:0px;">ULD Contour</h4>
								<div class="blk_contour bu_txt">
									<ol class="added_list uld_contour_input_wrapper">
										<li class="uld_contour_input_row" data-rowid="1">
											<select class="select_bu" id="uld_select_type_1">
												<option value="">&nbsp;</option>
												<option value="A2">A2</option>
												<option value="A3">A3</option>
												<option value="H2">H2</option>
												<option value="H3">H3</option>
												<option value="L3">L3</option>
												<option value="Q6">Q6</option>
												<option value="Q7">Q7</option>
												<option value="S6">S6</option>
												<option value="UP">UP</option>
												<option value="W2">W2</option>
												<option value="W3">W3</option>
												<option value="X2">X2</option>
												<option value="X4">X4</option>
												<option value="X6">X6</option>
												<option value="X8">X8</option>
												<option value="ZA">ZA</option>
												<option value="ZB">ZB</option>
												<option value="ZC">ZC</option>
												<option value="C1">C1</option>
												<option value="C2">C2</option>
												<option value="C3">C3</option>
												<option value="J1">J1</option>
												<option value="J2">J2</option>
												<option value="J3">J3</option>
											</select>
											<input id="uld_no_value_1" type="text" placeholder="No.of ULDs" class="uld_int_input">
											<div class="error_or_msg" style="display: none;">Invalid</div>
										</li>
										<li class="uld_contour_input_row" data-rowid="2">
											<select class="select_bu" id="uld_select_type_2">
												<option value="">&nbsp;</option>
												<option value="A2">A2</option>
												<option value="A3">A3</option>
												<option value="H2">H2</option>
												<option value="H3">H3</option>
												<option value="L3">L3</option>
												<option value="Q6">Q6</option>
												<option value="Q7">Q7</option>
												<option value="S6">S6</option>
												<option value="UP">UP</option>
												<option value="W2">W2</option>
												<option value="W3">W3</option>
												<option value="X2">X2</option>
												<option value="X4">X4</option>
												<option value="X6">X6</option>
												<option value="X8">X8</option>
												<option value="ZA">ZA</option>
												<option value="ZB">ZB</option>
												<option value="ZC">ZC</option>
												<option value="C1">C1</option>
												<option value="C2">C2</option>
												<option value="C3">C3</option>
												<option value="J1">J1</option>
												<option value="J2">J2</option>
												<option value="J3">J3</option>
											</select>
											<input id="uld_no_value_2" type="text" placeholder="No.of ULDs" class="uld_int_input">
											<div class="error_or_msg" style="display: none;">Invalid</div>
										</li>
										<li class="uld_contour_input_row" data-rowid="3">
											<select class="select_bu" id="uld_select_type_3">
												<option value="">&nbsp;</option>
												<option value="A2">A2</option>
												<option value="A3">A3</option>
												<option value="H2">H2</option>
												<option value="H3">H3</option>
												<option value="L3">L3</option>
												<option value="Q6">Q6</option>
												<option value="Q7">Q7</option>
												<option value="S6">S6</option>
												<option value="UP">UP</option>
												<option value="W2">W2</option>
												<option value="W3">W3</option>
												<option value="X2">X2</option>
												<option value="X4">X4</option>
												<option value="X6">X6</option>
												<option value="X8">X8</option>
												<option value="ZA">ZA</option>
												<option value="ZB">ZB</option>
												<option value="ZC">ZC</option>
												<option value="C1">C1</option>
												<option value="C2">C2</option>
												<option value="C3">C3</option>
												<option value="J1">J1</option>
												<option value="J2">J2</option>
												<option value="J3">J3</option>
											</select>
											<input id="uld_no_value_3" type="text" placeholder="No.of ULDs" class="uld_int_input">
											<div class="error_or_msg" style="display: none;">Invalid</div>
										</li>
									</ol>
									<a id="btnAddULDIcon" href="javascript:void(0)" class="bu_plus_link" onclick="addULDEdit(event)"><span></span></a>
									<a id="btnAddULD" href="javascript:void(0)" class="bu_plus_link" onclick="addULDEdit(event)" data-i18n="uld.AddMoreULD">Add more ULD</a>
								</div>
							</div>

							<div class="blkc"></div>
						</div>

						<div class="clearfix"></div>
						
					</div>
				</div>
                <div>
                    <a href="javascript:void(0)" class="link_bu_l2" style="float: left;" onclick="closeULDEdit(event)" data-i18n="common.Cancel">Cancel</a>
                    <span href="javascript:void(0)" class="btn_or_l" onclick="saveULDEdit()" data-i18n="common.Save">Save</span>
                    <div class="blkc"></div>
                </div>
				
				
				
			</div>
		</div>
	</div>
	
</div>

<script id="bd_uld_contour_temp" type="text/x-template">
	<li data-rowid="%ID%">
		<label class="contour_temp_val type" style="margin: 0px; width: 60px;">%TYPE%</label>
		<div class="contour_temp_val">%WEIGHT%</div>
	</li>
</script>

<script id="bd_uld_contour_edit_temp" type="text/x-template">
	<li class="uld_contour_input_row extra_row" data-rowid="%ID%">
		<select class="select_bu" id="uld_select_type_%ID%">
			<option value="">&nbsp;</option>
			<option value="A2">A2</option>
			<option value="A3">A3</option>
			<option value="H2">H2</option>
			<option value="H3">H3</option>
			<option value="L3">L3</option>
			<option value="Q6">Q6</option>
			<option value="Q7">Q7</option>
			<option value="S6">S6</option>
			<option value="UP">UP</option>
			<option value="W2">W2</option>
			<option value="W3">W3</option>
			<option value="X2">X2</option>
			<option value="X4">X4</option>
			<option value="X6">X6</option>
			<option value="X8">X8</option>
			<option value="ZA">ZA</option>
			<option value="ZB">ZB</option>
			<option value="ZC">ZC</option>
			<option value="C1">C1</option>
			<option value="C2">C2</option>
			<option value="C3">C3</option>
			<option value="J1">J1</option>
			<option value="J2">J2</option>
			<option value="J3">J3</option>
		</select>
		<input id="uld_no_value_%ID%" type="text" placeholder="No.of ULDs" class="uld_int_input" />
		<div class="error_or_msg" style="display: none;">Invalid</div>
	</li>
</script>

<script id="uld_input_row_temp" type="text/x-template">
	<li class="uld_contour_input_row extra_row" data-rowid="%ID%">
		<select class="select_bu" id="uld_select_type_%ID%">
			<option value="">&nbsp;</option>
			<option value="A2">A2</option>
			<option value="A3">A3</option>
			<option value="H2">H2</option>
			<option value="H3">H3</option>
			<option value="L3">L3</option>
			<option value="Q6">Q6</option>
			<option value="Q7">Q7</option>
			<option value="S6">S6</option>
			<option value="UP">UP</option>
			<option value="W2">W2</option>
			<option value="W3">W3</option>
			<option value="X2">X2</option>
			<option value="X4">X4</option>
			<option value="X6">X6</option>
			<option value="X8">X8</option>
			<option value="ZA">ZA</option>
			<option value="ZB">ZB</option>
			<option value="ZC">ZC</option>
			<option value="C1">C1</option>
			<option value="C2">C2</option>
			<option value="C3">C3</option>
			<option value="J1">J1</option>
			<option value="J2">J2</option>
			<option value="J3">J3</option>
		</select>
		<input id="uld_no_value_%ID%" type="text" placeholder="No.of ULDs" class="uld_int_input" />
		<div class="error_or_msg" style="display: none;">Invalid</div>
	</li>
</script>

<script>
	var LHContourCodeList = ['C1', 'C2', 'C3', 'J1', 'J2', 'J3'];

	$(function() {
		var id = "#bkd_def_uld";
		var uldLity;
		
		$(id).on("clear", function(event) {
			//console.log(data);
			
			//debugger;
			$("#uld_upper_deck_pallet").val("");
			$("#uld_lower_deck_pallet").val("");
			$("#uld_lower_deck_container").val("");
			
			$("li[class^='uld_contour_input_row']").each(function (i, el) {
				//var id = el.id.substring(el.id.indexOf("_")+1);
				var rowid = $(this).attr("data-rowid");
				//console.log("flightSegment");
				//console.log("rowid: " +rowid);
				//console.log("i: " +i);
				 
				$("#uld_select_type_"+rowid).val("");
				$("#uld_no_value_"+rowid).val("");
				$("#uld_no_value_"+rowid).removeClass("invalid_input_field");
				$("#uld_no_value_"+rowid+" ~ .error_or_msg").hide();
				
			});
			
			$(".uld_contour_input_row.extra_row").remove();
			
			$("#uld_contour_table").empty();
			$("#bd_uld_upper_deck_pallet").text("");
			$("#bd_uld_lower_deck_pallet").text("");
			$("#bd_uld_lower_deck_container").text("");
			
			
		});
		
		$(id).on("init", function(event, data) {
			console.log(data);
			var currentRowID;
			debugger;
			//sdadsad
			
			$("#uld_upper_deck_pallet").val(data.ULDInfo.UpperDeckPallet);
			$("#uld_lower_deck_pallet").val(data.ULDInfo.LowerDeckPallet);
			$("#uld_lower_deck_container").val(data.ULDInfo.LowerDeckContainer);
			
			for (var i = 0; i < data.ULDInfo.ULDContour.length; i++) {
				currentRowID = i + 1;
				
				if (i > 2) {
					AddULDContourInput(currentRowID, i, function(cID, dataRow){
						$("#uld_select_type_" + cID).val(data.ULDInfo.ULDContour[dataRow].ULDType);
						$("#uld_no_value_" + cID).val(data.ULDInfo.ULDContour[dataRow].ULDVal);
					});
				} else {
					$("#uld_select_type_" + currentRowID).val(data.ULDInfo.ULDContour[i].ULDType);
					$("#uld_no_value_" + currentRowID).val(data.ULDInfo.ULDContour[i].ULDVal);
				}
			}
			
		});
		
		$(id).on("submit", function() {
		
			var bkdData = "";
			if (typeof localStorage.getItem("bd_uld_edit") !== 'undefined' && localStorage.getItem("bd_uld_edit") != null) {
				bkdData = JSON.parse(localStorage.getItem("bd_uld_edit"));
			} else if (typeof localStorage.getItem("bd_uld") !== 'undefined' && localStorage.getItem("bd_uld") != null) {
				bkdData = JSON.parse(localStorage.getItem("bd_uld"));
			}
			
			var upperDeckPallet = "";
			var lowerDeckPallet = "";
			var lowerDeckContainer = "";
			var uldList = [];
			

			var upperDeckPallet = $("#uld_upper_deck_pallet").val();
			var lowerDeckPallet = $("#uld_lower_deck_pallet").val();
			var lowerDeckContainer = $("#uld_lower_deck_container").val();
			
			for (var i = 0; i < bkdData.ULDList.length; i++) {
				var obj = new Object();
				obj.ULDType = bkdData.ULDList[i].Type;
				obj.ULDVal = bkdData.ULDList[i].Weight.toString();
				uldList.push(obj);
			}
			
			return { 
				"ULDInfo" : {
					"UpperDeckPallet": upperDeckPallet,
					"LowerDeckPallet": lowerDeckPallet,
					"LowerDeckContainer": lowerDeckContainer,
					"ULDContour": uldList
				}
			};
					
		});
		
		$(id).on("loadBookingData", function(event, bkdData) {
			console.log(bkdData);
			
			var obj = new Object();
			obj.ULDList = [];
			obj.UpperDeckPallet = "";
			obj.LowerDeckPallet = "";
			obj.LowerDeckContainer = "";
			
			var uldObj;
			
			if (typeof bkdData.FlightDetail !== 'undefined' && bkdData.FlightDetail != null) {
				if (bkdData.FlightDetail.length > 0) {
					if (typeof bkdData.FlightDetail[0].FlightDetailCx !== 'undefined' && bkdData.FlightDetail[0].FlightDetailCx != null) {
						obj.UpperDeckPallet = bkdData.FlightDetail[0].FlightDetailCx.UDP;
						obj.LowerDeckPallet = bkdData.FlightDetail[0].FlightDetailCx.LDP;
						obj.LowerDeckContainer = bkdData.FlightDetail[0].FlightDetailCx.LDC;
						
						if (typeof bkdData.FlightDetail[0].FlightDetailCx.ContourCodeList !== 'undefined' && bkdData.FlightDetail[0].FlightDetailCx.ContourCodeList != null) {
							for (var i = 0; i < bkdData.FlightDetail[0].FlightDetailCx.ContourCodeList.length; i++) {
								uldObj = new Object();
								uldObj.Type = bkdData.FlightDetail[0].FlightDetailCx.ContourCodeList[i].Code;
								uldObj.Weight = bkdData.FlightDetail[0].FlightDetailCx.ContourCodeList[i].Count;
								obj.ULDList.push(uldObj);
							}	
						}
						
					}
				}
			}
			
			/*
			for (var i = 0; i < bkdData.Uld.length; i++) {
				uldObj = new Object();
				uldObj.Type = bkdData.Uld[i].UldType;
				if (!isNaN(parseFloat(bkdData.Uld[i].UldWeight).toFixed(decimalWeightRoundTo))) {
					uldObj.Weight = parseFloat(bkdData.Uld[i].UldWeight).toFixed(decimalWeightRoundTo);
				} else {
					uldObj.Weight = bkdData.Uld[i].UldWeight;
				}
				obj.ULDList.push(uldObj);
			}
			*/
			
			
			localStorage.setItem("bd_uld", JSON.stringify(obj));
			localStorage.removeItem("bd_uld_edit");
			uldRefreshDisplay();
				
		});

		$(id).on("validate", function() {
			var isValid = true;
			if(!checkIfLHFlightExist()) {
				$("#uld_contour_table li .type").each(function (i, el) {
	    			if(_.find(LHContourCodeList, function(o) { return o == el.textContent; })){
	    				isValid = false;
	    			}
					
				});
			}

			if(!isValid){
				$('#bkd_def_uld').addClass('error_tag');
				DialogManager.alert(i18next.t("cargoInfo.InvalidValue"), i18next.t("uld.InvalidContourCode"));
			}
			else{
				$('#bkd_def_uld').removeClass('error_tag');
			}
			return isValid;
		});
		
		$(".uld_pallet_input").keypress(function(e) {
			if(e.which >= 48 && e.which <= 57 ){
			} else {
				return false;
			}
		});
		
		function AddULDContourInput(cID, dID, callback) {

			var row = $("#uld_input_row_temp").html();
			
            var currentRowID = getComponentRowID("uld_contour_input_row");
			row = row.replaceAll("%ID%", currentRowID + 1);
			$(".uld_contour_input_wrapper").append(row);

			if (typeof callback === "function" && typeof cID !== 'undefined' && typeof dID !== 'undefined') {
				callback(cID, dID);
			}
			
			$(".uld_int_input").keypress(function(e) {
				console.log(e.which);
				if(e.which >= 48 && e.which <= 57 ){
				} else {
					return false;
				}
			});

			$(".uld_dec_input, .uld_dec_input_weight").keypress(function(e) {
				console.log(e.which);
				if((e.which >= 48 && e.which <= 57) || e.which == 46 ){
				} else {
					return false;
				}
			});
			
			$(".uld_dec_input").blur(function(e) {
				if ($(this).val() != "") {
					$(this).val(FormatDecInput($(this).val(), decimalRoundTo));
				}
			});
			
			$(".uld_dec_input_weight").blur(function(e) {
				if ($(this).val() != "") {
					$(this).val(FormatDecInput($(this).val(), decimalWeightRoundTo));
				}
			});
        }
		
	});	
	
	function uldRefreshDisplay() {
		
		$("#uld_contour_table").empty();
		
		var bkdData = "";
		if (typeof localStorage.getItem("bd_uld_edit") !== 'undefined' && localStorage.getItem("bd_uld_edit") != null) {
			bkdData = JSON.parse(localStorage.getItem("bd_uld_edit"));
		} else if (typeof localStorage.getItem("bd_uld") !== 'undefined' && localStorage.getItem("bd_uld") != null) {
			bkdData = JSON.parse(localStorage.getItem("bd_uld"));
		}
		
		if (bkdData != "") {
			//console.log("fltRefreshDisplay: " + JSON.stringify(bkdData));
			if (bkdData.UpperDeckPallet != "") {
				$("#bd_uld_upper_deck_pallet").text(bkdData.UpperDeckPallet);
			} else {
				$("#bd_uld_upper_deck_pallet").text("-");
			}
			if (bkdData.LowerDeckPallet != "") {
				$("#bd_uld_lower_deck_pallet").text(bkdData.LowerDeckPallet);
			} else {
				$("#bd_uld_lower_deck_pallet").text("-");
			}
			if (bkdData.LowerDeckContainer != "") {
				$("#bd_uld_lower_deck_container").text(bkdData.LowerDeckContainer);
			} else {
				$("#bd_uld_lower_deck_container").text("-");
			}
			
			var uldContourTemp = $("#bd_uld_contour_temp").html();
			var uldContent;
			for (var i = 0; i < bkdData.ULDList.length; i++) {
				uldContent = uldContourTemp.replace("%TYPE%", bkdData.ULDList[i].Type).replace("%WEIGHT%", bkdData.ULDList[i].Weight).replace("%ID%", i);
				$("#uld_contour_table").append(uldContent);
			}	
			updateIndicatorULD();
		}
	}
	
	// uld edit
	
	function openULDEdit(e) {
		e.preventDefault();
		clearEditErrorMsgULD();
		regULDInit();
		$(".uld_contour_input_row.extra_row").remove();
		loadEditDataULD();
		uldLity = lity('#uld_edit');

		$('.uld_int_input').attr("placeholder", i18next.t("createBooking.NoOfULDs"));
	}
	
	function closeULDEdit(e) {
		if (typeof e !== 'undefined' && e != null) {
			e.preventDefault();
		}
		uldLity.close();
	}
	
	function regULDInit() {
		$(".uld_int_input").keypress(function(e) {
			console.log(e.which);
			if(e.which >= 48 && e.which <= 57 ){
			} else {
				return false;
			}
		});
	
		$(".uld_dec_input, .uld_dec_input_weight").keypress(function(e) {
			console.log(e.which);
			if((e.which >= 48 && e.which <= 57) || e.which == 46 ){
			} else {
				return false;
			}
		});
		
		$(".uld_dec_input").blur(function(e) {
			if ($(this).val() != "") {
				if ($(this).val().indexOf(".") > -1) {
					$(this).val(parseFloat($(this).val()).toFixed(decimalRoundTo));
				}
			}
		});
		
		$(".uld_dec_input_weight").blur(function(e) {
			if ($(this).val() != "") {
				if ($(this).val().indexOf(".") > -1) {
					$(this).val(parseFloat($(this).val()).toFixed(decimalWeightRoundTo));
				}
			}
		});
	}
	
	function loadEditDataULD() {
	
		uldResetEdit();
		
		var bkdData = "";
		if (typeof localStorage.getItem("bd_uld_edit") !== 'undefined' && localStorage.getItem("bd_uld_edit") != null) {
			bkdData = JSON.parse(localStorage.getItem("bd_uld_edit"));
		} else if (typeof localStorage.getItem("bd_uld") !== 'undefined' && localStorage.getItem("bd_uld") != null) {
			bkdData = JSON.parse(localStorage.getItem("bd_uld"));
		}
		
		if (bkdData != "") {

			$("#uld_upper_deck_pallet").val(bkdData.UpperDeckPallet);
			$("#uld_lower_deck_pallet").val(bkdData.LowerDeckPallet);
			$("#uld_lower_deck_container").val(bkdData.LowerDeckContainer);
			
			for (var i = 0; i < bkdData.ULDList.length; i++) {
				currentRowID = i + 1;
				
				if (i > 2) {
					AddULDEditInput(currentRowID, i, function(cID, dataRow){
						$("#uld_select_type_" + cID).val(bkdData.ULDList[dataRow].Type);
						$("#uld_no_value_" + cID).val(bkdData.ULDList[dataRow].Weight);
					});
				} else {
					$("#uld_select_type_" + currentRowID).val(bkdData.ULDList[i].Type);
					$("#uld_no_value_" + currentRowID).val(bkdData.ULDList[i].Weight);
				}
			}
		}
		
	}
	
	function validateULDInfo() {
		//var intVad = /^\+?(0|[1-9]\d*)$/;
		//var decVad = /^([1-9]\d*|0\.\d*[1-9]|[1-9]\d*\.\d*[0-9]|0)$/;
		var isValid = true;

		var upperDeckPallet = $("#uld_upper_deck_pallet").val();
		var lowerDeckPallet = $("#uld_lower_deck_pallet").val();
		var lowerDeckContainer = $("#uld_lower_deck_container").val();
		
		if (upperDeckPallet != ""){
		} else {
		}
		
		if (lowerDeckPallet != ""){
		} else {
		}
		
		if (lowerDeckContainer != ""){
		} else {
		}
		$("li[class^='uld_contour_input_row']").each(function (i, el) {
			//var id = el.id.substring(el.id.indexOf("_")+1);
			var rowid = $(this).attr("data-rowid");
			//console.log("flightSegment");
			//console.log("rowid: " +rowid);
			//console.log("i: " +i);
			 
			var ULDType = $("#uld_select_type_"+rowid).val();
			var ULDVal = $("#uld_no_value_"+rowid).val();

			$("#uld_no_value_"+rowid+" ~ .error_or_msg").text(i18next.t("uld.Invalid"));
			$("#uld_no_value_"+rowid).removeClass("invalid_input_field");
			$("#uld_select_type_"+rowid).removeClass("invalid_input_field");
			$("#uld_no_value_"+rowid+" ~ .error_or_msg").hide();
			
			if (ULDType != "") {
				if (ULDVal != "" && !intVad.test(ULDVal)) {
					//$("#uld_no_value_"+rowid).css("background-color", "#ffffcc");
					$("#uld_no_value_"+rowid).addClass("invalid_input_field");
					$("#uld_no_value_"+rowid+" ~ .error_or_msg").show();
					$("#uld_no_value_"+rowid+" ~ .error_or_msg").css("display", "inline");
					isValid = false;
				} else if (ULDVal == "" ){
					$("#uld_no_value_"+rowid).addClass("invalid_input_field");
					$("#uld_no_value_"+rowid+" ~ .error_or_msg").show();
					$("#uld_no_value_"+rowid+" ~ .error_or_msg").css("display", "inline");
					isValid = false;
				} else if(!checkIfLHFlightExist()) {
	    			if(_.find(LHContourCodeList, function(o) { return o == ULDType; })){
	    				$("#uld_no_value_"+rowid+" ~ .error_or_msg").text(i18next.t("uld.InvalidContourCode"));
	    				$("#uld_no_value_"+rowid+" ~ .error_or_msg").css("display", "block");
	    				$("#uld_no_value_"+rowid+" ~ .error_or_msg").show();
	    				$("#uld_select_type_"+rowid).addClass("invalid_input_field");
	    				isValid = false;
	    			}
				}
			} else if (ULDVal != "" ){
				$("#uld_no_value_"+rowid).addClass("invalid_input_field");
				$("#uld_no_value_"+rowid+" ~ .error_or_msg").show();
				$("#uld_no_value_"+rowid+" ~ .error_or_msg").css("display", "inline");
				isValid = false;
			}
			
		});
		console.log("uld isValid:" + isValid);
		return isValid;
	}
	
	function saveULDEdit() {
		
		if (!validateULDInfo()) {
			return false;
		}
		
		var obj = new Object();
		obj.ULDList = [];
		obj.UpperDeckPallet = $("#uld_upper_deck_pallet").val();
		obj.LowerDeckPallet = $("#uld_lower_deck_pallet").val();
		obj.LowerDeckContainer = $("#uld_lower_deck_container").val();
		
		var uldObj;
		
		$("li[class^='uld_contour_input_row']").each(function (i, el) {
			//var id = el.id.substring(el.id.indexOf("_")+1);
			var rowid = $(this).attr("data-rowid");
			//console.log("flightSegment");
			//console.log("rowid: " +rowid);
			//console.log("i: " +i);
			 
			var uldObj = new Object();
			uldObj.Type = $("#uld_select_type_"+rowid).val();
			uldObj.Weight = $("#uld_no_value_"+rowid).val();
			
			if (uldObj.Type == "" && uldObj.Weight == "") {
			} else {
				obj.ULDList.push(uldObj);
			}
			
		});
		
		localStorage.setItem("bd_uld_edit", JSON.stringify(obj));

		uldRefreshDisplay();
		closeULDEdit();
		
	}
	
	function updateIndicatorULD() {
		
		$(".contour_temp_val").removeClass("update_indicator");
		
		var original;
		var updated;
		var hasUpdate = false;
		
		if (typeof localStorage.getItem("bd_uld_edit") !== 'undefined' && localStorage.getItem("bd_uld_edit") != null) {
			original = JSON.parse(localStorage.getItem("bd_uld"));
			updated = JSON.parse(localStorage.getItem("bd_uld_edit"));

			if (typeof updated.ULDList !== 'undefined' && updated.ULDList != null) {
				
				if (typeof original.ULDList === 'undefined' || original.ULDList == null) {
					hasUpdate = true;
					$(".contour_temp_val").addClass("update_indicator");
				} else {
					//if (original.ULDList.length != updated.ULDList.length) {
					//	hasUpdate = true;
					//	$(".contour_temp_val").addClass("update_indicator");
					//} else {
						for (var i = 0; i < updated.ULDList.length; i++) {
							if (original.ULDList[i] !== 'undefined' && original.ULDList[i] != null) {
								if (original.ULDList[i].Type != updated.ULDList[i].Type 
								|| original.ULDList[i].Weight != updated.ULDList[i].Weight) {
									$("li[data-rowid='"+i+"'] .contour_temp_val").addClass("update_indicator");
									hasUpdate = true;
								}
							} else {
								$("li[data-rowid='"+i+"'] .contour_temp_val").addClass("update_indicator");
								hasUpdate = true;
							}
						}
					//}
				}
			}

			if (original.UpperDeckPallet != updated.UpperDeckPallet) {
				$("#bd_uld_upper_deck_pallet").addClass("update_indicator");
				hasUpdate = true;
			} else {
				$("#bd_uld_upper_deck_pallet").removeClass("update_indicator");
			}
			
			if (original.LowerDeckPallet != updated.LowerDeckPallet) {
				$("#bd_uld_lower_deck_pallet").addClass("update_indicator");
				hasUpdate = true;
			} else {
				$("#bd_uld_lower_deck_pallet").removeClass("update_indicator");
			}
			
			if (original.LowerDeckContainer != updated.LowerDeckContainer) {
				$("#bd_uld_lower_deck_container").addClass("update_indicator");
				hasUpdate = true;
			} else {
				$("#bd_uld_lower_deck_container").removeClass("update_indicator");
			}
		}
		
		if (hasUpdate) {
			localStorage.setItem("bd_uld_has_update", 1);
		}
		
	}
	
	function addULDEdit(e) {
		e.preventDefault();
		AddULDEditInput();
	}
	
	function AddULDEditInput(cID, dID, callback) {
		
		var row = $("#bd_uld_contour_edit_temp").html();
		
		var currentRowID = getComponentRowID("uld_contour_input_row");
		row = row.replaceAll("%ID%", currentRowID + 1);
		
		$(".uld_contour_input_wrapper").append(row);
		var newRowID = currentRowID + 1;

		if (typeof callback === "function" && typeof cID !== 'undefined' && typeof dID !== 'undefined') {
			callback(cID, dID);
		}
		
        regULDInit();
        refreshModuleTranslation();
        $('.uld_int_input').attr("placeholder", i18next.t("createBooking.NoOfULDs"));
	}
	
	function clearEditErrorMsgULD() {
		$("#uld_edit .error_or").removeClass("error_or");
		$("#uld_edit .error_or_msg").hide();
		
	}
	
	function uldResetEdit() {
		$("#uld_upper_deck_pallet").val("");
		$("#uld_lower_deck_pallet").val("");
		$("#uld_lower_deck_container").val("");
		
		$("li[class^='uld_contour_input_row']").each(function (i, el) {
			//var id = el.id.substring(el.id.indexOf("_")+1);
			var rowid = $(this).attr("data-rowid");
			//console.log("flightSegment");
			//console.log("rowid: " +rowid);
			//console.log("i: " +i);
			 
			$("#uld_select_type_"+rowid).val("");
			$("#uld_no_value_"+rowid).val("");
			$("#uld_no_value_"+rowid).removeClass("invalid_input_field");
			$("#uld_no_value_"+rowid+" ~ .error_or_msg").hide();
			
		});
		
		$(".uld_contour_input_row.extra_row").remove();
	}

	function checkIfLHFlightExist(){
    	var flightNoList = getData("bkd_def_flight", "AllFlightNo");

    	if(_.find(flightNoList, function(flightNo) { return flightNo.includes("LH"); })){
    		return true;
    	}
    	else{
    		return false;
    	}
    }
</script><div id="bkd_def_dim" class="bkd_block">
	<div class="col-xs-12">
		<h3 class="inline_block" data-i18n="dimension.Dimension">Dimension</h3>
		<a onclick="openDimEdit(event)" href="javascript:void(0)" class="btn_gy_edit"></a>
	</div>

	<div class="blkc"></div>

	<div class="col-xs-12">
		<div class="blk_gy_line blkl">
			<div class="blk_typeb table-responsive">

				<table id="dim_table" class="table table-sm">
					<thead>
						<tr><th scope="col"></th>
						<th data-i18n="dimension.Length" scope="col">Length</th>
						<th data-i18n="dimension.Width" scope="col">Width</th>
						<th data-i18n="dimension.Height" scope="col">Height</th>
						<th data-i18n="dimension.Unit" scope="col">Unit</th>
						<th data-i18n="cargoInfo.Pieces" scope="col">Pieces</th>
						<th data-i18n="dimension.Weight" scope="col">Weight(KG)</th>
						<th data-i18n="dimension.Volume" scope="col">Volume(m³)</th>
					</tr></thead>
					<tbody id="dim_table_body"></tbody>
					<tfoot>
						<tr>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td>Total</td>
							<td id="dim_disp_totalPiece">0</td>
							<td id="dim_disp_totalWeight">0.0</td>
							<td>
								<span id="dim_disp_totalVolume">0.000</span> <span id="dim_disp_VolUnit">MC</span>
							</td>
						</tr>


					</tfoot>
				</table>
			</div>

	    </div>
    </div>

    <div class="blkc"></div>

	<div class="clearfix"></div>

	<div class="booking_lb lity-hide" id="dim_edit" style="width: 100%; min-width: 900px; max-width: 900px;">
		<div class="lightbox_ctr" style="width: 100%;">
			<div class="close_ctr"><a id="btn_dim_edit_close" href="javascript:void(0)" class="close_btn" onclick="closeDimEdit(event)"></a></div>
			<div class="lightbox_blk">
				<h3 data-i18n="dimension.Dimension">Dimension</h3>
				<div class="blkc"></div>

				<div class="blk_filter">
					<div class="head_hr"></div>
					<div class="consign_info no_side_padding">


						<ol class="add_flights dimension added_list dimension_input_wrapper" style="display: inline-block; width: auto;">
							<li class="dimension_input_row" data-rowid="1" style="margin-right: 0px;">
								<div class="cnt_inline bu_txt w64 mr20">
									<label for="dimension_length_1" data-i18n="dimension.Length">Length</label>
									<input class="vol_cal_input dimension_int_input" type="text" value="" id="dimension_length_1" maxlength="5">
								</div>
								<div class="cnt_inline bu_txt w64 mr20">
									<label for="dimension_width_1" data-i18n="dimension.Width">Width</label>
									<input class="vol_cal_input dimension_int_input" type="text" value="" id="dimension_width_1" maxlength="5">
								</div>
								<div class="cnt_inline bu_txt w64 mr20">
									<label for="dimension_height_1" data-i18n="dimension.Height">Height</label>
									<input class="vol_cal_input dimension_int_input" type="text" value="" id="dimension_height_1" maxlength="5">
								</div>
								<div class="cnt_inline bu_txt w64 mr20 tbl_switch">
									<label for="cm1" data-i18n="dimension.Unit">Unit</label>
									<fieldset class="switch-toggle-set">
										<div class="switch-toggle switch-candy">
											<input id="dimension_cm_1" name="dimension-unit_1" type="radio" value="0" checked=""><label for="dimension_cm_1" onclick="" data-i18n="dimension.CM">CM</label>
											<input id="dimension_in_1" name="dimension-unit_1" type="radio" value="1"><label for="dimension_in_1" onclick="" data-i18n="dimension.IN">IN</label>
											<a></a>
										</div>
									</fieldset>
								</div>
								<div class="cnt_inline bu_txt w64 mr20">
									<label for="dimension_pcs_1" data-i18n="cargoInfo.Pieces">Pieces</label>
									<input class="vol_cal_input int_input pc_cal dimension_int_input" type="text" value="" id="dimension_pcs_1" maxlength="4">
								</div>
								<div class="cnt_inline bu_txt w64 mr20">
									<label for="dimension_weight_1" data-i18n="dimension.Weight">Weight(KG)</label>
									<input class="weight_cal dimension_dec_input_weight" type="text" value="" id="dimension_weight_1" maxlength="7">
								</div>
								<div class="cnt_inline bu_txt w64 mr20">
									<label for="dimension_vol_1" data-i18n="dimension.Volume">Volume(m³)</label>
									<input class="volume_cal bkd_num_input" type="text" value="" id="dimension_vol_1" readonly="readonly">
								</div>
								<span class="rubbish_bin" onclick="ClearRow(this.parentElement)"></span>
							</li>

							<li class="dimension_input_row" data-rowid="2" style="margin-right: 0px;">
								<div class="cnt_inline bu_txt w64 mr20">
									<label for="dimension_length_2" data-i18n="dimension.Length">Length</label>
									<input class="vol_cal_input dimension_int_input" type="text" value="" id="dimension_length_2" maxlength="5">
								</div>
								<div class="cnt_inline bu_txt w64 mr20">
									<label for="dimension_width_2" data-i18n="dimension.Width">Width</label>
									<input class="vol_cal_input dimension_int_input" type="text" value="" id="dimension_width_2" maxlength="5">
								</div>
								<div class="cnt_inline bu_txt w64 mr20">
									<label for="dimension_height_2" data-i18n="dimension.Height">Height</label>
									<input class="vol_cal_input dimension_int_input" type="text" value="" id="dimension_height_2" maxlength="5">
								</div>
								<div class="cnt_inline bu_txt w64 mr20 tbl_switch">
									<label for="dimension_cm_2" data-i18n="dimension.Unit">Unit</label>
									<fieldset class="switch-toggle-set">
										<div class="switch-toggle switch-candy">
											<input id="dimension_cm_2" name="dimension-unit_2" type="radio" value="0" checked=""><label for="dimension_cm_2" onclick="" data-i18n="dimension.CM">CM</label>
											<input id="dimension_in_2" name="dimension-unit_2" type="radio" value="1"><label for="dimension_in_2" onclick="" data-i18n="dimension.IN">IN</label>
											<a></a>
										</div>
									</fieldset>
								</div>
								<div class="cnt_inline bu_txt w64 mr20">
									<label for="dimension_pcs_2" data-i18n="cargoInfo.Pieces">Pieces</label>
									<input class="vol_cal_input int_input pc_cal dimension_int_input" type="text" value="" id="dimension_pcs_2" maxlength="4">
								</div>
								<div class="cnt_inline bu_txt w64 mr20">
									<label for="dimension_weight_2" data-i18n="dimension.Weight">Weight(KG)</label>
									<input class="weight_cal dimension_dec_input_weight" type="text" value="" id="dimension_weight_2" maxlength="7">
								</div>
								<div class="cnt_inline bu_txt w64 mr20">
									<label for="dimension_vol_2" data-i18n="dimension.Volume">Volume(m³)</label>
									<input class="volume_cal bkd_num_input" type="text" value="" id="dimension_vol_2" readonly="readonly">
								</div>
								<span class="rubbish_bin" onclick="ClearRow(this.parentElement)"></span>
							</li>

							<li class="dimension_input_row" data-rowid="3" style="margin-right: 0px;">
								<div class="cnt_inline bu_txt w64 mr20">
									<label for="dimension_length_3" data-i18n="dimension.Length">Length</label>
									<input class="vol_cal_input dimension_int_input" type="text" value="" id="dimension_length_3" maxlength="5">
								</div>
								<div class="cnt_inline bu_txt w64 mr20">
									<label for="dimension_width_3" data-i18n="dimension.Width">Width</label>
									<input class="vol_cal_input dimension_int_input" type="text" value="" id="dimension_width_3" maxlength="5">
								</div>
								<div class="cnt_inline bu_txt w64 mr20">
									<label for="dimension_height_3" data-i18n="dimension.Height">Height</label>
									<input class="vol_cal_input dimension_int_input" type="text" value="" id="dimension_height_3" maxlength="5">
								</div>
								<div class="cnt_inline bu_txt w64 mr20 tbl_switch">
									<label for="cm3" data-i18n="dimension.Unit">Unit</label>
									<fieldset class="switch-toggle-set">
										<div class="switch-toggle switch-candy">
											<input id="dimension_cm_3" name="dimension-unit_3" type="radio" value="0" checked=""><label for="dimension_cm_3" onclick="" data-i18n="dimension.CM">CM</label>
											<input id="dimension_in_3" name="dimension-unit_3" type="radio" value="1"><label for="dimension_in_3" onclick="" data-i18n="dimension.IN">IN</label>
											<a></a>
										</div>
									</fieldset>
								</div>
								<div class="cnt_inline bu_txt w64 mr20">
									<label for="dimension_pcs_3" data-i18n="cargoInfo.Pieces">Pieces</label>
									<input class="vol_cal_input int_input pc_cal dimension_int_input" type="text" value="" id="dimension_pcs_3" maxlength="4">
								</div>
								<div class="cnt_inline bu_txt w64 mr20">
									<label for="dimension_weight_3" data-i18n="dimension.Weight">Weight(KG)</label>
									<input class="weight_cal dimension_dec_input_weight" type="text" value="" id="dimension_weight_3" maxlength="7">
								</div>
								<div class="cnt_inline bu_txt w64 mr20">
									<label for="dimension_vol_3" data-i18n="dimension.Volume">Volume(m³)</label>
									<input class="volume_cal bkd_num_input" type="text" value="" id="dimension_vol_3" readonly="readonly">
								</div>
								<span class="rubbish_bin" onclick="ClearRow(this.parentElement)"></span>
							</li>
						</ol>
						<div>
							<a id="btnDimensionAddIcon" href="javascript:void(0)" class="bu_plus_link" style="display:inline-block;" tabindex="-1"><span></span></a>
							<a id="btnDimensionAdd" href="javascript:void(0)" class="bu_plus_link" style="display:inline-block;" data-i18n="cargoInfo.AddMore">Add More</a>
						</div>
						<!-- total value -->
						<div>
							<div style="" class="dimension_total title" data-i18n="dimension.Total">Total:</div>
							<div style="" class="dimension_total"><span data-i18n="cargoInfo.Pieces">Pieces</span><div id="dimension_pc_total">0</div></div>
							<div style="" class="dimension_total"><span data-i18n="dimension.Weight">Weight(KG)</span><div id="dimension_weight_total">0.0</div></div>
							<div style="" class="dimension_total bkd_num_input">
								<span data-i18n="dimension.Volume">Volume(m³)</span>
								<div id="dimension_volume_total" class="bkd_num_input">0.00</div>
								<div id="total_in_selected_unit_wrapper">
									<span id="total_in_selected_unit" class="bkd_num_input">0.00</span>
									<span id="selected_unit"></span>
								</div>
							</div>
							<span id="delete_all_btn" class="rubbish_bin" onclick="ClearAllRows($(&#39;.dimension_input_wrapper&#39;))" data-i18n="dimension.DeleteAll">Delete All</span>
						</div>

						<div id="dimension_pieces_err" class="error_or_msg" style="display:none;">
							<span data-i18n="dimension.InvalidPieces">Pieces input does not match to Cargo Information</span>
							<span id="dimension_cargo_info_pieces">
							</span>
						</div>

						<div id="dimension_weight_err" class="error_or_msg" style="display:none;">
							<span data-i18n="dimension.InvalidWeight">Weight input does not match with Cargo Information</span>
							<span id="dimension_cargo_info_weight">
							</span>
						</div>


						<div class="clearfix"></div>

					</div>
				</div>




			</div>



			<div>
				<a href="javascript:void(0)" class="link_bu_l2" style="float: left;" onclick="closeDimEdit(event)" data-i18n="common.Cancel">Cancel</a>
				<span href="javascript:void(0)" class="btn_or_l" onclick="saveDimEdit()" data-i18n="common.Save">Save</span>
				<div class="blkc"></div>
			</div>




		</div>
	</div>

</div>

<script id="bd_dim_table_body_temp" type="text/x-template">
	<tr data-rowid="%ID%" class="dim_temp_val">
		<td>%ID%.</td>
		<td>%LENGTH%</td>
		<td>%WIDTH%</td>
		<td>%HEIGHT%</td>
		<td>%UNIT%</td>
		<td>%PIECES%</td>
		<td>%WEIGHT_KG%</td>
		<td>%VOLUME_M3%</td>
	</tr>
</script>

<script id="bd_dim_edit_temp" type="text/x-template">
	<li class="dimension_input_row extra_row" data-rowid="%ID%" style="margin-right: 0px;">
		<div class="cnt_inline bu_txt w64 mr20">
			<label for="dimension_length_%ID%" data-i18n="dimension.Length">Length</label>
			<input class="vol_cal_input dimension_int_input" type="text" value="" id="dimension_length_%ID%" maxlength="5">
		</div>
		<div class="cnt_inline bu_txt w64 mr20">
			<label for="dimension_width_%ID%" data-i18n="dimension.Width">Width</label>
			<input class="vol_cal_input dimension_int_input" type="text" value="" id="dimension_width_%ID%" maxlength="5">
		</div>
		<div class="cnt_inline bu_txt w64 mr20">
			<label for="dimension_height_%ID%" data-i18n="dimension.Height">Height</label>
			<input class="vol_cal_input dimension_int_input" type="text" value="" id="dimension_height_%ID%" maxlength="5">
		</div>
		<div class="cnt_inline bu_txt w64 mr20 tbl_switch">
			<label for="dimension_cm_%ID%" data-i18n="dimension.Unit">Unit</label>
			<fieldset class="switch-toggle-set">
				<div class="switch-toggle switch-candy">
					<input id="dimension_cm_%ID%" name="dimension-unit_%ID%" type="radio" value="0" checked><label for="dimension_cm_%ID%" onclick="" data-i18n="dimension.CM">CM</label>
					<input id="dimension_in_%ID%" name="dimension-unit_%ID%" type="radio" value="1"><label for="dimension_in_%ID%" onclick="" data-i18n="dimension.IN">IN</label>
					<a></a>
				</div>
			</fieldset>
		</div>
		<div class="cnt_inline bu_txt w64 mr20">
			<label for="dimension_pcs_%ID%" data-i18n="cargoInfo.Pieces">Pieces</label>
			<input class="vol_cal_input int_input pc_cal dimension_int_input" type="text" value="" id="dimension_pcs_%ID%" maxlength="4">
		</div>
		<div class="cnt_inline bu_txt w64 mr20">
			<label for="dimension_weight_%ID%" data-i18n="dimension.Weight">Weight(KG)</label>
			<input class="weight_cal dimension_dec_input_weight" type="text" value="" id="dimension_weight_%ID%" maxlength="7">
		</div>
		<div class="cnt_inline bu_txt w64 mr20">
			<label for="dimension_vol_%ID%" data-i18n="dimension.Volume">Volume(m³)</label>
			<input class="volume_cal bkd_num_input" type="text" value="" id="dimension_vol_%ID%" readonly="readonly">
		</div>
		<span class="rubbish_bin" onclick="ClearRow(this.parentElement)"></span>
	</li>
</script>

<script>
	$(function() {
		var id = "#bkd_def_dim";
		var dimLity;

		$(id).on("clear", function(event) {
			$("#dim_table_body").empty();
		});

		$(id).on("init", function(event, data) {
			console.log(data);

		});

		$(id).on("submit", function() {

			var bkdData = "";
			if (typeof localStorage.getItem("bd_dim_edit") !== 'undefined' && localStorage.getItem("bd_dim_edit") != null) {
				bkdData = JSON.parse(localStorage.getItem("bd_dim_edit"));
			} else if (typeof localStorage.getItem("bd_dim") !== 'undefined' && localStorage.getItem("bd_dim") != null) {
				bkdData = JSON.parse(localStorage.getItem("bd_dim"));
			}

			var dimensionList = [];

			for (var i = 0; i < bkdData.DimList.length; i++) {
				var obj = new Object();
				obj.Seq = (i + 1).toString();
				obj.Length = bkdData.DimList[i].Length.toString();
				obj.Width = bkdData.DimList[i].Width.toString();
				obj.Height = bkdData.DimList[i].Height.toString();
				obj.Unit = (bkdData.DimList[i].UnitCode == 0) ? "0" : "1" ;
				obj.Pieces = bkdData.DimList[i].Pieces.toString();
				obj.Weight = bkdData.DimList[i].Weight.toString();
				obj.Volume = bkdData.DimList[i].Volume.toString();
				dimensionList.push(obj);
			}

			return {
				"DimensionInfo" : {
					"Dimension": dimensionList
				}
			};
		});

		$(id).on("loadBookingData", function(event, bkdData) {
			console.log(bkdData);
			var obj = new Object();
			obj.DimList = [];
			obj.TotalPieces = 0;
			obj.TotalWeight = 0;
			obj.TotalVolume = 0;
			var dimObj;

			if (typeof bkdData.DimInfo !== 'undefined' && bkdData.DimInfo != null) {
				if (bkdData.DimInfo.length > 0) {
					var pcVal = 0;
					var weightVal = 0;
					var volumeVal = 0;

					for (var i = 0; i < bkdData.DimInfo.length; i++)
					{
						dimObj = new Object();
						dimObj.Weight = bkdData.DimInfo[i].DiWeight;
						dimObj.Length = bkdData.DimInfo[i].DiLength;
						dimObj.Width = bkdData.DimInfo[i].DiWidth;
						dimObj.UnitCode = bkdData.DimInfo[i].DiUnitCode;
						dimObj.Height = bkdData.DimInfo[i].DiHeight;
						dimObj.Pieces = bkdData.DimInfo[i].DiPieces;

						if (dimObj.UnitCode == 0)
							dimObj.Volume = calculateVolumeFromUnitCm(dimObj.Length, dimObj.Width, dimObj.Height, dimObj.Pieces, decimalRoundTo)
						else if (dimObj.UnitCode == 3)
							dimObj.Volume = calculateVolumeFromUnitInh(dimObj.Length, dimObj.Width, dimObj.Height, dimObj.Pieces, decimalRoundTo)
						else
							dimObj.Volume = 0;

						obj.DimList.push(dimObj);
						pcVal += parseInt(dimObj.Pieces);
						weightVal += parseFloat(dimObj.Weight);
						volumeVal += parseFloat(dimObj.Volume);
					}

					obj.TotalPieces += parseInt(pcVal.toFixed(decimalRoundTo));
					obj.TotalWeight += parseFloat(weightVal.toFixed(decimalWeightRoundTo));
					obj.TotalVolume += parseFloat(volumeVal.toFixed(decimalVolumeRoundToCX));
				}
			}

			localStorage.setItem("bd_dim", JSON.stringify(obj));
			localStorage.removeItem("bd_dim_edit");
			dimRefreshDisplay();
		});

		$(id).on("validate", function() {
			var isValid = true;

			return isValid;
		});

		$(id).on("getData", function(event, dataID){
			console.log(dataID);

			var rtn;
			var seq;
			var dataType = dataID.substring(0, dataID.lastIndexOf("_"));
			if (dataType == "") {
				dataType = dataID;
			} else {
				seq = dataID.substring(dataID.lastIndexOf("_")+1);
			}

			switch(dataType) {
				case "Length":
					rtn = $("#dimension_length_"+seq).val();
					break;
				case "Width":
					rtn = $("#dimension_width_"+seq).val()
					break;
				case "Height":
					rtn = $("#dimension_height_"+seq).val();
					break;
				case "Unit":
					rtn = $("input[name=dimension-unit_"+rowid+"]:checked").val();
					break;
				case "Piece":
					rtn = $("#dimension_pcs_"+seq).val();
					break;
				case "Weight":
					rtn = $("#dimension_weight_"+seq).val();
					break;
				case "Volume":
					rtn = $("#dimension_vol_"+seq).val();
					break;
				case "TotalPiece":
					rtn = $("#dimension_pc_total").text();
					break;
				case "TotalWeight":
					rtn = $("#dimension_weight_total").text();
					break;
				case "TotalVolume":
					rtn = $("#dimension_volume_total").text();
					break;
			}

			return rtn;

		});

		$("#btnDimensionAdd").click(function (e){
			e.preventDefault();
			AddDimensionEditInput();
			$(".dimension_input_wrapper li").last().find("input").first().focus();
		});

		$(".dimension_int_input").keypress(function(e) {
			if(e.which >= 48 && e.which <= 57 ){
			} else {
				return false;
			}
		});

		$(".dimension_dec_input, .dimension_dec_input_weight").keypress(function(e) {
			if((e.which >= 48 && e.which <= 57) || e.which == 46 ){
			} else {
				return false;
			}
		});

		$(".dimension_dec_input").blur(function(e) {
			if ($(this).val() != "") {
				$(this).val(FormatDecInput($(this).val(), decimalRoundTo));
			}
		});

		$(".dimension_dec_input_weight").blur(function(e) {
			if ($(this).val() != "") {
				$(this).val(FormatDecInput($(this).val(), decimalWeightRoundTo));
			}
		});
	});

	function dimRefreshDisplay() {
		var currentRowID;

		$("#dim_table_body").empty();

		var bkdData = "";
		var bkdCargoData = "";
		if (typeof localStorage.getItem("bd_dim_edit") !== 'undefined' && localStorage.getItem("bd_dim_edit") != null) {
			bkdData = JSON.parse(localStorage.getItem("bd_dim_edit"));
		} else if (typeof localStorage.getItem("bd_dim") !== 'undefined' && localStorage.getItem("bd_dim") != null) {
			bkdData = JSON.parse(localStorage.getItem("bd_dim"));
		}

		if (typeof localStorage.getItem("bd_cargo_info_edit") !== 'undefined' && localStorage.getItem("bd_cargo_info_edit") != null) {
			bkdCargoData = JSON.parse(localStorage.getItem("bd_cargo_info_edit"));
		} else if (typeof localStorage.getItem("bd_cargo_info") !== 'undefined' && localStorage.getItem("bd_cargo_info") != null) {
			bkdCargoData = JSON.parse(localStorage.getItem("bd_cargo_info"));
		}

		if (bkdData != "" && bkdCargoData != "") {

			var dimTblBodyTemp = $("#bd_dim_table_body_temp").html();
			var dimBodyContent;
			for (var i = 0; i < bkdData.DimList.length; i++) {
				currentRowID = i + 1;
				dimBodyContent = dimTblBodyTemp
									.replaceAll("%ID%", currentRowID)
									.replace("%LENGTH%", bkdData.DimList[i].Length)
									.replace("%WIDTH%", bkdData.DimList[i].Width)
									.replace("%HEIGHT%", bkdData.DimList[i].Height)
									.replace("%UNIT%", getDimUnitTextBoCode(bkdData.DimList[i].UnitCode))
									.replace("%PIECES%", bkdData.DimList[i].Pieces)
									.replace("%WEIGHT_KG%", bkdData.DimList[i].Weight.toFixed(decimalWeightRoundTo))
									.replace("%VOLUME_M3%", bkdData.DimList[i].Volume.toFixed(decimalVolumeRoundToCX));
				$("#dim_table_body").append(dimBodyContent);
			}

			$("#dim_disp_totalPiece").text(bkdData.TotalPieces);
			$("#dim_disp_totalWeight").text(bkdData.TotalWeight.toFixed(decimalWeightRoundTo));
			$("#dim_disp_totalVolume").text(bkdData.TotalVolume.toFixed(decimalVolumeRoundToCX));
			$("#dim_disp_VolUnit").text(getVolUnitTextByCode(bkdCargoData.VolumeCode));
			updateIndicatorDim();
			updateIndicatorCargoInfo();
		}
	}

	// dimension edit

	function openDimEdit(e) {
		e.preventDefault();
		clearEditErrorMsgDim();
		loadEditDataCargoInfo();
		loadEditDataDim();
		RegDimensionCal(decimalVolumeRoundToCX);
		dimLity = lity('#dim_edit');
	}

	function closeDimEdit(e) {
		if (typeof e !== 'undefined' && e != null) {
			e.preventDefault();
		}
		dimLity.close();
	}

	function loadEditDataDim() {

		var bkdData = "";
		if (typeof localStorage.getItem("bd_dim_edit") !== 'undefined' && localStorage.getItem("bd_dim_edit") != null) {
			bkdData = JSON.parse(localStorage.getItem("bd_dim_edit"));
		} else if (typeof localStorage.getItem("bd_dim") !== 'undefined' && localStorage.getItem("bd_dim") != null) {
			bkdData = JSON.parse(localStorage.getItem("bd_dim"));
		}

		var bkdCargoData = "";
		if (typeof localStorage.getItem("bd_cargo_info_edit") !== 'undefined' && localStorage.getItem("bd_cargo_info_edit") != null) {
			bkdCargoData = JSON.parse(localStorage.getItem("bd_cargo_info_edit"));
		} else if (typeof localStorage.getItem("bd_cargo_info") !== 'undefined' && localStorage.getItem("bd_cargo_info") != null) {
			bkdCargoData = JSON.parse(localStorage.getItem("bd_cargo_info"));
		}

		if (bkdData != "" || bkdCargoData != "") {

			for (var i = 0; i < bkdData.DimList.length; i++) {
				currentRowID = i + 1;

				if (i > 2) {

					AddDimensionEditInput(currentRowID, i, function(cID, dataRow){
						$("#dimension_length_" + cID).val(bkdData.DimList[i].Length);
						$("#dimension_width_" + cID).val(bkdData.DimList[i].Width);
						$("#dimension_height_" + cID).val(bkdData.DimList[i].Height);
						//Unit Code
						if (bkdData.DimList[i].UnitCode == 0 || typeof bkdData.DimList[i].UnitCode === 'undefined'){
							$("#dimension_cm_" + cID).prop("checked", true);
						} else {
							$("#dimension_in_" + cID).prop("checked", true);
						}

						$("#dimension_pcs_" + cID).val(bkdData.DimList[i].Pieces);
						$("#dimension_weight_" + cID).val(bkdData.DimList[i].Weight);
						$("#dimension_vol_" + cID).val(bkdData.DimList[i].Volume);
					});
				} else {

					$("#dimension_length_" + currentRowID).val(bkdData.DimList[i].Length);
					$("#dimension_width_" + currentRowID).val(bkdData.DimList[i].Width);
					$("#dimension_height_" + currentRowID).val(bkdData.DimList[i].Height);
					//Unit Code
					if (bkdData.DimList[i].UnitCode == 0 || typeof bkdData.DimList[i].UnitCode === 'undefined'){
						$("#dimension_cm_" + currentRowID).prop("checked", true);
					} else {
						$("#dimension_in_" + currentRowID).prop("checked", true);
					}

					$("#dimension_pcs_" + currentRowID).val(bkdData.DimList[i].Pieces);
					$("#dimension_weight_" + currentRowID).val(bkdData.DimList[i].Weight);
					$("#dimension_vol_" + currentRowID).val(bkdData.DimList[i].Volume);
				}

			}

			$("#dimension_pc_total").text(bkdData.TotalPieces);
			$("#dimension_weight_total").text(bkdData.TotalWeight.toFixed(decimalWeightRoundTo));
			$("#dimension_volume_total").text(bkdData.TotalVolume.toFixed(decimalVolumeRoundToCX));
			$("#total_in_selected_unit").text(bkdData.TotalVolume.toFixed(decimalVolumeRoundToCX));
			$("#selected_unit").text(getVolUnitTextByCode(bkdCargoData.VolumeCode));
		}

	}

	function validateDimInfo() {
		//var intVad = /^\+?(0|[1-9]\d*)$/;
		//var decVad = /^([1-9]\d*|0\.\d*[1-9]|[1-9]\d*\.\d*[0-9]|0)$/;
		var isValid = true;

		$("li[class^='dimension_input_row']").each(function (i, el) {
			//var id = el.id.substring(el.id.indexOf("_")+1);
			var rowid = $(this).attr("data-rowid");
			//console.log("flightSegment");
			//console.log("rowid: " +rowid);
			//console.log("i: " +i);

			var Length = $("#dimension_length_"+rowid).val();
			var Width = $("#dimension_width_"+rowid).val();
			var Height = $("#dimension_height_"+rowid).val();
			var Unit = $("input[name=dimension-unit_"+rowid+"]:checked").val();
			var Pieces = $("#dimension_pcs_"+rowid).val();
			var Weight = $("#dimension_weight_"+rowid).val();
			var Volume = $("#dimension_vol_"+rowid).val();

			if (Length != "" || Width != "" || Height != "" || Pieces != "" || Weight != "") {
				if (!decVad.test(Length)){
					$("#dimension_length_"+rowid).addClass("invalid_input_field");
					isValid = false;
				} else {
					$("#dimension_length_"+rowid).removeClass("invalid_input_field");
				}

				if (!decVad.test(Width)){
					$("#dimension_width_"+rowid).addClass("invalid_input_field");
					isValid = false;
				} else {
					$("#dimension_width_"+rowid).removeClass("invalid_input_field");
				}

				if (!decVad.test(Height)){
					$("#dimension_height_"+rowid).addClass("invalid_input_field");
					isValid = false;
				} else {
					$("#dimension_height_"+rowid).removeClass("invalid_input_field");
				}

				if (!intVad.test(Pieces) || Pieces == 0){
					$("#dimension_pcs_"+rowid).addClass("invalid_input_field");
					isValid = false;
				} else {
					$("#dimension_pcs_"+rowid).removeClass("invalid_input_field");
				}

				if (!decVad.test(Weight)){
					$("#dimension_weight_"+rowid).addClass("invalid_input_field");
					isValid = false;
				} else {
					$("#dimension_weight_"+rowid).removeClass("invalid_input_field");
				}
				/*
				if (!decVad.test(Volume)){
					$("#dimension_vol_"+rowid).addClass("invalid_input_field");
					isValid = false;
				} else {
					$("#dimension_vol_"+rowid).removeClass("invalid_input_field");
				}
				*/
			} else {
				$("#dimension_length_"+rowid).removeClass("invalid_input_field");
				$("#dimension_width_"+rowid).removeClass("invalid_input_field");
				$("#dimension_height_"+rowid).removeClass("invalid_input_field");
				$("#dimension_pcs_"+rowid).removeClass("invalid_input_field");
				$("#dimension_weight_"+rowid).removeClass("invalid_input_field");
				$("#dimension_vol_"+rowid).removeClass("invalid_input_field");
			}
		});

		if(!(cXbkdDimCheckPcs() && bkdDimCheckWeight())){
			isValid = false;
			$("#bkd_def_dim").addClass('error_tag');
		}
		else {
			$("#bkd_def_dim").removeClass('error_tag');
		}

		updateTotalVolInSelectUnit(decimalVolumeRoundToCX);

		console.log("dimension isValid:" + isValid);
		return isValid;
	}

	function saveDimEdit() {

		if (!validateDimInfo()) {
			return false;
		}

		var obj = new Object();
		obj.DimList = [];
		obj.TotalPieces = parseInt($("#dimension_pc_total").text());
		obj.TotalWeight = parseFloat($("#dimension_weight_total").text());
		obj.TotalVolume = parseFloat($("#dimension_volume_total").text());

		var dimObj;

		$("li[class^='dimension_input_row']").each(function (i, el) {
			var rowid = $(this).attr("data-rowid");

			var length = $("#dimension_length_"+rowid).val();
			var width = $("#dimension_width_"+rowid).val();
			var height = $("#dimension_height_"+rowid).val();
			var pieces = $("#dimension_pcs_"+rowid).val();
			var weight = $("#dimension_weight_"+rowid).val();
			var volume = $("#dimension_vol_"+rowid).val();

			var unit = 0;
			if ($("#dimension_cm_"+rowid).prop("checked"))
				unit = 0 ;
			else if ($("#dimension_in_"+rowid).prop("checked"))
				unit = 3 ;

			if (length != "" || width != "" || height != "" || pieces != "" || weight != "") {

				var dimObj = new Object();
				dimObj.UnitCode = unit;
				dimObj.Width = parseInt(width);
				dimObj.Length = parseInt(length);
				dimObj.Height = parseInt(height);
				dimObj.Pieces = parseInt(pieces);
				dimObj.Weight = parseFloat(weight);

				if (dimObj.UnitCode == 0)
					dimObj.Volume = calculateVolumeFromUnitCm(dimObj.Length, dimObj.Width, dimObj.Height, dimObj.Pieces, decimalVolumeRoundToCX)
				else if (dimObj.UnitCode == 3)
					dimObj.Volume = calculateVolumeFromUnitInh(dimObj.Length, dimObj.Width, dimObj.Height, dimObj.Pieces, decimalVolumeRoundToCX)
				else
					dimObj.Volume = 0;

				obj.DimList.push(dimObj);

			}

		});

		localStorage.setItem("bd_dim_edit", JSON.stringify(obj));

		//Copy the total dim volume to cargoInfo
		var bkdCargoData = "";
		if (typeof localStorage.getItem("bd_cargo_info_edit") !== 'undefined' && localStorage.getItem("bd_cargo_info_edit") != null) {
			bkdCargoData = JSON.parse(localStorage.getItem("bd_cargo_info_edit"));
		} else if (typeof localStorage.getItem("bd_cargo_info") !== 'undefined' && localStorage.getItem("bd_cargo_info") != null) {
			bkdCargoData = JSON.parse(localStorage.getItem("bd_cargo_info"));
		}

		bkdCargoData.Volume = obj.TotalVolume.toString();

		localStorage.setItem("bd_cargo_info_edit", JSON.stringify(bkdCargoData));
		//Copy end

		//For non split-booking, copy the dim volume to cargoInfo
		var bkdFlightData = "";
		var origs = [];
		var dests = [];
		if (typeof localStorage.getItem("bd_flight_edit") !== 'undefined' && localStorage.getItem("bd_flight_edit") != null) {
			bkdFlightData = JSON.parse(localStorage.getItem("bd_flight_edit"));
		} else if (typeof localStorage.getItem("bd_flight") !== 'undefined' && localStorage.getItem("bd_flight") != null) {
			bkdFlightData = JSON.parse(localStorage.getItem("bd_flight"));
		}
		var bkdFlightSegments = _.filter(bkdFlightData.FlightDetail, function(o) { return o.IsDelete == 0; });

		for (var i = 0; i < bkdFlightSegments.length; i++)
		{
			var from = bkdFlightSegments[i].DeparturePort;
			var to = bkdFlightSegments[i].ArrivalPort;

			if(from)
				origs.push(from);

			if(to)
				dests.push(to);
		}

		for (var i = 0; i < bkdFlightSegments.length; i++)
		{
			var isSplitBooking = false;
			var volume;

			var from = bkdFlightSegments[i].DeparturePort;
			var to = bkdFlightSegments[i].ArrivalPort;

			if(_.filter(origs, function(o) { return o == from; }).length > 1 || _.filter(dests, function(d) { return d == to; }).length > 1){
				isSplitBooking = true;
			}

			if (!isSplitBooking)
			{
				if (bkdFlightSegments[i].FlightDetailCx)
				{
					bkdFlightSegments[i].FlightDetailCx.Volume = obj.TotalVolume;
				}
			}
		}
		bkdFlightData.FlightDetail = bkdFlightSegments;
		localStorage.setItem("bd_flight_edit", JSON.stringify(bkdFlightData));
		//End



		dimRefreshDisplay();
		cargoInfoRefreshDisplay();
		fltRefreshDisplay();
		closeDimEdit();

	}

	function updateIndicatorDim() {
		var original;
		var updated;
		var hasUpdate = false;

		if (typeof localStorage.getItem("bd_dim_edit") !== 'undefined' && localStorage.getItem("bd_dim_edit") != null) {
			original = JSON.parse(localStorage.getItem("bd_dim"));
			updated = JSON.parse(localStorage.getItem("bd_dim_edit"));

			if (typeof updated.DimList !== 'undefined' && updated.DimList != null) {

				if (typeof original.DimList === 'undefined' || original.DimList == null) {
					hasUpdate = true;
				} else {

					for (var i = 0; i < updated.DimList.length; i++) {
						var currentRow = i+1;
						if (original.DimList[i] !== 'undefined' && original.DimList[i] != null) {
							if (original.DimList[i].Width != updated.DimList[i].Width
							|| original.DimList[i].Length != updated.DimList[i].Length
							|| original.DimList[i].Height != updated.DimList[i].Height
							|| original.DimList[i].Pieces != updated.DimList[i].Pieces
							|| original.DimList[i].Weight != updated.DimList[i].Weight
							|| original.DimList[i].Volume != updated.DimList[i].Volume) {
								$("#dim_table_body > tr:nth-child("+currentRow+")").addClass("update_indicator");
								hasUpdate = true;
							}
						} else {
							$("#dim_table_body > tr:nth-child("+currentRow+")").addClass("update_indicator");
							hasUpdate = true;
						}
					}
				}
			}
		}

		if (hasUpdate) {
			localStorage.setItem("bd_dim_has_update", 1);
		}

	}

	function addDimEdit(e) {
		e.preventDefault();
		AddDimensionEditInput();
	}

	function AddDimensionEditInput(cID, dID, callback) {

		var row = $("#bd_dim_edit_temp").html();

		var currentRowID = getComponentRowID("dimension_input_row");

		//add more edit dimension row if exact dimension record is larger then the current edit row(default = 3)
		if (cID > currentRowID){
			row = row.replaceAll("%ID%", currentRowID + 1);

			$(".dimension_input_wrapper").append(row);
			var newRowID = currentRowID + 1;

			if (typeof callback === "function" && typeof cID !== 'undefined' && typeof dID !== 'undefined') {
				callback(cID, dID);
			}

        	RegDimensionCal(decimalRoundTo);
        	refreshModuleTranslation();
		}


	}

	function clearEditErrorMsgDim() {
		$("#dim_edit .error_or").removeClass("error_or");
		$("#dim_edit .error_indicator").removeClass("error_indicator");
		$("#dim_edit .error_or_msg").hide();

	}

	function checkIfLHFlightExist(){
    	var flightNoList = getData("bkd_def_flight", "AllFlightNo");

    	if(_.find(flightNoList, function(flightNo) { return flightNo.includes("LH"); })){
    		return true;
    	}
    	else{
    		return false;
    	}
    }

	function calculateVolumeFromUnitCm(length, width, height, pcs, roundTo)
	{
		if (!isNaN(length) && !isNaN(width) && !isNaN(height) && !isNaN(pcs)) {
			var volume = length * width * height * Math.pow(0.01, 3) * pcs;

			if (typeof roundTo !== 'undefined' && roundTo != null) {
				volume = FormatDecInput(volume.toFixed(roundTo), roundTo, false);
			} else {
				volume = FormatDecInput(volume.toFixed(decimalVolumeRoundToCX), decimalVolumeRoundToCX, false);
			}

			return parseFloat(volume);
		}
	}

	function calculateVolumeFromUnitInh(length, width, height, pcs, rountTo)
	{
		if (!isNaN(length) && !isNaN(width) && !isNaN(height) && !isNaN(pcs)) {
			var volume = length * width * height * Math.pow(0.01, 3) * Math.pow(2.54, 3) * pcs;

			if (typeof roundTo !== 'undefined' && roundTo != null) {
				volume = FormatDecInput(volume.toFixed(roundTo), roundTo, false);
			} else {
				volume = FormatDecInput(volume.toFixed(decimalVolumeRoundToCX), decimalVolumeRoundToCX, false);
			}

			return parseFloat(volume);
		}
	}
</script>
<div id="bkd_def_shipperconsignee" class="bkd_block">

    <div class="col-xs-12">
        <h3 class="inline_block" data-i18n="shipperConsignee.ShipperConsignee">Shipper &amp; Consignee</h3>
        <a onclick="openContactEdit(event)" href="javascript:void(0)" class="btn_gy_edit"></a>
    </div>

    <div class="blkc"></div>

    <div class="col-xs-12 col-md-6">
        <div class="blk_gy_line blkl">
            <h4 data-i18n="shipperConsignee.Shipper">Shipper</h4>
            <div class="blk_typec">
                <label data-i18n="shipperConsignee.Name">Name</label>
                <div id="bd_contact_shipper_name">ABC COMPANY</div>
                <label data-i18n="shipperConsignee.Address">Address</label>
                <div id="bd_contact_shipper_address">ABC STREET</div>
            </div>
            <div class="blk_typed">
                <div class=" w45">
                    <label data-i18n="shipperConsignee.City">City</label>
                    <div id="bd_contact_shipper_city">HONG KONG</div>
                    <label data-i18n="shipperConsignee.Country">Country</label>
                    <div id="bd_contact_shipper_country">HK</div>
                    <label data-i18n="shipperConsignee.TelNo">Tel. No.</label>
                    <div id="bd_contact_shipper_tel">12345678</div>
                </div>
                <div class=" w45">
                    <label data-i18n="shipperConsignee.State">State</label>
                    <div id="bd_contact_shipper_state">-</div>
                    <label data-i18n="shipperConsignee.PostalCode">Postal Code</label>
                    <div id="bd_contact_shipper_postal">-</div>
                    <label data-i18n="shipperConsignee.FaxNo">Fax. No.</label>
                    <div id="bd_contact_shipper_fax">12345688</div>
                </div>
                <div class="blkc"></div>
            </div>
        </div>
    </div>

    <div class="col-xs-12 col-md-6">
        <div class="blk_gy_line blkl">
            <h4 data-i18n="shipperConsignee.Consignee">Consignee</h4>
            <div class="blk_typec">
                <label data-i18n="shipperConsignee.Name">Name</label>
                <div id="bd_contact_consignee_name">ABC</div>
                <label data-i18n="shipperConsignee.Address">Address</label>
                <div id="bd_contact_consignee_address">ABC ADDRESS</div>
            </div>
            <div class="blk_typed">
                <div class=" w45">
                    <label data-i18n="shipperConsignee.City">City</label>
                    <div id="bd_contact_consignee_city">HONG KONG</div>
                    <label data-i18n="shipperConsignee.Country">Country</label>
                    <div id="bd_contact_consignee_country">HK</div>
                    <label data-i18n="shipperConsignee.TelNo">Tel. No.</label>
                    <div id="bd_contact_consignee_tel">23456780</div>
                </div>
                <div class=" w45">
                    <label data-i18n="shipperConsignee.State">State</label>
                    <div id="bd_contact_consignee_state">HONG KONG</div>
                    <label data-i18n="shipperConsignee.PostalCode">Postal Code</label>
                    <div id="bd_contact_consignee_postal">-</div>
                    <label data-i18n="shipperConsignee.FaxNo">Fax. No.</label>
                    <div id="bd_contact_consignee_fax">23456780</div>
                </div>
                <div class="blkc"></div>
            </div>
        </div>
    </div>
    <div class="blkc"></div>

    <div class="booking_lb lity-hide" id="contact_edit" style="width: 100%; min-width: 900px; max-width: 900px;">
        <div class="lightbox_ctr" style="width: 100%;">
            <div class="close_ctr"><a id="btn_contact_edit_close" href="javascript:void(0)" class="close_btn" onclick="closeContactEdit(event)"></a></div>
            <div id="lb_contact_edit" class="lightbox_blk">
                <h3 data-i18n="shipperConsignee.ShipperConsignee">Shipper &amp; Consignee</h3>
                <div class="blkc"></div>

                <div class="blk_filter">
                    <div class="head_hr"></div>
                    <div class="consign_info">


                        <div class="blk_gy_line blkl w47 mrp5">
                            <h4 class="blk_in" data-i18n="shipperConsignee.Shipper">Shipper</h4>
                            <a href="javascript:void(0)" class="search_bu_link" data-i18n="shipperConsignee.AddressBook" onclick="openContactAddressBookSearch(event, 0)">Address book</a>
                            <div class="blkc"></div>
                            <div class="bu_txt shipper_remark_form">
                                <div class="w100">
                                    <label for="contact_shipper_name"><span data-i18n="shipperConsignee.Name">Name</span></label>
                                    <input class="w100" id="contact_shipper_name" maxlength="35">
                                    <div class="error_or_msg" style="display:none;" data-i18n="shipperConsignee.Invalid">Invalid</div>
                                </div>
                                <div class="w100">
                                    <label for="contact_shipper_address"><span data-i18n="shipperConsignee.Address">Address</span></label>
                                    <input class="w100" id="contact_shipper_address" maxlength="35">
                                    <div class="error_or_msg" style="display:none;" data-i18n="shipperConsignee.Invalid">Invalid</div>
                                </div>
                                <div class="blkl w47 mrp5p">
                                    <label for="contact_shipper_city"><span data-i18n="shipperConsignee.City">City</span></label>
                                    <input class="w100" id="contact_shipper_city" maxlength="17">
                                    <div class="error_or_msg" style="display:none;" data-i18n="shipperConsignee.Invalid">Invalid</div>
                                </div>
                                <div class="blkl w47">
                                    <label for="contact_shipper_state" data-i18n="shipperConsignee.State">State</label>
                                    <input class="w100" id="contact_shipper_state" maxlength="9">
                                    <div class="error_or_msg" style="display:none;" data-i18n="shipperConsignee.Invalid">Invalid</div>
                                </div>
                                <div class="blkc"></div>
                                <div class="blkl w47 mrp5p">
                                    <label class="contact_shipper_country"><span data-i18n="shipperConsignee.Country">Country</span></label>
                                    <input class="w100" id="contact_shipper_country" maxlength="2">
                                    <div class="error_or_msg" style="display:none;" data-i18n="shipperConsignee.Invalid">Invalid</div>
                                </div>
                                <div class="blkl w47">
                                    <label for="contact_shipper_postal" data-i18n="shipperConsignee.PostalCode">Postal Code</label>
                                    <input class="w100" id="contact_shipper_postal" maxlength="9">
                                    <div class="error_or_msg" style="display:none;" data-i18n="shipperConsignee.Invalid">Invalid</div>
                                </div>
                                <div class="blkc"></div>
                                <div class="blkl w47 mrp5p">
                                    <label for="contact_shipper_tel" data-i18n="shipperConsignee.TelNo">Tel. No.</label>
                                    <input class="w100" id="contact_shipper_tel" maxlength="19">
                                    <div class="error_or_msg" style="display:none;" data-i18n="shipperConsignee.Invalid">Invalid</div>
                                </div>
                                <div class="blkl w47">
                                    <label for="contact_shipper_fax" data-i18n="shipperConsignee.FaxNo">Fax. No.</label>
                                    <input class="w100" id="contact_shipper_fax" maxlength="19">
                                    <div class="error_or_msg" style="display:none;" data-i18n="shipperConsignee.Invalid">Invalid</div>
                                </div>
                                <div class="blkc"></div>
                                <a data-toggle="collapse" href="#" role="button" aria-expanded="false" aria-controls="collapseAddressBook_shipper" class="bu_plus_link btn_addr_add"><span></span></a>
                                <a data-toggle="collapse" href="#" role="button" aria-expanded="false" aria-controls="collapseAddressBook_shipper" class="bu_plus_link btn_addr_add" data-i18n="contact.AddToAddressBook">Add to address book</a>
                                <div class="collapse" id="collapseAddressBook_shipper">
                                    <div class="cnt_inline bu_txt">
                                        <input type="text" value="" class="code_02 contact_addressbook_code" id="contact_addressbook_code_ins_shipper" placeholder="Enter code to add..." maxlength="15">
                                        <span id="contact_addressbook_loading_shipper" class="inline_loading_panel" style="display:none;">&nbsp;</span>
                                        <a id="contact_btn_addressbook_ins_shipper" href="javascript:void(0)" onclick="addtoAddressBook(0)" data-i18n="common.Add">Add</a>
                                        <div class="error_or_msg" style="display:none;" data-i18n="shipperConsignee.Invalid">Invalid</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="blk_gy_line blkl w47">
                            <h4 class="blk_in" data-i18n="shipperConsignee.Consignee">Consignee</h4>
                            <a href="javascript:void(0)" class="search_bu_link" data-i18n="shipperConsignee.AddressBook" onclick="openContactAddressBookSearch(event, 1)">Address book</a>
                            <div class="blkc"></div>
                            <div class="bu_txt shipper_remark_form">
                                <div class="w100">
                                    <label for="contact_consignee_name"><span data-i18n="shipperConsignee.Name">Name</span></label>
                                    <input class="w100" id="contact_consignee_name" maxlength="35">
                                    <div class="error_or_msg" style="display:none;" data-i18n="shipperConsignee.Invalid">Invalid</div>
                                </div>
                                <div class="w100">
                                    <label for="contact_consignee_address"><span data-i18n="shipperConsignee.Address">Address</span></label>
                                    <input class="w100" id="contact_consignee_address" maxlength="35">
                                    <div class="error_or_msg" style="display:none;" data-i18n="shipperConsignee.Invalid">Invalid</div>
                                </div>
                                <div class="blkl w47 mrp5p">
                                    <label for="contact_consignee_city"><span data-i18n="shipperConsignee.City">City</span></label>
                                    <input class="w100" id="contact_consignee_city" maxlength="17">
                                    <div class="error_or_msg" style="display:none;" data-i18n="shipperConsignee.Invalid">Invalid</div>
                                </div>
                                <div class="blkl w47">
                                    <label for="contact_consignee_state" data-i18n="shipperConsignee.State">State</label>
                                    <input class="w100" id="contact_consignee_state" maxlength="9">
                                    <div class="error_or_msg" style="display:none;" data-i18n="shipperConsignee.Invalid">Invalid</div>
                                </div>
                                <div class="blkc"></div>
                                <div class="blkl w47 mrp5p">
                                    <label for="contact_consignee_country"><span data-i18n="shipperConsignee.Country">Country</span></label>
                                    <input class="w100" id="contact_consignee_country" maxlength="2">
                                    <div class="error_or_msg" style="display:none;" data-i18n="shipperConsignee.Invalid">Invalid</div>
                                </div>
                                <div class="blkl w47">
                                    <label for="contact_consignee_postal" data-i18n="shipperConsignee.PostalCode">Postal Code</label>
                                    <input class="w100" id="contact_consignee_postal" maxlength="9">
                                    <div class="error_or_msg" style="display:none;" data-i18n="shipperConsignee.Invalid">Invalid</div>
                                </div>
                                <div class="blkc"></div>
                                <div class="blkl w47 mrp5p">
                                    <label for="contact_consignee_tel" data-i18n="shipperConsignee.TelNo">Tel. No.</label>
                                    <input class="w100" id="contact_consignee_tel" maxlength="19">
                                    <div class="error_or_msg" style="display:none;" data-i18n="shipperConsignee.Invalid">Invalid</div>
                                </div>
                                <div class="blkl w47">
                                    <label for="contact_consignee_fax" data-i18n="shipperConsignee.FaxNo">Fax. No.</label>
                                    <input class="w100" id="contact_consignee_fax" maxlength="19">
                                    <div class="error_or_msg" style="display:none;" data-i18n="shipperConsignee.Invalid">Invalid</div>
                                </div>
                                <div class="blkc"></div>
                                <a data-toggle="collapse" href="#" role="button" aria-expanded="false" aria-controls="collapseAddressBook_consignee" class="bu_plus_link btn_addr_add"><span></span></a>
                                <a data-toggle="collapse" href="#" role="button" aria-expanded="false" aria-controls="collapseAddressBook_consignee" class="bu_plus_link btn_addr_add" data-i18n="contact.AddToAddressBook">Add to address book</a>
                                <div class="collapse" id="collapseAddressBook_consignee">
                                    <div class="cnt_inline bu_txt">
                                        <input type="text" value="" class="code_02 contact_addressbook_code" id="contact_addressbook_code_ins_consignee" placeholder="Enter code to add..." maxlength="15">
                                        <span id="contact_addressbook_loading_consignee" class="inline_loading_panel" style="display:none;">&nbsp;</span>
                                        <a id="contact_btn_addressbook_ins_consignee" href="javascript:void(0)" onclick="addtoAddressBook(1)" data-i18n="common.Add">Add</a>
                                        <div class="error_or_msg" style="display:none;" data-i18n="shipperConsignee.Invalid">Invalid</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="blkc"></div>



                    </div>
                </div>
                <div>
                    <a href="javascript:void(0)" class="link_bu_l2" style="float: left;" onclick="closeContactEdit(event)" data-i18n="common.Cancel">Cancel</a>
                    <span href="javascript:void(0)" class="btn_or_l" onclick="saveContactEdit()" data-i18n="common.Save">Save</span>
                    <div class="blkc"></div>
                </div>

            </div>

            <!-- test  -->

            <div id="lb_addressbook_src" class="lightbox_blk" style="display: none;">
                <h3 data-i18n="shipperConsignee.AddressBook">Address book</h3>
                <div class="blkc"></div>
                <div class="blk_filter" style="margin-bottom: 30px;">
                    <div class="cnt_inline bu_txt">
                        <label for="contact_addressbook_code_src" data-i18n="shipperConsignee.AddressCode" style="color: #000000;">Address code</label>
                        <input type="text" value="" class="code_02" id="contact_addressbook_code_src">
                        <input id="contact_btn_address_src" class="btn_search" type="button" onclick="getAddressBookSrc(event)">
                        <a href="javascript:void(0)" onclick="closeContactAddressBookSearch(event)" data-i18n="contact.BackToEditForm">back to edit form</a>
                    </div>
                    <div class="blkc"></div>
                </div>

                <div id="contact_addressbook_result" class="ts_table">
                    <div class="trow theader">
                        <div class="tcell col1" data-i18n="shipperConsignee.AddressCode">Address code</div>
                        <div class="tcell col1" data-i18n="shipperConsignee.Name">Name</div>
                        <div class="tcell colh" data-i18n="shipperConsignee.City">City</div>
                    </div>
                </div>

                <div id="addressBookResultStatusWrapper" class="">
                    <div class="error-box disabled">
                        <p class="error-message" style="text-align: left;" data-i18n="cargoInfo.RecordNotFound">Records not found</p>
                        <div class="errorTable">
                            <div class="errorTableBody">

                            </div>
                        </div>
                    </div>
                    <div class="loading-main disabled">
                        <span id="loading_message" data-i18n="common.Loading">Loading</span>
                    </div>
                </div>
            </div>


            <!-- test -->

        </div>
    </div>

</div>

<script id="contact_addressbook_src_temp" type="text/x-template">
    <div class="rowwrapper">
        <div class="trow">
            <div class="tcell col1">
                <div class="contact_addrbook_item"><a href="javascript:void(0)" onclick="bindAddressBookData(event, %ROWID%)">%ADDRCODE%</a></div>
            </div>
            <div class="tcell col1">
                <div class="contact_addrbook_item"><a href="javascript:void(0)" onclick="bindAddressBookData(event, %ROWID%)">%NAME%</a></div>
            </div>
            <div class="tcell cols">
                <div class="contact_addrbook_item"><a href="javascript:void(0)" onclick="bindAddressBookData(event, %ROWID%)">%CITY%</a></div>
            </div>
        </div>
    </div>
</script>

<script>
	$(function() {
		var id = "#bkd_def_shipperconsignee";
		var contactLity;
		var contactSearchLity;

		$(id).on("clear", function(event) {
			//console.log(data);

			//debugger;
			$("#bd_contact_shipper_name").val("");
			$("#bd_contact_shipper_address").val("");
			$("#bd_contact_shipper_city").val("");
			$("#bd_contact_shipper_state").val("");
			$("#bd_contact_shipper_country").val("");
			$("#bd_contact_shipper_postal").val("");
			$("#bd_contact_shipper_tel").val("");
			$("#bd_contact_shipper_fax").val("");

			$("#bd_contact_consignee_name").val("");
			$("#bd_contact_consignee_address").val("");
			$("#bd_contact_consignee_city").val("");
			$("#bd_contact_consignee_state").val("");
			$("#bd_contact_consignee_country").val("");
			$("#bd_contact_consignee_postal").val("");
			$("#bd_contact_consignee_tel").val("");
			$("#bd_contact_consignee_fax").val("");

			$("#bd_contact_shipper_name").text("");
			$("#bd_contact_shipper_address").text("");
			$("#bd_contact_shipper_city").text("");
			$("#bd_contact_shipper_state").text("");
			$("#bd_contact_shipper_country").text("");
			$("#bd_contact_shipper_postal").text("");
			$("#bd_contact_shipper_tel").text("");
			$("#bd_contact_shipper_fax").text("");

			$("#bd_contact_consignee_name").text("");
			$("#bd_contact_consignee_address").text("");
			$("#bd_contact_consignee_city").text("");
			$("#bd_contact_consignee_state").text("");
			$("#bd_contact_consignee_country").text("");
			$("#bd_contact_consignee_postal").text("");
			$("#bd_contact_consignee_tel").text("");
			$("#bd_contact_consignee_fax").text("");

			clearEditErrorMsgContact();

		});

		$(id).on("init", function(event, data) {
			console.log(data);
			var currentRowID;
			//debugger;

			$("#contact_shipper_name").val(data.ShipperConsignee.ShipperName);
			$("#contact_shipper_address").val(data.ShipperConsignee.ShipperAddress);
			$("#contact_shipper_city").val(data.ShipperConsignee.ShipperCity);
			$("#contact_shipper_state").val(data.ShipperConsignee.ShipperState);
			$("#contact_shipper_country").val(data.ShipperConsignee.ShipperCountry);
			$("#contact_shipper_postal").val(data.ShipperConsignee.ShipperPostalCode);
			$("#contact_shipper_tel").val(data.ShipperConsignee.ShipperTel);
			$("#contact_shipper_fax").val(data.ShipperConsignee.ShipperFax);

			$("#contact_consignee_name").val(data.ShipperConsignee.ConsignName);
			$("#contact_consignee_address").val(data.ShipperConsignee.ConsignAddress);
			$("#contact_consignee_city").val(data.ShipperConsignee.ConsignCity);
			$("#contact_consignee_state").val(data.ShipperConsignee.ConsignState);
			$("#contact_consignee_country").val(data.ShipperConsignee.ConsignCountry);
			$("#contact_consignee_postal").val(data.ShipperConsignee.ConsignPostalCode);
			$("#contact_consignee_tel").val(data.ShipperConsignee.ConsignTel);
			$("#contact_consignee_fax").val(data.ShipperConsignee.ConsignFax);

		});

		$(id).on("validate", function() {
			console.log("OK");
			console.log("bkd_def_shipperconsignee");
			var isValid = true;
			return isValid;
			//return true;
		});
		$(id).on("submit", function() {

			var shipperName = "";
			var shipperAddress = "";
			var shipperCity = "";
			var shipperState = "";
			var shipperCountry = "";
			var shipperPostalCode = "";
			var shipperTel = "";
			var shipperFax = "";

			var consignName = "";
			var consignAddress = "";
			var consignCity = "";
			var consignState = "";
			var consignCountry = "";
			var consignPostalCode = "";
			var consignTel = "";
			var consignFax = "";

			var bkdData = "";
			if (typeof localStorage.getItem("bd_contact_edit") !== 'undefined' && localStorage.getItem("bd_contact_edit") != null) {
				bkdData = JSON.parse(localStorage.getItem("bd_contact_edit"));
			} else if (typeof localStorage.getItem("bd_contact") !== 'undefined' && localStorage.getItem("bd_contact") != null) {
				bkdData = JSON.parse(localStorage.getItem("bd_contact"));
			}

			if (bkdData != "") {
				//console.log("fltRefreshDisplay: " + JSON.stringify(bkdData));

				if (bkdData.Shipper.Name != "") {
					shipperName = bkdData.Shipper.Name;
				} else {
					shipperName = "";
				}
				if (bkdData.Shipper.Address != "") {
					shipperAddress = bkdData.Shipper.Address;
				} else {
					shipperAddress = "";
				}
				if (bkdData.Shipper.City != "") {
					shipperCity = bkdData.Shipper.City;
				} else {
					shipperCity = "";
				}
				if (bkdData.Shipper.State != "") {
					shipperState = bkdData.Shipper.State;
				} else {
					shipperState = "";
				}
				if (bkdData.Shipper.CountryCode != "") {
					shipperCountry = bkdData.Shipper.CountryCode;
				} else {
					shipperCountry = "";
				}
				if (bkdData.Shipper.PostCode != "") {
					shipperPostalCode = bkdData.Shipper.PostCode;
				} else {
					shipperPostalCode = "";
				}
				if (bkdData.Shipper.TelNo != "") {
					shipperTel = bkdData.Shipper.TelNo;
				} else {
					shipperTel = "";
				}
				if (bkdData.Shipper.FaxNo != "") {
					shipperFax = bkdData.Shipper.FaxNo;
				} else {
					shipperFax = "";
				}

				if (bkdData.Consignee.Name != "") {
					consignName = bkdData.Consignee.Name;
				} else {
					consignName = "";
				}
				if (bkdData.Consignee.Address != "") {
					consignAddress = bkdData.Consignee.Address;
				} else {
					consignAddress = "";
				}
				if (bkdData.Consignee.City != "") {
					consignCity = bkdData.Consignee.City;
				} else {
					consignCity = "";
				}
				if (bkdData.Consignee.State != "") {
					consignState = bkdData.Consignee.State;
				} else {
					consignState = "";
				}
				if (bkdData.Consignee.CountryCode != "") {
					consignCountry = bkdData.Consignee.CountryCode;
				} else {
					consignCountry = "";
				}
				if (bkdData.Consignee.PostCode != "") {
					consignPostalCode = bkdData.Consignee.PostCode;
				} else {
					consignPostalCode = "";
				}
				if (bkdData.Consignee.TelNo != "") {
					consignTel = bkdData.Consignee.TelNo;
				} else {
					consignTel = "";
				}
				if (bkdData.Consignee.FaxNo != "") {
					consignFax = bkdData.Consignee.FaxNo;
				} else {
					consignFax = "";
				}

			}

			return {
				"ShipperConsignee" : {
					"ShipperName" : shipperName,
					"ShipperAddress" : shipperAddress,
					"ShipperCity" : shipperCity,
					"ShipperState" : shipperState,
					"ShipperCountry" : shipperCountry ? shipperCountry.toUpperCase() : "",
					"ShipperPostalCode" : shipperPostalCode,
					"ShipperTel" : shipperTel,
					"ShipperFax" : shipperFax,
					"ConsignName" : consignName,
					"ConsignAddress" : consignAddress,
					"ConsignCity" : consignCity,
					"ConsignState" : consignState,
					"ConsignCountry" : consignCountry? consignCountry.toUpperCase() : "",
					"ConsignPostalCode" : consignPostalCode,
					"ConsignTel" : consignTel,
					"ConsignFax" : consignFax
				}
			};

		});

		$(id).on("bindAddressBookSearchResult", function() {
			console.log("bindAddressBookSearchResult start");

			//stopAddressBookSearchAction();

			$("#contact_addressbook_result .rowwrapper").remove();

			var lt = [];
			if (localStorage.getItem("contact_addr_book") != null) {
				lt = JSON.parse(localStorage.getItem("contact_addr_book"));
			}

			if (lt.length == 0) {
				showAddressBookError("No Record found.");
			} else {
				hideAddressBookError();
			}

			content = getAddressbookResult();

			$("#contact_addressbook_result").append(content);

		});

		$(id).on("loadBookingData", function(event, bkdData) {
			//console.log("contact: " + JSON.stringify(bkdData));
			//var currentRowID;
			//var insertRowID;
			//debugger;

			var obj = new Object();
			obj.Shipper = new Object();
			obj.Consignee = new Object();

			if (bkdData.ShipperIsSpecified == true) {
				if (typeof bkdData.Shipper !== 'undefined' && bkdData.Shipper != null) {
					if (typeof bkdData.Shipper.Name !== 'undefined' && bkdData.Shipper.Name != null) {
						obj.Shipper.Name = bkdData.Shipper.Name.join();
					} else {
						obj.Shipper.Name = "";
					}
					if (typeof bkdData.Shipper.StreetAdd !== 'undefined' && bkdData.Shipper.StreetAdd != null) {
						obj.Shipper.Address = bkdData.Shipper.StreetAdd.join();
					} else {
						obj.Shipper.Address = "";
					}
					if (typeof bkdData.Shipper.Place !== 'undefined' && bkdData.Shipper.Place != null) {
						obj.Shipper.City = bkdData.Shipper.Place;
					} else {
						obj.Shipper.City = "";
					}
					if (typeof bkdData.Shipper.State !== 'undefined' && bkdData.Shipper.State != null) {
						obj.Shipper.State = bkdData.Shipper.State;
					} else {
						obj.Shipper.State = "";
					}
					if (typeof bkdData.Shipper.CountryCode !== 'undefined' && bkdData.Shipper.CountryCode != null) {
						obj.Shipper.CountryCode = bkdData.Shipper.CountryCode;
					} else {
						obj.Shipper.CountryCode = "";
					}
					if (typeof bkdData.Shipper.PostCode !== 'undefined' && bkdData.Shipper.PostCode != null) {
						obj.Shipper.PostCode = bkdData.Shipper.PostCode;
					} else {
						obj.Shipper.PostCode = "";
					}
					obj.Shipper.TelNo = "";
					obj.Shipper.FaxNo = "";
					if (typeof bkdData.Shipper.ContactDetail !== 'undefined' && bkdData.Shipper.ContactDetail != null) {
						for (var i = 0; i < bkdData.Shipper.ContactDetail.length; i++) {
							if (bkdData.Shipper.ContactDetail[i].ContactDetailType == 0) {
								obj.Shipper.TelNo = bkdData.Shipper.ContactDetail[i].ContactNum;
							} else if (bkdData.Shipper.ContactDetail[i].ContactDetailType == 1) {
								obj.Shipper.FaxNo = bkdData.Shipper.ContactDetail[i].ContactNum;
							}
						}
					}
				}
			} else {
				obj.Shipper.Name = "";
				obj.Shipper.Address = "";
				obj.Shipper.City = "";
				obj.Shipper.State = "";
				obj.Shipper.CountryCode = "";
				obj.Shipper.PostCode = "";
				obj.Shipper.TelNo = "";
				obj.Shipper.FaxNo = "";
			}

			if (bkdData.ConsigneerIsSpecified == true) {
				if (typeof bkdData.Consignee !== 'undefined' && bkdData.Consignee != null) {
					if (typeof bkdData.Consignee.Name !== 'undefined' && bkdData.Consignee.Name != null) {
						obj.Consignee.Name = bkdData.Consignee.Name.join();
					} else {
						obj.Consignee.Name = "";
					}
					if (typeof bkdData.Consignee.StreetAdd !== 'undefined' && bkdData.Consignee.StreetAdd != null) {
						obj.Consignee.Address = bkdData.Consignee.StreetAdd.join();
					} else {
						obj.Consignee.Address = "";
					}
					if (typeof bkdData.Consignee.Place !== 'undefined' && bkdData.Consignee.Place != null) {
						obj.Consignee.City = bkdData.Consignee.Place;
					} else {
						obj.Consignee.City = "";
					}
					if (typeof bkdData.Consignee.State !== 'undefined' && bkdData.Consignee.State != null) {
						obj.Consignee.State = bkdData.Consignee.State;
					} else {
						obj.Consignee.State = "";
					}
					if (typeof bkdData.Consignee.CountryCode !== 'undefined' && bkdData.Consignee.CountryCode != null) {
						obj.Consignee.CountryCode = bkdData.Consignee.CountryCode;
					} else {
						obj.Consignee.CountryCode = "";
					}
					if (typeof bkdData.Consignee.PostCode !== 'undefined' && bkdData.Consignee.PostCode != null) {
						obj.Consignee.PostCode = bkdData.Consignee.PostCode;
					} else {
						obj.Consignee.PostCode = "";
					}
					obj.Consignee.TelNo = "";
					obj.Consignee.FaxNo = "";
					if (typeof bkdData.Consignee.ContactDetail !== 'undefined' && bkdData.Consignee.ContactDetail != null) {
						for (var i = 0; i < bkdData.Consignee.ContactDetail.length; i++) {
							if (bkdData.Consignee.ContactDetail[i].ContactDetailType == 0) {
								obj.Consignee.TelNo = bkdData.Consignee.ContactDetail[i].ContactNum;
							} else if (bkdData.Consignee.ContactDetail[i].ContactDetailType == 1) {
								obj.Consignee.FaxNo = bkdData.Consignee.ContactDetail[i].ContactNum;
							}
						}
					}
				}
			} else {
				obj.Consignee.Name = "";
				obj.Consignee.Address = "";
				obj.Consignee.City = "";
				obj.Consignee.State = "";
				obj.Consignee.CountryCode = "";
				obj.Consignee.PostCode = "";
				obj.Consignee.TelNo = "";
				obj.Consignee.FaxNo = "";
			}

			localStorage.setItem("bd_contact", JSON.stringify(obj));
			localStorage.removeItem("bd_contact_edit");

			contactRefreshDisplay();

		});

	});

	function contactRefreshDisplay() {

		var bkdData = "";
		if (typeof localStorage.getItem("bd_contact_edit") !== 'undefined' && localStorage.getItem("bd_contact_edit") != null) {
			bkdData = JSON.parse(localStorage.getItem("bd_contact_edit"));
		} else if (typeof localStorage.getItem("bd_contact") !== 'undefined' && localStorage.getItem("bd_contact") != null) {
			bkdData = JSON.parse(localStorage.getItem("bd_contact"));
		}

		if (bkdData != "") {
			//console.log("fltRefreshDisplay: " + JSON.stringify(bkdData));

			if (bkdData.Shipper.Name != "") {
				$("#bd_contact_shipper_name").text(bkdData.Shipper.Name);
			} else {
				$("#bd_contact_shipper_name").text("-");
			}
			if (bkdData.Shipper.Address != "") {
				$("#bd_contact_shipper_address").text(bkdData.Shipper.Address);
			} else {
				$("#bd_contact_shipper_address").text("-");
			}
			if (bkdData.Shipper.City != "") {
				$("#bd_contact_shipper_city").text(bkdData.Shipper.City);
			} else {
				$("#bd_contact_shipper_city").text("-");
			}
			if (bkdData.Shipper.State != "") {
				$("#bd_contact_shipper_state").text(bkdData.Shipper.State);
			} else {
				$("#bd_contact_shipper_state").text("-");
			}
			if (bkdData.Shipper.CountryCode != "") {
				$("#bd_contact_shipper_country").text(bkdData.Shipper.CountryCode);
			} else {
				$("#bd_contact_shipper_country").text("-");
			}
			if (bkdData.Shipper.PostCode != "") {
				$("#bd_contact_shipper_postal").text(bkdData.Shipper.PostCode);
			} else {
				$("#bd_contact_shipper_postal").text("-");
			}
			if (bkdData.Shipper.TelNo != "") {
				$("#bd_contact_shipper_tel").text(bkdData.Shipper.TelNo);
			} else {
				$("#bd_contact_shipper_tel").text("-");
			}
			if (bkdData.Shipper.FaxNo != "") {
				$("#bd_contact_shipper_fax").text(bkdData.Shipper.FaxNo);
			} else {
				$("#bd_contact_shipper_fax").text("-");
			}

			if (bkdData.Consignee.Name != "") {
				$("#bd_contact_consignee_name").text(bkdData.Consignee.Name);
			} else {
				$("#bd_contact_consignee_name").text("-");
			}
			if (bkdData.Consignee.Address != "") {
				$("#bd_contact_consignee_address").text(bkdData.Consignee.Address);
			} else {
				$("#bd_contact_consignee_address").text("-");
			}
			if (bkdData.Consignee.City != "") {
				$("#bd_contact_consignee_city").text(bkdData.Consignee.City);
			} else {
				$("#bd_contact_consignee_city").text("-");
			}
			if (bkdData.Consignee.State != "") {
				$("#bd_contact_consignee_state").text(bkdData.Consignee.State);
			} else {
				$("#bd_contact_consignee_state").text("-");
			}
			if (bkdData.Consignee.CountryCode != "") {
				$("#bd_contact_consignee_country").text(bkdData.Consignee.CountryCode);
			} else {
				$("#bd_contact_consignee_country").text("-");
			}
			if (bkdData.Consignee.PostCode != "") {
				$("#bd_contact_consignee_postal").text(bkdData.Consignee.PostCode);
			} else {
				$("#bd_contact_consignee_postal").text("-");
			}
			if (bkdData.Consignee.TelNo != "") {
				$("#bd_contact_consignee_tel").text(bkdData.Consignee.TelNo);
			} else {
				$("#bd_contact_consignee_tel").text("-");
			}
			if (bkdData.Consignee.FaxNo != "") {
				$("#bd_contact_consignee_fax").text(bkdData.Consignee.FaxNo);
			} else {
				$("#bd_contact_consignee_fax").text("-");
			}
			updateIndicatorContact();
		}
	}

	// contact edit

	function openContactEdit(e) {
		e.preventDefault();
		clearEditErrorMsgContact();
		regContactInit();
		loadEditDataContact();
		closeContactAddressBookSearch();
		contactLity = lity('#contact_edit');
	}

	function closeContactEdit(e) {
		if (typeof e !== 'undefined' && e != null) {
			e.preventDefault();
		}
		contactLity.close();
	}

	function regContactInit() {

	}

	function loadEditDataContact() {

		contactResetEdit();

		var bkdData = "";
		if (typeof localStorage.getItem("bd_contact_edit") !== 'undefined' && localStorage.getItem("bd_contact_edit") != null) {
			bkdData = JSON.parse(localStorage.getItem("bd_contact_edit"));
		} else if (typeof localStorage.getItem("bd_contact") !== 'undefined' && localStorage.getItem("bd_contact") != null) {
			bkdData = JSON.parse(localStorage.getItem("bd_contact"));
		}

		if (bkdData != "") {
			//console.log("fltRefreshDisplay: " + JSON.stringify(bkdData));

			if (bkdData.Shipper.Name != "") {
				$("#contact_shipper_name").val(bkdData.Shipper.Name);
			} else {
				$("#contact_shipper_name").val("");
			}
			if (bkdData.Shipper.Address != "") {
				$("#contact_shipper_address").val(bkdData.Shipper.Address);
			} else {
				$("#contact_shipper_address").val("");
			}
			if (bkdData.Shipper.City != "") {
				$("#contact_shipper_city").val(bkdData.Shipper.City);
			} else {
				$("#contact_shipper_city").val("");
			}
			if (bkdData.Shipper.State != "") {
				$("#contact_shipper_state").val(bkdData.Shipper.State);
			} else {
				$("#contact_shipper_state").val("");
			}
			if (bkdData.Shipper.CountryCode != "") {
				$("#contact_shipper_country").val(bkdData.Shipper.CountryCode);
			} else {
				$("#contact_shipper_country").val("");
			}
			if (bkdData.Shipper.PostCode != "") {
				$("#contact_shipper_postal").val(bkdData.Shipper.PostCode);
			} else {
				$("#contact_shipper_postal").val("");
			}
			if (bkdData.Shipper.TelNo != "") {
				$("#contact_shipper_tel").val(bkdData.Shipper.TelNo);
			} else {
				$("#contact_shipper_tel").val("");
			}
			if (bkdData.Shipper.FaxNo != "") {
				$("#contact_shipper_fax").val(bkdData.Shipper.FaxNo);
			} else {
				$("#contact_shipper_fax").val("");
			}

			if (bkdData.Consignee.Name != "") {
				$("#contact_consignee_name").val(bkdData.Consignee.Name);
			} else {
				$("#contact_consignee_name").val("");
			}
			if (bkdData.Consignee.Address != "") {
				$("#contact_consignee_address").val(bkdData.Consignee.Address);
			} else {
				$("#contact_consignee_address").val("");
			}
			if (bkdData.Consignee.City != "") {
				$("#contact_consignee_city").val(bkdData.Consignee.City);
			} else {
				$("#contact_consignee_city").val("");
			}
			if (bkdData.Consignee.State != "") {
				$("#contact_consignee_state").val(bkdData.Consignee.State);
			} else {
				$("#contact_consignee_state").val("");
			}
			if (bkdData.Consignee.CountryCode != "") {
				$("#contact_consignee_country").val(bkdData.Consignee.CountryCode);
			} else {
				$("#contact_consignee_country").val("");
			}
			if (bkdData.Consignee.PostCode != "") {
				$("#contact_consignee_postal").val(bkdData.Consignee.PostCode);
			} else {
				$("#contact_consignee_postal").val("");
			}
			if (bkdData.Consignee.TelNo != "") {
				$("#contact_consignee_tel").val(bkdData.Consignee.TelNo);
			} else {
				$("#contact_consignee_tel").val("");
			}
			if (bkdData.Consignee.FaxNo != "") {
				$("#contact_consignee_fax").val(bkdData.Consignee.FaxNo);
			} else {
				$("#contact_consignee_fax").val("");
			}

		}

	}

	function validateContactInfo() {
		var shipperName = $("#contact_shipper_name").val();
		var shipperAddress = $("#contact_shipper_address").val();
		var shipperCity = $("#contact_shipper_city").val();
		var shipperState = $("#contact_shipper_state").val();
		var shipperCountry = $("#contact_shipper_country").val();
		var shipperPostalCode = $("#contact_shipper_postal").val();
		var shipperTel = $("#contact_shipper_tel").val();
		var shipperFax = $("#contact_shipper_fax").val();

		var consignName = $("#contact_consignee_name").val();
		var consignAddress = $("#contact_consignee_address").val();
		var consignCity = $("#contact_consignee_city").val();
		var consignState = $("#contact_consignee_state").val();
		var consignCountry = $("#contact_consignee_country").val();
		var consignPostalCode = $("#contact_consignee_postal").val();
		var consignTel = $("#contact_consignee_tel").val();
		var consignFax = $("#contact_consignee_fax").val();
		var isValid = true;

		//shipper info
		if (shipperName != "" || shipperAddress != "" || shipperCity != "" || shipperState != "" || shipperCountry != ""
		|| shipperPostalCode != "" || shipperTel != "" || shipperFax != "") {
			if (!StringFormatChecker.checkFormatF(shipperName, 1, 35)) {
                $("#contact_shipper_name ~ .error_or_msg").show();
                $("#contact_shipper_name").parent().addClass("error_or");
                isValid = false;
            } else {
                $("#contact_shipper_name ~ .error_or_msg").hide();
                $("#contact_shipper_name").parent().removeClass("error_or");
            }
            
            if (!StringFormatChecker.checkFormatF(shipperAddress, 1, 35)) {
                $("#contact_shipper_address ~ .error_or_msg").show();
                $("#contact_shipper_address").parent().addClass("error_or");
                isValid = false;
            } else {
                $("#contact_shipper_address ~ .error_or_msg").hide();
                $("#contact_shipper_address").parent().removeClass("error_or");
            }
            
            if (!StringFormatChecker.checkFormatT(shipperCity, 1, 17)) {
                $("#contact_shipper_city ~ .error_or_msg").show();
                $("#contact_shipper_city").parent().addClass("error_or");
                isValid = false;
            } else {
                $("#contact_shipper_city ~ .error_or_msg").hide();
                $("#contact_shipper_city").parent().removeClass("error_or");
            }

            if (!StringFormatChecker.checkFormatT(shipperState, 0, 9)) {
                $("#contact_shipper_state ~ .error_or_msg").show();
                $("#contact_shipper_state").parent().addClass("error_or");
                isValid = false;
            } else {
                $("#contact_shipper_state ~ .error_or_msg").hide();
                $("#contact_shipper_state").parent().removeClass("error_or");
            }

            if (!StringFormatChecker.checkFormatA(shipperCountry.toUpperCase(), 2, 2)) {
                $("#contact_shipper_country ~ .error_or_msg").show();
                $("#contact_shipper_country").parent().addClass("error_or");
                isValid = false;
            } else {
                $("#contact_shipper_country ~ .error_or_msg").hide();
                $("#contact_shipper_country").parent().removeClass("error_or");
            }

            if (!StringFormatChecker.checkFormatT(shipperPostalCode, 0, 9)) {
                $("#contact_shipper_postal ~ .error_or_msg").show();
                $("#contact_shipper_postal").parent().addClass("error_or");
                isValid = false;
            } else {
                $("#contact_shipper_postal ~ .error_or_msg").hide();
                $("#contact_shipper_postal").parent().removeClass("error_or");
            }
            
            //Tel length is 19 for CX
            if (!StringFormatChecker.checkFormatM(shipperTel, 0, 19)) {
                $("#contact_shipper_tel ~ .error_or_msg").show();
                $("#contact_shipper_tel").parent().addClass("error_or");
                isValid = false;
            } else {
                $("#contact_shipper_tel ~ .error_or_msg").hide();
                $("#contact_shipper_tel").parent().removeClass("error_or");
            }
            
            //Fax length is 19 for CX
            if (!StringFormatChecker.checkFormatM(shipperFax, 0, 19)) {
                $("#contact_shipper_fax ~ .error_or_msg").show();
                $("#contact_shipper_fax").parent().addClass("error_or");
                isValid = false;
            } else {
                $("#contact_shipper_fax ~ .error_or_msg").hide();
                $("#contact_shipper_fax").parent().removeClass("error_or");
            }

		} else {
			$("#contact_shipper_name ~ .error_or_msg").hide();
			$("#contact_shipper_name").parent().removeClass("error_or");

			$("#contact_shipper_address ~ .error_or_msg").hide();
			$("#contact_shipper_address").parent().removeClass("error_or");

			$("#contact_shipper_city ~ .error_or_msg").hide();
			$("#contact_shipper_city").parent().removeClass("error_or");

			$("#contact_shipper_country ~ .error_or_msg").hide();
			$("#contact_shipper_country").parent().removeClass("error_or");
		}

		//consignee info
		if (consignName != "" || consignAddress != "" || consignCity != "" || consignState != "" || consignCountry != ""
		|| consignPostalCode != "" || consignTel != "" || consignFax != "") {
			if (!StringFormatChecker.checkFormatF(consignName, 1, 35)) {
                $("#contact_consignee_name ~ .error_or_msg").show();
                $("#contact_consignee_name").parent().addClass("error_or");
                isValid = false;
            } else {
                $("#contact_consignee_name ~ .error_or_msg").hide();
                $("#contact_consignee_name").parent().removeClass("error_or");
            }
            
            if (!StringFormatChecker.checkFormatF(consignAddress, 1, 35)) {
                $("#contact_consignee_address ~ .error_or_msg").show();
                $("#contact_consignee_address").parent().addClass("error_or");
                isValid = false;
            } else {
                $("#contact_consignee_address ~ .error_or_msg").hide();
                $("#contact_consignee_address").parent().removeClass("error_or");
            }
            
            if (!StringFormatChecker.checkFormatT(consignCity, 1, 17)) {
                $("#contact_consignee_city ~ .error_or_msg").show();
                $("#contact_consignee_city").parent().addClass("error_or");
                isValid = false;
            } else {
                $("#contact_consignee_city ~ .error_or_msg").hide();
                $("#contact_consignee_city").parent().removeClass("error_or");
            }

            if (!StringFormatChecker.checkFormatT(consignState, 0, 9)) {
                $("#contact_consignee_state ~ .error_or_msg").show();
                $("#contact_consignee_state").parent().addClass("error_or");
                isValid = false;
            } else {
                $("#contact_consignee_state ~ .error_or_msg").hide();
                $("#contact_consignee_state").parent().removeClass("error_or");
            }

            if (!StringFormatChecker.checkFormatA(consignCountry.toUpperCase(), 2, 2)) {
                $("#contact_consignee_country ~ .error_or_msg").show();
                $("#contact_consignee_country").parent().addClass("error_or");
                isValid = false;
            } else {
                $("#contact_consignee_country ~ .error_or_msg").hide();
                $("#contact_consignee_country").parent().removeClass("error_or");
            }

            if (!StringFormatChecker.checkFormatT(consignPostalCode, 0, 9)) {
                $("#contact_consignee_postal ~ .error_or_msg").show();
                $("#contact_consignee_postal").parent().addClass("error_or");
                isValid = false;
            } else {
                $("#contact_consignee_postal ~ .error_or_msg").hide();
                $("#contact_consignee_postal").parent().removeClass("error_or");
            }
            
            //Tel length is 19 for CX
            if (!StringFormatChecker.checkFormatM(consignTel, 0, 19)) {
                $("#contact_consignee_tel ~ .error_or_msg").show();
                $("#contact_consignee_tel").parent().addClass("error_or");
                isValid = false;
            } else {
                $("#contact_consignee_tel ~ .error_or_msg").hide();
                $("#contact_consignee_tel").parent().removeClass("error_or");
            }
            
            //Fax length is 19 for CX
            if (!StringFormatChecker.checkFormatM(consignFax, 0, 19)) {
                $("#contact_consignee_fax ~ .error_or_msg").show();
                $("#contact_consignee_fax").parent().addClass("error_or");
                isValid = false;
            } else {
                $("#contact_consignee_fax ~ .error_or_msg").hide();
                $("#contact_consignee_fax").parent().removeClass("error_or");
            }
            
		} else {
			$("#contact_consignee_name ~ .error_or_msg").hide();
			$("#contact_consignee_name").parent().removeClass("error_or");

			$("#contact_consignee_address ~ .error_or_msg").hide();
			$("#contact_consignee_address").parent().removeClass("error_or");

			$("#contact_consignee_city ~ .error_or_msg").hide();
			$("#contact_consignee_city").parent().removeClass("error_or");

			$("#contact_consignee_country ~ .error_or_msg").hide();
			$("#contact_consignee_country").parent().removeClass("error_or");
		}

		console.log("Contact isValid:" + isValid);
		return isValid;
	}

	function saveContactEdit() {

		if (!validateContactInfo()) {
			return false;
		}

		var obj = new Object();
		obj.Shipper = new Object();
		obj.Consignee = new Object();

		obj.Shipper.Name = $("#contact_shipper_name").val();
		obj.Shipper.Address = $("#contact_shipper_address").val();
		obj.Shipper.City = $("#contact_shipper_city").val();
		obj.Shipper.State = $("#contact_shipper_state").val();
		obj.Shipper.CountryCode = $("#contact_shipper_country").val();
		obj.Shipper.PostCode = $("#contact_shipper_postal").val();
		obj.Shipper.TelNo = $("#contact_shipper_tel").val();
		obj.Shipper.FaxNo = $("#contact_shipper_fax").val();

		obj.Consignee.Name = $("#contact_consignee_name").val();
		obj.Consignee.Address = $("#contact_consignee_address").val();
		obj.Consignee.City = $("#contact_consignee_city").val();
		obj.Consignee.State = $("#contact_consignee_state").val();
		obj.Consignee.CountryCode = $("#contact_consignee_country").val();
		obj.Consignee.PostCode = $("#contact_consignee_postal").val();
		obj.Consignee.TelNo = $("#contact_consignee_tel").val();
		obj.Consignee.FaxNo = $("#contact_consignee_fax").val();

		localStorage.setItem("bd_contact_edit", JSON.stringify(obj));

		contactRefreshDisplay();
		closeContactEdit();

	}

	function updateIndicatorContact() {
		var original;
		var updated;
		var hasUpdate = false;

		if (typeof localStorage.getItem("bd_contact_edit") !== 'undefined' && localStorage.getItem("bd_contact_edit") != null) {
			original = JSON.parse(localStorage.getItem("bd_contact"));
			updated = JSON.parse(localStorage.getItem("bd_contact_edit"));

			if (original.Shipper.Name != updated.Shipper.Name) {
				$("#bd_contact_shipper_name").addClass("update_indicator");
				hasUpdate = true;
			} else {
				$("#bd_contact_shipper_name").removeClass("update_indicator");
			}

			if (original.Shipper.Address != updated.Shipper.Address) {
				$("#bd_contact_shipper_address").addClass("update_indicator");
				hasUpdate = true;
			} else {
				$("#bd_contact_shipper_address").removeClass("update_indicator");
			}

			if (original.Shipper.City != updated.Shipper.City) {
				$("#bd_contact_shipper_city").addClass("update_indicator");
				hasUpdate = true;
			} else {
				$("#bd_contact_shipper_city").removeClass("update_indicator");
			}

			if (original.Shipper.State != updated.Shipper.State) {
				$("#bd_contact_shipper_state").addClass("update_indicator");
				hasUpdate = true;
			} else {
				$("#bd_contact_shipper_state").removeClass("update_indicator");
			}

			if (original.Shipper.CountryCode != updated.Shipper.CountryCode) {
				$("#bd_contact_shipper_country").addClass("update_indicator");
				hasUpdate = true;
			} else {
				$("#bd_contact_shipper_country").removeClass("update_indicator");
			}

			if (original.Shipper.PostCode != updated.Shipper.PostCode) {
				$("#bd_contact_shipper_postal").addClass("update_indicator");
				hasUpdate = true;
			} else {
				$("#bd_contact_shipper_postal").removeClass("update_indicator");
			}

			if (original.Shipper.TelNo != updated.Shipper.TelNo) {
				$("#bd_contact_shipper_tel").addClass("update_indicator");
				hasUpdate = true;
			} else {
				$("#bd_contact_shipper_tel").removeClass("update_indicator");
			}

			if (original.Shipper.FaxNo != updated.Shipper.FaxNo) {
				$("#bd_contact_shipper_fax").addClass("update_indicator");
				hasUpdate = true;
			} else {
				$("#bd_contact_shipper_fax").removeClass("update_indicator");
			}

			if (original.Consignee.Name != updated.Consignee.Name) {
				$("#bd_contact_consignee_name").addClass("update_indicator");
				hasUpdate = true;
			} else {
				$("#bd_contact_consignee_name").removeClass("update_indicator");
			}

			if (original.Consignee.Address != updated.Consignee.Address) {
				$("#bd_contact_consignee_address").addClass("update_indicator");
				hasUpdate = true;
			} else {
				$("#bd_contact_consignee_address").removeClass("update_indicator");
			}

			if (original.Consignee.City != updated.Consignee.City) {
				$("#bd_contact_consignee_city").addClass("update_indicator");
				hasUpdate = true;
			} else {
				$("#bd_contact_consignee_city").removeClass("update_indicator");
			}

			if (original.Consignee.State != updated.Consignee.State) {
				$("#bd_contact_consignee_state").addClass("update_indicator");
				hasUpdate = true;
			} else {
				$("#bd_contact_consignee_state").removeClass("update_indicator");
			}

			if (original.Consignee.CountryCode != updated.Consignee.CountryCode) {
				$("#bd_contact_consignee_country").addClass("update_indicator");
				hasUpdate = true;
			} else {
				$("#bd_contact_consignee_country").removeClass("update_indicator");
			}

			if (original.Consignee.PostCode != updated.Consignee.PostCode) {
				$("#bd_contact_consignee_postal").addClass("update_indicator");
				hasUpdate = true;
			} else {
				$("#bd_contact_consignee_postal").removeClass("update_indicator");
			}

			if (original.Consignee.TelNo != updated.Consignee.TelNo) {
				$("#bd_contact_consignee_tel").addClass("update_indicator");
				hasUpdate = true;
			} else {
				$("#bd_contact_consignee_tel").removeClass("update_indicator");
			}

			if (original.Consignee.FaxNo != updated.Consignee.FaxNo) {
				$("#bd_contact_consignee_fax").addClass("update_indicator");
				hasUpdate = true;
			} else {
				$("#bd_contact_consignee_fax").removeClass("update_indicator");
			}

		}

		if (hasUpdate) {
			localStorage.setItem("bd_contact_has_update", 1);
		}
	}

	function clearEditErrorMsgContact() {
		$("#contact_edit .error_or").removeClass("error_or");
		$("#contact_edit .error_or_msg").hide();
	}

	function contactResetEdit() {
		$("#contact_shipper_name").val("");
		$("#contact_shipper_address").val("");
		$("#contact_shipper_city").val("");
		$("#contact_shipper_state").val("");
		$("#contact_shipper_country").val("");
		$("#contact_shipper_postal").val("");
		$("#contact_shipper_tel").val("");
		$("#contact_shipper_fax").val("");

		$("#contact_consignee_name").val("");
		$("#contact_consignee_address").val("");
		$("#contact_consignee_city").val("");
		$("#contact_consignee_state").val("");
		$("#contact_consignee_country").val("");
		$("#contact_consignee_postal").val("");
		$("#contact_consignee_tel").val("");
		$("#contact_consignee_fax").val("");
	}

	function openContactAddressBookSearch(e, tab) {
		if (typeof e !== 'undefined' && e != null) {
			e.preventDefault();
		}
		resetAddressBookSrc();
		localStorage.setItem("openAddressBookTab", tab);
		$("#lb_contact_edit").fadeOut();
		$("#lb_addressbook_src").fadeIn();
		getAddressBookSrc(null, defaultAddressBookCount);
	}

	function closeContactAddressBookSearch(e) {
		if (typeof e !== 'undefined' && e != null) {
			e.preventDefault();
		}
		localStorage.removeItem("openAddressBookTab");
		$("#lb_addressbook_src").fadeOut();
		$("#lb_contact_edit").fadeIn();
	}

	function getAddressBookSrc(e, count) {
		if (typeof e !== 'undefined' && e != null) {
			e.preventDefault();
		}
		var addrCode = $("#contact_addressbook_code_src").val() || "";

		//startAddressBookSearchAction();
		if (typeof count !== 'undefined' && count != null) {
			GetAddressBook(addrCode, count);
		} else {
			GetAddressBook(addrCode);
		}

	}

	function getAddressbookResult() {

		var rtn = "";
		var addressRecordTemp = $("#contact_addressbook_src_temp").html();

		var lt = [];
		if (localStorage.getItem("contact_addr_book") != null) {
			lt = JSON.parse(localStorage.getItem("contact_addr_book"));
		}

		for (var i = 0; i < lt.length; i++) {
			var name = lt[i].Name;
			if (lt[i].Name2 != "") {
				name += "," + lt[i].Name2;
			}
			rtn += addressRecordTemp.replaceAll("%ROWID%", i).replace("%ADDRCODE%", lt[i].AddressCode).replace("%NAME%", name).replace("%CITY%", lt[i].City);
		}

		return rtn;
	}

	function resetAddressBookSrc() {
		$("#contact_addressbook_code_src").val("");
		$("#contact_addressbook_result .rowwrapper").remove();

		$("#addressBookResultStatusWrapper .error-box").addClass("disabled");
		hideAddressBookLoading();
		hideAddressBookError();
	}

	function bindAddressBookData(e, row) {
		if (typeof e !== 'undefined' && e != null) {
			e.preventDefault();
		}
		var lt = [];
		var tab;
		if (localStorage.getItem("contact_addr_book") != null && localStorage.getItem("openAddressBookTab") != null) {
			lt = JSON.parse(localStorage.getItem("contact_addr_book"));
			tab = localStorage.getItem("openAddressBookTab");
			if (typeof lt[row] !== 'undefined' && lt[row] != null) {
				var name = lt[row].Name || "" ;

				var name2 = lt[row].Name2 || "";
				if (name2 != "") {
					name = "," + name2;
				}

				var addr1 = lt[row].Address1 || "";
				var addr2 = lt[row].Address2 || "";
				var addr3 = lt[row].Address3 || "";
				var addr = addr1;
				if (addr2 != "") {
					if (addr != "") {
						addr += " " + addr2;
					} else {
						addr = addr2;
					}
				}

				if (addr3 != "") {
					if (addr != "") {
						addr += " " + addr3;
					} else {
						addr = addr3;
					}
				}

				var city = lt[row].Place || "";
				var state = lt[row].City || "";
				var country = lt[row].CountryCode || "";
				var postalCode = lt[row].PostalCode || "";
				var tel = lt[row].Tel || "";
				var fax = lt[row].Fax || "";

				if (tab == 0) {
                    $("#contact_shipper_name").val(getFieldMaxlengthVal($("#contact_shipper_name"), name));
                    $("#contact_shipper_address").val(getFieldMaxlengthVal($("#contact_shipper_address"), addr));
                    $("#contact_shipper_city").val(getFieldMaxlengthVal($("#contact_shipper_city"), city));
                    $("#contact_shipper_state").val(getFieldMaxlengthVal($("#contact_shipper_state"), state));
                    $("#contact_shipper_country").val(getFieldMaxlengthVal($("#contact_shipper_country"), country));
                    $("#contact_shipper_postal").val(getFieldMaxlengthVal($("#contact_shipper_postal"), postalCode));
                    $("#contact_shipper_tel").val(getFieldMaxlengthVal($("#contact_shipper_tel"), tel));
                    $("#contact_shipper_fax").val(getFieldMaxlengthVal($("#contact_shipper_fax"), fax));
                } else if (tab == 1) {
                    $("#contact_consignee_name").val(getFieldMaxlengthVal($("#contact_consignee_name"), name));
                    $("#contact_consignee_address").val(getFieldMaxlengthVal($("#contact_consignee_address"), addr));
                    $("#contact_consignee_city").val(getFieldMaxlengthVal($("#contact_consignee_city"), city));
                    $("#contact_consignee_state").val(getFieldMaxlengthVal($("#contact_consignee_state"), state));
                    $("#contact_consignee_country").val(getFieldMaxlengthVal($("#contact_consignee_country"), country));
                    $("#contact_consignee_postal").val(getFieldMaxlengthVal($("#contact_consignee_postal"), postalCode));
                    $("#contact_consignee_tel").val(getFieldMaxlengthVal($("#contact_consignee_tel"), tel));
                    $("#contact_consignee_fax").val(getFieldMaxlengthVal($("#contact_consignee_fax"), fax));
                }

			} else {
				alert("Load Address book error occured");
			}
		} else {
			alert("Load Address book error occured");
		}

		closeContactAddressBookSearch();
	}

	function addtoAddressBook(tab) {
		console.log("addtoAddressBook");
		$("#contact_addressbook_code_ins_shipper ~ .error_or_msg").hide();
		$("#contact_addressbook_code_ins_consignee ~ .error_or_msg").hide();
		var isValid = true;
		var ind;
		var obj;
		if (tab == 0) {
			ind = "shipper";
			var addressCode = $("#contact_addressbook_code_ins_shipper").val();
			var name = $("#contact_shipper_name").val();
			var addr = $("#contact_shipper_address").val();
			var city = $("#contact_shipper_city").val();
			var state = $("#contact_shipper_state").val();
			var country = $("#contact_shipper_country").val();
			var postalCode = $("#contact_shipper_postal").val();
			var tel = $("#contact_shipper_tel").val();
			var fax = $("#contact_shipper_fax").val();

		} else if (tab == 1) {
			ind = "consignee";
			var addressCode = $("#contact_addressbook_code_ins_consignee").val();
			var name = $("#contact_consignee_name").val();
			var addr = $("#contact_consignee_address").val();
			var city = $("#contact_consignee_city").val();
			var state = $("#contact_consignee_state").val();
			var country = $("#contact_consignee_country").val();
			var postalCode = $("#contact_consignee_postal").val();
			var tel = $("#contact_consignee_tel").val();
			var fax = $("#contact_consignee_fax").val();
		} else {
			isValid = false;
		}

		if (isValid) {
			obj = new Object();
			obj.AddressCode = addressCode;
			obj.Name = name;
			obj.Address1 = addr;
			obj.Place = city;
			obj.City = state;
			obj.CountryCode = country;
			obj.PostalCode = postalCode;
			obj.Tel = tel;
			obj.Fax = fax;
		}

		if (addressCode == "") {
			if (tab == 0) {
				$("#contact_addressbook_code_ins_shipper ~ .error_or_msg").text(i18next.t("contact.AddressCodeRequired"));
				$("#contact_addressbook_code_ins_shipper ~ .error_or_msg").show();
			} else {
				$("#contact_addressbook_code_ins_consignee ~ .error_or_msg").text(i18next.t("contact.AddressCodeRequired"));
				$("#contact_addressbook_code_ins_consignee ~ .error_or_msg").show();
			}
			isValid = false;
		} else if (name == "") {
			if (tab == 0) {
				$("#contact_addressbook_code_ins_shipper ~ .error_or_msg").text(i18next.t("contact.NameRequired"));
				$("#contact_addressbook_code_ins_shipper ~ .error_or_msg").show();
			} else {
				$("#contact_addressbook_code_ins_consignee ~ .error_or_msg").text(i18next.t("contact.NameRequired"));
				$("#contact_addressbook_code_ins_consignee ~ .error_or_msg").show();
			}
			isValid = false;
		} else if (addr == "") {
			if (tab == 0) {
				$("#contact_addressbook_code_ins_shipper ~ .error_or_msg").text(i18next.t("contact.AddressRequired"));
				$("#contact_addressbook_code_ins_shipper ~ .error_or_msg").show();
			} else {
				$("#contact_addressbook_code_ins_consignee ~ .error_or_msg").text(i18next.t("contact.AddressRequired"));
				$("#contact_addressbook_code_ins_consignee ~ .error_or_msg").show();
			}
			isValid = false;
		} else if (city == "") {
			if (tab == 0) {
				$("#contact_addressbook_code_ins_shipper ~ .error_or_msg").text(i18next.t("contact.CityRequired"));
				$("#contact_addressbook_code_ins_shipper ~ .error_or_msg").show();
			} else {
				$("#contact_addressbook_code_ins_consignee ~ .error_or_msg").text(i18next.t("contact.CityRequired"));
				$("#contact_addressbook_code_ins_consignee ~ .error_or_msg").show();
			}
			isValid = false;
		} else if (country == "") {
			if (tab == 0) {
				$("#contact_addressbook_code_ins_shipper ~ .error_or_msg").text(i18next.t("contact.CountryRequired"));
				$("#contact_addressbook_code_ins_shipper ~ .error_or_msg").show();
			} else {
				$("#contact_addressbook_code_ins_consignee ~ .error_or_msg").text(i18next.t("contact.CountryRequired"));
				$("#contact_addressbook_code_ins_consignee ~ .error_or_msg").show();
			}
			isValid = false;
		}

		if (isValid) {
			 showAddressBookAddLoading(ind);
			 AddAddressBookContact(obj);
		}
        refreshModuleTranslation();
	}

    function getFieldMaxlengthVal($field, val) {
        if ($field.attr('maxlength'))
            return val.substring(0, $field.attr('maxlength'));
        else
            return val;
    }

</script><div id="bkd_def_remarks" class="bkd_block">

    <div class="col-xs-12">
		<h3 class="inline_block" data-i18n="cargoInfo.Remarks">Remarks</h3>
		<a onclick="openRemarkEdit(event)" href="#" class="btn_gy_edit"></a>
	</div>

    <div class="blkc"></div>
    <div class="col-xs-12">
	    <div class="blk_gy_line blkl">
	        <div class="blk_typea" style="width: 100%;">
	            <label data-i18n="remark.OSI">Other Service Information</label>
	            <div id="bd_remark_osi">Delete from EzyCargo Web</div>
	            <div id="bd_remark_osi2">-</div>
	            <br>
	            <label data-i18n="remark.SSI">Special Service Information</label>
	            <div id="bd_remark_ssi">TEMPERATURE -2C10C  </div>
	            <div id="bd_remark_ssi2">STORAGE 10C20CCTC 789332 TEMPERATURE -2C10C   STORAGE 10C20CCTC 789332 TEMP</div>
	        </div>
	    </div>
	</div>

    <div class="booking_lb lity-hide" id="remark_edit" style="width: 100%; min-width: 900px; max-width: 900px;">
        <div class="lightbox_ctr" style="width: 100%;">
            <div class="close_ctr"><a id="btn_remark_edit_close" href="javascript:void(0)" class="close_btn" onclick="closeRemarkEdit(event)"></a></div>
            <div class="lightbox_blk">
                <h3 data-i18n="cargoInfo.Remarks">Remarks</h3>
                <div class="blkc"></div>

                <div class="blk_filter">
                    <div class="head_hr"></div>
                    <div class="consign_info">
                        <div class="cnt_inline chk_general">
                            <label for="remark_osi1" data-i18n="remark.OSI">Other Service Information</label>
                            <div>
					            <input class="w100" id="remark_osi" maxlength="75">
					            <div class="error_or_msg" style="display:none;" data-i18n="cargoInfo.Invalid">Invalid</div>
					        </div>
					        <div>
					            <input class="w100" id="remark_osi2" maxlength="75" style="margin-top: 5px;">
					            <div class="error_or_msg" style="display:none;" data-i18n="cargoInfo.Invalid">Invalid</div>
					        </div>
                        </div>
                        <div class="cnt_inline chk_general">
                            <label for="remark_ssi1" data-i18n="remark.SSI">Special Service Information</label>
                            <div>
					            <input class="w100" id="remark_ssi" maxlength="75">
					            <div class="error_or_msg" style="display:none;" data-i18n="cargoInfo.Invalid">Invalid</div>
					        </div>
					        <div>
					            <input class="w100" id="remark_ssi2" maxlength="75" style="margin-top: 5px;">
					            <div class="error_or_msg" style="display:none;" data-i18n="cargoInfo.Invalid">Invalid</div>
					        </div>
                        </div>
                    </div>
                </div>
                <div>
                    <a href="javascript:void(0)" class="link_bu_l2" style="float: left;" onclick="closeRemarkEdit(event)" data-i18n="common.Cancel">Cancel</a>
                    <span href="javascript:void(0)" class="btn_or_l" onclick="saveRemarkEdit()" data-i18n="common.Save">Save</span>
                    <div class="blkc"></div>
                </div>

            </div>
        </div>
    </div>

</div>

<script>
	$(function() {
		var id = "#bkd_def_remarks";
		var remarkLity;
		
		$(id).on("clear", function(event) {
			//console.log(data);
			
			//debugger;
			$("#remark_osi").val("");
			$("#remark_ssi").val("");
			$("#remark_osi2").val("");
			$("#remark_ssi2").val("");
			
			$("#bd_remark_osi").text("");
			$("#bd_remark_ssi").text("");
			$("#bd_remark_osi2").text("");
			$("#bd_remark_ssi2").text("");
			clearEditErrorMsgRemark();
			
		});
		
		$(id).on("init", function(event, data) {
			console.log(data);
			var currentRowID;
			//debugger;
			
			$("#remark_osi").val(data.Remark.OtherServiceInfo);
			$("#remark_ssi").val(data.Remark.SpServiceInfo);
			$("#remark_osi2").val(data.Remark.OtherServiceInfo2);
			$("#remark_ssi2").val(data.Remark.SpServiceInfo2);
			
		});
		
		$(id).on("validate", function() {
			console.log("OK");
			
			return true;
		});
		
		$(id).on("submit", function() {
			
			var bkdData = "";
			if (typeof localStorage.getItem("bd_remarks_edit") !== 'undefined' && localStorage.getItem("bd_remarks_edit") != null) {
				bkdData = JSON.parse(localStorage.getItem("bd_remarks_edit"));
			} else if (typeof localStorage.getItem("bd_remarks") !== 'undefined' && localStorage.getItem("bd_remarks") != null) {
				bkdData = JSON.parse(localStorage.getItem("bd_remarks"));
			}
			
			var osi = bkdData.Osi;
			var ssi = bkdData.Ssi;
			var osi2 = bkdData.Osi2;
			var ssi2 = bkdData.Ssi2;

			return { 
				"Remark" : {
					"OtherServiceInfo" : osi,
					"SpServiceInfo" : ssi,
					"OtherServiceInfo2" : osi2,
					"SpServiceInfo2" : ssi2
				}
			};
		});
		
		$(id).on("loadBookingData", function(event, bkdData) {
			//console.log(bkdData);
			//var currentRowID;
			//var insertRowID;
			//debugger;
			
			var obj = new Object();
			if (typeof bkdData.Osi !== 'undefined' && bkdData.Osi != null) {
				if (typeof bkdData.Osi[0] !== 'undefined' && bkdData.Osi[0] != null) {
					obj.Osi = bkdData.Osi[0];
				} else {
					obj.Osi = "";
				}
				
				if (typeof bkdData.Osi[1] !== 'undefined' && bkdData.Osi[1] != null) {
					obj.Osi2 = bkdData.Osi[1];
				} else {
					obj.Osi2 = "";
				}
			}
			if (typeof bkdData.SsrDetail !== 'undefined' && bkdData.SsrDetail != null) {
				if (typeof bkdData.SsrDetail[0] !== 'undefined' && bkdData.SsrDetail[0] != null) {
					obj.Ssi = bkdData.SsrDetail[0];
				} else {
					obj.Ssi = "";
				}
				
				if (typeof bkdData.SsrDetail[1] !== 'undefined' && bkdData.SsrDetail[1] != null) {
					obj.Ssi2 = bkdData.SsrDetail[1];
				} else {
					obj.Ssi2 = "";
				}
			}
				
			localStorage.setItem("bd_remarks", JSON.stringify(obj));
			localStorage.removeItem("bd_remarks_edit");
			remarkRefreshDisplay();
		});
		
		$(id).on("setData", function(event, dataID, value) {
			console.log(dataID);
			console.log(value);
			
			//loadEditDataRemark();
			
			var bkdData = "";
			if (typeof localStorage.getItem("bd_remarks_edit") !== 'undefined' && localStorage.getItem("bd_remarks_edit") != null) {
				bkdData = JSON.parse(localStorage.getItem("bd_remarks_edit"));
			} else if (typeof localStorage.getItem("bd_remarks") !== 'undefined' && localStorage.getItem("bd_remarks") != null) {
				bkdData = JSON.parse(localStorage.getItem("bd_remarks"));
			}
			
			var osi = bkdData.Osi;
			var ssi = bkdData.Ssi;
			var osi2 = bkdData.Osi2;
			var ssi2 = bkdData.Ssi2;
			
			var obj = new Object();
			obj.Osi = osi;
			obj.Ssi = ssi;
			obj.Osi2 = osi2;
			obj.Ssi2 = ssi2;
			
			switch(dataID) {
				case "OSI":
					obj.Osi = value;
					break;
				case "OSI2":
					obj.Osi2 = value;
					break;
				case "SSI":
					obj.Ssi = value;
					break;
				case "SSI2":
					obj.Ssi2 = value;
					break;
			}
			
			localStorage.setItem("bd_remarks_edit", JSON.stringify(obj));
			remarkRefreshDisplay();
		
		});
		
	});	
	
	function remarkRefreshDisplay() {
			
		var bkdData = "";
		if (typeof localStorage.getItem("bd_remarks_edit") !== 'undefined' && localStorage.getItem("bd_remarks_edit") != null) {
			bkdData = JSON.parse(localStorage.getItem("bd_remarks_edit"));
		} else if (typeof localStorage.getItem("bd_remarks") !== 'undefined' && localStorage.getItem("bd_remarks") != null) {
			bkdData = JSON.parse(localStorage.getItem("bd_remarks"));
		}
		
		if (bkdData != "") {
			//console.log("fltRefreshDisplay: " + JSON.stringify(bkdData));
			if (bkdData.Osi != "") {
				$("#bd_remark_osi").text(bkdData.Osi);
			} else {
				$("#bd_remark_osi").text("-");
			}
			if (bkdData.Osi2 != "") {
				$("#bd_remark_osi2").text(bkdData.Osi2);
			} else {
				$("#bd_remark_osi2").text("-");
			}
			if (bkdData.Ssi != "") {
				$("#bd_remark_ssi").text(bkdData.Ssi);
			} else {
				$("#bd_remark_ssi").text("-");
			}
			if (bkdData.Ssi2 != "") {
				$("#bd_remark_ssi2").text(bkdData.Ssi2);
			} else {
				$("#bd_remark_ssi2").text("-");
			}

			updateIndicatorRemark();
		}
	}
	
	// remark edit
	
	function openRemarkEdit(e) {
		e.preventDefault();
		clearEditErrorMsgRemark();
		regRemarkInit();
		loadEditDataRemark();
		remarkLity = lity('#remark_edit');
	}
	
	function closeRemarkEdit(e) {
		if (typeof e !== 'undefined' && e != null) {
			e.preventDefault();
		}
		remarkLity.close();
	}
	
	function regRemarkInit() {
		
	}
	
	function loadEditDataRemark() {
		
		var bkdData = "";
		if (typeof localStorage.getItem("bd_remarks_edit") !== 'undefined' && localStorage.getItem("bd_remarks_edit") != null) {
			bkdData = JSON.parse(localStorage.getItem("bd_remarks_edit"));
		} else if (typeof localStorage.getItem("bd_remarks") !== 'undefined' && localStorage.getItem("bd_remarks") != null) {
			bkdData = JSON.parse(localStorage.getItem("bd_remarks"));
		}
		
		if (bkdData != "") {

			$("#remark_osi").val(bkdData.Osi);
			$("#remark_ssi").val(bkdData.Ssi);
			$("#remark_osi2").val(bkdData.Osi2);
			$("#remark_ssi2").val(bkdData.Ssi2);
		}
		
	}
	
	function validateRemarkInfo() {
		var isValid = true;

		var osi = $("#remark_osi").val();
		var osi2 = $("#remark_osi2").val();
		var ssi = $("#remark_ssi").val();
		var ssi2 = $("#remark_ssi2").val();

		//75 is for CXWebService only
		if (!StringFormatChecker.checkFormatT(osi, 0, 75)) {
			$("#remark_osi ~ .error_or_msg").show();
			$("#remark_osi").parent().addClass("error_or");
			isValid = false;
		} else {
			$("#remark_osi ~ .error_or_msg").hide();
			$("#remark_osi").parent().removeClass("error_or");
		}

		if (!StringFormatChecker.checkFormatT(osi2, 0, 75)) {
			$("#remark_osi2 ~ .error_or_msg").show();
			$("#remark_osi2").parent().addClass("error_or");
			isValid = false;
		} else {
			$("#remark_osi2 ~ .error_or_msg").hide();
			$("#remark_osi2").parent().removeClass("error_or");
		}

		if (!StringFormatChecker.checkFormatT(ssi, 0, 75)) {
			$("#remark_ssi ~ .error_or_msg").show();
			$("#remark_ssi").parent().addClass("error_or");
			isValid = false;
		} else {
			$("#remark_ssi ~ .error_or_msg").hide();
			$("#remark_ssi").parent().removeClass("error_or");
		}

		if (!StringFormatChecker.checkFormatT(ssi2, 0, 75)) {
			$("#remark_ssi2 ~ .error_or_msg").show();
			$("#remark_ssi2").parent().addClass("error_or");
			isValid = false;
		} else {
			$("#remark_ssi2 ~ .error_or_msg").hide();
			$("#remark_ssi2").parent().removeClass("error_or");
		}

		console.log("remark isValid:" + isValid);
		return isValid;
	}
	
	function saveRemarkEdit() {
		
		if (!validateRemarkInfo()) {
			return false;
		}
		
		var obj = new Object();
		obj.Osi = $("#remark_osi").val();
		obj.Ssi = $("#remark_ssi").val();
		obj.Osi2 = $("#remark_osi2").val();
		obj.Ssi2 = $("#remark_ssi2").val();
		
		localStorage.setItem("bd_remarks_edit", JSON.stringify(obj));

		remarkRefreshDisplay();
		closeRemarkEdit();
		
	}
	
	function updateIndicatorRemark() {
		
		var original;
		var updated;
		var hasUpdate = false;
		
		if (typeof localStorage.getItem("bd_remarks_edit") !== 'undefined' && localStorage.getItem("bd_remarks_edit") != null) {
			original = JSON.parse(localStorage.getItem("bd_remarks"));
			updated = JSON.parse(localStorage.getItem("bd_remarks_edit"));
		
			if (original.Osi != updated.Osi) {
				$("#bd_remark_osi").addClass("update_indicator");
				hasUpdate = true;
			} else {
				$("#bd_remark_osi").removeClass("update_indicator");
			}
			
			if (original.Ssi != updated.Ssi) {
				$("#bd_remark_ssi").addClass("update_indicator");
				hasUpdate = true;
			} else {
				$("#bd_remark_ssi").removeClass("update_indicator");
			}
			
			if (original.Osi2 != updated.Osi2) {
				$("#bd_remark_osi2").addClass("update_indicator");
				hasUpdate = true;
			} else {
				$("#bd_remark_osi2").removeClass("update_indicator");
			}
			
			if (original.Ssi2 != updated.Ssi2) {
				$("#bd_remark_ssi2").addClass("update_indicator");
				hasUpdate = true;
			} else {
				$("#bd_remark_ssi2").removeClass("update_indicator");
			}
			
		}
		
		if (hasUpdate) {
			localStorage.setItem("bd_remark_has_update", 1);
		}
		
	}
	
	function clearEditErrorMsgRemark() {
		$("#remark_edit .error_or").removeClass("error_or");
		$("#remark_edit .error_or_msg").hide();
		
	}
	
	function remarkResetEdit() {
		$("#remark_osi").val("");
		$("#remark_ssi").val("");
		$("#remark_osi2").val("");
		$("#remark_ssi2").val("");
		clearEditErrorMsgRemark();
	}
	
	function remarkEnableOSI() {
		$('#remark_osi').prop('readonly', false);
		$('#remark_osi2').prop('readonly', false);
	}
	
	function remarkDisableClearOSI() {
		$('#remark_osi').prop('readonly', true);
		$('#remark_osi2').prop('readonly', true);
		$('#remark_osi').val("");
		$('#remark_osi2').val("");
		
		var bkdData = "";
		if (typeof localStorage.getItem("bd_remarks_edit") !== 'undefined' && localStorage.getItem("bd_remarks_edit") != null) {
			bkdData = JSON.parse(localStorage.getItem("bd_remarks_edit"));
		} else if (typeof localStorage.getItem("bd_remarks") !== 'undefined' && localStorage.getItem("bd_remarks") != null) {
			bkdData = JSON.parse(localStorage.getItem("bd_remarks"));
		}
		
		if (bkdData != "") {
			bkdData.Osi = "";
			bkdData.Osi2 = "";
			localStorage.setItem("bd_remarks_edit", JSON.stringify(bkdData));
			remarkRefreshDisplay();
		}
	}
	
	//end remark edit
</script><!--
	NGTT page for booking detail
	20201117 > Assign date to read/write to protobuf only. NO UI DISPLAYED AND IMPLEMENTED
-->


<div id="bkd_def_ngtt" class="bkd_block" style="display:none;">

	<!-- Details -->
    <div class="col-xs-12">
		<h3 class="inline_block" data-i18n="ngtt.NGTTInfo">Smart Track Information</h3>
		<a onclick="openNGTTEdit(event)" href="#" class="btn_gy_edit"></a>
	</div>

    <div class="blkc"></div>
    <div class="col-xs-12">
	    <div class="blk_gy_line blkl">
	        <div class="blk_typea" style="width: 100%;">

				<label data-i18n="ngtt.Product">Product</label>
				<div id="bd_ngtt_product">TRK</div>
				<br>

				<label data-i18n="ngtt.ServiceLevel">Service Level</label>
				<div id="bd_ngtt_temperature">COL (2 to 8°C; 35 to 47°F)</div>
				<br>

				<div id="bd_ngtt_ctTemperature">-</div>
				<br>

				<label data-i18n="ngtt.OtherTrackingService">Other Tracking Service</label>
				<br>
				<label data-i18n="ngtt.Humidity">Humidity</label>
				<div id="bd_ngtt_humidity">N/A</div>
				<label data-i18n="ngtt.Shock">Shock</label>
				<div id="bd_ngtt_shock">N/A</div>
				<label data-i18n="ngtt.Light">Light</label>
				<div id="bd_ngtt_light">N/A</div>
				<br>

				<label data-i18n="ngtt.DeviceID">Device ID *</label>
				<ul id="bd_ngtt_deviceIds" class="bu_list show_ngtt_deviceId">
	<li>1. 300411</li>

	<li>2. 300422</li>
</ul>
				<br>

				<label data-i18n="ngtt.ContactPerson">Contact Person</label>
				<div id="bd_ngtt_contact">ELISHA LAM</div>
				<br>

				<label data-i18n="ngtt.Email">Smart Track Notification (E-mail Contact)</label>
				<ul id="bd_ngtt_emails" class="bu_list show_ngtt_email">
	<li>1. Elisha.Lam@glshk.com</li>
</ul>
				<br>

				<label data-i18n="ngtt.Tel">Smart Track Notification (Tel. Contact)</label>
				<ul id="bd_ngtt_tels" class="bu_list show_ngtt_tel">
	<li>1. 23456789</li>
</ul>
				<br>

	        </div>
	    </div>
	</div>

	<!-- Popup
		20201117 > POPUP is not implemented, readonly. Required view in future
	-->
    <div class="booking_lb lity-hide" id="ngtt_edit" style="width: 100%; min-width: 900px; max-width: 900px;">
        <div class="lightbox_ctr" style="width: 100%;">
            <div class="close_ctr"><a id="btn_ngtt_edit_close" href="javascript:void(0)" class="close_btn" onclick="closeNGTTEdit(event)"></a></div>
            <div class="lightbox_blk">

				<h1>NGTT POPUP IS DISABLED</h1>

				<!--
                <h3 data-i18n="ngtt.NGTTInfo">NGTT Information</h3>
                <div class="blkc"></div>

                <div class="blk_filter">
                    <div class="head_hr"></div>
					<div class="cnt_inline chk_general">
						<label for="edit_ngtt_product" data-i18n="ngtt.Product">Product</label>
						<div>
							<input class="w100" id="edit_ngtt_product" maxlength="75" />
							<div class="error_or_msg" style="display:none;" data-i18n="cargoInfo.Invalid">Invalid</div>
						</div>
					</div>
					<div class="cnt_inline chk_general">
						<label for="edit_ngtt_temperature" data-i18n="ngtt.ServiceLevel">Service Level</label>
						<div>
							<input class="w100" id="edit_ngtt_temperature" maxlength="75"/>
							<div class="error_or_msg" style="display:none;" data-i18n="cargoInfo.Invalid">Invalid</div>
						</div>

						<div>
							<input class="w100" id="edit_ngtt_ctTemperature" maxlength="75"/>
							<div class="error_or_msg" style="display:none;" data-i18n="cargoInfo.Invalid">Invalid</div>
						</div>
					</div>

					<label data-i18n="ngtt.OtherTrackingService">Other Tracking Service</label>
					<div class="cnt_inline chk_general">
						<label for="edit_ngtt_humidity" data-i18n="ngtt.Humidity">Humidity</label>
						<div>
							<input class="w100" id="edit_ngtt_humidity" maxlength="75"/>
							<div class="error_or_msg" style="display:none;" data-i18n="cargoInfo.Invalid">Invalid</div>
						</div>
					</div>
					<div class="cnt_inline chk_general">
						<label for="edit_ngtt_shock" data-i18n="ngtt.Shock">Shock</label>
						<div>
							<input class="w100" id="edit_ngtt_shock" maxlength="75"/>
							<div class="error_or_msg" style="display:none;" data-i18n="cargoInfo.Invalid">Invalid</div>
						</div>
					</div>
					<div class="cnt_inline chk_general">
						<label for="edit_ngtt_light" data-i18n="ngtt.Light">Light</label>
						<div>
							<input class="w100" id="edit_ngtt_light" maxlength="75"/>
							<div class="error_or_msg" style="display:none;" data-i18n="cargoInfo.Invalid">Invalid</div>
						</div>
					</div>

					<div class="cnt_inline chk_general">
						<label for="edit_ngtt_contactPerson" data-i18n="ngtt.ContactPerson">Contact Person</label>
						<div>
							<input class="w100" id="edit_ngtt_contactPerson" maxlength="75"/>
							<div class="error_or_msg" style="display:none;" data-i18n="cargoInfo.Invalid">Invalid</div>
						</div>
					</div>

					<div class="cnt_inline chk_general">
						<label for="edit_ngtt_deviceId" data-i18n="ngtt.DeviceID">Device ID</label>
						<div>
							<input class="w100" id="edit_ngtt_deviceId" maxlength="75"/>
							<div class="error_or_msg" style="display:none;" data-i18n="cargoInfo.Invalid">Invalid</div>
						</div>
					</div>

					<div class="cnt_inline chk_general">
						<label for="edit_ngtt_email" data-i18n="ngtt.Email">NGTT Notification (E-mail Contact)</label>
						<div>
							<input class="w100" id="edit_ngtt_email" maxlength="75"/>
							<div class="error_or_msg" style="display:none;" data-i18n="cargoInfo.Invalid">Invalid</div>
						</div>
					</div>

					<div class="cnt_inline chk_general">
						<label for="edit_ngtt_tel" data-i18n="ngtt.Tel">NGTT Notification (Tel. Contact)</label>
						<div>
							<input class="w100" id="edit_ngtt_tel" maxlength="75"/>
							<div class="error_or_msg" style="display:none;" data-i18n="cargoInfo.Invalid">Invalid</div>
						</div>
					</div>

                </div>
                <div>
                    <a href="javascript:void(0)" class="link_bu_l2" style="float: left;" onclick="closeNGTTEdit(event)" data-i18n="common.Cancel">Cancel</a>
                    <span href="javascript:void(0)" class="btn_or_l" onclick="saveNGTTEdit()" data-i18n="common.Save">Save</span>
                    <div class="blkc"></div>
                </div>
				-->

            </div>
        </div>
    </div>

</div>


<script id="bu_ngtt_deviceId_list_temp" type="text/x-template">
	<li>%cnt%. %deviceID%</li>
</script>

<script id="bu_ngtt_email_list_temp" type="text/x-template">
	<li>%cnt%. %email%</li>
</script>

<script id="bu_ngtt_tel_list_temp" type="text/x-template">
	<li>%cnt%. %tel%</li>
</script>


<script>
	$(function() {
		var id = "#bkd_def_ngtt";
		var remarkLity;

		$(id).on("clear", function(event) {
			//console.log(data);

			//debugger;
			$("#edit_ngtt_product").val("");
			$("#edit_ngtt_temperature").val("");
            $("#edit_ngtt_ctTemperature").val("");
			$("#edit_ngtt_humidity").val("");
			$("#edit_ngtt_shock").val("");
			$("#edit_ngtt_light").val("");
			$("#edit_ngtt_contactPerson").val("");
			$("#edit_ngtt_deviceId").val("");
			$("#edit_ngtt_email").val("");
			$("#edit_ngtt_tel").val("");

			$("#bd_ngtt_product").text("");
			$("#bd_ngtt_temperature").text("");
            $("#bd_ngtt_ctTemperature").text("");
			$("#bd_ngtt_humidity").text("");
			$("#bd_ngtt_shock").text("");
			$("#bd_ngtt_light").text("");
			$("#bd_ngtt_deviceIds").text("");
			$("#bd_ngtt_contact").text("");
			$("#bd_ngtt_emails").text("");
			$("#bd_ngtt_tels").text("");
			clearEditErrorMsgRemark();

		});

		$(id).on("init", function(event, data) {
			console.log(data);
			var currentRowID;
			//debugger;

		});

		$(id).on("validate", function() {
			console.log("OK");

			return true;
		});

		$(id).on("submit", function() {

			var bkdData = "";
			if (typeof localStorage.getItem("bd_ngtt_edit") !== 'undefined' && localStorage.getItem("bd_ngtt_edit") != null) {
				bkdData = JSON.parse(localStorage.getItem("bd_ngtt_edit"));
			} else if (typeof localStorage.getItem("bd_ngtt") !== 'undefined' && localStorage.getItem("bd_ngtt") != null) {
				bkdData = JSON.parse(localStorage.getItem("bd_ngtt"));
			}

			if (!$.isEmptyObject(bkdData)) {
				//Simulate DeviceIdList syntax to SingleBooking form
				var tempDeviceIdList = [];
				for (var cnt = 0; cnt < bkdData.DeviceIdList.length ; cnt++)
				{
					var obj = new Object();
					obj.Seq = cnt+1;
					obj.DeviceID = bkdData.DeviceIdList[cnt];

					if (obj.DeviceID == ""){
					} else {
						tempDeviceIdList.push(obj);
					}
				}

				//Simulate EmailList syntax to SingleBooking form
				var tempEmailList = [] ;
				for (var cnt = 0; cnt < bkdData.NgttNotification.EmailList.length ; cnt++)
				{
					var obj = new Object();
					obj.Seq = cnt+1;
					obj.Email = bkdData.NgttNotification.EmailList[cnt];

					if (obj.Email == ""){
					} else {
						tempEmailList.push(obj);
					}
				}

				//Simulate TelList syntax to SingleBooking form
				var tempTelList = [] ;
				for (var cnt = 0; cnt < bkdData.NgttNotification.TelList.length ; cnt++)
				{
					var obj = new Object();
					obj.Seq = cnt+1;
					obj.Tel = bkdData.NgttNotification.TelList[cnt];

					if (obj.Tel == ""){
					} else {
						tempTelList.push(obj);
					}
				}

				var ngttProduct = bkdData.ProductCode;
				var ngttTemperature = bkdData.NgttService.TempCode;
				var ngttTemperatureShc = ngttTemperature;
				var ngttHumidity = bkdData.NgttService.Humidity;
				var ngttShock = bkdData.NgttService.Shock;
				var ngttLight = bkdData.NgttService.Light;
				var ngttContact = bkdData.ContactPerson;
				var deviceList = tempDeviceIdList;
				var emailList = tempEmailList;
				var telList = tempTelList;
				var ngttStartTemp = bkdData.NgttService.StartTemp;
				var ngttEndTemp = bkdData.NgttService.EndTemp;
                var ngttInCooltainer = bkdData.NgttService.InCooltainer;
                var ngttCtTemperatureCode = ngttInCooltainer ? bkdData.NgttService.CtTemperatureCode : '';
                var ngttCtStartTemp = bkdData.NgttService.CtStartTemperature;
                var ngttCtEndTemp = bkdData.NgttService.CtEndTemperature;

				return {
					"NGTTInfo": {
						"ProductCode": ngttProduct,
						"TemperatureCode": ngttTemperature,
						"TemperatureShc": ngttTemperatureShc,
						"Humidity": ngttHumidity.toString(),
						"Shock": ngttShock.toString(),
						"Light": ngttLight.toString(),
						"ContactPerson": ngttContact,
						"DeviceList": deviceList,
						"EmailList": emailList,
						"TelList": telList,
						"StartTemp": ngttStartTemp,
						"EndTemp": ngttEndTemp,
                        "InCooltainer": ngttInCooltainer,
                        "CtTemperatureCode": ngttCtTemperatureCode,
                        "CtStartTemperature": ngttCtStartTemp,
                        "CtEndTemperature": ngttCtEndTemp
					}
				};
			}
		});

		$(id).on("loadBookingData", function(event, bkdData) {
			//console.log(bkdData);
			//var currentRowID;
			//var insertRowID;
			//debugger;

			var obj = new Object();

			if(bkdData.Cx.NgttInfo){
				obj = bkdData.Cx.NgttInfo;
			}

			localStorage.setItem("bd_ngtt", JSON.stringify(obj));
			localStorage.removeItem("bd_ngtt_edit");
			ngttRefreshDisplay();
		});

		$(id).on("setData", function(event, dataID, value) {
			console.log(dataID);
			console.log(value);

			//loadEditDataRemark();

			var bkdData = "";
			if (typeof localStorage.getItem("bd_ngtt_edit") !== 'undefined' && localStorage.getItem("bd_ngtt_edit") != null) {
				bkdData = JSON.parse(localStorage.getItem("bd_ngtt_edit"));
			} else if (typeof localStorage.getItem("bd_ngtt") !== 'undefined' && localStorage.getItem("bd_ngtt") != null) {
				bkdData = JSON.parse(localStorage.getItem("bd_ngtt"));
			}

			var obj = new Object();
			obj.productCode = bkdData.ProductCode;
			obj.deviceIdList = bkdData.DeviceIdList;
			obj.contactPerson = bkdData.ContactPerson;
			obj.ngttService = {
				tempCode: bkdData.NgttService.TempCode,
				startTemp: bkdData.NgttService.StartTemp,
				endTemp: bkdData.NgttService.EndTemp,
				humidity: bkdData.NgttService.Humidity,
				shock: bkdData.NgttService.Shock,
				light: bkdData.NgttService.Light,
				tempShc: bkdData.NgttService.TempShc,
                inCooltainer: bkdData.NgttService.InCooltainer,
                ctTemperatureCode: bkdData.NgttService.CtTemperatureCode,
                ctStartTemp: bkdData.NgttService.CtStartTemperature,
                ctEndTemp: bkdData.NgttService.CtEndTemperature
			}
			obj.ngttNotification = {
				emailList: bkdData.NgttNotification.EmailList,
				telList: bkdData.NgttNotification.TelList
			}

			/* Disable Change value from NGTT popup
			switch(dataID) {
				case "OSI":
					obj.Osi = value;
					break;
				case "OSI2":
					obj.Osi2 = value;
					break;
				case "SSI":
					obj.Ssi = value;
					break;
				case "SSI2":
					obj.Ssi2 = value;
					break;
			}
			*/

			localStorage.setItem("bd_ngtt_edit", JSON.stringify(obj));
			ngttRefreshDisplay();

		});

	});

	function ngttRefreshDisplay() {

		$("#bd_ngtt_deviceIds").empty();
		$("#bd_ngtt_emails").empty();
		$("#bd_ngtt_tels").empty();

		var bkdData = "";
		if (typeof localStorage.getItem("bd_ngtt_edit") !== 'undefined' && localStorage.getItem("bd_ngtt_edit") != null) {
			bkdData = JSON.parse(localStorage.getItem("bd_ngtt_edit"));
		} else if (typeof localStorage.getItem("bd_ngtt") !== 'undefined' && localStorage.getItem("bd_ngtt") != null) {
			bkdData = JSON.parse(localStorage.getItem("bd_ngtt"));
		}


		if (bkdData != "") {
			//console.log("fltRefreshDisplay: " + JSON.stringify(bkdData));
			if (bkdData.ProductCode != "") {
				$("#bd_ngtt_product").text(bkdData.ProductCode);
			} else {
				$("#bd_ngtt_product").text("-");
			}

			if (bkdData.NgttService) {
				if (bkdData.NgttService.TempCode) {
					$("#bd_ngtt_temperature").text(bkdData.NgttService.TempCode + ' (' + bkdData.NgttService.StartTemp + ' to ' + bkdData.NgttService.EndTemp + '\u00B0C\; ' + convertToF(bkdData.NgttService.StartTemp, 'start') + ' to ' + convertToF(bkdData.NgttService.EndTemp, 'end') + '\u00B0F)');
				} else {
					$("#bd_ngtt_temperature").text("-");
				}

                if (bkdData.NgttService.InCooltainer) {
                    $("#bd_ngtt_ctTemperature").text(bkdData.NgttService.CtTemperatureCode + ' (' + bkdData.NgttService.CtStartTemperature + ' to ' + bkdData.NgttService.CtEndTemperature + '\u00B0C\; ' + convertToF(bkdData.NgttService.CtStartTemperature, 'start') + ' to ' + convertToF(bkdData.NgttService.CtEndTemperature, 'end') + '\u00B0F)');
                } else {
                    $("#bd_ngtt_ctTemperature").text("-");
                }

				if (bkdData.NgttService.Humidity) {
					$("#bd_ngtt_humidity").text(bkdData.NgttService.Humidity);
				} else {
					$("#bd_ngtt_humidity").text("N/A");
				}

				if (bkdData.NgttService.Shock) {
					$("#bd_ngtt_shock").text(bkdData.NgttService.Shock);
				} else {
					$("#bd_ngtt_shock").text("N/A");
				}

				if (bkdData.NgttService.Light) {
					$("#bd_ngtt_light").text(bkdData.NgttService.Light);
				} else {
					$("#bd_ngtt_light").text("N/A");
				}

				if (bkdData.ContactPerson) {
					$("#bd_ngtt_contact").text(bkdData.ContactPerson);
				} else {
					$("#bd_ngtt_contact").text("-");
				}

				if (bkdData.DeviceIdList) {
					var deviceIdTemp = $("#bu_ngtt_deviceId_list_temp").html();
					for (var i = 0; i < bkdData.DeviceIdList.length ; i++) {
						deviceIdContent = deviceIdTemp.replace("%cnt%", i+1).replace("%deviceID%", bkdData.DeviceIdList[i]);
						$("#bd_ngtt_deviceIds").append(deviceIdContent);
					}
				}

				if (bkdData.NgttNotification) {

					if (bkdData.NgttNotification.EmailList) {
						var emailTemp = $("#bu_ngtt_email_list_temp").html();
						for (var i = 0; i < bkdData.NgttNotification.EmailList.length ; i++) {
							emailContent = emailTemp.replace("%cnt%", i+1).replace("%email%", bkdData.NgttNotification.EmailList[i]);
							$("#bd_ngtt_emails").append(emailContent);
						}
					}

					if (bkdData.NgttNotification.TelList) {
						var telTemp = $("#bu_ngtt_tel_list_temp").html();
						for (var i = 0; i < bkdData.NgttNotification.TelList.length ; i++) {
							telContent = telTemp.replace("%cnt%", i+1).replace("%tel%", bkdData.NgttNotification.TelList[i]);
							$("#bd_ngtt_tels").append(telContent);
						}
					}
				}
			}


			updateIndicatorRemark();
		}
	}

	// NGTT

	function openNGTTEdit(e) {
		e.preventDefault();
		clearEditErrorMsgRemark();
		regRemarkInit();
		loadEditDataRemark();
		remarkLity = lity('#ngtt_edit');
	}

	function closeNGTTEdit(e) {
		if (typeof e !== 'undefined' && e != null) {
			e.preventDefault();
		}
		remarkLity.close();
	}

	function regRemarkInit() {

	}

	function loadEditDataRemark() {

		var bkdData = "";
		if (typeof localStorage.getItem("bd_ngtt_edit") !== 'undefined' && localStorage.getItem("bd_ngtt_edit") != null) {
			bkdData = JSON.parse(localStorage.getItem("bd_ngtt_edit"));
		} else if (typeof localStorage.getItem("bd_ngtt") !== 'undefined' && localStorage.getItem("bd_ngtt") != null) {
			bkdData = JSON.parse(localStorage.getItem("bd_ngtt"));
		}

		/* Disable refresh update from popup , as popup feature is disabled
		if (bkdData != "") {

			$("#remark_osi").val(bkdData.Osi);
			$("#remark_ssi").val(bkdData.Ssi);
			$("#remark_osi2").val(bkdData.Osi2);
			$("#remark_ssi2").val(bkdData.Ssi2);
		}
		*/
	}

	function validateRemarkInfo() {
		var isValid = true;

		/* Disable validation as popup feature is disabled
		var osi = $("#remark_osi").val();
		var osi2 = $("#remark_osi2").val();
		var ssi = $("#remark_ssi").val();
		var ssi2 = $("#remark_ssi2").val();

		//75 is for CXWebService only
		if (!StringFormatChecker.checkFormatT(osi, 0, 75)) {
			$("#remark_osi ~ .error_or_msg").show();
			$("#remark_osi").parent().addClass("error_or");
			isValid = false;
		} else {
			$("#remark_osi ~ .error_or_msg").hide();
			$("#remark_osi").parent().removeClass("error_or");
		}

		if (!StringFormatChecker.checkFormatT(osi2, 0, 75)) {
			$("#remark_osi2 ~ .error_or_msg").show();
			$("#remark_osi2").parent().addClass("error_or");
			isValid = false;
		} else {
			$("#remark_osi2 ~ .error_or_msg").hide();
			$("#remark_osi2").parent().removeClass("error_or");
		}

		if (!StringFormatChecker.checkFormatT(ssi, 0, 75)) {
			$("#remark_ssi ~ .error_or_msg").show();
			$("#remark_ssi").parent().addClass("error_or");
			isValid = false;
		} else {
			$("#remark_ssi ~ .error_or_msg").hide();
			$("#remark_ssi").parent().removeClass("error_or");
		}

		if (!StringFormatChecker.checkFormatT(ssi2, 0, 75)) {
			$("#remark_ssi2 ~ .error_or_msg").show();
			$("#remark_ssi2").parent().addClass("error_or");
			isValid = false;
		} else {
			$("#remark_ssi2 ~ .error_or_msg").hide();
			$("#remark_ssi2").parent().removeClass("error_or");
		}

		console.log("remark isValid:" + isValid);
		*/
		return isValid;
	}

	function saveNGTTEdit() {

		/* Disable save ngtt edit information as the popup feature is disabled
		if (!validateRemarkInfo()) {
			return false;
		}

		var obj = new Object();
		obj.Osi = $("#remark_osi").val();
		obj.Ssi = $("#remark_ssi").val();
		obj.Osi2 = $("#remark_osi2").val();
		obj.Ssi2 = $("#remark_ssi2").val();

		localStorage.setItem("bd_ngtt_edit", JSON.stringify(obj));
		*/

		ngttRefreshDisplay();
		closeNGTTEdit();

	}

	function updateIndicatorRemark() {

		/* updateIndicator is disabled because popup feature is disabled.
		var original;
		var updated;
		var hasUpdate = false;

		if (typeof localStorage.getItem("bd_ngtt_edit") !== 'undefined' && localStorage.getItem("bd_ngtt_edit") != null) {
			original = JSON.parse(localStorage.getItem("bd_ngtt"));
			updated = JSON.parse(localStorage.getItem("bd_ngtt_edit"));

			if (original.Osi != updated.Osi) {
				$("#bd_remark_osi").addClass("update_indicator");
				hasUpdate = true;
			} else {
				$("#bd_remark_osi").removeClass("update_indicator");
			}

			if (original.Ssi != updated.Ssi) {
				$("#bd_remark_ssi").addClass("update_indicator");
				hasUpdate = true;
			} else {
				$("#bd_remark_ssi").removeClass("update_indicator");
			}

			if (original.Osi2 != updated.Osi2) {
				$("#bd_remark_osi2").addClass("update_indicator");
				hasUpdate = true;
			} else {
				$("#bd_remark_osi2").removeClass("update_indicator");
			}

			if (original.Ssi2 != updated.Ssi2) {
				$("#bd_remark_ssi2").addClass("update_indicator");
				hasUpdate = true;
			} else {
				$("#bd_remark_ssi2").removeClass("update_indicator");
			}

		}

		if (hasUpdate) {
			localStorage.setItem("bd_remark_has_update", 1);
		}
		*/

	}

	function clearEditErrorMsgRemark() {
		$("#ngtt_edit .error_or").removeClass("error_or");
		$("#ngtt_edit .error_or_msg").hide();

	}

	function ngttResetEdit() {
		/*
		$("#remark_osi").val("");
		$("#remark_ssi").val("");
		$("#remark_osi2").val("");
		$("#remark_ssi2").val("");
		clearEditErrorMsgRemark();
		*/
	}

	//end ngtt edit

	//Copied from _NGTT.cshtml
	function convertToF(celsius, type) {

        var result = celsius * 9 / 5 + 32;

        switch (type) {
            case "start":
                result = Math.floor(result);
                break;

            case "end":
                result = Math.ceil(result);
                break;
        }

        return result;
    }
</script>                            </div>
                        </div> <!-- outer wbg -->
                    </li>

                    <li id="tab2" data-content="tab2" class="bkdtabs" style="">
                        <!-- Tab2 -->
                        <div class="wbg">
                            <div class="container wbg">
                                <div id="booking_detail_records" class="tab_inner">
                                    <h3 class="col-xs-7"><span id="booking_detail_records_count">12</span>&nbsp;<span data-i18n="cargoInfo.BookingRecords">Booking Records</span></h3>
                                    <div class="col-xs-5 header_inline_right">
                                        <a id="booking_detail_records_time" href="javascript:void(0)" class="date_refresh" onclick="reloadBookingDetail()">09 Sep 10:13</a>
                                    </div>
                                    <div class="blk_c"></div>

                                    <div id="booking_detail_records_table" class="ts_table">
    <div class="trow theader">
        <div class="tcell colh" data-i18n="common.Status">Status</div>
        <div class="tcell colh" data-i18n="flight.Flights">Flights</div>
        <div class="tcell colh" data-i18n="cargoInfo.Depart">Depart</div>
        <div class="tcell colh" data-i18n="BookingDetails.Rounting">Rounting</div>
        <div class="tcell colh" data-i18n="cargoInfo.AllotmentID">Allotment ID</div>
        <div class="tcell colh" data-i18n="BookingLog.ActionBy">Action By</div>
        <div class="tcell colh" data-i18n="BookingLog.ActionTime">Action Time</div>
        <div class="tcell colh"></div>

    </div>

    <div class="rowwrapper">
        <a href="#" class="trow" onclick="bkdOpenBookingRecordRow(&#39;CX&#39;, &#39;160&#39;, &#39;10099364&#39;, &#39;88250&#39;, &#39;88249&#39;)">
            <div class="tcell cols">
                <div class="flight_status_null">Acknowledged</div>
            </div>
            <div class="tcell colm">
                <div class="flight_general"></div>
            </div>
            <div class="tcell cols col15">
                <div class="flight_general cell_hs">CX909</div>
            </div>
            <div class="tcell cols col20">
                <div class="flight_general cell_hs">2021-08-02</div>
            </div>
            <div class="tcell cols col40">
                <div class="flight_location cell_hs">HKG <img src="./img/icon_gy_flight.png">TPE</div>
            </div>
            <div class="tcell cols col100">
                <div class="flight_general cell_hs">-</div>
            </div>
            <div class="tcell colr">
                <div class="flight_general">ADMIN</div>
            </div>
            <div class="tcell cols col40 colpl row2">
                <div class="flight_general cell_hs">2021-09-09 10:13</div>
            </div>

            <div class="tcell cols colp row_ar">
                <span class="link_bu_r"></span>
            </div>
        </a>
    </div>

    <div class="rowwrapper">
        <a href="#" class="trow" onclick="bkdOpenBookingRecordRow(&#39;CX&#39;, &#39;160&#39;, &#39;10099364&#39;, &#39;88238&#39;, &#39;88237&#39;)">
            <div class="tcell cols">
                <div class="flight_status_null">Acknowledged</div>
            </div>
            <div class="tcell colm">
                <div class="flight_general"></div>
            </div>
            <div class="tcell cols col15">
                <div class="flight_general cell_hs">CX909</div>
            </div>
            <div class="tcell cols col20">
                <div class="flight_general cell_hs">2021-08-02</div>
            </div>
            <div class="tcell cols col40">
                <div class="flight_location cell_hs">HKG <img src="./img/icon_gy_flight.png">TPE</div>
            </div>
            <div class="tcell cols col100">
                <div class="flight_general cell_hs">-</div>
            </div>
            <div class="tcell colr">
                <div class="flight_general">ADMIN</div>
            </div>
            <div class="tcell cols col40 colpl row2">
                <div class="flight_general cell_hs">2021-09-09 10:09</div>
            </div>

            <div class="tcell cols colp row_ar">
                <span class="link_bu_r"></span>
            </div>
        </a>
    </div>

    <div class="rowwrapper">
        <a href="#" class="trow" onclick="bkdOpenBookingRecordRow(&#39;CX&#39;, &#39;160&#39;, &#39;10099364&#39;, &#39;86681&#39;, &#39;86680&#39;)">
            <div class="tcell cols">
                <div class="flight_status_null">Confirmed</div>
            </div>
            <div class="tcell colm">
                <div class="flight_general"></div>
            </div>
            <div class="tcell cols col15">
                <div class="flight_general cell_hs">CX909</div>
            </div>
            <div class="tcell cols col20">
                <div class="flight_general cell_hs">2021-08-02</div>
            </div>
            <div class="tcell cols col40">
                <div class="flight_location cell_hs">HKG <img src="./img/icon_gy_flight.png">TPE</div>
            </div>
            <div class="tcell cols col100">
                <div class="flight_general cell_hs">-</div>
            </div>
            <div class="tcell colr">
                <div class="flight_general">ADMIN</div>
            </div>
            <div class="tcell cols col40 colpl row2">
                <div class="flight_general cell_hs">2021-07-30 09:56</div>
            </div>

            <div class="tcell cols colp row_ar">
                <span class="link_bu_r"></span>
            </div>
        </a>
    </div>

    <div class="rowwrapper">
        <a href="#" class="trow" onclick="bkdOpenBookingRecordRow(&#39;CX&#39;, &#39;160&#39;, &#39;10099364&#39;, &#39;86679&#39;, &#39;86677&#39;)">
            <div class="tcell cols">
                <div class="flight_status_null">Cancelled</div>
            </div>
            <div class="tcell colm">
                <div class="flight_general"></div>
            </div>
            <div class="tcell cols col15">
                <div class="flight_general cell_hs">CX909</div>
            </div>
            <div class="tcell cols col20">
                <div class="flight_general cell_hs">2021-08-02</div>
            </div>
            <div class="tcell cols col40">
                <div class="flight_location cell_hs">HKG <img src="./img/icon_gy_flight.png">TPE</div>
            </div>
            <div class="tcell cols col100">
                <div class="flight_general cell_hs">-</div>
            </div>
            <div class="tcell colr">
                <div class="flight_general">ADMIN</div>
            </div>
            <div class="tcell cols col40 colpl row2">
                <div class="flight_general cell_hs">2021-07-30 09:55</div>
            </div>

            <div class="tcell cols colp row_ar">
                <span class="link_bu_r"></span>
            </div>
        </a>
    </div>

    <div class="rowwrapper">
        <a href="#" class="trow" onclick="bkdOpenBookingRecordRow(&#39;CX&#39;, &#39;160&#39;, &#39;10099364&#39;, &#39;86678&#39;, &#39;86677&#39;)">
            <div class="tcell cols">
                <div class="flight_status_null">Cancelled</div>
            </div>
            <div class="tcell colm">
                <div class="flight_general"></div>
            </div>
            <div class="tcell cols col15">
                <div class="flight_general cell_hs">CX909</div>
            </div>
            <div class="tcell cols col20">
                <div class="flight_general cell_hs">2021-08-02</div>
            </div>
            <div class="tcell cols col40">
                <div class="flight_location cell_hs">HKG <img src="./img/icon_gy_flight.png">TPE</div>
            </div>
            <div class="tcell cols col100">
                <div class="flight_general cell_hs">-</div>
            </div>
            <div class="tcell colr">
                <div class="flight_general">ADMIN</div>
            </div>
            <div class="tcell cols col40 colpl row2">
                <div class="flight_general cell_hs">2021-07-30 09:55</div>
            </div>

            <div class="tcell cols colp row_ar">
                <span class="link_bu_r"></span>
            </div>
        </a>
    </div>

    <div class="rowwrapper">
        <a href="#" class="trow" onclick="bkdOpenBookingRecordRow(&#39;CX&#39;, &#39;160&#39;, &#39;10099364&#39;, &#39;86676&#39;, &#39;86675&#39;)">
            <div class="tcell cols">
                <div class="flight_status error"><span><b>Error</b></span></div>
            </div>
            <div class="tcell colm">
                <div class="flight_general"></div>
            </div>
            <div class="tcell cols col15">
                <div class="flight_general cell_hs">CX909</div>
            </div>
            <div class="tcell cols col20">
                <div class="flight_general cell_hs">2021-08-02</div>
            </div>
            <div class="tcell cols col40">
                <div class="flight_location cell_hs">HKG <img src="./img/icon_gy_flight.png">TPE</div>
            </div>
            <div class="tcell cols col100">
                <div class="flight_general cell_hs">-</div>
            </div>
            <div class="tcell colr">
                <div class="flight_general">ADMIN</div>
            </div>
            <div class="tcell cols col40 colpl row2">
                <div class="flight_general cell_hs">2021-07-30 09:48</div>
            </div>

            <div class="tcell cols colp row_ar">
                <span class="link_bu_r"></span>
            </div>
        </a>
    </div>

    <div class="rowwrapper">
        <a href="#" class="trow" onclick="bkdOpenBookingRecordRow(&#39;CX&#39;, &#39;160&#39;, &#39;10099364&#39;, &#39;86672&#39;, &#39;86671&#39;)">
            <div class="tcell cols">
                <div class="flight_status_null">Confirmed</div>
            </div>
            <div class="tcell colm">
                <div class="flight_general"></div>
            </div>
            <div class="tcell cols col15">
                <div class="flight_general cell_hs">CX909</div>
            </div>
            <div class="tcell cols col20">
                <div class="flight_general cell_hs">2021-08-02</div>
            </div>
            <div class="tcell cols col40">
                <div class="flight_location cell_hs">HKG <img src="./img/icon_gy_flight.png">TPE</div>
            </div>
            <div class="tcell cols col100">
                <div class="flight_general cell_hs">-</div>
            </div>
            <div class="tcell colr">
                <div class="flight_general">ADMIN</div>
            </div>
            <div class="tcell cols col40 colpl row2">
                <div class="flight_general cell_hs">2021-07-29 16:32</div>
            </div>

            <div class="tcell cols colp row_ar">
                <span class="link_bu_r"></span>
            </div>
        </a>
    </div>

    <div class="rowwrapper">
        <a href="#" class="trow" onclick="bkdOpenBookingRecordRow(&#39;CX&#39;, &#39;160&#39;, &#39;10099364&#39;, &#39;86670&#39;, &#39;86669&#39;)">
            <div class="tcell cols">
                <div class="flight_status_null">Acknowledged</div>
            </div>
            <div class="tcell colm">
                <div class="flight_general"></div>
            </div>
            <div class="tcell cols col15">
                <div class="flight_general cell_hs">CX909</div>
            </div>
            <div class="tcell cols col20">
                <div class="flight_general cell_hs">2021-08-02</div>
            </div>
            <div class="tcell cols col40">
                <div class="flight_location cell_hs">HKG <img src="./img/icon_gy_flight.png">TPE</div>
            </div>
            <div class="tcell cols col100">
                <div class="flight_general cell_hs">-</div>
            </div>
            <div class="tcell colr">
                <div class="flight_general">ADMIN</div>
            </div>
            <div class="tcell cols col40 colpl row2">
                <div class="flight_general cell_hs">2021-07-29 16:26</div>
            </div>

            <div class="tcell cols colp row_ar">
                <span class="link_bu_r"></span>
            </div>
        </a>
    </div>

    <div class="rowwrapper">
        <a href="#" class="trow" onclick="bkdOpenBookingRecordRow(&#39;CX&#39;, &#39;160&#39;, &#39;10099364&#39;, &#39;86668&#39;, &#39;86667&#39;)">
            <div class="tcell cols">
                <div class="flight_status_null">Acknowledged</div>
            </div>
            <div class="tcell colm">
                <div class="flight_general"></div>
            </div>
            <div class="tcell cols col15">
                <div class="flight_general cell_hs">CX909</div>
            </div>
            <div class="tcell cols col20">
                <div class="flight_general cell_hs">2021-08-02</div>
            </div>
            <div class="tcell cols col40">
                <div class="flight_location cell_hs">HKG <img src="./img/icon_gy_flight.png">TPE</div>
            </div>
            <div class="tcell cols col100">
                <div class="flight_general cell_hs">-</div>
            </div>
            <div class="tcell colr">
                <div class="flight_general">ADMIN</div>
            </div>
            <div class="tcell cols col40 colpl row2">
                <div class="flight_general cell_hs">2021-07-29 16:08</div>
            </div>

            <div class="tcell cols colp row_ar">
                <span class="link_bu_r"></span>
            </div>
        </a>
    </div>

    <div class="rowwrapper">
        <a href="#" class="trow" onclick="bkdOpenBookingRecordRow(&#39;CX&#39;, &#39;160&#39;, &#39;10099364&#39;, &#39;86666&#39;, &#39;86665&#39;)">
            <div class="tcell cols">
                <div class="flight_status_null">Acknowledged</div>
            </div>
            <div class="tcell colm">
                <div class="flight_general"></div>
            </div>
            <div class="tcell cols col15">
                <div class="flight_general cell_hs">CX909</div>
            </div>
            <div class="tcell cols col20">
                <div class="flight_general cell_hs">2021-08-02</div>
            </div>
            <div class="tcell cols col40">
                <div class="flight_location cell_hs">HKG <img src="./img/icon_gy_flight.png">TPE</div>
            </div>
            <div class="tcell cols col100">
                <div class="flight_general cell_hs">-</div>
            </div>
            <div class="tcell colr">
                <div class="flight_general">ADMIN</div>
            </div>
            <div class="tcell cols col40 colpl row2">
                <div class="flight_general cell_hs">2021-07-29 16:07</div>
            </div>

            <div class="tcell cols colp row_ar">
                <span class="link_bu_r"></span>
            </div>
        </a>
    </div>

    <div class="rowwrapper">
        <a href="#" class="trow" onclick="bkdOpenBookingRecordRow(&#39;CX&#39;, &#39;160&#39;, &#39;10099364&#39;, &#39;86664&#39;, &#39;86663&#39;)">
            <div class="tcell cols">
                <div class="flight_status_null">Acknowledged</div>
            </div>
            <div class="tcell colm">
                <div class="flight_general"></div>
            </div>
            <div class="tcell cols col15">
                <div class="flight_general cell_hs">CX909</div>
            </div>
            <div class="tcell cols col20">
                <div class="flight_general cell_hs">2021-08-02</div>
            </div>
            <div class="tcell cols col40">
                <div class="flight_location cell_hs">HKG <img src="./img/icon_gy_flight.png">TPE</div>
            </div>
            <div class="tcell cols col100">
                <div class="flight_general cell_hs">-</div>
            </div>
            <div class="tcell colr">
                <div class="flight_general">ADMIN</div>
            </div>
            <div class="tcell cols col40 colpl row2">
                <div class="flight_general cell_hs">2021-07-29 16:01</div>
            </div>

            <div class="tcell cols colp row_ar">
                <span class="link_bu_r"></span>
            </div>
        </a>
    </div>

    <div class="rowwrapper">
        <a href="#" class="trow" onclick="bkdOpenBookingRecordRow(&#39;CX&#39;, &#39;160&#39;, &#39;10099364&#39;, &#39;86620&#39;, &#39;86619&#39;)">
            <div class="tcell cols">
                <div class="flight_status_null">Acknowledged</div>
            </div>
            <div class="tcell colm">
                <div class="flight_general"></div>
            </div>
            <div class="tcell cols col15">
                <div class="flight_general cell_hs">CX564</div>
            </div>
            <div class="tcell cols col20">
                <div class="flight_general cell_hs">2021-07-30</div>
            </div>
            <div class="tcell cols col40">
                <div class="flight_location cell_hs">HKG <img src="./img/icon_gy_flight.png">TPE</div>
            </div>
            <div class="tcell cols col100">
                <div class="flight_general cell_hs">-</div>
            </div>
            <div class="tcell colr">
                <div class="flight_general">ADMIN</div>
            </div>
            <div class="tcell cols col40 colpl row2">
                <div class="flight_general cell_hs">2021-07-28 09:27</div>
            </div>

            <div class="tcell cols colp row_ar">
                <span class="link_bu_r"></span>
            </div>
        </a>
    </div>
</div>
                                </div>
                                <div id="booking_detail_records_loading" class="loading-main disabled" style="margin-top: 65px;">
                                    <span id="loading_message" data-i18n="common.Loading">Loading</span>
                                </div>
                            </div>
                        </div> <!-- outer wbg -->
                    </li>
                </ul>
            </div>
        </div>


        <div class="bottom-panel">
            <div class="blk_malign">
                <a class="act_bu act_cancel" onclick="return discardChanges(event);" data-i18n="cargoInfo.DiscardChanges">Discard changes</a>
                <a href="javascript:void(0)" class="btn_or_l" id="btn_submit" style="" onclick="return false;" data-i18n="common.Submit">Submit</a>
                <div class="lbl_date" style="display: none"><b data-i18n="cargoInfo.LastSaved">Last saved:</b> Today 11:30</div>
            </div>
        </div>
    </div>
</div>

<div id="bkd_booking_detail_result" class="jumbotron" style="margin-top: 150px; display: none; min-height: calc(100% - 344px)">
    <input id="bkd_result_airline" type="hidden" value="">
    <input id="bkd_result_awbprefix" type="hidden" value="">
    <input id="bkd_result_awbsuffix" type="hidden" value="">
    <div class="wbg">
        <div class="container wbg">
            <div id="bkd_reply_status_icon" class="blk_success">
                <div class="blk_msg"><h2 id="bkd_message"></h2><p id="bkd_sub_message" style="display: none">Booking Created: 18 Nov 16:33</p></div>
                <div class="blkc"></div>
            </div>
            <div class="blk_gy_line just_created">
                <div class="blk_cnt">
                    <div class="lbl_bookno"><span id="bkd_awb_number">$AWB$</span><span class="act_save"></span></div>
                    <div class="blksent_grp"><div class="lbl_value" id="bkd_orig">$ORIG$</div><div class="flight_to"></div><div class="lbl_value mr40" id="bkd_dest">$DEST$</div></div>
                    <div class="blksent_grp"><div class="lbl_value mr40"><span id="bkd_pcs">176</span><span data-i18n="cargoInfo.pcs">pcs</span></div><div class="lbl_value"><span id="bkd_weight">$WEIGHT$</span><span data-i18n="cargoInfo.kg">kg</span></div></div>
                </div>
                <div class="blk_bcnt">
                    <div class="lbl_value created_status" id="bkd_detail_message">$MESSAGE$</div><div class="lbl_remarks" id="bkd_detail_message_time">$TIME$</div>
					<div class="mark_booked">
						<a href="javascript: void(0)" onclick="javascript: bkdGoToBookingDetail(event);" data-i18n="cargoInfo.BookingDetails">Booking Details</a>
					</div>
					<div class="mark_booked flex-container margin-right">
						<a href="javascript: void(0)" onclick="javascript: goToAmendSingleBooking()" data-i18n="cargoInfo.Amend">Amend</a>
					</div>		
                    <div class="blkc"></div>
                </div>
            </div>
            <div class="blk_btm_success"><a href="javascript: void(0)" class="link_bu_r" onclick="javascript: bkdGoToBookingLog(event);" data-i18n="cargoInfo.AllBookingLogs">All booking logs</a></div>
        </div>
    </div>
</div>

<style>
    .lity-container {
        /*left: -25%;*/
    }

        .lity-container > #bkd_tran_record_loading {
            /*left: 25%;*/
        }
</style>

<div id="bkd_tran_record" class="lity-hide booking_lb">
</div>

<script id="bkd_tran_record_template" type="type/x-template">
    <div id="bkd_tran_record_loading" class="loading-main" style="display: block; background-color: white; padding: 100px;">
        <span id="tran_loading_message" data-i18n="common.Loading">Loading</span>
    </div>
    <div id="bkd_tran_record_lightbox" class=" disabled" style="opacity: 1">
        <div class="lightbox_ctr" id="print_object">
            <div class="close_ctr"><a href="javascript: void(0)" class="close_btn" onclick="bkdCloseBookingRecordRow(event)"></a></div>
            <div class="lightbox_blk">
                <div class="blk_filter">
                    <div class="blkl">
                        <div class="b_flight_num">$AWB$</div>
                        <div class="cnt" style="float: right; padding-top: 8px;">
                            <div class="b_flight_piece">$AIRLINE$</div><div class="b_flight_location">$ORIG$<img src="/img/icon_gy_flight.png">$DEST$</div>
                        </div>
                    </div>
                    <div class="blkr"><a href="javascript:void(0)" class="btn_img_print" onclick="printDetailDiv('bkd_tran_record');"></a></div>
                    <div class="blkc"></div>
                    <div>
                        <div id="inTab2" class="inner_tab">
                            <ul class="nav nav-pills">
                                <li class="active">
                                    <a href="#1a" data-toggle="tab" aria-expanded="true" id="bkd_title_reply0">$TAB1NAME$</a>
                                </li>
                                <li class="$SHOWTAB2$">
                                    <a href="#1b" data-toggle="tab" aria-expanded="false" id="bkd_title_reply1">$TAB2NAME$</a>
                                </li>
                            </ul>
                            <div class="tab-content clearfix">
                                <div class="tab-pane active" id="1a">
                                    <div style="padding-top: 24px;"></div>
                                    <div class="bkdTab1Error $TAB1ERROR$" style="padding-bottom: 12px">
                                        <p class="txt12">The Booking contains the following error(s).</p>
                                        <div style="color: red">$ERRORMSG$</div>
                                    </div>
                                    <h3 data-i18n="cargoInfo.CargoInfo">Cargo Information</h3>
                                    <div class="blkr gy_remark">$USERID$ <span data-i18n="createBooking.ReceivedTime">Received time:</span> $TIME$</div>
                                    <div class="head_hr"></div>
                                    <div class="consign_info m_table">
                                        <div class="cnt_inline bu_txt w48 mr55"><label data-i18n="cargoInfo.SH">Special Handling</label><div class="lbl_value">$SHC$&nbsp;</div></div>
                                        <div class="cnt_inline bu_txt mr55"><label data-i18n="flight.Description">Description</label><div class="lbl_value">$ITEMDESC$&nbsp;</div></div>
                                        <div class="cnt_inline bu_txt w175 mr55" id="d_priority" style="display: none;"><label data-i18n="cargoInfo.PriorityType">Priority Type</label><div class="lbl_value">$PRTYPE$&nbsp;</div></div>
                                        <div class="cnt_inline bu_txt w175 mr55" id="d_product" style="display: none;"><label data-i18n="cargoInfo.Product">Product</label><div class="lbl_value">$PDTYPE$&nbsp;</div></div>
                                        <div class="cnt_inline bu_txt w175 mr55" id="d_deal_code" style="display: none;"><label data-i18n="cargoInfo.DealCode">Deal Code</label><div class="lbl_value">$DEALCODE$&nbsp;</div></div>
                                    </div>
                                    <h3 data-i18n="flight.RoutingFlights">Routing &amp; Flights</h3>
                                    <div class="head_hr"></div>
                                    <div class="consign_info m_table bkd_detail_routing">
                                        <div class="$ROUTING_DISABLED$">
                                            <div class="cnt_inline bu_txt mr5"><div class="lbl_value">$ORIG$</div></div>
                                            $ROUTINGS$
                                        </div>
                                    </div>
                                    <ol id="bkd_detail_record_flights" class="routing_flights">
                                        $FLIGHTS$
                                    </ol>
                                </div>
                                <div class="tab-pane" id="1b">
                                    <div style="padding-top: 24px;"></div>
                                    <h3 data-i18n="cargoInfo.CargoInfo">Cargo Information</h3>
                                    <div class="blkr gy_remark">$USERID2$ <span data-i18n="createBooking.ReceivedTime">Received time:</span> $TIME2$</div>
                                    <div class="head_hr"></div>
                                    <div class="consign_info m_table">
                                        <div class="cnt_inline bu_txt w48 mr55"><label data-i18n="cargoInfo.SH">Special Handling</label><div class="lbl_value">$SHC2$&nbsp;</div></div>
                                        <div class="cnt_inline bu_txt mr55"><label data-i18n="flight.Description">Description</label><div class="lbl_value">$ITEMDESC2$&nbsp;</div></div>
                                        <div class="cnt_inline bu_txt w175 mr55" id="d_priority_2" style="display: none;"><label data-i18n="cargoInfo.PriorityType">Priority Type</label><div class="lbl_value">$PRTYPE2$&nbsp;</div></div>
                                        <div class="cnt_inline bu_txt w175 mr55" id="d_product_2" style="display: none;"><label data-i18n="cargoInfo.Product">Product</label><div class="lbl_value">$PDTYPE2$&nbsp;</div></div>
                                    </div>
                                    <h3 data-i18n="flight.RoutingFlights">Routing &amp; Flights</h3>
                                    <div class="head_hr"></div>
                                    <div class="consign_info m_table bkd_detail_routing">
                                        <div class="$ROUTING_DISABLED$">
                                            <div class="cnt_inline bu_txt mr5"><div class="lbl_value">$ORIG2$</div></div>
                                            $ROUTINGS2$
                                        </div>
                                    </div>
                                    <ol id="bkd_detail_record_flights" class="routing_flights">
                                        $FLIGHTS2$
                                    </ol>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</script>

<style>
    .lightbox_ctr .inner_tab ul.nav.nav-pills {
        margin: 15px 0 0 0;
        border-bottom: 1px solid #CCC
    }

    .lightbox_ctr .inner_tab .nav-pills > li {
        border: 0;
        border-radius: 0;
        margin-left: -4px;
    }

    .lightbox_ctr .inner_tab .nav-pills > li > a {
        font-size: 12px;
        font-weight: normal;
        color: #136ABF;
        margin: 0;
        padding: 1em 2.8em 0 2.8em;
        height: 40px;
        border: none;
        border-bottom: 2px solid #FFFFFF;
        border-radius: 0;
        background: #FFFFFF;
    }

    .lightbox_ctr .inner_tab .nav-pills > li.active > a, .lightbox .inner_tab .nav-pills > li.active > a:hover, .lightbox .inner_tab .nav-pills > li.active > a:focus {
        font-size: 12px;
        font-weight: bold;
        color: #136ABF;
        margin: 0;
        padding: 1em 2.8em 0 2.8em;
        height: 40px;
        border: 0;
        border-bottom: 2px solid #4a9419;
        border-radius: 0;
        background: #FFFFFF;
    }

    #bkd_detail_record_flights_no {
        display: block;
        font-weight: bold;
        padding-top: 10px;
    }

    #bkd_detail_record_flights_no_icon {
        padding-top: 0px;
        height: 19px;
    }

    #bkd_tran_record_lightbox .lightbox_ctr {
        width: 800px !important;
    }

</style>

<script type="text/x-template" id="bkd_tran_detail_routing_template">
    <div class="cnt_inline chk_to"></div>
    <div class="cnt_inline bu_txt mr5"><div class="lbl_value">$PORT$/$AIRLINE$</div></div>
</script>

<script type="text/x-template" id="bkd_tran_detail_flight_template">
    <li>
        <div class="cola"><span id="bkd_detail_record_flights_no">$FLIGHTNUM$</span><span>$ORIG$</span><div id="bkd_detail_record_flights_no_icon" class="cnt_inline chk_to"></div><span>$DEST$</span></div>
        <div class="colb"><label data-i18n="flight.Departure">Departure</label><span>$DEPTIME$&nbsp;</span></div>
        <div class="colb"><label data-i18n="flight.Arrival">Arrival</label><span>$ARRTIME$&nbsp;</span></div>
        <div class="cola"><span>$PIECES$</span></div>
        <div class="cola"><span>$WEIGHT$</span></div>
        <div class="cola"><span>$VOLUME$</span></div>
        <div class="colb"><label data-i18n="cargoInfo.AllotmentID">Allotment ID</label><span>$ALLOTID$&nbsp;</span></div>
        <div class="colb"><div class="$HASERROR$"><span></span>$STATUS$&nbsp;</div></div>
    </li>
</script>

<script id="booking_detail_record_header" type="text/x-template">
    <div class="trow theader">
        <div class="tcell colh" data-i18n="common.Status">
            Status
        </div>
        <div class="tcell colh" data-i18n="flight.Flights">
            Flight
        </div>
        <div class="tcell colh" data-i18n="cargoInfo.Depart">
            Depart
        </div>
        <div class="tcell colh" data-i18n="BookingDetails.Rounting">
            Rounting
        </div>
        <div class="tcell colh" data-i18n="cargoInfo.AllotmentID">
            Alloment ID
        </div>
        <div class="tcell colh" data-i18n="BookingLog.ActionBy">
            Action by
        </div>
        <div class="tcell colh" data-i18n="BookingLog.ActionTime">
            Action Time
        </div>
        <div class="tcell colh"></div>

    </div>
</script>
<script id="booking_detail_record_row" type="text/x-template">
    <div class="rowwrapper">
        <a href="#booking_details1" class="trow" onclick="bkdOpenBookingRecordRow('$AIRLINE$', '$AWBPREFIX$', '$AWBSUFFIX$', '$TRANID$', '$REFTRANID$')">
            <div class="tcell cols">
                <div class="$ERROR$">$STATUS$</div>
            </div>
            <div class="tcell colm">
                <div class="flight_general">$REPLYTYPE$</div>
            </div>
            <div class="tcell cols col15">
                <div class="flight_general cell_hs">$FLIGHTNUM$</div>
            </div>
            <div class="tcell cols col20">
                <div class="flight_general cell_hs">$FLIGHTDATE$</div>
            </div>
            <div class="tcell cols col40">
                <div class="flight_location cell_hs">$ORIG$ <img src="/img/icon_gy_flight.png">$DEST$</div>
            </div>
            <div class="tcell cols col100">
                <div class="flight_general cell_hs">-</div>
            </div>
            <div class="tcell colr">
                <div class="flight_general">$USERID$</div>
            </div>
            <div class="tcell cols col40 colpl row2">
                <div class="flight_general cell_hs">$UPDATEDT$</div>
            </div>

            <div class="tcell cols colp row_ar">
                <span class="link_bu_r"></span>
            </div>
        </a>
    </div>
</script>

<script>
	console.log("wayToRetrieveBookingLog", wayToRetrieveBookingLog);
	console.time("pageLoad");
	console.time("injectScripts");
    $.holdReady(true);
    Promise.all([
		ConfigManager.injectConfig(),
        loadMainScript(),
        InjectionManager.injectScripts(['fs.js', 'addressbook.js', 'msgCtrl.js', 'dimension_cal.js'])
    ]).then(function () {
		console.timeEnd("injectScripts");
		console.time("holdReady");
        $.holdReady(false);	
        $(function () {
			console.log("BASE_URL:", config.BASE_URL);
			console.timeEnd("holdReady");
			reloadBookingDetail();
            regContactElsOnEnter();
            RegDimensionCal();
        })
    })

    var defaultAirline = "CX";
    var lityInstance;
    var loadPrimaryAWBInfo = false;

    var goodReplyMessage = [
        "",
        "CONFIRMED",
        "SUBMITTED",
        "ARRANGED",
        "NN",
        "NA",
        "CA",
        "KK",
        "HK",
        "KL",
        "NS",
        "KC",
        "LA"
    ];

    var spaceAllocationCodeDict = [];
    spaceAllocationCodeDict["CA"] = "Booking against allotment";
    spaceAllocationCodeDict["NN"] = "Book not accept alternative";
    spaceAllocationCodeDict["NA"] = "Book accept alternative";
    spaceAllocationCodeDict["XX"] = "Cancel booking";
    spaceAllocationCodeDict["NL"] = "Booking for wait list";

    function regContactElsOnEnter() {
        if (typeof getAddressBookSrc === "function")
            assignElsOnEnterFunc($("#contact_addressbook_code_src"), getAddressBookSrc);

        if (typeof addtoAddressBook === "function") {
            assignElsOnEnterFunc($("#contact_addressbook_code_ins_shipper"), function () { addtoAddressBook(0) });
            assignElsOnEnterFunc($("#contact_addressbook_code_ins_consignee"), function () { addtoAddressBook(1) });
        }
    }

    function bkdTimeout() {
        bookingHub.client.error("Timeout");
        timeoutHandle = -1;
        showBookingErrorMsg("Get booking error", ["Connection timeout"]);
    }

    function getAWB(airline, awbPrefix, awbSuffix) {
		console.time("getAWB");
        resetScreenForLoading();
        clearBookingData();
        connectHub(function () {
            for (var i = 1; i <= 3; i++) {
                $("#tab" + i + " > .bkd_block").each(function (i, o) {
                    if ($._data(o, 'events') && $._data(o, 'events').clear != null)
                        $(o).triggerHandler("clear");
                });
            }
            startAction(true, i18next.t("common.Loading"), true);
            // bookingHub.server.getBooking(airline, awbPrefix, awbSuffix);
            bookingHub.server.getBookingHistorySummary(airline, awbPrefix, awbSuffix);
        });
    }

    function getAWBfromAPI(airline, awbPrefix, awbSuffix) {
		console.time("getAWBfromAPI");
        resetScreenForLoading();
        clearBookingData();
		
		var token = this.$cookies.get("ApiToken");
		var data = {
					"request": {
						"airline": airline,
						"awbPrefix": awbPrefix,
						"awbSuffix": awbSuffix
					},
                        "source": "EzyCargo"
				}; //create array of objects
        $.ajax({
            url: RetrieveBookingHistoryAPIURL + "getBookingHistorySummary",
            method: "POST",
			contentType:  "application/json; charset=utf-8",
			headers: {
				Authorization: "Bearer " + token
			},
			dataType: "json",
            data: JSON.stringify(data),
			beforeSend: function(){$("#main_loading").removeClass("disabled");}
        })
		.always(function() {$("#main_loading").addClass("disabled");})
		.fail(function(response){
			console.log("getAWBfromAPI Failed");
			console.log(response.statusText);
			// DialogManager.alert(i18next.t('common.Error'), 'Failed to Retreive Booking History Summary! (' + response.status + ' ' + response.statusText.toUpperCase() + ')');
			DialogManager.alert(i18next.t('common.System'), i18next.t('common.SessionTimeout'));
		})
		.done(function (response) {
			if(response.bookings === null) {
				// DialogManager.alert(i18next.t('common.Error'), 'Bookings cannot be null');
				console.log('Bookings cannot be null');
				DialogManager.alert(i18next.t('common.System'), i18next.t('common.SessionTimeout'));
			}
			if(response.HistoryBookingSummaryInfos === null) {
				// DialogManager.alert(i18next.t('common.Error'), 'HistoryBookingSummaryInfos cannot be null');
				console.log('HistoryBookingSummaryInfos cannot be null');
				DialogManager.alert(i18next.t('common.System'), i18next.t('common.SessionTimeout'));
			}
			if(response.TranBookingSummaryInfos === null) {
				// DialogManager.alert(i18next.t('common.Error'), 'TranBookingSummaryInfos cannot be null');
				console.log('TranBookingSummaryInfos cannot be null');
				DialogManager.alert(i18next.t('common.System'), i18next.t('common.SessionTimeout'));
			}
            for (var i = 1; i <= 3; i++) {
                $("#tab" + i + " > .bkd_block").each(function (i, o) {
                    if ($._data(o, 'events') && $._data(o, 'events').clear != null)
                        $(o).triggerHandler("clear");
                });
            }
            console.log("bookings", response.bookings);
            console.log("HistoryBookingSummaryInfos", response.HistoryBookingSummaryInfos);
            console.log("TranBookingSummaryInfos", response.TranBookingSummaryInfos);
			localStorage.setItem("currentAirline", response.bookings.Airline);
			loadBookingHistorySummary(response.HistoryBookingSummaryInfos);
            bkdDetailLoadBookingDataFromAPI(response.bookings, [response.TranBookingSummaryInfos], false);
			bkdDisplayBkdTranHistory(response.TranBookingSummaryInfos, response.bookings, null, null);
        });

    }

    var currentAirline;
    var currentAWBPrefix;
    var currentAWBSuffix;

    function getAWBHistorySummary() {
        connectHub(function () {

            $("#booking_detail_records").addClass("disabled")
            $("#booking_detail_records_loading").removeClass("disabled")
            bookingHub.server.getBookingHistorySummary(currentAirline, currentAWBPrefix, currentAWBSuffix);
        });
    }

    function getAirlineTemplate(airline) {
        hideBookingErrorMsg();
        connectHub(function () {
            startAction(true, "Switching Airline Profile", true);
            bookingHub.server.getAirlineTemplates(airline);
        });
    }

    function validateTab(e, tabID) {
        hideBookingErrorMsg();
        var isValid = true;

        for (var i = tabID - 1; i > 0; i = i - 1) {
            $("#tab" + i + "  .bkd_block").each(function (i, o) {
                if ($._data(o, 'events') && $._data(o, 'events').validate != null)
                    if (!$(o).triggerHandler("validate"))
                        isValid = false;
            });

            if (!isValid)
                break;
        }

        if (!isValid) {
            e.preventDefault();
            e.stopPropagation();
            console.log(i);

            $("#tab" + i + "btn").click();
            return false;
        }

        return isValid;
    }

    function prepareSubmitData() {
        var submitData = {};

        for (var i = 1; i <= 3; i++) {
            $("#tab" + i + "  .bkd_block").each(function (i, o) {
                if ($._data(o, 'events') && $._data(o, 'events').submit != null)
                    $.extend(submitData, $(o).triggerHandler("submit"));
            });
        }
        console.log(submitData);
        return submitData;
    }

	 function wayToSubmitForm(e) {
            console.time("submitForm");
            var currentAirline = localStorage.getItem("currentAirline");
            console.log("currentAirline:", currentAirline);
            console.log("wayToRetrieveBookingLog", wayToRetrieveBookingLog);
            if (wayToRetrieveBookingLog == 1) {
                if (_.find(Constant.cxTemplateAirlines, function (o) { return o == currentAirline; })) {

                    startAction(false, i18next.t("common.Submitting"), true);
                    setTimeout(function () { submitFormAPI(e) }, 1);
                } else {
                    submitForm(e);
                }
            } else {
                submitForm(e);
            }
        }
	
    function submitForm(e) {
        hideBookingErrorMsg();
        if (validateTab(e, 2)) {
            submitData = prepareSubmitData();

            connectHub(function () {
                startAction(false, i18next.t("common.Submitting"), true);
                bookingHub.server.submit(JSON.stringify(submitData));
            });
        }
    }
	
	function submitFormAPI(e) {
            console.log("start createAWBAPI");
            if (validateTab(e, 4)) {
                validateApiCheck(e, 4).then(function (isValid) {
                    if (isValid) {
                        submitData = prepareSubmitData();
                        console.log("submitData", submitData);
                        var d = {
                            "request": {
                                "submitData": submitData
                            },
                            "source": "EzyCargo"
                        }; //create array of objects
                        console.log(d);
                        var options = {};
                        options.url = SubmitAPIURL;
                        options.type = "POST";
                        options.contentType = "application/json; charset=utf-8";
                        options.dataType = "json";
                        options.data = JSON.stringify(d);
                        options.beforeSend = function (xhr, settings) {
                            xhr.setRequestHeader('Authorization', 'Bearer ' + getCookie('ApiToken'));
                        };
                        options.success = function (res) {
                            console.log(res);
                            if (res.Booking != null) {
                                bkd = res.Booking;
                                $("#bkd_result_airline").val(bkd.Airline);
                                $("#bkd_result_awbprefix").val(bkd.AwbPrefix);
                                $("#bkd_result_awbsuffix").val(bkd.AwbSuffix);
                                var message = "";
                                var isError = false;
                                var hasError = false;
                                if (res.Errors != null) {
                                    if (res.Errors.length > 0) {
                                        hasError = true;
                                    }
                                }
                                if (hasError) {
                                    console.log("res.Errors ",res.Errors);
                                    if (res.Errors.length > 0) {
                                        for (var i = 0; i < res.Errors.length; i++) {
                                            if (message != "") message += "<br />";
                                            message += res.Errors[i].ErrorCode + " - " + res.Errors[i].ErrorDescription;
                                        }
                                        console.log("message ", message);
                                        isError = true;
                                        //revision needed handling
                                        if (message.indexOf("CSP_WS_00039") > -1) {
                                            message += "<br />" + i18next.t("cargoInfo.RetrieveAWBMsg");
                                            message = message.replace('$AWB$', "<a id=\"reply_redirect\" href=\"javascript: void(0)\">" + i18next.t("menu.SingleBooking") + "</a>");
                                            console.log("message CSP_WS_00039", message);
                                        }
                                    }
                                }
                                else {
                                    console.log("bkd.Reply ", bkd.Reply);
                                    if (bkd.Reply != null && bkd.Reply.length > 0 && bkd.Reply[0].Ack2 != "") {
                                        message = bkd.Reply[0].Ack2;
                                        isError = true;
                                        console.log("bkd.Reply message ", message);
                                    }
                                    else {
                                        if (bkd.CxIsSpecified) {
                                            var cxGoodReply = true;
                                            var cxGoodMessage = "";
                                            if (typeof bkd.FlightDetail !== 'undefined' && bkd.FlightDetail != null) {
                                                for (var i = 0; i < bkd.FlightDetail.length; i++) {
                                                    if (bkd.FlightDetail[0].FlightDetailCxIsSpecified) {
                                                        if (goodReplyMessage.indexOf(bkd.FlightDetail[i].FlightDetailCx.FCTLStatusX.toUpperCase()) != -1 || goodReplyMessage.indexOf(bkd.FlightDetail[i].FlightDetailCx.FCTLStatus.toUpperCase()) != -1) {
                                                            if (bkd.FlightDetail[i].FlightDetailCx.FCTLStatusX != "") {
                                                                cxGoodMessage = bkd.FlightDetail[i].FlightDetailCx.FCTLStatusX;
                                                            }
                                                        }
                                                        else {
                                                            cxGoodReply = false;
                                                            message = bkd.FlightDetail[i].FlightDetailCx.FCTLStatusX;
                                                            break;
                                                        }
                                                    }
                                                    else {
                                                        if (!goodReplyMessage.indexOf(bkd.FlightDetail[i].SpaceAllocationCode) != -1) {
                                                            headerErrorMessage = spaceAllocationCodeDict[bkd.FlightDetail[i].SpaceAllocationCode];
                                                            headerDisplayError = true;
                                                        }
                                                    }
                                                }
                                                if (cxGoodReply) {
                                                    message = cxGoodMessage;
                                                }
                                            }
                                            if (typeof bkd.Cx !== 'undefined' && bkd.Cx != null) {
                                                if (typeof bkd.Cx.NgttInfo !== 'undefined' && bkd.Cx.NgttInfo != null) {
                                                    if (bkd.Cx.NgttInfo.ProductCode != '') {
                                                        message += '<br> Smart Track is subscribed, should you have any problem, please contact to CX local sales team';
                                                    }
                                                }
                                            }
                                        }
                                        else {
                                            message = "Booking Submitted";
                                        }
                                    }
                                }
                                if (isError) {
                                    $("#bkd_reply_status_icon").addClass("blk_error");
                                    $('#bkd_reply_status_icon #bkd_message').text(i18next.t("cargoInfo.ResubmitMsg"));
                                }
                                else {
                                    $("#bkd_reply_status_icon").removeClass("blk_error");
                                    $('#bkd_reply_status_icon #bkd_message').text(i18next.t("cargoInfo.BookingSubmitted"));
                                }
								
								$("#bkd_awb_number").html(bkd.AwbPrefix + "-" + bkd.AwbSuffix);
								$("#bkd_orig").html(bkd.Origin);
								$("#bkd_dest").html(bkd.Destination);
								$("#bkd_pcs").html(bkd.Pieces);
								$("#bkd_weight").html(bkd.Weight);
								$("#bkd_detail_message").html(message);
								$("#bkd_detail_message_time").html(new Date().ToString(DateTimeFormat.Full));

								$("#bkd_booking_detail_result").css("display", "block");
								$("#bkd_detail").css("display", "none");
								window.scrollTo(0, 0);

								$("#reply_redirect").click(function () {
									goToSingleBooking(bkd.Airline, bkd.AwbPrefix, bkd.AwbSuffix);
								});
                            }
                            refreshModuleTranslation();
                            console.log("end createAWBAPI");
                        };
                        options.error = function () {
                            console.log("Error while calling the Web API!");
                            stopAction();
                            DialogManager.alert(i18next.t('common.System'), i18next.t('common.SessionTimeout'));
                        };
                        $.ajax(options);
                    }
                    else {
                        autoScroll();
                        stopAction();
                    }
                });
            }
            else {
                autoScroll();
                stopAction();
            }

        }
		
	function validateApiCheck(e, tabID){
				var validatePromises = [] ;

				for (var i = tabID - 1; i > 0; i = i - 1) {
					//Server Side Validation
					$("#tab" + i + " > .bkd_block").each(function (blockIdx, o) {
						if ($._data(o, 'events') && $._data(o, 'events').apiValidate != null)
							validatePromises.push($(o).triggerHandler("apiValidate"));
					});
				}
				return Promise.all(validatePromises).then(function(p){
					if (p.every((function(x) { return x.isValid === true }))){
						return true;
					}
					else {
						e.preventDefault();
						e.stopPropagation();
						//Find the first tabID with validation error
						let tabNo = p.filter(function(x) { return x.isValid == false })[0].tabId;

						$("#tab" + tabNo + "btn").click();
						return false;
					}
				});
			}
			
    function submitCancel(e) {

        // var r = confirm(i18next.t("BookingDetails.ConfirmCancelAlert"));

        // if (r == false) {
            // return;
        // }

        hideBookingErrorMsg();
        if (validateTab(e, 2)) {
            submitData = prepareSubmitData();

            if (submitData != null && submitData["FlightSegmentInfo"] != null && submitData["FlightSegmentInfo"]["FlightSegment"] != null) {
                for (var i in submitData["FlightSegmentInfo"]["FlightSegment"]) {
                    submitData["FlightSegmentInfo"]["FlightSegment"][i].AllocationCode = "XX";
                }
            }

            connectHub(function () {
                startAction(false, i18next.t("common.Submitting"), true);
                bookingHub.server.submit(JSON.stringify(submitData));
            });
        }
    }
	
	function submitCancelAPI(e) {
		// var r = confirm(i18next.t("BookingDetails.ConfirmCancelAlert"));

        // if (r == false) {
            // return;
        // }

        hideBookingErrorMsg();
        if (validateTab(e, 2)) {
			validateApiCheck(e, 2).then(function (isValid) {
				if (isValid) {
					submitData = prepareSubmitData();

					if (submitData != null && submitData["FlightSegmentInfo"] != null && submitData["FlightSegmentInfo"]["FlightSegment"] != null) {
						for (var i in submitData["FlightSegmentInfo"]["FlightSegment"]) {
							submitData["FlightSegmentInfo"]["FlightSegment"][i].AllocationCode = "XX";
						}
					}
					console.log("submitData", submitData);
					var d = {
						"request": {
							"submitData": submitData
						},
						"source": "EzyCargo"
					}; //create array of objects
					console.log(d);
					var options = {};
					options.url = SubmitAPIURL;
					options.type = "POST";
					options.contentType = "application/json; charset=utf-8";
					options.dataType = "json";
					options.data = JSON.stringify(d);
					options.beforeSend = function (xhr, settings) {
						xhr.setRequestHeader('Authorization', 'Bearer ' + getCookie('ApiToken'));
					};
					options.success = function (res) {
						console.log(res);
						if (res.Booking != null) {
							bkd = res.Booking;
							$("#bkd_result_airline").val(bkd.Airline);
							$("#bkd_result_awbprefix").val(bkd.AwbPrefix);
							$("#bkd_result_awbsuffix").val(bkd.AwbSuffix);
							var message = "";
							var isError = false;
							var hasError = false;
							if (res.Errors != null) {
								if (res.Errors.length > 0) {
									hasError = true;
								}
							}
							if (hasError) {
								console.log("res.Errors ",res.Errors);
								if (res.Errors.length > 0) {
									for (var i = 0; i < res.Errors.length; i++) {
										if (message != "") message += "<br />";
										message += res.Errors[i].ErrorCode + " - " + res.Errors[i].ErrorDescription;
									}
									console.log("message ", message);
									isError = true;
									//revision needed handling
									if (message.indexOf("CSP_WS_00039") > -1) {
										message += "<br />" + i18next.t("cargoInfo.RetrieveAWBMsg");
										message = message.replace('$AWB$', "<a id=\"reply_redirect\" href=\"javascript: void(0)\">" + i18next.t("menu.SingleBooking") + "</a>");
										console.log("message CSP_WS_00039", message);
									}
								}
							}
							else {
								console.log("bkd.Reply ", bkd.Reply);
								if (bkd.Reply != null && bkd.Reply.length > 0 && bkd.Reply[0].Ack2 != "") {
									message = bkd.Reply[0].Ack2;
									isError = true;
									console.log("bkd.Reply message ", message);
								}
								else {
									if (bkd.CxIsSpecified) {
										var cxGoodReply = true;
										var cxGoodMessage = "";
										if (typeof bkd.FlightDetail !== 'undefined' && bkd.FlightDetail != null) {
											for (var i = 0; i < bkd.FlightDetail.length; i++) {
												if (bkd.FlightDetail[0].FlightDetailCxIsSpecified) {
													if (goodReplyMessage.indexOf(bkd.FlightDetail[i].FlightDetailCx.FCTLStatusX.toUpperCase()) != -1 || goodReplyMessage.indexOf(bkd.FlightDetail[i].FlightDetailCx.FCTLStatus.toUpperCase()) != -1) {
														if (bkd.FlightDetail[i].FlightDetailCx.FCTLStatusX != "") {
															cxGoodMessage = bkd.FlightDetail[i].FlightDetailCx.FCTLStatusX;
														}
													}
													else {
														cxGoodReply = false;
														message = bkd.FlightDetail[i].FlightDetailCx.FCTLStatusX;
														break;
													}
												}
												else {
													if (!goodReplyMessage.indexOf(bkd.FlightDetail[i].SpaceAllocationCode) != -1) {
														headerErrorMessage = spaceAllocationCodeDict[bkd.FlightDetail[i].SpaceAllocationCode];
														headerDisplayError = true;
													}
												}
											}
											if (cxGoodReply) {
												message = cxGoodMessage;
											}
										}
										if (typeof bkd.Cx !== 'undefined' && bkd.Cx != null) {
											if (typeof bkd.Cx.NgttInfo !== 'undefined' && bkd.Cx.NgttInfo != null) {
												if (bkd.Cx.NgttInfo.ProductCode != '') {
													message += '<br> Smart Track is subscribed, should you have any problem, please contact to CX local sales team';
												}
											}
										}
									}
									else {
										message = "Booking Submitted";
									}
								}
							}
							if (isError) {
								$("#bkd_reply_status_icon").addClass("blk_error");
								$('#bkd_reply_status_icon #bkd_message').text(i18next.t("cargoInfo.ResubmitMsg"));
							}
							else {
								$("#bkd_reply_status_icon").removeClass("blk_error");
								$('#bkd_reply_status_icon #bkd_message').text(i18next.t("cargoInfo.BookingSubmitted"));
							}
							
							$("#bkd_awb_number").html(bkd.AwbPrefix + "-" + bkd.AwbSuffix);
							$("#bkd_orig").html(bkd.Origin);
							$("#bkd_dest").html(bkd.Destination);
							$("#bkd_pcs").html(bkd.Pieces);
							$("#bkd_weight").html(bkd.Weight);
							$("#bkd_detail_message").html(message);
							$("#bkd_detail_message_time").html(new Date().ToString(DateTimeFormat.Full));

							$("#bkd_booking_detail_result").css("display", "block");
							$("#bkd_detail").css("display", "none");
							window.scrollTo(0, 0);

							$("#reply_redirect").click(function () {
								goToSingleBooking(bkd.Airline, bkd.AwbPrefix, bkd.AwbSuffix);
							});
						}
						refreshModuleTranslation();
						console.log("end createAWBAPI");
					};
					options.error = function () {
						console.log("Error while calling the Web API!");
						stopAction();
						DialogManager.alert(i18next.t('common.System'), i18next.t('common.SessionTimeout'));
					};
					$.ajax(options);
				}
				else {
					autoScroll();
					stopAction();
				}
			});
        }
		else {
			autoScroll();
			stopAction();
		}
	}
	
	function wayToSubmitCancel(e) {
		var r = confirm(i18next.t("BookingDetails.ConfirmCancelAlert"));

        if (r == false) {
            return;
        }
		console.time("submitCancel");
		var currentAirline = localStorage.getItem("currentAirline");
		console.log("currentAirline:", currentAirline);
		console.log("wayToRetrieveBookingLog", wayToRetrieveBookingLog);
		if (wayToRetrieveBookingLog == 1) {
			if (_.find(Constant.cxTemplateAirlines, function (o) { return o == currentAirline; })) {

				startAction(false, i18next.t("common.Submitting"), true);
				setTimeout(function () { submitCancelAPI(e) }, 1);
			} else {
				submitCancel(e);
			}
		} else {
			submitCancel(e);
		}
	}

    function submitDraftForm(e) {
        hideBookingErrorMsg();
        submitData = prepareSubmitData();

        connectHub(function () {
            startAction(false, i18next.t("common.Submitting"), true);
            bookingHub.server.submitDraft(JSON.stringify(submitData));
        });
    }

    function discardChanges(e) {
        e.preventDefault();
        //reloadBookingDetail();
		location.reload();
    }

    function toggleSubmitButton(tabID, doChangeTab) {
        hideBookingErrorMsg();
        if (!!!tabID) tabID = 1;

        switch (tabID) {
            case 1:
                //$('#btn_submit').css('display', 'inline-block');
                $('.bottom-panel').css('display', 'block');
                break;
            case 2:
                //$('#btn_submit').css('display', 'none');
                $('.bottom-panel').css('display', 'none');
                break;
        }
    }

    function toggleFastSubmit(allow) {
        hideBookingErrorMsg();
        if (allow) {
            toggleSubmitButton();
            $("li.dash_2 a").attr("disabled", "disabled");
            $("li.dash_3 a").attr("disabled", "disabled");
        }
        else {
            toggleSubmitButton(1);
            $("li.dash_2 a").removeAttr("disabled");
            $("li.dash_3 a").removeAttr("disabled");
        }
    }

    $("#tab1btn").onFirst('click', function (event) {
        return changeTab(1);
    });
    $("#tab2btn").onFirst('click', function (event) {
        return changeTab(2);
    });

    function changeTab(tabID, doChangeTab) {
        switch (tabID) {
            case 1:
                toggleSubmitButton(1);

                if (doChangeTab) {
                    $("li.dash_1 a").addClass("selected");
                    $("li.dash_2 a").removeClass("selected");
                    $("li[data-content='tab1']").addClass("selected");
                    $("li[data-content='tab2']").removeClass("selected");
                }
                break;
            case 2:
                if (!validateTab(event, 2)) return false;
                toggleSubmitButton(2);

                if (doChangeTab) {
                    $("li.dash_1 a").removeClass("selected");
                    $("li.dash_2 a").addClass("selected");
                    $("li[data-content='tab1']").removeClass("selected");
                    $("li[data-content='tab2']").addClass("selected");
                }
                break;
        }
        autoScroll();
        return true;
    }

    bookingHub.client.submitSuccess = function (bkd) {
        stopAction();

        //debugger;
        console.log(bkd);
        $("#bkd_awb_number").html(bkd.AwbPrefix + "-" + bkd.AwbSuffix);

        var isError = false;

        if (message != "") {
            isError = true;
        }
        else {
            if (bkd.Reply != null && bkd.Reply.length > 0 && bkd.Reply[0].Ack2 != "") {
                message = bkd.Reply[0].Ack2;
                isError = true;
            }
            else {
                if (bkd.CxIsSpecified) {
                    var cxGoodReply = true;
                    var cxGoodMessage = "";

                    if (typeof bkd.FlightDetail !== 'undefined' && bkd.FlightDetail != null) {
                        for (var i = 0; i < bkd.FlightDetail.length; i++) {
                            if (bkd.FlightDetail[0].FlightDetailCxIsSpecified) {
                                if (goodReplyMessage.indexOf(bkd.FlightDetail[i].FlightDetailCx.FCTLStatusX.toUpperCase()) != -1 || goodReplyMessage.indexOf(bkd.FlightDetail[i].FlightDetailCx.FCTLStatus.toUpperCase()) != -1) {
                                    if (bkd.FlightDetail[i].FlightDetailCx.FCTLStatusX != "") {
                                        cxGoodMessage = bkd.FlightDetail[i].FlightDetailCx.FCTLStatusX;
                                    }
                                }
                                else {
                                    cxGoodReply = false;
                                    message = bkd.FlightDetail[i].FlightDetailCx.FCTLStatusX;
                                    break;
                                }
                            }
                            else {
                                if (!goodReplyMessage.indexOf(bkd.FlightDetail[i].SpaceAllocationCode) != -1) {
                                    headerErrorMessage = spaceAllocationCodeDict[bkd.FlightDetail[i].SpaceAllocationCode];
                                    headerDisplayError = true;
                                }
                            }
                        }

                        if (cxGoodReply) {
                            message = cxGoodMessage;
                        }
                    }
                }
                else {
                    message = "Booking Submitted";
                }
            }
        }


        if (isError) {
            $("#bkd_reply_status_icon").addClass("blk_error");
            $('#bkd_reply_status_icon #bkd_message').text(i18next.t("cargoInfo.ResubmitMsg"));
        }
        else {
            $("#bkd_reply_status_icon").removeClass("blk_error");
            $('#bkd_reply_status_icon #bkd_message').text(i18next.t("cargoInfo.BookingSubmitted"));
        }

        $("#bkd_orig").html(bkd.Origin);
        $("#bkd_dest").html(bkd.Destination);
        $("#bkd_pcs").html(bkd.Pieces);
        $("#bkd_weight").html(bkd.Weight);
        $("#bkd_detail_message").html(message);
        $("#bkd_detail_message_time").html(new Date().ToString(DateTimeFormat.Full));

        $("#bkd_single_booking_result").css("display", "block");
        $("#bkd_single_booking").css("display", "none");

        stopAction();

        refreshModuleTranslation();
    }

    bookingHub.client.error = function (msg) {
        switch (msg) {
            case "ERR_BKDNOTFOUND":
                msg = "Booking Not Found";
                break;
        }

        displayError(msg.split("\n"));
        stopAction();

        refreshModuleTranslation();
    }

    bookingHub.client.renderTabs = function (tabs) {
        console.log("Received Tabs HTMLs");
        //debugger;

        var submitData = prepareSubmitData();

        $("#tab1").html("");
        $("#tab2").html("");

        var tab1Html = ""
        for (var i = 0; i < tabs.Tab1.length; i++) {
            tab1Html += tabs.Tab1[i];
        }

        $("#tab1").html(tab1Html);

        var tab2Html = ""
        for (var i = 0; i < tabs.Tab2.length; i++) {
            tab2Html += tabs.Tab2[i];
        }

        $("#tab2").html(tab2Html);

        for (var i = 1; i <= 2; i++) {
            $("#tab" + i + "  .bkd_block").each(function (i, o) {
                //console.log($._data(o, 'events'));
                if ($._data(o, 'events') && $._data(o, 'events').init != null)
                    $(o).triggerHandler("init", submitData);
            });
        }

        stopAction();

        refreshModuleTranslation();
    }

    function bkdDetailLoadBookingDataFromAPI (bkd, tran, isNew) {
        console.log("Received Booking Data From Server");

        if (isNew) {
            console.log("New booking")
            displayError(["Air WayBill not found in system"])
            return;
        }
		for (var i = 0; i < bkd.FlightDetail.length; i++) {
			bkd.FlightDetail[i].ArrivalDate =  getDateFromDateString(bkd.FlightDetail[i].ArrivalDate);
			bkd.FlightDetail[i].DepartureDate =  getDateFromDateString(bkd.FlightDetail[i].DepartureDate);
			
		}
        console.log(bkd);

        //Issue #27684, Temp fix for csp reply - consignee and shipper addr "null" value
        if (bkd.Consignee && bkd.Consignee.StreetAdd)
            bkd.Consignee.StreetAdd = HandleContactAddrNullVal(bkd.Consignee.StreetAdd);
        if (bkd.Shipper && bkd.Shipper.StreetAdd)
            bkd.Shipper.StreetAdd = HandleContactAddrNullVal(bkd.Shipper.StreetAdd);

        loadBookingData(bkd, tran);

        for (var i = 1; i <= 3; i++) {
            $("#tab" + i + "  .bkd_block").each(function (i, o) {
                // console.log(o);
                // console.log($._data(o, 'events'));
                // console.log($._data(o, 'events').loadBookingData);
                if ($._data(o, 'events') && $._data(o, 'events').loadBookingData != null)
                    $(o).triggerHandler("loadBookingData", bkd);
            });
        }

        $("#bkd_detail").removeClass("disabled")
        $("#bkd_detail_error").addClass("disabled")
		console.timeEnd("getAWBfromAPI");
		console.timeEnd("pageLoad");
        refreshModuleTranslation();
    }

    function bkdDetailLoadBookingData (bkd, tran, isNew) {
        console.log("Received Booking Data From Server");

        if (isNew) {
            console.log("New booking")
            displayError(["Air WayBill not found in system"])
            return;
        }

        console.log(bkd);

        //Issue #27684, Temp fix for csp reply - consignee and shipper addr "null" value
        if (bkd.Consignee && bkd.Consignee.StreetAdd)
            bkd.Consignee.StreetAdd = HandleContactAddrNullVal(bkd.Consignee.StreetAdd);
        if (bkd.Shipper && bkd.Shipper.StreetAdd)
            bkd.Shipper.StreetAdd = HandleContactAddrNullVal(bkd.Shipper.StreetAdd);

        loadBookingData(bkd, tran);

        for (var i = 1; i <= 3; i++) {
            $("#tab" + i + "  .bkd_block").each(function (i, o) {
                // console.log(o);
                // console.log($._data(o, 'events'));
                // console.log($._data(o, 'events').loadBookingData);
                if ($._data(o, 'events') && $._data(o, 'events').loadBookingData != null)
                    $(o).triggerHandler("loadBookingData", bkd);
            });
        }
		$("#main_loading").addClass("disabled");
        stopAction();
        $("#bkd_detail").removeClass("disabled")
        $("#bkd_detail_error").addClass("disabled")
		console.timeEnd("getAWB");
		console.timeEnd("pageLoad");
        refreshModuleTranslation();
    }
	
	function loadBookingHistorySummary(bkds) {
		console.log("Received Booking History From Server");
        console.log(bkds);
        var header = $("#booking_detail_record_header").html();
        var row_template = $("#booking_detail_record_row").html();

        var html = header;

        var handled_refTranID = [];

        var recCnt = 0;

        for (var i = 0; i < bkds.length; i++) {
            var bkd = bkds[i];

            // if (i == 0) {
                // var airline = bkd.Airline;
                // var awbPrefix = bkd.AwbPrefix;
                // var awbSuffix = bkd.AwbSuffix;
                // var tranID = bkd.TransactionId;
                // setTimeout(function () {
                    // connectHub(function () {
                        // bookingHub.server.getBookingTranRecord(airline, awbPrefix, awbSuffix, tranID, 0);
                    // });
                // }, 0);
            // }

            var error = "flight_status_null";

            var status = bkdStatusToText(bkd.BookingStatus);

            status.StatusText = i18next.t("common." + status.StatusText.replace(/\s/g, ''));

            if (status.Error) {
                error = "flight_status error";
                status.StatusText = "<span><b>" + status.StatusText + "</b></span>"
            }

            var refTranID = bkd.RefTransactionId;

            if (handled_refTranID.indexOf(bkd.TransactionId) != -1) {
                continue;
            }

			var actionBy = bkd.ActionUserId;

            if (refTranID != 0) {
                handled_refTranID.push(refTranID);

				// Get Corressponding Ref Action By Value
				for (var j = 0; j < bkds.length; j++) {
					if (bkds[j].TransactionId == refTranID) {
						actionBy = bkds[j].ActionUserId;
						break;
					}
				}
            }

            recCnt++
			
			console.log("loadBookingHistorySummary_bkds", bkds);
			console.log("loadBookingHistorySummary_UpdateTime", bkd.UpdateTime);
						
            html += row_template
                .replace("$STATUS$", status.StatusText)
                .replace("$ERROR$", error)
                .replace("$REPLYTYPE$", "")
                //.replace("$FLIGHTDATE$", getAPIDate(bkd.DepartureDate).ToString(DateTimeFormat.YearMonthDate))
                .replace("$FLIGHTNUM$", bkd.CarrierCode.toUpperCase() + bkd.FlightNum)
                .replace("$ORIG$", bkd.Origin.toUpperCase())
                .replace("$DEST$", bkd.Destination.toUpperCase())
                .replace("$ALLOTMENTID$", bkd.AllotmentId)
                .replace("$USERID$", actionBy)
                .replace("$UPDATEDT$", GetLocalTimeFromServerTS(bkd.UpdateTime).ToString(DateTimeFormat.FullWithoutSecond))
                .replace("$TRANID$", bkd.TransactionId)
                .replace("$REFTRANID$", bkd.RefTransactionId)
                .replace("$AIRLINE$", bkd.Airline.toUpperCase())
                .replace("$AWBPREFIX$", bkd.AwbPrefix)
                .replace("$AWBSUFFIX$", bkd.AwbSuffix);

            if (typeof bkd.DepartureDate !== 'undefined' && bkd.DepartureDate != null) {
                html = html.replace("$FLIGHTDATE$", getAPIDate(bkd.DepartureDate).ToString(DateTimeFormat.YearMonthDate))
            }

        }

        if (bkds.length > 0) {
            currentAirline = bkds[0].Airline;
            currentAWBPrefix = bkds[0].AwbPrefix;
            currentAWBSuffix = bkds[0].AwbSuffix;
        }

        //debugger;
        //stopAction();

        $("#booking_detail_records_count").html(recCnt);
        $("#booking_detail_records_time").html(new Date().ToString(DateTimeFormat.DateMonthTime));
        $("#booking_detail_records_table").html(html);
        $("#booking_detail_records").removeClass("disabled");
        $("#booking_detail_records_loading").addClass("disabled");

        refreshModuleTranslation();
	}

    bookingHub.client.loadBookingHistorySummary = function (bkds) {
        console.log("Received Booking History From Server");
        console.log(bkds);
        var header = $("#booking_detail_record_header").html();
        var row_template = $("#booking_detail_record_row").html();

        var html = header;

        var handled_refTranID = [];

        var recCnt = 0;

        for (var i = 0; i < bkds.length; i++) {
            var bkd = bkds[i];

            if (i == 0) {
                var airline = bkd.Airline;
                var awbPrefix = bkd.AwbPrefix;
                var awbSuffix = bkd.AwbSuffix;
                var tranID = bkd.TransactionId;
                setTimeout(function () {
                    connectHub(function () {
                        bookingHub.server.getBookingTranRecord(airline, awbPrefix, awbSuffix, tranID, 0);
                    });
                }, 0);
            }

            var error = "flight_status_null";

            var status = bkdStatusToText(bkd.BookingStatus);

            status.StatusText = i18next.t("common." + status.StatusText.replace(/\s/g, ''));

            if (status.Error) {
                error = "flight_status error";
                status.StatusText = "<span><b>" + status.StatusText + "</b></span>"
            }

            var refTranID = bkd.RefTransactionId;

            if (handled_refTranID.indexOf(bkd.TransactionId) != -1) {
                continue;
            }

			var actionBy = bkd.ActionUserId;

            if (refTranID != 0) {
                handled_refTranID.push(refTranID);

				// Get Corressponding Ref Action By Value
				for (var j = 0; j < bkds.length; j++) {
					if (bkds[j].TransactionId == refTranID) {
						actionBy = bkds[j].ActionUserId;
						break;
					}
				}
            }

            recCnt++

            html += row_template
                .replace("$STATUS$", status.StatusText)
                .replace("$ERROR$", error)
                .replace("$REPLYTYPE$", "")
                //.replace("$FLIGHTDATE$", getAPIDate(bkd.DepartureDate).ToString(DateTimeFormat.YearMonthDate))
                .replace("$FLIGHTNUM$", bkd.CarrierCode.toUpperCase() + bkd.FlightNum)
                .replace("$ORIG$", bkd.Origin.toUpperCase())
                .replace("$DEST$", bkd.Destination.toUpperCase())
                .replace("$ALLOTMENTID$", bkd.AllotmentId)
                .replace("$USERID$", actionBy)
                .replace("$UPDATEDT$", GetLocalTimeFromServerTS(bkd.UpdateTime).ToString(DateTimeFormat.FullWithoutSecond))
                .replace("$TRANID$", bkd.TransactionId)
                .replace("$REFTRANID$", bkd.RefTransactionId)
                .replace("$AIRLINE$", bkd.Airline.toUpperCase())
                .replace("$AWBPREFIX$", bkd.AwbPrefix)
                .replace("$AWBSUFFIX$", bkd.AwbSuffix);

            if (typeof bkd.DepartureDate !== 'undefined' && bkd.DepartureDate != null) {
                html = html.replace("$FLIGHTDATE$", getAPIDate(bkd.DepartureDate).ToString(DateTimeFormat.YearMonthDate))
            }

        }

        if (bkds.length > 0) {
            currentAirline = bkds[0].Airline;
            currentAWBPrefix = bkds[0].AwbPrefix;
            currentAWBSuffix = bkds[0].AwbSuffix;
        }

        //debugger;
        //stopAction();

        $("#booking_detail_records_count").html(recCnt);
        $("#booking_detail_records_time").html(new Date().ToString(DateTimeFormat.DateMonthTime));
        $("#booking_detail_records_table").html(html);
        $("#booking_detail_records").removeClass("disabled");
        $("#booking_detail_records_loading").addClass("disabled");

        refreshModuleTranslation();
    }

    bookingHub.client.submitReply = function (bkd, status, message) {
        stopAction();
        //debugger;
        console.log(bkd);

        $("#bkd_result_airline").val(bkd.Airline);
        $("#bkd_result_awbprefix").val(bkd.AwbPrefix);
        $("#bkd_result_awbsuffix").val(bkd.AwbSuffix);

        var isError = false;

        if (message != "") {
            isError = true;
            //revision needed handling
            if (message.indexOf("CSP_WS_00039") > -1) {
                message += "<br />" + i18next.t("cargoInfo.RetrieveAWBMsg");
                message = message.replace('$AWB$', "<a id=\"reply_redirect\" href=\"javascript: void(0)\">" + i18next.t("menu.SingleBooking") + "</a>");
            }
        }
        else {
            if (bkd.Reply != null && bkd.Reply.length > 0 && bkd.Reply[0].Ack2 != "") {
                message = bkd.Reply[0].Ack2;
                isError = true;
            }
            else {
                if (bkd.CxIsSpecified) {
                    var cxGoodReply = true;
                    var cxGoodMessage = "";

                    if (typeof bkd.FlightDetail !== 'undefined' && bkd.FlightDetail != null) {
                        for (var i = 0; i < bkd.FlightDetail.length; i++) {
                            if (bkd.FlightDetail[0].FlightDetailCxIsSpecified) {
                                if (goodReplyMessage.indexOf(bkd.FlightDetail[i].FlightDetailCx.FCTLStatusX.toUpperCase()) != -1 || goodReplyMessage.indexOf(bkd.FlightDetail[i].FlightDetailCx.FCTLStatus.toUpperCase()) != -1) {
                                    if (bkd.FlightDetail[i].FlightDetailCx.FCTLStatusX != "") {
                                        cxGoodMessage = bkd.FlightDetail[i].FlightDetailCx.FCTLStatusX;
                                    }
                                }
                                else {
                                    cxGoodReply = false;
                                    message = bkd.FlightDetail[i].FlightDetailCx.FCTLStatusX;
                                    break;
                                }
                            }
                            else {
                                if (!goodReplyMessage.indexOf(bkd.FlightDetail[i].SpaceAllocationCode) != -1) {
                                    headerErrorMessage = spaceAllocationCodeDict[bkd.FlightDetail[i].SpaceAllocationCode];
                                    headerDisplayError = true;
                                }
                            }
                        }

                        if (cxGoodReply) {
                            message = cxGoodMessage;
                        }
                    }

                    if (typeof bkd.Cx !== 'undefined' && bkd.Cx != null)
                        {
                            if (typeof bkd.Cx.NgttInfo !== 'undefined' && bkd.Cx.NgttInfo != null)
                            {
                                if (bkd.Cx.NgttInfo.ProductCode != '')
                                {
                                    message += '<br> Smart Track is subscribed, should you have any problem, please contact to CX local sales team';
                                }
                            }
                        }
                }
                else {
                    message = "Booking Submitted";
                }
            }
        }


        if (isError) {
            $("#bkd_reply_status_icon").addClass("blk_error");
            $('#bkd_reply_status_icon #bkd_message').text(i18next.t("cargoInfo.ResubmitMsg"));
        }
        else {
            $("#bkd_reply_status_icon").removeClass("blk_error");
            $('#bkd_reply_status_icon #bkd_message').text(i18next.t("cargoInfo.BookingSubmitted"));
        }

        $("#bkd_awb_number").html(bkd.AwbPrefix + "-" + bkd.AwbSuffix);
        $("#bkd_orig").html(bkd.Origin);
        $("#bkd_dest").html(bkd.Destination);
        $("#bkd_pcs").html(bkd.Pieces);
        $("#bkd_weight").html(bkd.Weight);
        $("#bkd_detail_message").html(message);
        $("#bkd_detail_message_time").html(new Date().ToString(DateTimeFormat.Full));

        $("#bkd_booking_detail_result").css("display", "block");
        $("#bkd_detail").css("display", "none");
        window.scrollTo(0, 0);

        $("#reply_redirect").click(function () {
            goToSingleBooking(bkd.Airline, bkd.AwbPrefix, bkd.AwbSuffix);
        });

        refreshModuleTranslation();
    }


    bookingHub.client.accepted = function (bkd) {
        stopAction();
        console.log(bkd);

        $("#bkd_result_airline").val(bkd.Airline);
        $("#bkd_result_awbprefix").val(bkd.AwbPrefix);
        $("#bkd_result_awbsuffix").val(bkd.AwbSuffix);

        $("#bkd_awb_number").html(bkd.AwbPrefix + "-" + bkd.AwbSuffix);
        $("#bkd_orig").html(bkd.Origin);
        $("#bkd_dest").html(bkd.Destination);
        $("#bkd_pcs").html(bkd.Pieces);
        $("#bkd_weight").html(bkd.Weight);
        $("#bkd_detail_message").html("Booking Submitted");
        $("#bkd_detail_message_time").html(new Date().ToString(DateTimeFormat.Full));

        $("#bkd_booking_detail_result").css("display", "block");
        $("#bkd_detail").css("display", "none");
        window.scrollTo(0, 0);

        refreshModuleTranslation();
    }

    /* error msg box */
    function hideBookingErrorMsg() {
        $("#errorWrapper").addClass("disabled");
        $("#errorWrapper .error-box .error-message").text("");
        $("#blk_errorLt li").remove();
    }

    function showBookingErrorMsg(msg, list) {
        $("#errorWrapper").removeClass("disabled");
        if (typeof msg !== 'undefined' && msg != null) {
            $("#errorWrapper .error-box .error-message").text(msg);
        }
        if (typeof list !== 'undefined' && list != null) {
            if (Array.isArray(list)) {
                for (var i = 0; i < list.length; i++) {
                    $("#blk_errorLt").append("<li>"+list[i]+"</li>");
                }
            }
        }
    }

    /* tag-input */
    var availableSHCTags = [];
    var availableSHCDesc = [];
    var showTempList = ["PES", "ACT"];
    /*
    var SHCodeOptionData = [];
    var SHCodeOptionData = JSON.parse(SHCodeOptionModel);
    for (i = 0; i < SHCodeOptionData.length; i++) {
        availableSHCTags.push(SHCodeOptionData[i]);
    }
    */

    function regSHCodeAutoComplete() {

        getSpecialHandlingCode();
        /*
        $(".SHCodeAC .autocomplete").autocomplete({
            source: availableSHCTags
        });
        */
    }

    (function ($, Sys) {

        localStorage.setItem("currentAirline", defaultAirline);
        localStorage.setItem("loadAWBno", "");
        var userCity = "HKG";
        localStorage.setItem("userCity", userCity.toUpperCase());
        // reloadBookingDetail();
        //hideBookingErrorMsg();

        refreshModuleTranslation();

    }(jQuery, window.Sys));
    /* end tag-input */

    function getComponentRowID(com) {
        var rowID = $("."+com).last().attr("data-rowid");
        console.log("getComponentRowID: " + rowID);
        return parseInt(rowID);
    }

    // prevent unexpected page reload when pressing enter key
    $(document).keypress(function(e) {
        if(e.which == 13) {
            e.preventDefault();
            console.log('You pressed enter!');
        }
    });

    //Get Special Handling Code
    function getSpecialHandlingCode() {
        connectHub(function () {
            //startAction(true);
            bookingHub.server.getSpecialHandlingCode();
        });
    }

    bookingHub.client.setSpecialHandling = function (shcList) {
        console.log("Received SHC");
        //debugger;
        console.log("shcList: " + shcList);

        availableSHCTags = shcList;
        $(".SHCodeAC .autocomplete").autocomplete({
            source: availableSHCTags,
            select: selectSHCFromAutoComplete
        });

        /*
        var shcListOpt = [];
        //shcListOpt = shcList.split(",");
        var obj;
        for (var i = 0; i < shcList.length; i++) {
            obj = new Object();
            obj.SHCCode = shcList[i];
            shcListOpt.push(obj);
            //console.log(shcList[i]);
        }

        //availableSHCTags = JSON.parse(data);


        for (var i = 1; i <= 3; i++) {
            $("#tab" + i + " > .bkd_block").each(function (i, o) {
                if ($._data(o, 'events') && $._data(o, 'events').setSHC != null)
                    //console.log("shcList2: " + shcList);
                    //console.log("shcList2: " + shcListOpt);
                    $(o).triggerHandler("setSHC", JSON.stringify(shcList));
            });
        }
        */
        //stopAction();
    }

    //Get port info
    function getPortCode(src, callback) {
        connectHub(function () {
            //startAction(true);
            bookingHub.server.getPortInfo(src).done(function (result) {
                console.log(result);
                callback(JSON.parse(result));
                //stopAction();
            });
        });
    }

    function getPortCodeV3(src, callback) {

        if (typeof sessionStorage.getItem("PortList") !== 'undefined' && sessionStorage.getItem("PortList") != null) {

            var arr = JSON.parse(sessionStorage.getItem("PortList"));
            callback(arr.sort(function(a, b){return b.value.indexOf(src) - a.value.indexOf(src) }));

        } else {
            callback([]);
        }
    }

    var portList = null;

    function getPortCodeV4(src, callback) {
        //debugger;

        if (portList == null) {
            portList = JSON.parse(sessionStorage.getItem("PortList"))
        }

        src = src.toUpperCase();

        var returnList = JSON.search(portList, "//*[data='" + src + "']");
        returnList = returnList.concat(JSON.search(portList, "//*[contains(value, '" + src + "')]").slice(0,99));
        returnList = removeDuplicates(returnList, "data");

        var o = { suggestions: returnList };

        callback(o);
    }

    function removeDuplicates(originalArray, prop) {
        var newArray = [];
        var lookupObject  = {};

        for(var i in originalArray) {
            if (isNaN(parseInt(i))) continue;
            lookupObject[originalArray[i][prop]] = originalArray[i];
        }

        for(i in lookupObject) {
            newArray.push(lookupObject[i]);
        }
        return newArray;
    }

    function regPortQuery() {

        $('.port_query').devbridgeAutocomplete({

            lookup: function (query, done) {
                // Do Ajax call or lookup locally, when done,
                // call the callback and pass your results:
                getPortCode(query, done);
            },
            preserveInput: true,
            deferRequestBy: 300,
            minChars: 2,
            autoSelectFirst: true,
            onSelect: function (response) {
                $(this).val(response.data);
                //alert('You selected: ' + response.value + ', ' + response.data);
            }
        });
    }

    function regPortQueryV2() {

        $('.port_query').devbridgeAutocomplete({

            lookup: function (query, done) {
                getPortCodeV4(query, done);
            }, //JSON.parse(sessionStorage.getItem("PortList")),
            preserveInput: true,
            deferRequestBy: 200,
            minChars: 2,
            autoSelectFirst: false,
            onSelect: function (response) {
                $(this).val(response.data);
                //alert('You selected: ' + response.value + ', ' + response.data);
            },
            lookupLimit: 10
        });
    }

    function regPortQueryV3() {

        $('.port_query').devbridgeAutocomplete({

            lookup: function (query, done) {
                // Do Ajax call or lookup locally, when done,
                // call the callback and pass your results:
                getPortCodeV3(query, done);
            },
            preserveInput: true,
            deferRequestBy: 300,
            minChars: 2,
            autoSelectFirst: true,
            onSelect: function (response) {
                $(this).val(response.data);
                //alert('You selected: ' + response.value + ', ' + response.data);
            }
        });
    }

    //set good desc dropdown box
    function setGoodsDescDropdownBox() {
        var arr = [];
        //getPriorityType(setPriorityTypeOption);
        if (typeof sessionStorage.getItem("GoodDescList") !== 'undefined' && sessionStorage.getItem("GoodDescList") != null) {
            arr = JSON.parse(sessionStorage.getItem("GoodDescList"));
            setGoodsDescTypeOption(arr);
        } else {
            getDefaultOptionalItem();
        }

    }

    //Get goods desc type info
    function getGoodsDescType(callback) {
        connectHub(function () {
            //startAction(true);
            bookingHub.server.getGoodsDescTypeList().done(function (result) {
                console.log(result);
                callback(JSON.parse(result));
                //stopAction();
            });
        });
    }

    function setGoodsDescTypeOption(arr) {

        if (typeof arr !== 'undefined' && arr != null){
            //$('select#cargoInfo_good_des').children('option:not(:first)').remove();
            $('select#cargoInfo_good_des').children().remove();
            for (var i = 0; i < arr.length; i++) {
                //console.log(arr[i].Value);
                //console.log(arr[i].Desc);
                $("select#cargoInfo_good_des").append( $("<option>")
                    .val(arr[i].Value)
                    .html(arr[i].Desc)
                );
            }
            $("select#cargoInfo_good_des").val("OTH");
            $("#cargoInfo_good_detail").show();
        }
    }

    //Get priority type info
    function getPriorityType(callback) {
        connectHub(function () {
            //startAction(true);
            bookingHub.server.getPriorityTypeList().done(function (result) {
                console.log(result);
                callback(JSON.parse(result));
                //stopAction();
            });
        });
    }

    function setPriorityTypeOption(arr) {

        if (typeof arr !== 'undefined' && arr != null){
            $('select#cargoInfo_priority').children('option:not(:first)').remove();

            for (var i = 0; i < arr.length; i++) {
                //console.log(arr[i].Value);
                //console.log(arr[i].Desc);
                $("select#cargoInfo_priority").append( $("<option>")
                    .val(arr[i])
                    .html(arr[i])
                );
            }
        }
    }
	
	function getDefaultOptionalItemAPI(callback) {
		console.log("start getDefaultOptionalItemAPI");
		console.time("getDefaultOptionalItemAPI");
		console.time("API:getDefaultOptionalItemAPI");
		var d = {

		}; //create array of objects
		var options = {};
		options.url = BookingAPIURL + "defaultOptions";
		options.type = "POST";
		options.contentType = "application/json; charset=utf-8";
		options.dataType = "json";
		options.data = JSON.stringify(d);
		options.beforeSend = function (xhr, settings) {
			xhr.setRequestHeader('Authorization', 'Bearer ' + getCookie('ApiToken'));
		};
		options.success = function (response) {
			console.log("getDefaultOptionalItemAPI response:", response);
			var obj = response.options;
			// console.log(JSON.stringify(obj));
			console.timeEnd("API:getDefaultOptionalItemAPI");
			// set special handling code
			if (typeof sessionStorage.getItem("SHCList") !== 'undefined' && sessionStorage.getItem("SHCList") != null) {
				localStorage.removeItem("SHCList");
			}

			if (typeof obj.shcList !== 'undefined' && obj.shcList != null) {
				sessionStorage.setItem("SHCList", JSON.stringify(obj.shcList));
				availableSHCTags = obj.shcList;
			}
			if (typeof sessionStorage.getItem("SHCDescList") !== 'undefined' && sessionStorage.getItem("SHCDescList") != null) {
				localStorage.removeItem("SHCDescList");
			}
			if (typeof obj.shcDescList !== 'undefined' && obj.shcDescList != null) {
				sessionStorage.setItem("SHCDescList", JSON.stringify(obj.shcDescList));
				availableSHCDesc = obj.shcDescList;
				$(".SHCodeAC .autocomplete").autocomplete({
					source: availableSHCDesc,
					select: selectSHCFromAutoComplete
				});

				$(".SHCodeDG .autocomplete").autocomplete({
					source: availableSHCDesc,
					select: selectSHCFromAutoCompleteDG
				});
			}

			// set goods desc type
			if (typeof sessionStorage.getItem("GoodDescList") !== 'undefined' && sessionStorage.getItem("GoodDescList") != null) {
				localStorage.removeItem("GoodDescList");
			}

			if (typeof obj.goodsDescType !== 'undefined' && obj.goodsDescType != null) {
				sessionStorage.setItem("GoodDescList", JSON.stringify(obj.goodsDescType));
				setGoodsDescTypeOption(obj.goodsDescType);
			}
			if (typeof sessionStorage.getItem("Commodity_LH") !== 'undefined' && sessionStorage.getItem("Commodity_LH") != null) {
				localStorage.removeItem("Commodity_LH");
			}
			if (typeof obj.commodityLH !== 'undefined' && obj.commodityLH != null) {
				sessionStorage.setItem("Commodity_LH", JSON.stringify(obj.commodityLH));
			}
			if (typeof sessionStorage.getItem("ULDType_LH") !== 'undefined' && sessionStorage.getItem("ULDType_LH") != null) {
				localStorage.removeItem("ULDType_LH");
			}
			if (typeof obj.uldTypeListLH !== 'undefined' && obj.uldTypeListLH != null) {
				sessionStorage.setItem("ULDType_LH", JSON.stringify(obj.uldTypeListLH));
			}
			if (typeof sessionStorage.getItem("AirlineAdvBookDay") !== 'undefined' && sessionStorage.getItem("AirlineAdvBookDay") != null) {
				localStorage.removeItem("AirlineAdvBookDay");
			}
			if (typeof obj.airlineAdvBookDay !== 'undefined' && obj.airlineAdvBookDay != null) {
				sessionStorage.setItem("AirlineAdvBookDay", JSON.stringify(obj.airlineAdvBookDay));
			}

			if (typeof sessionStorage.getItem("AirlinesList") !== 'undefined' && sessionStorage.getItem("AirlinesList") != null) {
				localStorage.removeItem("AirlinesList");
			}
			if (typeof obj.airlineList !== 'undefined' && obj.airlineList != null) {
				sessionStorage.setItem("AirlinesList", JSON.stringify(obj.airlineList));
				airlineList = [];

				if (obj.airlineList.length > 0) {
					for (var i = 0; i < obj.airlineList.length; i++) {
						airlineList.push(obj.airlineList[i]);
					}
					// setCargoInfoAirlineOption();
					// if (localStorage.getItem("pasteFlightDetailData") != null) {
						// var flightData = JSON.parse(localStorage.getItem("pasteFlightDetailData"));
						// $("#bkd_def_cargoinfo").triggerHandler("pasteAirline", flightData.Airline);
					// }

					// if (!loadAWB) {
						// $('#cargoInfo_airline').selectpicker('toggle');
					// }

				}
			}

			// set port list
			if (typeof sessionStorage.getItem("PortList") !== 'undefined' && sessionStorage.getItem("PortList") != null) {
				localStorage.removeItem("PortList");
			}

			if (typeof obj.suggestions !== 'undefined' && obj.suggestions != null) {
				sessionStorage.setItem("PortList", JSON.stringify(obj.suggestions));
				regPortQueryV2();
			}
			
			//set Other Booking Prefix Pfl
			if (typeof sessionStorage.getItem("OtherBookingPrefixPflList") !== 'undefined' && sessionStorage.getItem("OtherBookingPrefixPflList") != null) {
				localStorage.removeItem("OtherBookingPrefixPflList");
			}

			if (typeof obj.otherBookingPrefixPfl !== 'undefined' && obj.otherBookingPrefixPfl != null) {
				sessionStorage.setItem("OtherBookingPrefixPflList", JSON.stringify(obj.otherBookingPrefixPfl));
			}
			
			//set airlineDetail
			if (typeof sessionStorage.getItem("AirlineDetailList") !== 'undefined' && sessionStorage.getItem("AirlineDetailList") != null) {
				localStorage.removeItem("AirlineDetailList");
			}

			if (typeof obj.airlineDetailList !== 'undefined' && obj.airlineDetailList != null) {
				sessionStorage.setItem("AirlineDetailList", JSON.stringify(obj.airlineDetailList));
			}
			
			console.timeEnd("getDefaultOptionalItemAPI");
			console.log(sessionStorage.getItem("PortList"));

			if (typeof callback == 'function') {
				callback();
			}
		};
		options.error = function () {
			console.log("Error while calling the Web API!");
			stopAction();
			DialogManager.alert(i18next.t('common.System'), i18next.t('common.SessionTimeout'));
		};
		$.ajax(options);
	}

    // get default optional item
    function getDefaultOptionalItem(callback) {
		console.time("getDefaultOptionalItem");
        connectHub(function () {
            //startAction(true);
            bookingHub.server.getDefaultOptionalValue().done(function (result) {
                console.log(result);
                //callback(JSON.parse(result));
                //stopAction();

                var obj = JSON.parse(result);
                //console.log(obj);

                // set special handling code
                if (typeof sessionStorage.getItem("SHCList") !== 'undefined' && sessionStorage.getItem("SHCList") != null) {
                    localStorage.removeItem("SHCList");
                }

                if (typeof obj.shcList !== 'undefined' && obj.shcList != null) {
                    sessionStorage.setItem("SHCList", JSON.stringify(obj.shcList));
                    availableSHCTags = obj.shcList;
                    availableSHCDesc = obj.shcDescList;
                    //availableSHCTags = JSON.parse(sessionStorage.getItem("SHCList"));
                    $(".SHCodeAC .autocomplete").autocomplete({
                        source: availableSHCDesc,
                        select: selectSHCFromAutoComplete
                    });
                }
                console.log(sessionStorage.getItem("SHCList"));

                // set goods desc type
                if (typeof sessionStorage.getItem("GoodDescList") !== 'undefined' && sessionStorage.getItem("GoodDescList") != null) {
                    localStorage.removeItem("GoodDescList");
                }

                if (typeof obj.goodsDescType !== 'undefined' && obj.goodsDescType != null) {
                    sessionStorage.setItem("GoodDescList", JSON.stringify(obj.goodsDescType));
                    setGoodsDescTypeOption(obj.goodsDescType);
                }
                console.log(sessionStorage.getItem("GoodDescList"));

                if (typeof obj.commodityLH !== 'undefined' && obj.commodityLH != null) {
                    sessionStorage.setItem("Commodity_LH", JSON.stringify(obj.commodityLH));
                }
                //console.log(sessionStorage.getItem("Commodity_LH"));
                if (typeof obj.uldTypeListLH !== 'undefined' && obj.uldTypeListLH != null) {
                    sessionStorage.setItem("ULDType_LH", JSON.stringify(obj.uldTypeListLH));
                }

                if (typeof obj.airlineAdvBookDay !== 'undefined' && obj.airlineAdvBookDay != null) {
                    sessionStorage.setItem("AirlineAdvBookDay", JSON.stringify(obj.airlineAdvBookDay));
                }

                if (typeof obj.airlineList !== 'undefined' && obj.airlineList != null) {
                    airlineList = [];

                    if (obj.airlineList.length > 0) {
                        for (var i = 0; i < obj.airlineList.length; i++) {
                            airlineList.push(obj.airlineList[i]);
                        }
                    }
                }

                // set priority type
                /*
                if (localStorage.getItem("PrList") !== 'undefined' && localStorage.getItem("PrList") != null) {
                    localStorage.removeItem("PrList");
                }

                if (obj.prList !== 'undefined' && obj.prList != null) {
                    localStorage.setItem("PrList", JSON.stringify(obj.prList));
                    setPriorityTypeOption(obj.prList);
                }
                console.log(localStorage.getItem("PrList"));
                */

                // set port list
                if (typeof sessionStorage.getItem("PortList") !== 'undefined' && sessionStorage.getItem("PortList") != null) {
                    sessionStorage.removeItem("PortList");
                }

                if (typeof obj.suggestions !== 'undefined' && obj.suggestions != null) {
                    sessionStorage.setItem("PortList", JSON.stringify(obj.suggestions));
                    regPortQueryV2();
                }
				console.timeEnd("getDefaultOptionalItem");
                console.log(sessionStorage.getItem("PortList"));

                if (typeof callback == 'function') {
                    callback();
                }

            });
        });
    }

    function gotoMultiAWB(e) {
        e.preventDefault();
        window.location.href="#";
    }

    function loadBookingData(bkd, tran) {
		console.log(tran);


        if (typeof bkd !== 'undefined' && bkd != null) {
            $("#bd_awbno").text(bkd.AwbPrefix+"-"+bkd.AwbSuffix);
            $("#bd_origin").text(bkd.Origin);
            $("#bd_dest").text(bkd.Destination);
            $("#bd_pcs").text(bkd.Pieces);
            $("#bd_weight").text(bkd.Weight);
            $("#bd_weight_code").text(getWeightUnitTextByCode(bkd.WeightCode));

            var headerSuccessMessage = i18next.t("common.Submitted");
            var headerErrorMessage = "";

            var headerDisplayError = false;

            //debugger;

            if (tran.BookingStatus == 1) {
                headerSuccessMessage = i18next.t("common.Saved");
                hideCancelBtn();
            } else if (tran.BookingStatus == 13) {
                headerSuccessMessage = i18next.t("BookingDetails.CancelBooking");
                hideCancelBtn();
            }
            else {
                if (bkd.Reply != null && bkd.Reply.length > 0) {
                    if (bkd.Reply[0].Ack2 != "") {
                        headerErrorMessage = bkd.Reply[0].Ack2;
                        headerDisplayError = true;
                    } else if (bkd.Reply[0].Ack1.indexOf("CSP_WS") == -1 && bkd.Reply[0].Ack1.indexOf("CIMFMA") == -1 && bkd.Reply[0].Ack1.indexOf("CIMFNA") == -1) {
                        headerErrorMessage = bkd.Reply[0].Ack1;
                        headerDisplayError = true;
                    }
                }

                if (!headerDisplayError) {
                    if (typeof bkd.FlightDetail !== 'undefined' && bkd.FlightDetail != null) {
                        for (var i = 0; i < bkd.FlightDetail.length; i++) {
                            if (bkd.FlightDetail[0].FlightDetailCxIsSpecified) {
                                if (goodReplyMessage.indexOf(bkd.FlightDetail[i].FlightDetailCx.FCTLStatusX.toUpperCase()) != -1 || goodReplyMessage.indexOf(bkd.FlightDetail[i].FlightDetailCx.FCTLStatus.toUpperCase()) != -1) {
                                    if (bkd.FlightDetail[i].FlightDetailCx.FCTLStatusX != "")
                                        headerSuccessMessage = bkd.FlightDetail[i].FlightDetailCx.FCTLStatusX;
                                }
                                else {
                                    headerErrorMessage = bkd.FlightDetail[i].FlightDetailCx.FCTLStatusX;
                                    headerDisplayError = true;
                                }
                            }
                            else {
                                if (!goodReplyMessage.indexOf(bkd.FlightDetail[i].SpaceAllocationCode) != -1) {
                                    headerErrorMessage = spaceAllocationCodeDict[bkd.FlightDetail[i].SpaceAllocationCode];
                                    headerDisplayError = true;
                                }
                            }
                        }
                    }
                }
            }

            $("#booking_detail_summary_icon").removeClass("icon_success")
            $("#booking_detail_summary_icon").removeClass("icon_error")

            if (!headerDisplayError) {
                $("#bd_header_status").text(headerSuccessMessage);
                $("#booking_detail_summary_icon").addClass("icon_success")
            }
            else {
                $("#bd_header_status").text(headerErrorMessage);
                $("#booking_detail_summary_icon").addClass("icon_error")
            }

            for (var i = 1; i <= 3; i++) {
                $("#tab" + i + "  .bkd_block").each(function (i, o) {
                    //console.log(o);
                    //console.log($._data(o, 'events'));
                    //console.log($._data(o, 'events').loadBookingData);
                    if ($._data(o, 'events') && $._data(o, 'events').loadBookingData != null)
                        $(o).triggerHandler("loadBookingData", [bkd, tran.BookingStatus]);
                });
            }
        }

    }

    function clearBookingData() {
        $("#bd_awbno").text("");
        $("#bd_origin").text("");
        $("#bd_dest").text("");
        $("#bd_pcs").text("");
        $("#bd_weight").text("");
        $("#bd_weight_code").text("");
        $("#bd_header_status").text("");
    }

    function reloadBookingDetail() {
        console.log("reloadBookingDetail");
        localStorage.removeItem("bd_cargo_info_edit");
        localStorage.removeItem("bd_routing_edit");
        localStorage.removeItem("bd_flight_edit");
        localStorage.removeItem("bd_special_cargo_edit");
        localStorage.removeItem("bd_uld_edit");
        localStorage.removeItem("bd_dim_edit");
        localStorage.removeItem("bd_contact_edit");
        localStorage.removeItem("bd_remarks_edit");
        localStorage.removeItem("bd_ngtt_edit");
        localStorage.setItem("bd_cargo_info_has_update", 0);
        localStorage.setItem("bd_routing_has_update", 0);
        localStorage.setItem("bd_flight_has_update", 0);
        localStorage.setItem("bd_special_cargo_has_update", 0);
        localStorage.setItem("bd_uld_has_update", 0);
        localStorage.setItem("bd_dim_has_update", 0);
        localStorage.setItem("bd_contact_has_update", 0);
        localStorage.setItem("bd_remark_has_update", 0);
        localStorage.setItem("bd_ngtt_has_update", 0);

        loadPrimaryAWBInfo = false;

        var airline = "CX";
        var awbPrefix = "160";
        var awbSuffix = "10099364";
        //getAWB("CX", "043", "00099116");
		
		switch (wayToRetrieveBookingLog) {
			case 0:
				getDefaultOptionalItem(function () {getAWB(airline, awbPrefix, awbSuffix)});
				break;
			case 1:
				getDefaultOptions(function () {getAWBfromAPI(airline, awbPrefix, awbSuffix)});
				break;
			default:
				getDefaultOptionalItem(function () {getAWB(airline, awbPrefix, awbSuffix)});
				break;
		}		
    }

	// get default optional item
	function getDefaultOptions(callback) {
		// set special handling code
		console.log("getDefaultOptions");
		console.time("getDefaultOptions");
		if ((typeof sessionStorage.getItem("AirlineDetailList") == 'undefined' || sessionStorage.getItem("AirlineDetailList") == null) &&
			(typeof sessionStorage.getItem("SHCList") == 'undefined' || sessionStorage.getItem("SHCList") == null) &&
		   ( typeof sessionStorage.getItem("SHCDescList") == 'undefined' || sessionStorage.getItem("SHCDescList") == null) &&
		   ( typeof sessionStorage.getItem("GoodDescList") == 'undefined' || sessionStorage.getItem("GoodDescList") == null) &&
		   ( typeof sessionStorage.getItem("Commodity_LH") == 'undefined' || sessionStorage.getItem("Commodity_LH") == null) &&
		   ( typeof sessionStorage.getItem("ULDType_LH") == 'undefined' || sessionStorage.getItem("ULDType_LH") == null) &&
		   ( typeof sessionStorage.getItem("AirlineAdvBookDay") == 'undefined' || sessionStorage.getItem("AirlineAdvBookDay") == null) &&
		   ( typeof sessionStorage.getItem("PortList") == 'undefined' || sessionStorage.getItem("PortList") == null) &&
			(typeof sessionStorage.getItem("OtherBookingPrefixPflList") == 'undefined' || sessionStorage.getItem("OtherBookingPrefixPflList") == null) &&
		   ( typeof sessionStorage.getItem("AirlinesList") == 'undefined' || sessionStorage.getItem("AirlinesList") == null)
		) {
			console.timeEnd("getDefaultOptions");
			getDefaultOptionalItemAPI(callback);
		} else {
			//set airlineDetail
			if (typeof sessionStorage.getItem("AirlineDetailList") == 'undefined' || sessionStorage.getItem("AirlineDetailList") == null) {
				var objairlinedetailslist = postOptionaAPI("airlinedetailslist");
				console.log("objairlinedetailslist", objairlinedetailslist);
				sessionStorage.setItem("AirlineDetailList", JSON.stringify(objairlinedetailslist.options));
			}

			if (typeof sessionStorage.getItem("SHCList") == 'undefined' || sessionStorage.getItem("SHCList") == null ||
				typeof sessionStorage.getItem("SHCDescList") == 'undefined' || sessionStorage.getItem("SHCDescList") == null) {
				var shcoptions = getOptionaAPI("shcoptions");
				console.log("shcoptions", shcoptions);
				if (typeof shcoptions.shcList !== 'undefined' && shcoptions.shcList != null) {
					sessionStorage.setItem("SHCList", JSON.stringify(shcoptions.shcList));
					availableSHCTags = shcoptions.shcList;
				}
				if (typeof shcoptions.shcDescList !== 'undefined' && shcoptions.shcDescList != null) {
					sessionStorage.setItem("SHCDescList", JSON.stringify(shcoptions.shcDescList));
					availableSHCDesc = shcoptions.shcDescList;
				}

			} else {
				availableSHCTags = JSON.parse(sessionStorage.getItem("SHCList"));
				availableSHCDesc = JSON.parse(sessionStorage.getItem("SHCDescList"));
			}
			//   console.log("availableSHCTags", availableSHCTags);
			//  console.log("availableSHCDesc", availableSHCDesc);
			if (typeof availableSHCTags !== 'undefined' && availableSHCTags != null && typeof availableSHCDesc !== 'undefined' && availableSHCDesc != null) {
				$(".SHCodeAC .autocomplete").autocomplete({
					source: availableSHCDesc,
					select: selectSHCFromAutoComplete
				});

				$(".SHCodeDG .autocomplete").autocomplete({
					source: availableSHCDesc,
					select: selectSHCFromAutoCompleteDG
				});
			}

			// set goods desc type
			if (typeof sessionStorage.getItem("GoodDescList") == 'undefined' || sessionStorage.getItem("GoodDescList") == null) {
				var goodsdescOptions = getOptionaAPI("goodsdescOptions");
				console.log("goodsdescOptions", goodsdescOptions.options);
				sessionStorage.setItem("GoodDescList", JSON.stringify(goodsdescOptions.options));
				setGoodsDescTypeOption(goodsdescOptions.options);
			} else {

				setGoodsDescTypeOption(JSON.parse(sessionStorage.getItem("GoodDescList")));
			}

			if (typeof sessionStorage.getItem("Commodity_LH") == 'undefined' || sessionStorage.getItem("Commodity_LH") == null) {
				var Commodity_LH = getOptionaAPI("LHCommodityListOptions");
				console.log("Commodity_LH", Commodity_LH.options);
				sessionStorage.setItem("Commodity_LH", JSON.stringify(Commodity_LH.options));
			}

			if (typeof sessionStorage.getItem("ULDType_LH") == 'undefined' || sessionStorage.getItem("ULDType_LH") == null) {
				var ULDType_LH = getOptionaAPI("ULDTypeLHlistOptions");
				console.log("ULDType_LH", ULDType_LH.options);
				sessionStorage.setItem("ULDType_LH", JSON.stringify(ULDType_LH.options));
			}
			if (typeof sessionStorage.getItem("AirlineAdvBookDay") == 'undefined' || sessionStorage.getItem("AirlineAdvBookDay") == null) {
				var AirlineAdvBookDay = getOptionaAPI("airlineAdvBookDaylistOptions");
				console.log("AirlineAdvBookDay", AirlineAdvBookDay.options);
				sessionStorage.setItem("AirlineAdvBookDay", JSON.stringify(AirlineAdvBookDay.options));
			}

			// set port list
			if (typeof sessionStorage.getItem("PortList") == 'undefined' || sessionStorage.getItem("PortList") == null) {
				var PortList = getOptionaAPI("portlistOptions");
				console.log("PortList", PortList.options);
				sessionStorage.setItem("PortList", JSON.stringify(PortList.options));
			}
			regPortQueryV2();

			//set Other Booking Prefix Pfl

			if (typeof sessionStorage.getItem("OtherBookingPrefixPflList") == 'undefined' || sessionStorage.getItem("OtherBookingPrefixPflList") == null) {
				var OtherBookingPrefixPflList = getOptionaAPI("OtherBookingPrefixPfllistOptions");
				console.log("OtherBookingPrefixPflList", OtherBookingPrefixPflList.options);
				sessionStorage.setItem("OtherBookingPrefixPflList", JSON.stringify(OtherBookingPrefixPflList.options));
			}
			var List;
			var objairlineList;
			if (typeof sessionStorage.getItem("AirlinesList") == 'undefined' || sessionStorage.getItem("AirlinesList") == null) {
				List = postOptionaAPI("airlineslist");
				sessionStorage.setItem("AirlinesList", JSON.stringify(List.options));
				objairlineList = List.options;
			} else {
				List = JSON.parse(sessionStorage.getItem("AirlinesList"));
				objairlineList = List;
			}

			// if (typeof objairlineList !== 'undefined' && objairlineList != null) {
				// airlineList = [];

				// if (objairlineList.length > 0) {
					// for (var i = 0; i < objairlineList.length; i++) {
						// airlineList.push(objairlineList[i]);
					// }
					// setCargoInfoAirlineOption();
					// if (localStorage.getItem("pasteFlightDetailData") != null) {
						// var flightData = JSON.parse(localStorage.getItem("pasteFlightDetailData"));
						// $("#bkd_def_cargoinfo").triggerHandler("pasteAirline", flightData.Airline);
					// }

					// if (!loadAWB) {
						// $('#cargoInfo_airline').selectpicker('toggle');
					// }

				// }
			// }
			console.timeEnd("getDefaultOptions");
			if (typeof callback == 'function') {
				callback();
			}
		}
		// console.timeEnd("getDefaultOptions");
	}
	// post default optional item
	function postOptionaAPI(path) {
		console.log("start postOptionaAPI", path);
		console.time("postOptionaAPI" + path);
		var d = {
			"request": {
			}
		}; //create array of objects
		var options = {};
		options.url = BookingAPIURL + path;
		options.type = "POST";
		options.contentType = "application/json; charset=utf-8";
		options.dataType = "json";
		options.data = JSON.stringify(d);
		options.beforeSend = function (xhr, settings) {
			xhr.setRequestHeader('Authorization', 'Bearer ' + getCookie('ApiToken'));
		};
		options.success = function (response) {
			console.log("postOptionaAPI " + path + " response:", response);

			console.timeEnd("postOptionaAPI" + path);
			return response;
		};
		options.error = function () {
			console.log("Error while calling the Web API!");
			stopAction();
			DialogManager.alert(i18next.t('common.System'), i18next.t('common.SessionTimeout'));
		};
		var a = $.ajax(options);
		console.log(a);
		if (a.responseText != null || a.responseText != undefined) {
			return JSON.parse(a.responseText);
		}
	}

	 // get default optional item
	function getOptionaAPI(path) {
		console.log("start getOptionaAPI", path);
		console.time("getOptionaAPI" + path);
		//console.time("API:getOptionaAPI");
	   // var d = {

	  //  }; //create array of objects
		var options = {};
		options.url = BookingAPIURL + path;
		options.type = "Get";
		options.contentType = "application/json; charset=utf-8";
		options.dataType = "json";
	   // options.data = JSON.stringify(d);
		options.beforeSend = function (xhr, settings) {
			xhr.setRequestHeader('Authorization', 'Bearer ' + getCookie('ApiToken'));
		};
		options.success = function (response) {
			console.log("getOptionaAPI " + path+" response:", response);

			console.timeEnd("getOptionaAPI" + path);
			return response;
		};
		options.error = function () {
			console.log("Error while calling the Web API!");
			stopAction();
			DialogManager.alert(i18next.t('common.System'), i18next.t('common.SessionTimeout'));
		};
		var a = $.ajax(options);
		if (a.responseText != null || a.responseText != undefined) {
			return JSON.parse(a.responseText);
		}
	}
	
	function goToAmendSingleBooking() {
			let airline = $('#bkd_result_airline').val();
			let awbPrefix = $('#bkd_result_awbprefix').val();
			let awbSuffix = $('#bkd_result_awbsuffix').val();
			//console.log('airline: ' + airline);	
			//console.log('awbprefix: ' + awbPrefix);	
			//console.log('awbsuffix: ' + awbSuffix);	
			goToSingleBooking(airline, awbPrefix, awbSuffix);		
	}

    function goToSingleBooking(airline, awbPrefix, awbSuffix) {
        window.location.href = linkBkdSingleAwb + bkdQSSingle.replace("$AIRLINE$", airline).replace("$AWBPREFIX$", awbPrefix).replace("$AWBSUFFIX$", awbSuffix);
    }

    function hideBookingErrorMsg() {
        $("#blk_detail_errorLt").html("");
    }

    function resetScreenForLoading() {
        $("#blk_detail_errorLt").html("");
        $("#bkd_detail").addClass("disabled");
        $("#bkd_detail_error").addClass("disabled");
    }

    function displayError(errorMessage) {
        var errText = "";
        var errTemplate = $("#bkd_error_template").html();

        for (var e in errorMessage) {
            errText += errTemplate.replace("$ERRORMESSAGE$", errorMessage[e]);
        }

        $("#blk_detail_errorLt").html(errText);
        $("#bkd_detail").addClass("disabled");
        $("#bkd_detail_error").removeClass("disabled");
        stopAction();
    }

    function bkdGoToBookingLog(e) {
        e.preventDefault();
        window.location.href = linkBkdBookingLog;
    }

    function bkdGoToBookingDetail(e) {
        e.preventDefault();
        window.location.href = linkBkdDetail + bkdQSSingle
            .replace("$AIRLINE$", $("#bkd_result_airline").val())
            .replace("$AWBPREFIX$", $("#bkd_result_awbprefix").val())
            .replace("$AWBSUFFIX$", $("#bkd_result_awbsuffix").val());
    }

    var tranRecordLity;

    function bkdOpenBookingRecordRow(airline, awbPrefix, awbSuffix, tranID, refTranID) {
        console.log("bkdOpenBookingRecordRow");
        console.log(airline);
        console.log(awbPrefix);
        console.log(awbSuffix);
        console.log(tranID);
        console.log(refTranID);
        $("#bkd_tran_record").html($("#bkd_tran_record_template").html())
        tranRecordLity = lity("#bkd_tran_record");

		if(wayToRetrieveBookingLog == 1) {
			console.time("OpenBookingRecordRowAPI");
			var token = this.$cookies.get("ApiToken");
			var data = {
						  "request": {
							"airline": airline,
							"awbPrefix": awbPrefix,
							"awbSuffix": awbSuffix,
							"tranID": parseInt(tranID, 10),
							"refTranID": parseInt(refTranID, 10)
						  }  ,
                            "source": "EzyCargo"
					}; //create array of objects
			$.ajax({
				url: RetrieveBookingHistoryAPIURL + "getBookingTranRecord",
				method: "POST",
				contentType:  "application/json; charset=utf-8",
				headers: {
					Authorization: "Bearer " + token
				},
				dataType: "json",
				data: JSON.stringify(data)
			})
			.fail(function(response){
					console.log("bkdOpenBookingRecordRow Failed");
					console.log(response.statusText);
					// DialogManager.alert(i18next.t('common.Error'), 'Failed to Retreive Booking Tran Record! (' + response.status + ' ' + response.statusText.toUpperCase() + ')');
					DialogManager.alert(i18next.t('common.System'), i18next.t('common.SessionTimeout'));
			})
			.done(function (response) {
				if(response.bookingSummary1 === null) {
					// DialogManager.alert(i18next.t('common.Error'), 'bookingSummary1 is null');
					console.log('bookingSummary1 is null');
				}
				if(response.booking1 === null) {
					// DialogManager.alert(i18next.t('common.Error'), 'booking1 is null');
					console.log('booking1 is null');
				}
				// if(response.bookingSummary2 === null) {
					// DialogManager.alert(i18next.t('common.Error'), 'bookingSummary2 is null');
				// }
				// if(response.booking2 === null) {
					// DialogManager.alert(i18next.t('common.Error'), 'booking2 is null');
				// }
                console.log("bkdTran1", response.bookingSummary1);
                console.log("bkdBooking1", response.booking1);
                console.log("bkdTran2", response.bookingSummary2);
                console.log("bkdBooking2", response.booking2);
				bkdDisplayBkdTranHistory(response.bookingSummary1, response.booking1, response.bookingSummary2, response.booking2);
			});
		} else {
				console.time("OpenBookingRecordRow");
				connectHub(function () {
				bkdTran1 = null;
				bkdBooking1 = null;
				bkdTran2 = null;
				bkdBooking2 = null;
				bookingHub.server.getBookingTranRecord(airline, awbPrefix, awbSuffix, tranID, refTranID);
			});
		}

        refreshModuleTranslation();
    }

    function bkdCloseBookingRecordRow(event) {
        console.log("bkdCloseBookingRecordRow clicked");
        tranRecordLity.close();
    }

    var bkdTran1 = null;
    var bkdBooking1 = null;
    var bkdTran2 = null;
    var bkdBooking2 = null;

    bookingHub.client.loadBookingTranHistory = function (booking, bookingSummary, replyId) {
        console.log("loadBookingTranHistory booking", booking);
        console.log("loadBookingTranHistory bookingSummary", bookingSummary);
        console.log("loadBookingTranHistory replyId", replyId);
        if (booking == null || bookingSummary == null) {
            $("#bkd_tran_record").html("<span style='background-color: white; padding: 30px' data-i18n='cargoInfo.Unableloadhistory'>Unable to load booking history</span>");
            return;
        }

        var tran = bookingSummary[0];

        if (!loadPrimaryAWBInfo) {
            //debugger;
            bkdDetailLoadBookingData(booking, tran, false)
            loadPrimaryAWBInfo = true;
            return;
        }


        if (replyId == -1) {
            console.log("tran: " + JSON.stringify(tran));
            console.log("booking: " + JSON.stringify(booking));
            bkdDisplayBkdTranHistory(tran, booking, null, null)
        }
        else {
            if (replyId == 1) {
                bkdTran1 = tran;
                bkdBooking1 = booking;
            }
            else {
                bkdTran2 = tran;
                bkdBooking2 = booking;
            }

            if (bkdTran1 != null && bkdBooking1 != null &&
                bkdTran2 != null && bkdBooking2 != null) {
                console.log("bkdTran1: " + JSON.stringify(bkdTran1));
                console.log("bkdBooking1: " + JSON.stringify(bkdBooking1));
                console.log("bkdTran2: " + JSON.stringify(bkdTran2));
                console.log("bkdBooking2: " + JSON.stringify(bkdBooking2));
                bkdDisplayBkdTranHistory(bkdTran1, bkdBooking1, bkdTran2, bkdBooking2)
            }
        }
    }

    function bkdGetTabName(msgType) {
        switch (msgType) {
            case 1:
                return i18next.t("createBooking.BookingRequest");
            case 4:
                return i18next.t("createBooking.BookingRequest") + " (FFR)";
            case 2:
                return i18next.t("BookingRecord.AirlineReply");
            case 3:
                return i18next.t("BookingRecord.AirlineReply") + " (Late-FFA)";
            case 5:
                return i18next.t("BookingRecord.AirlineReply") + " (FMA)";
            case 6:
                return i18next.t("BookingRecord.AirlineReply") + " (FNA)";
            case 7:
                return i18next.t("BookingRecord.AirlineReply") + " (FFA)";
            default:
                return i18next.t("createBooking.BookingRecord");
        }
    }

    function bkdDisplayBkdTranHistory(tran, booking, tran2, booking2) {

        var shc = "";
        var tab1Name = bkdGetTabName(tran.MsgType);

        if (booking.ShrCode != null) {
            for (var s in booking.ShrCode) {
                if (shc != "") shc += ",";
                shc += booking.ShrCode[s]
            }
        }

        var prType = ""

        if (booking.Airline == "CX" || booking.Airline == "KA" || booking.Airline == "LD" || booking.Airline == "UO") {
            if (booking.Cx != null) {
                prType = booking.Cx.ProductCode;
                $("#d_priority").show();
            } else {
                $("#d_priority").hide();
            }

            $("#d_deal_code").show();
        } else {
            $("#d_priority").hide();
            $("#d_deal_code").hide();
        }

        var pdType = "";

        if (booking.Airline == "SQ") {
            if (booking.SqIsSpecified == true) {
                if (typeof booking.Sq !== 'undefined' && booking.Sq != null) {
                    switch (booking.Sq.Product) {
                        case 0:
                            pdType = "";
                            break;
                        case 1:
                            pdType = "SwiftRider";
                            break;
                        case 2:
                            pdType = "Value Add-Cool";
                            break;
                    }
                    console.log("booking.Sq.Product" + booking.Sq.Product);
                }
                $("#d_product").show();
            } else {
                $("#d_product").hide();
            }

        } else {
            $("#d_product").hide();
        }


        var routings = "";
        var routing_template = $("#bkd_tran_detail_routing_template").html()

        var flights = "";
        var flight_template = $("#bkd_tran_detail_flight_template").html()

        var isError = false;

        for (var f in booking.FlightDetail) {
            routings += routing_template
                .replace("$PORT$", booking.FlightDetail[f].ArrivalPort)
                .replace("$AIRLINE$", booking.FlightDetail[f].CarrierCode.toUpperCase())

            var depTime = ""
            if (booking.FlightDetail[f].DepartureDate != null) {
				if (wayToRetrieveBookingLog == 1) {
					console.log("get DepartureDate");
					console.log(booking.FlightDetail[f].DepartureDate);
					depTime = getAPIDate(getDateFromDateString(booking.FlightDetail[f].DepartureDate)).ToString(DateTimeFormat.DateMonth);
				} else {
					depTime = getAPIDate(booking.FlightDetail[f].DepartureDate).ToString(DateTimeFormat.DateMonth);
				}
			}

            var arrTime = ""
            if (booking.FlightDetail[f].ArrivalDate != null) {
				if (wayToRetrieveBookingLog == 1) {
					console.log("get ArrivalDate");
					console.log(booking.FlightDetail[f].ArrivalDate);
					arrTime = getAPIDate(getDateFromDateString(booking.FlightDetail[f].ArrivalDate)).ToString(DateTimeFormat.DateMonthTime);
				} else {
					arrTime = getAPIDate(booking.FlightDetail[f].ArrivalDate).ToString(DateTimeFormat.DateMonthTime);
				}
			}

            var status = ""
            if (booking.Airline == "CX") { // booking.FlightDetail[f].FlightDetailCx != null && booking.FlightDetail[f].FlightDetailCx.FCTLStatus != "" && booking.FlightDetail[f].FlightDetailCx.FCTLStatusX != "") {
                status = booking.FlightDetail[f].FlightDetailCx.FCTLStatusX;

                switch (status.toUpperCase()) {
                    case "CONFIRMED":
                        break;
                }
            }
            else {
                status = booking.FlightDetail[f].SpaceAllocationCode;
            }

            //debugger;
            isError = goodReplyMessage.indexOf(status.toUpperCase()) == -1;

            var allotmentId = booking.FlightDetail[f].AllotmentId;
            //debugger;
            /*
            if (booking.CxIsSpecified) {
                if (allotmentId != "-") {
                    allotmentId = "Allotted Booking";
                }
            }
            */
            if (booking.Airline == "CX") {
                if (allotmentId != "-" && allotmentId != "") {
                    allotmentId = "Allotted Booking";
                }
            }
            //debugger;
            flights += flight_template
                .replace(/\$ORIG\$/g, booking.FlightDetail[f].DeparturePort)
                .replace("$DEST$", booking.FlightDetail[f].ArrivalPort)
                .replace("$FLIGHTNUM$", booking.FlightDetail[f].CarrierCode.toUpperCase() + booking.FlightDetail[f].FlightNum)
                .replace("$DEPTIME$", depTime)
                .replace("$ARRTIME$", arrTime)
                .replace("$ALLOTID$", allotmentId)
                .replace("$STATUS$", status)
                .replace("$PIECES$", booking.Pieces + i18next.t("cargoInfo.pcs"))
                .replace("$WEIGHT$", booking.Weight + getWeightUnitTextByCode(booking.WeightCode))
                .replace("$VOLUME$", booking.VolumeAmount + " " + getVolUnitTextByCode(booking.VolumeCode))
                .replace("$HASERROR$", isError ? "blk_error" : status == "" ? "" : "ball_bu");
        }

        var tab1HasError = false;
        var tab1ErrorMessage = "";

        if (booking.Reply != null) {

            for (var i = 0; i < booking.Reply.length; i++) {
                if (booking.Reply[i].Ack2.trim() != "") {
					tab1HasError = true;
                    tab1ErrorMessage += "<p>" + booking.Reply[i].Ack2 + " (" + booking.Reply[i].Ack1 + ")</p>";
                }
            }
        }
		console.log("trans", tran);
		console.log("updateTime", tran.UpdateTime);
		
        $("#bkd_tran_record").html($("#bkd_tran_record").html()
            .replace("$TAB1NAME$", tab1Name)
            .replace("$AIRLINE$", booking.FlightDetail[f].CarrierCode.toUpperCase())
            .replace("$AWB$", booking.AwbPrefix + "-" + booking.AwbSuffix)
            .replace(/\$ORIG\$/g, booking.Origin)
            .replace("$DEST$", booking.Destination)
            .replace("$USERID$", tran.ActionUserId)
            .replace("$TIME$", GetLocalTimeFromServerTS(tran.UpdateTime).ToString(DateTimeFormat.FullWithoutSecond))
            .replace("$SHC$", shc)
            .replace("$ITEMDESC$", booking.ManifestDesc)
            .replace("$PRTYPE$", prType)
            .replace("$ROUTINGS$", routings.toUpperCase())
            .replace("$FLIGHTS$", flights)
            .replace("$TAB1ERROR$", tab1HasError ? "" : "disabled")
            .replace("$ERRORMSG$", tab1ErrorMessage)
			.replace(/\$ROUTING_DISABLED\$/g, booking.Airline == "CX" ? "" : "disabled")
            .replace("$PDTYPE$", pdType)
            .replace("$DEALCODE$", booking.Cx.DealCode)
        );

        if (tran2 != null) {
            var tab2Name = bkdGetTabName(tran2.MsgType);

            // Clarence 20181129: Change to function later, no time now...... copy code is no good, good boy dont learn it

            $("#bkd_tran_record").html($("#bkd_tran_record").html()
                .replace("$TIME$", GetLocalTimeFromServerTS(tran.UpdateTime).ToString(DateTimeFormat.FullWithoutSecond))
            );

            shc = ""

            if (booking2.ShrCode != null) {
                for (var s in booking2.ShrCode) {
                    if (shc != "") shc += ",";
                    shc += booking2.ShrCode[s]
                }
            }

            prType = ""

            if (booking2.Airline == "CX" || booking2.Airline == "KA" || booking2.Airline == "LD" || booking2.Airline == "UO") {
                if (booking2.Cx != null) {
                    prType = booking2.Cx.ProductCode;
                    $("#d_priority_2").show();
                } else {
                    $("#d_priority_2").hide();
                }
            } else {
                $("#d_priority_2").hide();
            }

            pdType = "";

            if (booking2.Airline == "SQ") {
                if (booking2.SqIsSpecified == true) {
                    if (typeof booking2.Sq !== 'undefined' && booking2.Sq != null) {
                        switch (booking2.Sq.Product) {
                            case 0:
                                pdType = "";
                                break;
                            case 1:
                                pdType = "SwiftRider";
                                break;
                            case 2:
                                pdType = "Value Add-Cool";
                                break;
                        }
                        console.log("booking2.Sq.Product" + booking.Sq.Product2);
                    }
                    $("#d_product_2").show();
                } else {
                    $("#d_product_2").hide();
                }
            } else {
                $("#d_product_2").hide();
            }

            routings = "";
            routing_template = $("#bkd_tran_detail_routing_template").html()

            flights = "";
            flight_template = $("#bkd_tran_detail_flight_template").html()

            isError = false;

            for (var f in booking2.FlightDetail) {
                routings += routing_template
                    .replace("$PORT$", booking2.FlightDetail[f].ArrivalPort)
                    .replace("$AIRLINE$", booking2.FlightDetail[f].CarrierCode.toUpperCase())

                var depTime = ""
                if (booking2.FlightDetail[f].DepartureDate != null){
					if (wayToRetrieveBookingLog == 1) {
						depTime = getAPIDate(getDateFromDateString(booking2.FlightDetail[f].DepartureDate)).ToString(DateTimeFormat.DateMonth);
					} else {
						depTime = getAPIDate(booking2.FlightDetail[f].DepartureDate).ToString(DateTimeFormat.DateMonth)
					}
                 }  

                var arrTime = ""
                if (booking2.FlightDetail[f].ArrivalDate != null) {
					if (wayToRetrieveBookingLog  == 1) {
						arrTime = getAPIDate(getDateFromDateString(booking2.FlightDetail[f].ArrivalDate)).ToString(DateTimeFormat.DateMonthTime);
					} else {
						arrTime = getAPIDate(booking2.FlightDetail[f].ArrivalDate).ToString(DateTimeFormat.DateMonthTime)
					}
					}

                var status = ""
                if (booking2.Airline == "CX") { // booking.FlightDetail[f].FlightDetailCx != null && booking.FlightDetail[f].FlightDetailCx.FCTLStatus != "" && booking.FlightDetail[f].FlightDetailCx.FCTLStatusX != "") {
                    status = booking2.FlightDetail[f].FlightDetailCx.FCTLStatusX;

                    switch (status.toUpperCase()) {
                        case "CONFIRMED":
                            break;
                    }
                }
                else {
                    switch (booking2.FlightDetail[f].SpaceAllocationCode) {
                        case "XX":
                            status = "Deleted";
                            break;
                        default:
                            status = booking2.FlightDetail[f].SpaceAllocationCode;
                    }
                }

                //debugger;
                isError = goodReplyMessage.indexOf(status.toUpperCase()) == -1;

                var allotmentId2 = booking2.FlightDetail[f].AllotmentId;
                //debugger;
                /*
                if (booking.CxIsSpecified) {
                    if (allotmentId != "-") {
                        allotmentId = "Allotted Booking";
                    }
                }
                */
                if (booking2.Airline == "CX") {
                    if (allotmentId2 != "-" && allotmentId2 != "") {
                        allotmentId2 = "Allotted Booking";
                    }
                }

                flights += flight_template
                    .replace(/\$ORIG\$/g, booking2.FlightDetail[f].DeparturePort)
                    .replace("$DEST$", booking2.FlightDetail[f].ArrivalPort)
                    .replace("$FLIGHTNUM$", booking2.FlightDetail[f].CarrierCode.toUpperCase() + booking2.FlightDetail[f].FlightNum)
                    .replace("$DEPTIME$", depTime)
                    .replace("$ARRTIME$", arrTime)
                    .replace("$ALLOTID$", allotmentId2)
                    .replace("$STATUS$", status)
                    .replace("$PIECES$", booking.Pieces + i18next.t("cargoInfo.pcs"))
                    .replace("$WEIGHT$", booking2.Weight + getWeightUnitTextByCode(booking.WeightCode))
                    .replace("$VOLUME$", booking2.VolumeAmount + " " + getVolUnitTextByCode(booking.VolumeCode))
                    .replace("$HASERROR$", isError ? "blk_error" : status == "" ? "" : "ball_bu");

            }
			console.log("updateTime", tran.UpdateTime);

            $("#bkd_tran_record").html($("#bkd_tran_record").html()
                .replace("$TAB2NAME$", tab2Name)
                .replace(/\$ORIG2\$/g, booking2.Origin)
                .replace("$DEST2$", booking2.Destination)
                .replace("$USERID2$", tran2.ActionUserId)
                .replace("$TIME2$", GetLocalTimeFromServerTS(tran.UpdateTime).ToString(DateTimeFormat.FullWithoutSecond))
                .replace("$SHC2$", shc)
                .replace("$ITEMDESC2$", booking2.ManifestDesc)
                .replace("$PRTYPE2$", prType)
                .replace("$ROUTINGS2$", routings.toUpperCase())
                .replace("$FLIGHTS2$", flights)
                .replace("$PDTYPE2$", pdType)
                .replace("$WEIGHT2$", booking2.Weight + getWeightUnitTextByCode(booking2.WeightCode))
                .replace("$VOLUME2$", booking2.VolumeAmount + " " + getVolUnitTextByCode(booking2.VolumeCode)));
        }
        else {
            $("#bkd_tran_record").html($("#bkd_tran_record").html()
                .replace("$SHOWTAB2$", tran2 == null ? "disabled" : ""));
        }

        $("#bkd_tran_record_loading").addClass("disabled");
        $("#bkd_tran_record_lightbox").removeClass("disabled");

        refreshModuleTranslation();
		
		if (wayToRetrieveBookingLog == 1) {
			console.timeEnd("OpenBookingRecordRowAPI");
			}
		else {
			console.timeEnd("OpenBookingRecordRow");
		}
    }

    function printDetailDiv(divName) {
        var modalId = $(event.target).closest('.lightbox_ctr').attr('id');
        $('body').css('visibility', 'hidden');
		$('form').css('display', 'none');
		$('.pageContent').css('display', 'none');
        $("#" + modalId).css('visibility', 'visible');

        window.print();

		$('form').css('display', '');
		$('.pageContent').css('display', '');
        $('body').css('visibility', 'visible');
    }

    function hideCancelBtn() {
        $("#cancel_booking_btn").hide();
    }

    function showCancelBtn() {
        $("#cancel_booking_btn").show();
    }
	function getDateFromDateString (dateString) {
		var currentdateoffset = new Date().getTimezoneOffset() / 60;
		var date = new Date(dateString);
		date.setHours(date.getHours() - currentdateoffset);// to offset the function getapidate
		return { "Seconds": date.getTime() / 1000 };
	}
</script>

</div>



</div><!-- End_Module_403 --></div>
	<div class="clear"></div>
</div>
</div></div>
</main>
</div>

<!-- Page Content END-->
</form>

<div id="loading" class="container wbg disabled" style="display: block; width: 100%">
    <div class="loading-main">
        <span id="loading_message" data-i18n="common.Loading">Loading...</span>
    </div>
</div>
<div id="loading_partial" class="loading-panel disabled">
	<span id="loading_message_partial" data-i18n="common.LoadingMore">Loading more results. This may take a while...</span>
</div>
<style>
#loading {
	position: fixed;
    margin-top: 240px;
    top: 0px;
    z-index: 999;
}

@media screen and (max-width: 977px)
{
	#loading {
		margin-top: 42px;
	}
}
</style>

<footer class="footer" style="margin-top: 296px;"> 
	<div class="container">
		<div class="blkl">
			<div class="blklogo"><img src="./img/logo_gls.png" title="Global Logistics System (HK)Co.Ltd">
				<span>
					<span>©</span>
					<span id="footer-year">2021</span>&nbsp;
					<span data-i18n="footer.GLS">Global Logistics System (HK) Co. Ltd</span><br>
					<span data-i18n="footer.Copyright">All rights reserved.</span>
				</span>
			</div>
			<ul class="mainmenu">
				<li><a data-i18n="menu.TrackShipment" href="#">Booking</a></li>
				<li><a data-i18n="menu.FlightAvailability" href="#">Track Shipment</a></li>
			</ul>
			<div class="blkc"></div>
		</div>
		<div class="blkr">
			<img src="./img/icon_gn_phone.png">
			<span data-i18n="footer.Helpdesk">Help desk</span>
			<span>+852 2838 1999  </span><br>
			

<span data-i18n="footer.Language">Languages</span><span class="dot"></span>   
<a id="dnn_GLS_FOOTER_GLS_LANGUAGE_lnk_enUS" class="fglink lang_enUS" href="#">English</a><span class="dot lang_enUS"></span>
<a id="dnn_GLS_FOOTER_GLS_LANGUAGE_lnk_zhHK" class="fglink lang_zhHK" href="#">繁體中文</a><span class="dot lang_zhHK"></span>
<a id="dnn_GLS_FOOTER_GLS_LANGUAGE_lnk_zhCN" class="fglink lang_zhCN" href="#">简体中文</a><span class="dot lang_zhCN"></span>
<a id="dnn_GLS_FOOTER_GLS_LANGUAGE_lnk_jaJP" class="fglink lang_jaJP" href="#">日本語</a><br>
<a id="dnn_GLS_FOOTER_GLS_LANGUAGE_Lnk_deDe" class="fglink" href="#">Deutsche</a><span class="dot"></span>
<a id="dnn_GLS_FOOTER_GLS_LANGUAGE_Lnk_esES" class="fglink" href="#">Español</a>	  
		</div>
		<div class="blkr" style="clear: right">
			<span id="classicLink" class="">
				<a id="classicLinkHref_1" href="#" class="btn_classic">
					<span data-i18n="common.EzyCargoClassic" style="font-size:13px">EzyCargo Classic</span>
				</a>
			</span>
		</div>
		<div class="blkc"></div>
	</div>
</footer>

<style>
    .mainmenu li a {
		color: #fff;
		text-decoration: none;
		cursor: pointer;
    }
</style>
	  
<script>

$(document).ready(function(){
    $("#d-off-canvas-trigger").click(function(){
        $(".active_page").toggleClass(function(){
            return "freeze_page";
        });
    });
});
$(document).ready(function() {
    $(window).resize(function() {
		var bodyheight = $(window).height();
		$(".navbar-collapse.collapse").height(bodyheight-105);
    }); 
   
    $("#footer-year").html(new Date().getFullYear());
});

function FootRedirect(subUrl){
	window.location.href = window.location.origin + '/' + i18next.language + subUrl;
}
</script>

<!-- Dialog -->
<div>
	<style>
    .bootstrap_modal {
        z-index: 9991;
    }
	
	.bootstrap_modal .modal-header{
		background: #00AEEB;
		color: white;
		border-top-left-radius: 5px;
		border-top-right-radius: 5px;
	}

    .bootstrap_modal .btn {
        background: #00AEEB;
        padding: 6px 30px;
        color: #FFF;
        font-size: 16px;
        border-radius: 2px;
        font-family: inherit;
    }

    .bootstrap_modal #message {
        white-space: pre-wrap;
    }
</style>

<div id="modal" class="modal bootstrap_modal fade" role="dialog">
    <div class="modal-dialog">

        <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="title" data-i18n="common.System">common.System</h4>
            </div>
            <div class="modal-body">
                <p id="message"></p>
            </div>
            <div class="modal-footer">
                <button id="btn_confirm" type="button" class="btn btn-default" data-i18n="dialog.Confirm" style="display: none;">Confirm</button>
                <button id="btn_close" type="button" class="btn btn-default" data-i18n="dialog.Close">Close</button>
            </div>
        </div>

    </div>
</div>

<script>
	
    var DialogManager = {

        alert: function (header, msg, close, modalOpts) {
            var dialogManager = this;
			
			var opts = _.merge(this.getDefModalOpts(), modalOpts);
			$("#modal").modal(opts);
			
            if (header)
                $('#modal #title').text(header);

            if (Array.isArray(msg))
                $('#modal #message').text(dialogManager.getMsgFromArray(msg));
            else
                $('#modal #message').text(msg);

            $('#modal #btn_close').click(function () {
                if (typeof close === "function") {
                    close();
                }
                $("#modal").modal('hide');
            });
        },

        confirm: function (header, msg, confirm, close, modalOpts) {
            var dialogManager = this;
			
			var opts = _.merge(this.getDefModalOpts(), modalOpts);
			$("#modal").modal(opts);
			
            if (header)
                $('#modal #title').text(header);

            if (Array.isArray(msg))
                $('#modal #message').text(dialogManager.getMsgFromArray(msg));
            else
                $('#modal #message').text(msg);
				
            $('#modal #btn_confirm').show();

            $('#modal #btn_confirm').click(function () {
                if (typeof confirm === "function") {
                    confirm();
                }
                $("#modal").modal('hide');
            });

            $('#modal #btn_close').click(function () {
                if (typeof close === "function") {
                    close();
                }
                $("#modal").modal('hide');
            });
        },

        reset: function () {
			$("#modal").data('bs.modal', null);
		
            $('#modal #title').text(i18next.t('common.System'));
            $('#modal #message').text('');
            $('#modal #btn_confirm').hide();
			
            $('#modal #btn_confirm').off('click');
            $('#modal #btn_close').off('click');
        },

        getMsgFromArray: function (arr) {
            return arr.join("\n");
        },
		
		getDefModalOpts: function () {
			return {
				backdrop: true,
				show: true,
				keyboard: true
			}
		}
    };

    $(function () {
        DialogManager.reset();
		$('#modal').on('hide.bs.modal', function () {
			DialogManager.reset();
		})

		$(document).on('keydown', function (e) {
			if(!($("#modal").data('bs.modal') || {}).isShown)
				return;
				
			//enter
			if (e.which == 13) {
				$("#btn_confirm").click();
				e.stopPropagation();
			}
			//escape
			else if(e.which == 27){
				$("#btn_close").click();
				e.stopPropagation();
			}
		})
    })
</script>
</div>
        <input name="ScrollTop" type="hidden" id="ScrollTop">
        <input name="__dnnVariable" type="hidden" id="__dnnVariable" autocomplete="off">
</body></html>